<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sukie&#39;s Blog</title>
  
  <subtitle>新世界编程</subtitle>
  <link href="https://sukie-sun.github.io/atom.xml" rel="self"/>
  
  <link href="https://sukie-sun.github.io/"/>
  <updated>2020-08-09T16:54:05.997Z</updated>
  <id>https://sukie-sun.github.io/</id>
  
  <author>
    <name>Sukie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="https://sukie-sun.github.io/2020/08/08/hello-world/"/>
    <id>https://sukie-sun.github.io/2020/08/08/hello-world/</id>
    <published>2020-08-08T04:56:00.000Z</published>
    <updated>2020-08-09T16:54:05.997Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><p>$$<br>x^{y^z}=(1+{\rm e}^x)^{-2xy^w}<br>$$</p><div class="github-widget" data-repo="sukie-sun/sukie-sun.github.io"></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height="200" src="//music.163.com/outchain/player?type=0&id=883067320&auto=1&height=430">// 歌曲 type=2，歌单 type=0，id 填对应 id</iframe><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#指定文章中关闭目录 `toc: false`</span><span class="token comment" spellcheck="true">#指定文章中关闭版权信息 original: false</span><span class="token comment" spellcheck="true">#指定文章中关闭图片浏览器 fancybox: false</span><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> Hello World<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2015-08-19 00:00:00</span><span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">original</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">fancybox</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-html"><code class="language-html">&lt;div class="aplayer"  data-id="883067320"   // 歌曲 / 专辑 / 歌单 ID  data-server="netease" // 音乐平台：netease、tencent、xiami、kugou、baidu  data-type="playlist"  // 类型：song、album、playlist、search、artist  data-mode="random"    // 播放模式：random、single、circulation、order  data-autoplay="true"  // 自动播放  ><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    <summary type="html">Welcome to Hexo! This is your very first post:新世界编程!</summary>
    
    
    
    <category term="Hexo" scheme="https://sukie-sun.github.io/categories/Hexo/"/>
    
    
    <category term="个人兴趣" scheme="https://sukie-sun.github.io/tags/%E4%B8%AA%E4%BA%BA%E5%85%B4%E8%B6%A3/"/>
    
    <category term="博客" scheme="https://sukie-sun.github.io/tags/%E5%8D%9A%E5%AE%A2/"/>
    
  </entry>
  
  <entry>
    <title>Spark学习（六）</title>
    <link href="https://sukie-sun.github.io/2019/02/22/Spark(6)/"/>
    <id>https://sukie-sun.github.io/2019/02/22/Spark(6)/</id>
    <published>2019-02-21T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.799Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、-SparkStreaming简介"><a href="#一、-SparkStreaming简介" class="headerlink" title="一、 SparkStreaming简介"></a>一、 SparkStreaming简介</h1><ul><li><p>SparkStreaming是流式处理框架，是Spark API的扩展，<code>支持</code>可扩展、高吞吐、容错的实时数据处理。</p></li><li><p>实时数据<code>来源</code>：kafka、Flume、Twitter、ZeroMQ、TCP Socket</p></li><li><p>可以使用高级功能的复杂算子来<code>处理</code>流数据：如 map、reduce、join、window</p></li><li><p>处理后的数据可以<code>存放</code>在文件系统、数据库等，方便实时展现</p></li></ul><h1 id="二、SparkStreaming-与-Storm-的区别"><a href="#二、SparkStreaming-与-Storm-的区别" class="headerlink" title="二、SparkStreaming 与 Storm 的区别"></a>二、SparkStreaming 与 Storm 的区别</h1><blockquote><ul><li><p>Storm 是纯实时的流式处理框架，SparkStreaming 是准实时的处理框架（微批处理）。因为微批处理，SparkStreaming 的吞吐量比 Storm 要高。</p></li><li><p>Storm 的事务机制要比 SparkStreaming 的要完善。 </p></li><li><p>Storm 支持动态资源调度。(spark1.2 开始和之后也支持)</p></li><li><p>SparkStreaming 擅长复杂的业务处理，Storm 不擅长复杂的业务处理，擅长简单的汇总型计算</p></li></ul></blockquote><table><thead><tr><th align="center">SparkStreaming</th><th align="center">Storm</th></tr></thead><tbody><tr><td align="center">微批处理，准实时的流式处理框架</td><td align="center">实时计算框架，来一条数据马上处理</td></tr><tr><td align="center">支持动态调整资源</td><td align="center">支持动态调整资源</td></tr><tr><td align="center">支持事务</td><td align="center">支持事务</td></tr><tr><td align="center">支持复杂的业务场景</td><td align="center">处理场景相对简单一些</td></tr></tbody></table><h1 id="三、SparkStreaming的详情"><a href="#三、SparkStreaming的详情" class="headerlink" title="三、SparkStreaming的详情"></a>三、SparkStreaming的详情</h1><h2 id="1、运行流程"><a href="#1、运行流程" class="headerlink" title="1、运行流程"></a>1、运行流程</h2><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0ff16n6p0j30rp08075q.jpg"></p><blockquote><p>SparkStreaming会启动receive task一直接受数据，每个batchInterval的时间周期，就会把数据变成一个batch，然后进一步封装成RDD，最后变成DStream ,用户操作DStream 时，可以使用一系列算子： map、flatmap、filter。。。。。</p></blockquote><blockquote><p><code>情况：</code></p><p>1、batchInterval为5s ，计算这批数据的时间为3s ，则此时 0—5s，在结束数据；5—10s，一边接收数据，一边处理上一批数据；依次类推。</p><p>2、batchInterval为5s ，计算这批数据的时间为6s ，则此时0—5s，在接收数据；5—10s，一边接收第二批数据，一边处理第一批数据；10—11s,一边接收第三批数据，一边处理第一批数据，第二批数据等待计算，就会造成数据堆积，如果SparkStreaming的数据存储是仅在内存中，就会发生OOM；如果设置StorageLevel 包含 disk, 则内存存放不下的数据会溢写至 disk, 加大延迟</p></blockquote><blockquote><p><code>注意；</code></p><ul><li>receiver task 是 7*24 小时一直在执行</li></ul></blockquote><h2 id="2、SparkStreaming-代码"><a href="#2、SparkStreaming-代码" class="headerlink" title="2、SparkStreaming 代码"></a>2、SparkStreaming 代码</h2><h3 id="（1）关于SparkStreaming-框架我们必须要知道的几点"><a href="#（1）关于SparkStreaming-框架我们必须要知道的几点" class="headerlink" title="（1）关于SparkStreaming 框架我们必须要知道的几点"></a>（1）关于SparkStreaming 框架我们必须要知道的几点</h3><blockquote><p><code>注意：</code></p><ul><li><p>receiver模式下接收数据，local的模拟线程必须大于等于2：</p><ul><li>一个线程用receiver的数据接收</li><li>一个线程用于执行job</li></ul></li><li><p>Duration时间设置就是我们能接受的延迟度，需要根据集群的资源情况以及监控每一个job的执行时间来调节出最佳时间。</p></li><li><p>创建JavaStreamingContext有两种方式：SparkConf 、 SparkContext</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//     JavaSparkContext  →   JavaStreamingContext  </span>JavaStreamingContext jsc <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span>Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//    JavaStreamingContext    →    JavaSparkContext</span><span class="token keyword">final</span> JavaSparkContext sparkContext <span class="token operator">=</span> jsc<span class="token punctuation">.</span><span class="token function">sparkContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>所有的代码逻辑完成以后，必须要有一个ouput opertion类算子</p></li><li><p>JavaStreamingContext.start()   ，Streaming框架便启动，之后，就不能再次添加业务逻辑</p></li><li><p>JavaStreamingContext.stop()   ，无参的stop( )  会把SparkContext一同关闭；stop(false) , 只会关闭StreamContext ,SparkContext依然存在</p></li><li><p>JavaStreamingContext.stop()停止之后不能再调用 start</p></li></ul></blockquote><h3 id="（2）代码举例：WordCount"><a href="#（2）代码举例：WordCount" class="headerlink" title="（2）代码举例：WordCount"></a>（2）代码举例：WordCount</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedReader<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileInputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStreamReader<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>Accumulator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span>Broadcast<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Durations<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Time<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaReceiverInputDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContext<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCountOnline</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**     The master URL to connect to,      such as "local" to run locally with one thread,      "local[4]" to run locally with 4 cores,       or "spark://master:7077" to run on a Spark standalone cluster.   */</span>         <span class="token keyword">final</span> SparkConf conf <span class="token operator">=</span>                <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"WordCountOnline"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 在创建streamingContext的时候 设置batch Interval         * 创建streamingContext有两种方式：conf， context         */</span><span class="token comment" spellcheck="true">//    final JavaStreamingContext jsc = </span><span class="token comment" spellcheck="true">//             new JavaStreamingContext(conf, Durations.seconds(5));</span>        JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建StreamContext，及间隔时间：每个5秒处理数据        </span>        JavaStreamingContext jsc <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span>Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//        final JavaSparkContext sparkContext = jsc.sparkContext();</span><span class="token comment" spellcheck="true">//设置监听节点及端口，接收从这个节点的这个port输入的数据，最后封装成DStream</span><span class="token comment" spellcheck="true">//避免端口被占用        </span>        JavaReceiverInputDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> lines <span class="token operator">=</span>                                    jsc<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"node00"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//切割每一行数据</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> words <span class="token operator">=</span>             lines<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> ones <span class="token operator">=</span>             words<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//给每个单词计为1</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//累加，并指定分区数</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> counts <span class="token operator">=</span>             ones<span class="token punctuation">.</span><span class="token function">reduceByKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer i1<span class="token punctuation">,</span> Integer i2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> i1 <span class="token operator">+</span> i2<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//outputoperator类的算子   </span><span class="token comment" spellcheck="true">//         counts.print();</span>counts<span class="token punctuation">.</span><span class="token function">foreachRDD</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Integer<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> pairRDD<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           pairRDD<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Integer<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>                <span class="token annotation punctuation">@Override</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> tuple<span class="token punctuation">)</span><span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"tuple ---- "</span><span class="token operator">+</span>tuple <span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//框架启动必须调用start</span>         jsc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//等待spark程序被终止</span>         jsc<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个期间可用于一些扫尾操作，如获取SparkContext，如果直接stop，就无法实现了        </span><span class="token comment" spellcheck="true">//任务执行结束</span>        jsc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"stop====================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（3）代码运行"><a href="#（3）代码运行" class="headerlink" title="（3）代码运行"></a>（3）代码运行</h3><p>在Linux系统中：</p><ul><li>启动socket server 服务：node00</li></ul><pre class="line-numbers language-shell"><code class="language-shell">yum install nc -ync -lk 9999<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>在该节点上输入输入数据 （避免端口被占用）</li></ul><blockquote><p>在Windows端运行代码，便能接收到数据，从而执行运算处理</p></blockquote><h3 id="广播黑名单："><a href="#广播黑名单：" class="headerlink" title="广播黑名单："></a>广播黑名单：</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sxt<span class="token punctuation">.</span>java<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span>Broadcast<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Durations<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaReceiverInputDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContext<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>base<span class="token punctuation">.</span>Optional<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 过滤黑名单（使用广播变量）</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformOperator</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"transform"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaStreamingContext jsc <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span>Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//模拟黑名单</span>        List<span class="token operator">&lt;</span>String<span class="token operator">></span> blackList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        blackList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//广播黑名单    </span>        <span class="token keyword">final</span> Broadcast<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>String<span class="token operator">>></span> broadcastList <span class="token operator">=</span>            jsc<span class="token punctuation">.</span><span class="token function">sparkContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>blackList<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//接受socket数据源: 1 zhangsan     2  lisi       3   wangwu</span>        JavaReceiverInputDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> nameList <span class="token operator">=</span>             jsc<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> pairNameList <span class="token operator">=</span>             nameList<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//对DStream使用transform算子，在算子内部实现RDD到RDD的转换</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> transFormResult <span class="token operator">=</span> pairNameList<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">,</span>JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> nameRDD<span class="token punctuation">)</span><span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> filter <span class="token operator">=</span>                    nameRDD<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">,</span> Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>                    <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Boolean <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> v1<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">//得到广播变量</span>                        List<span class="token operator">&lt;</span>String<span class="token operator">></span> blackList <span class="token operator">=</span> broadcastList<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token keyword">return</span> <span class="token operator">!</span>blackList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> filter<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> String <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> v1<span class="token punctuation">)</span>                            <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> v1<span class="token punctuation">.</span>_2<span class="token punctuation">;</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        transFormResult<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="统计累计值："><a href="#统计累计值：" class="headerlink" title="统计累计值："></a>统计累计值：</h3><p>从程序启动，到当前 ， 所有批次数据的累加值</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Durations<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaReceiverInputDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContext<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>base<span class="token punctuation">.</span>Optional<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateStateByKeyOperator</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span>  <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"UpdateStateByKeyDemo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaStreamingContext jsc <span class="token operator">=</span>            <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置checkpoint目录</span><span class="token comment" spellcheck="true">//         jsc.checkpoint("hdfs://shsxt/spark/checkpoint");</span>        jsc<span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span><span class="token string">"./checkpoint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 数据格式：   hello shsxt     hello bjsxt*/</span>        JavaReceiverInputDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> lines <span class="token operator">=</span>             jsc<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"node00"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> words <span class="token operator">=</span>             lines<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> ones <span class="token operator">=</span>             words<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//updateStateByKey  更新key值状态</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> counts <span class="token operator">=</span>ones<span class="token punctuation">.</span><span class="token function">updateStateByKey</span><span class="token punctuation">(</span>            <span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">,</span> Optional<span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">,</span> Optional<span class="token operator">&lt;</span>Integer<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>                    <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> Optional<span class="token operator">&lt;</span>Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>              List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> values<span class="token punctuation">,</span> Optional<span class="token operator">&lt;</span>Integer<span class="token operator">></span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">/**                         * values:经过分组最后 这个key所对应的value  [1,1,1,1,1]                         * state:这个key在前一个批次的状态                         */</span>                        Integer updateValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">//如果存在值，便获取</span>                            updateValue <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>updateValue <span class="token operator">+</span> <span class="token string">" ========  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Integer value <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                            updateValue <span class="token operator">+=</span> value<span class="token punctuation">;</span>                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>updateValue<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//output operator</span>        counts<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        counts.foreachRDD(new VoidFunction&lt;JavaPairRDD&lt;String, Integer>>() &amp;#123;</span><span class="token comment" spellcheck="true">//            @Override</span><span class="token comment" spellcheck="true">// public void call(JavaPairRDD&lt;String, Integer> pairRDD) throws Exception &amp;#123;</span><span class="token comment" spellcheck="true">//                System.out.println(pairRDD.getNumPartitions());</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//                pairRDD.collect();</span><span class="token comment" spellcheck="true">//            &amp;#125;</span><span class="token comment" spellcheck="true">//        &amp;#125;);</span>        jsc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>注意：</code></p><blockquote><p>Optional 类</p><ul><li>Java 8 引入的类</li><li>主要用于解决空指针异常的问题</li><li>从本质上说，这是一个包含有可选值的包装类，意味着Optional 类既可以包含有对象，也可以为空</li></ul></blockquote><h2 id="3、SparkStreaming算子操作"><a href="#3、SparkStreaming算子操作" class="headerlink" title="3、SparkStreaming算子操作"></a>3、SparkStreaming算子操作</h2><h3 id="1、ouput-opertion类算子"><a href="#1、ouput-opertion类算子" class="headerlink" title="1、ouput opertion类算子"></a>1、ouput opertion类算子</h3><ul><li><blockquote><p><strong>foreachRDD</strong></p><p>参数：RDD    返回值：无</p><ul><li><p>foreachRDD可以遍历得到DStream中的RDD</p></li><li><p>可以对RDD使用RDD的Transformation类算子进行转化</p></li><li><p>但是在这个算子内 <strong>必须对抽取出来的RDD执行Action类算子</strong>，代码才能执行</p></li><li><p>在这个算子<strong>内</strong>，RDD算子<strong>外</strong>执行的代码是在Driver端执行，RDD算子<strong>内</strong>的代码是在Executor中执行。</p><p><strong>print</strong></p></li></ul></blockquote></li></ul><h3 id="2、transformation类算子"><a href="#2、transformation类算子" class="headerlink" title="2、transformation类算子"></a>2、transformation类算子</h3><ul><li><blockquote><p><strong>transform</strong></p><p>参数：RDD   返回：另一RDD</p><p>transform算子可将DStream做RDD到RDD的任意操作</p><ul><li>在这个算子<strong>内</strong>，RDD算子<strong>外</strong>执行的代码是在Driver端执行，RDD算子<strong>内</strong>的代码是在Executor中执行。</li><li></li></ul><p><strong>updateStateByKey</strong></p><ul><li><p>此算子为SparkStreaming中每一个key维护一个state，state可以是任意类型，也可以是自定义对象，更新函数也可以是自定义</p></li><li><p>与reduceByKey相似的地方就是会先按key进行分组</p></li><li><p>通过更新函数对该 key 的状态不断更新，对于每个新的 batch 而言，SparkStreaming 会在使用 updateStateByKey 的时候为已经存在的 key 进行 state 的状态更新。</p></li><li><p>如果要不断的更新每个key的state，就一定涉及到了状态的保存和容错，这个时候就需要开启checkpoint机制和功能</p></li><li><p>有何用？全面的广告点击分析，统计广告点击流量，统计这一天的车流量，统计点击量</p></li></ul></blockquote></li></ul><h3 id="3、注意"><a href="#3、注意" class="headerlink" title="3、注意"></a>3、注意</h3><ul><li><h4 id="使用到-updateStateByKey-要开启-checkpoint-机制和功能。"><a href="#使用到-updateStateByKey-要开启-checkpoint-机制和功能。" class="headerlink" title="使用到 updateStateByKey 要开启 checkpoint 机制和功能。"></a>使用到 updateStateByKey 要开启 checkpoint 机制和功能。</h4></li></ul><pre><code>//设置checkpoint目录: // 落地到本地磁盘  jsc.checkpoint(&quot;./checkpoint&quot;);//保存在hdfs  jsc.checkpoint(&quot;hdfs://shsxt/spark/checkpoint&quot;);</code></pre><ul><li><h4 id="多久会将内存中的数据-每一个key所对应的状态-写入到磁盘一份？"><a href="#多久会将内存中的数据-每一个key所对应的状态-写入到磁盘一份？" class="headerlink" title="多久会将内存中的数据(每一个key所对应的状态)写入到磁盘一份？"></a>多久会将内存中的数据(每一个key所对应的状态)写入到磁盘一份？</h4><blockquote><p>如果batchInterval设置的时间小于10秒，那么10秒写入磁盘一份。</p><p>如果 batchInterval 设置的时间大于 10 秒，那么就会 batchInterval时间间隔写入磁盘一份。</p><p>这样做是为了防止频繁的写HDFS</p></blockquote></li></ul><h3 id="4、窗口操作"><a href="#4、窗口操作" class="headerlink" title="4、窗口操作"></a>4、窗口操作</h3><h4 id="1-窗口操作理解图："><a href="#1-窗口操作理解图：" class="headerlink" title="(1)窗口操作理解图："></a>(1)窗口操作理解图：</h4><p><img src="http://spark.apache.org/docs/latest/img/streaming-dstream-window.png"></p><p>假设每隔 5s 1 个 batch,上图中窗口长度为 15s，窗口滑动间隔 10s。</p><ul><li>窗口长度和滑动间隔必须是 batchInterval 的整数倍。如果不是整数倍会检测报错。</li></ul><blockquote><p>用于计算最近一段时间的数据</p></blockquote><h4 id="2-优化后的-window-窗口操作示意图："><a href="#2-优化后的-window-窗口操作示意图：" class="headerlink" title="(2)优化后的 window 窗口操作示意图："></a>(2)优化后的 window 窗口操作示意图：</h4><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0fh4r65nej30g507b0vo.jpg"></p><ul><li>优化后的 window 操作要保存状态所以要设置 checkpoint 路径，没有优化的 window 操作可以不设置 checkpoint 路径</li></ul><h4 id="3-代码实现"><a href="#3-代码实现" class="headerlink" title="(3)代码实现"></a>(3)代码实现</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Durations<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaReceiverInputDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContext<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//基于滑动窗口的热点搜索词实时统计</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperator</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"WindowHotWord"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         JavaStreamingContext jssc <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置日志级别为WARN</span>        jssc<span class="token punctuation">.</span><span class="token function">sparkContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLogLevel</span><span class="token punctuation">(</span><span class="token string">"WARN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 注意：         *  没有优化的窗口函数可以不设置checkpoint目录         *  优化的窗口函数必须设置checkpoint目录                  */</span><span class="token comment" spellcheck="true">//      jssc.checkpoint("hdfs://node1:9000/spark/checkpoint");</span>           jssc<span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span><span class="token string">"./checkpoint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaReceiverInputDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> searchLogsDStream <span class="token operator">=</span>                            jssc<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"node00"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//word    1</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> searchWordsDStream <span class="token operator">=</span>             searchLogsDStream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String t<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t <span class="token operator">+</span> <span class="token string">"*************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 将搜索词映射为(searchWord, 1)的tuple格式</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> searchWordPairDStream <span class="token operator">=</span>             searchWordsDStream<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span>                                <span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>                    <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String searchWord<span class="token punctuation">)</span><span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span>searchWord<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 每隔10秒，计算最近60秒内的数据，         * 那么这个窗口大小就是60秒，里面有12个rdd，在没有计算之前，这些rdd是不会进行计算的。         * 那么在计算的时候会将这12个rdd聚合起来，然后一起执行reduceByKeyAndWindow操作 ，         * reduceByKeyAndWindow是针对窗口操作的而不是针对DStream操作的。         */</span><span class="token comment" spellcheck="true">// JavaPairDStream&lt;String, Integer> searchWordCountsDStream =</span><span class="token comment" spellcheck="true">//        searchWordPairDStream.reduceByKeyAndWindow(</span><span class="token comment" spellcheck="true">//                 new Function2&lt;Integer, Integer, Integer>() &amp;#123;</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//                    private static final long serialVersionUID = 1L;</span><span class="token comment" spellcheck="true">//                    @Override</span><span class="token comment" spellcheck="true">//                    public Integer call(Integer v1, Integer v2) throws Exception &amp;#123;</span><span class="token comment" spellcheck="true">//                        return v1 + v2;</span><span class="token comment" spellcheck="true">//                    &amp;#125;</span><span class="token comment" spellcheck="true">//        &amp;#125;, Durations.minutes(30), Durations.seconds(60));</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//        JavaPairDStream&lt;String, Integer> searchWordCountsDStream =</span><span class="token comment" spellcheck="true">//            searchWordPairDStream.reduceByKeyAndWindow(</span><span class="token comment" spellcheck="true">//        new Function2&lt;Integer, Integer, Integer>() &amp;#123;</span><span class="token comment" spellcheck="true">//                @Override</span><span class="token comment" spellcheck="true">//                public Integer call(Integer v1, Integer v2) throws Exception &amp;#123;</span><span class="token comment" spellcheck="true">//                    System.out.println(v1 + " : " + v2);</span><span class="token comment" spellcheck="true">//                    return v1 + v2;</span><span class="token comment" spellcheck="true">//                &amp;#125;</span><span class="token comment" spellcheck="true">//            &amp;#125;,Durations.seconds(15),Durations.seconds(5));</span>               <span class="token comment" spellcheck="true">// 窗口时间               滑块时间     </span>        <span class="token comment" spellcheck="true">//window窗口操作优化：</span>        <span class="token comment" spellcheck="true">//将划出串窗口的数据排除，将新划入窗口的数据添加</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> searchWordCountsDStream <span class="token operator">=</span>          searchWordPairDStream<span class="token punctuation">.</span><span class="token function">reduceByKeyAndWindow</span><span class="token punctuation">(</span>            <span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token annotation punctuation">@Override</span>                <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer v1<span class="token punctuation">,</span> Integer v2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"v1:"</span> <span class="token operator">+</span> v1 <span class="token operator">+</span> <span class="token string">" v2:"</span> <span class="token operator">+</span> v2 <span class="token operator">+</span> <span class="token string">"  ++++++++++"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token annotation punctuation">@Override</span>                <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer v1<span class="token punctuation">,</span> Integer v2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"v1:"</span> <span class="token operator">+</span> v1 <span class="token operator">+</span> <span class="token string">" v2:"</span> <span class="token operator">+</span> v2 <span class="token operator">+</span> <span class="token string">"------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> v1 <span class="token operator">-</span> v2<span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          searchWordCountsDStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jssc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jssc<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jssc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>reduceByKeyAndWindow</li></ul><blockquote><p>reduceByKeyAndWindow是针对窗口操作的而不是针对DStream操作的。</p></blockquote><h2 id="5-Driver-HA（Standalone-或者-Mesos）"><a href="#5-Driver-HA（Standalone-或者-Mesos）" class="headerlink" title="5. Driver HA（Standalone 或者 Mesos）"></a>5. Driver HA（Standalone 或者 Mesos）</h2><p>代码举例：</p><h3 id="产生文件："><a href="#产生文件：" class="headerlink" title="产生文件："></a>产生文件：</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileInputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>UUID<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 此复制文件的程序是模拟在data目录下动态生成相同格式的txt文件，用于给sparkstreaming 中 textFileStream提供输入流。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyFile_data</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            String uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">copyFile</span><span class="token punctuation">(</span>       <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"./data/scores.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"./dataTest/"</span><span class="token operator">+</span>uuid<span class="token operator">+</span><span class="token string">"----words.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">copyFile</span><span class="token punctuation">(</span>File fromFile<span class="token punctuation">,</span> File toFile<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        FileInputStream ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>fromFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        FileOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>toFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unused"</span><span class="token punctuation">)</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        ins<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="处理数据："><a href="#处理数据：" class="headerlink" title="处理数据："></a>处理数据：</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Durations<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContextFactory<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span>DStream<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** *  Spark standalone or Mesos with cluster deploy mode only: *  在提交application的时候  添加 --supervise 选项  如果Driver挂掉 会自动启动一个Driver */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SparkStreamingOnHDFS</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> SparkConf conf <span class="token operator">=</span>       <span class="token keyword">new</span>  <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"SparkStreamingOnHDFS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//      final String checkpointDirectory =</span>        <span class="token string">"hdfs://shsxt/spark/SparkStreaming/CheckPoint2017"</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> String checkpointDirectory <span class="token operator">=</span> <span class="token string">"./checkpoint"</span><span class="token punctuation">;</span>        JavaStreamingContextFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContextFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> JavaStreamingContext <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                  <span class="token keyword">return</span> <span class="token function">createContext</span><span class="token punctuation">(</span>checkpointDirectory<span class="token punctuation">,</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//getOrCreate() 该方法会先到checkpointDirectory的文件中检查是否有checkpoint记录，如果没有就会让 factory 去调用 create() 来创建JavaStreamingContext ；如果存在就执行checkpoint的任务</span>        JavaStreamingContext jsc <span class="token operator">=</span> JavaStreamingContext<span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span>checkpointDirectory<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> JavaStreamingContext         <span class="token function">createContext</span><span class="token punctuation">(</span>String checkpointDirectory<span class="token punctuation">,</span>SparkConf conf<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// If you do not see this printed, that means the StreamingContext has been loaded</span><span class="token comment" spellcheck="true">// from the new checkpoint</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Creating new context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SparkConf sparkConf <span class="token operator">=</span> conf<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Create the context with a 1 second batch size</span>        JavaStreamingContext ssc <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        ssc.sparkContext().setLogLevel("WARN");</span>        <span class="token comment" spellcheck="true">/**         *  checkpoint 保存：         *        1.配置信息         *        2.DStream操作逻辑         *        3.job的执行进度         *      4.offset         */</span>        ssc<span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span>checkpointDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/**         * 监控的是HDFS上的一个目录，监控文件数量的变化     文件内容如果追加监控不到。         * 只监控文件夹下新增的文件，减少的文件时监控不到的，文件的内容有改动也监控不到。         */</span><span class="token comment" spellcheck="true">//        JavaDStream&lt;String> lines = </span><span class="token comment" spellcheck="true">//        ssc.textFileStream("hdfs://node1:9000/spark/sparkstreaming");</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> lines <span class="token operator">=</span> ssc<span class="token punctuation">.</span><span class="token function">textFileStream</span><span class="token punctuation">(</span><span class="token string">"./dataTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> words <span class="token operator">=</span>             lines<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> ones <span class="token operator">=</span>             words<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> counts <span class="token operator">=</span>             ones<span class="token punctuation">.</span><span class="token function">reduceByKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer i1<span class="token punctuation">,</span> Integer i2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> i1 <span class="token operator">+</span> i2<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        counts.print();</span>        DStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> dstream <span class="token operator">=</span> counts<span class="token punctuation">.</span><span class="token function">dstream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dstream<span class="token punctuation">.</span><span class="token function">saveAsTextFiles</span><span class="token punctuation">(</span><span class="token string">"./data/write/xxxxx"</span><span class="token punctuation">,</span><span class="token string">"yyyyyy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ssc<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>注意</code></strong></p><ul><li><p>因为 SparkStreaming 是 7*24 小时运行，Driver 只是一个简单的进程，有可能挂掉，所以实现 Driver 的 HA 就有必要</p></li><li><p>如果使用的 Client 模式就无法实现 Driver HA ，这里针对的是 cluster 模式</p></li><li><p>Yarn 平台 cluster 模式提交任务，AM(AplicationMaster)相当于 Driver，如果挂掉会自动启动 AM</p></li><li><p>这里所说的 DriverHA 针对的是 Spark standalone 和 Mesos 资源调度的情况下</p></li></ul><p>实现 Driver 的高可用有两个**<code>步骤</code>**：</p><ul><li><p>第一：提交任务层面，在提交任务的时候加上选项 –supervise,当 Driver挂掉的时候会自动重启 Driver。</p></li><li><p>第二：代码层面，使用 JavaStreamingContext.getOrCreate（checkpoint路径，JavaStreamingContextFactory）</p></li><li><p>Driver 中元数据包括：</p><ol><li>创建应用程序的配置信息。</li><li>DStream 的操作逻辑</li><li>job 中没有完成的批次数据，也就是 job 的执行进度。</li></ol></li></ul><h2 id="6、SparkStreaming-Kafka"><a href="#6、SparkStreaming-Kafka" class="headerlink" title="6、SparkStreaming+Kafka"></a>6、SparkStreaming+Kafka</h2><h3 id="（1）receiver-模式"><a href="#（1）receiver-模式" class="headerlink" title="（1）receiver 模式"></a>（1）receiver 模式</h3><h4 id="receiver-模式原理图"><a href="#receiver-模式原理图" class="headerlink" title="receiver 模式原理图"></a>receiver 模式原理图</h4><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0g5e9n7b7j315j0ywn1a.jpg"></p><h4 id="receiver-模式理解："><a href="#receiver-模式理解：" class="headerlink" title="receiver 模式理解："></a>receiver 模式理解：</h4><blockquote><p>1.在 SparkStreaming 程序运行起来后，Executor 中会有 receivertasks 接收 kafka 推送过来的数据。数据会被持久化，默认级别为MEMORY_AND_DISK_SER_2,这个级别也可以修改。</p><p>2.receiver task对接收过来的数据进行存储和备份，这个过程会有节点之间的数据传输。</p><p>3.备份完成后去 zookeeper 中更新消费偏移量，然后向 Driver 中的 receiver tracker 汇报数据的位置。最后 Driver 根据数据本地化将 task 分发到不同节点上执行</p></blockquote><blockquote><p> 数据本地化原则：将task分配到data所在节点</p></blockquote><h4 id="receiver-模式中存在的问题："><a href="#receiver-模式中存在的问题：" class="headerlink" title="receiver 模式中存在的问题："></a>receiver 模式中存在的问题：</h4><p><strong><em>场景一：</em></strong></p><blockquote><p>1、当 Driver 进程挂掉后，Driver 下的 Executor 都会被杀掉，当更新完 zookeeper 消费偏移量的时Driver 如果挂掉了，就会存在找不到数据的问题，相当于丢失数据。如何解决这个问题？</p><p>2、开启**<code>WAL</code>**(write ahead log)<em>预写日志机制</em>， 在接受过来数据备份到其他节点的时候，同时备份到 HDFS 上一份（我们需要将接收来的数据的持久化级别降级到 MEMORY_AND_DISK），这样就能保证数据的安全性。</p><p>3、不过，因为写 HDFS 比较消耗性能，要在备份完数据之后才能进行更新 zookeeper 以及汇报位置等，这样会增加 job 的执行时间，这样对于任务的执行提高了延迟度</p></blockquote><p><strong><em>场景二：</em></strong></p><blockquote><p>开启了WAL机制</p><p>若数据接收完后（50~100），也将数据备份到另一节点和HDFS上，正准备更新偏移量（100）的时候，driver挂掉了，重启后，就会到HDFS上去获取未计算的数据，然后，检查偏移量（50），再根据偏移量去消费topic。这就出现了重复消费的现象</p></blockquote><p><strong><code>*术语解释：*</code></strong></p><blockquote><p>SparkStreaming的receive模式能保证 at least模型，只能保证至少消费一次，不能保证仅被消费一次</p><p>exactly-once模型   能保证仅被消费一次，较理想的模型可以避免重复消费，direct模式可以实现，但是输出不能保证</p></blockquote><h4 id="receiver-的并行度设置："><a href="#receiver-的并行度设置：" class="headerlink" title="receiver 的并行度设置："></a>receiver 的并行度设置：</h4><blockquote><p>1、receiver 的并行度是由 spark.streaming.blockInterval 来决定的，默认为200ms,</p><p>2、假设 batchInterval 为 5s,那么每隔 blockInterval 就会产生一个 block,这里就对应每批次产生 RDD 的 partition,这样 5 秒产生的这个 Dstream 中的这个 RDD 的 partition 为 25 个，并行度就是25。</p><p>3、如果想提高并行度，可以减少 blockInterval 的数值，但是最好不要低于 50ms。</p></blockquote><h4 id="receiver-模式代码："><a href="#receiver-模式代码：" class="headerlink" title="receiver 模式代码："></a>receiver 模式代码：</h4><h5 id="产生数据："><a href="#产生数据：" class="headerlink" title="产生数据："></a>产生数据：</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> kafka<span class="token punctuation">.</span>javaapi<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>Producer<span class="token punctuation">;</span><span class="token keyword">import</span> kafka<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KeyedMessage<span class="token punctuation">;</span><span class="token keyword">import</span> kafka<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>ProducerConfig<span class="token punctuation">;</span><span class="token keyword">import</span> kafka<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>StringEncoder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>KafkaProducer<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>SimpleDateFormat<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//向kafka中生产数据</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyProducer</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// sparkstreaming  storm  flink 两三年后变成主流  流式处理，可能更复杂，数据处理性能要非常好</span>    <span class="token keyword">private</span> String topic<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//发送给Kafka的数据,topic</span>    <span class="token keyword">private</span> Producer<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> producerForKafka<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">MyProducer</span><span class="token punctuation">(</span>String topic<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topic<span class="token punctuation">;</span>        Properties conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"metadata.broker.list"</span><span class="token punctuation">,</span> <span class="token string">"node01:9092,node02:9092,node03:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"serializer.class"</span><span class="token punctuation">,</span> StringEncoder<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        producerForKafka <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerConfig</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          counter<span class="token operator">++</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// String value = "shsxt" + counter;</span>            String value <span class="token operator">=</span> <span class="token string">"shsxt"</span>          KeyedMessage<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyedMessage</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            producerForKafka<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token string">" - -- -- --- -- - -- - -"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//hash partitioner 当有key时，则默认通过key 取hash后 ，对partition_number 取余数</span><span class="token comment" spellcheck="true">//            producerForKafka.send(new KeyedMessage&lt;Integer, String>(topic,22,userLog));</span><span class="token comment" spellcheck="true">//            每2条数据暂停2秒</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> counter <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">MyProducer</span><span class="token punctuation">(</span><span class="token string">"sk1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">MyProducer</span><span class="token punctuation">(</span><span class="token string">"sk2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="操作："><a href="#操作：" class="headerlink" title="操作："></a>操作：</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">import</span> kafka<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>StringDecoder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>StorageLevel<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Durations<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairReceiverInputDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>KafkaUtils<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//receiver 模式并行度是由blockInterval决定的</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SparkStreamingOnKafkaReceiver</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>     SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         conf<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"SparkStreamingOnKafkaReceiver"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//开启预写日志 WAL机制</span>        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"spark.streaming.receiver.writeAheadLog.enable"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaStreamingContext jsc <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span><span class="token string">"./receivedata"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> topicConsumerConcurrency <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//设置读取的topic和接受数据的线程数</span>        topicConsumerConcurrency<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sk1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topicConsumerConcurrency<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sk2"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 第一个参数是StreamingContext         * 第二个参数是ZooKeeper集群信息         （接受Kafka数据的时候会从Zookeeper中获得Offset等元数据信息）         * 第三个参数是Consumer Group 消费者组         * 第四个参数是消费的Topic以及并发读取Topic中Partition的线程数         *         * 注意：         * KafkaUtils.createStream 使用五个参数的方法，设置receiver的存储级别         */</span><span class="token comment" spellcheck="true">//        JavaPairReceiverInputDStream&lt;String,String> lines = KafkaUtils.createStream(</span><span class="token comment" spellcheck="true">//                jsc,</span><span class="token comment" spellcheck="true">//                "node3:2181,node4:2181,node5:2181",</span><span class="token comment" spellcheck="true">//                "MyFirstConsumerGroup", </span><span class="token comment" spellcheck="true">//                topicConsumerConcurrency,</span><span class="token comment" spellcheck="true">//                StorageLevel.MEMORY_AND_DISK());</span>        JavaPairReceiverInputDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> lines <span class="token operator">=</span>            KafkaUtils<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span>                jsc<span class="token punctuation">,</span>                <span class="token string">"node01:2181,node02:2181,node03:2181"</span><span class="token punctuation">,</span>                <span class="token string">"MyFirstConsumerGroup"</span><span class="token punctuation">,</span>                topicConsumerConcurrency<span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> words <span class="token operator">=</span>               lines<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>              <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>      <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> tuple<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span>_2<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> pairs <span class="token operator">=</span>             words<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String word<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> wordsCount <span class="token operator">=</span>             pairs<span class="token punctuation">.</span><span class="token function">reduceByKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//对相同的Key，进行Value的累计（包括Local和Reducer级别同时Reduce）</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer v1<span class="token punctuation">,</span> Integer v2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        wordsCount<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="运行代码："><a href="#运行代码：" class="headerlink" title="运行代码："></a>运行代码：</h5><p>Linux端</p><ul><li>启动zookeeper：3台</li></ul><pre class="line-numbers language-shell"><code class="language-shell">zkServer.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>启动kafka：3台</li></ul><p>在kafka的解压路径下的/bin目录下</p><pre class="line-numbers language-shell"><code class="language-shell"> kafka-server-start.sh ../config/server.properties <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>终止kafka：</p><pre><code> kafka-server-stop.sh</code></pre><h3 id="（2）Driect-模式"><a href="#（2）Driect-模式" class="headerlink" title="（2）Driect 模式"></a>（2）Driect 模式</h3><h4 id="Driect-模式原理图"><a href="#Driect-模式原理图" class="headerlink" title="Driect 模式原理图"></a>Driect 模式原理图</h4><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0hviwdqgkj30my0ba3z2.jpg"></p><h4 id="Direct-模式理解："><a href="#Direct-模式理解：" class="headerlink" title="Direct 模式理解："></a>Direct 模式理解：</h4><blockquote><p>SparkStreaming+kafka 的 Driect 模式就是将 kafka 看成存数据的一方，不是被动接收数据，而是主动去取数据。拉取数据后先进行计算，成功后再更新偏移量</p><p>消费者偏移量也不是用 zookeeper 来管理，而是 SparkStreaming 内部对消费者偏移量自动来维护，默认消费偏移量是在内存中，当然如果设置了checkpoint 目录，那么消费偏移量也会保存在 checkpoint 中。当然也可以实现用 zookeeper 来管理</p></blockquote><h4 id="Direct-模式并行度设置："><a href="#Direct-模式并行度设置：" class="headerlink" title="Direct 模式并行度设置："></a>Direct 模式并行度设置：</h4><blockquote><p>Direct 模式的并行度是由读取的 kafka 中 topic 的 partition 数决定的。</p><p>可以在sparksteaming中使用算子改变分区数，如reartition</p></blockquote><h4 id="Direct-模式代码："><a href="#Direct-模式代码：" class="headerlink" title="Direct 模式代码："></a>Direct 模式代码：</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>Durations<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairDStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaStreamingContextFactory<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span>DStream<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * *  Spark standalone or Mesos with cluster deploy mode only: *  在提交application的时候  添加 --supervise 选项  如果Driver挂掉 会自动启动一个Driver * */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SparkStreamingOnHDFS</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[2]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"SparkStreamingOnHDFS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        final String checkpointDirectory = "hdfs://shsxt/spark/SparkStreaming/CheckPoint2017";</span>        <span class="token keyword">final</span> String checkpointDirectory <span class="token operator">=</span> <span class="token string">"./checkpoint"</span><span class="token punctuation">;</span>        JavaStreamingContextFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContextFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> JavaStreamingContext <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                  <span class="token keyword">return</span> <span class="token function">createContext</span><span class="token punctuation">(</span>checkpointDirectory<span class="token punctuation">,</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>        JavaStreamingContext jsc <span class="token operator">=</span>             JavaStreamingContext<span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span>checkpointDirectory<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> JavaStreamingContext         <span class="token function">createContext</span><span class="token punctuation">(</span>String checkpointDirectory<span class="token punctuation">,</span>SparkConf conf<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// If you do not see this printed, that means the StreamingContext has</span>        <span class="token comment" spellcheck="true">// been loaded</span>        <span class="token comment" spellcheck="true">// from the new checkpoint</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Creating new context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SparkConf sparkConf <span class="token operator">=</span> conf<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Create the context with a 1 second batch size</span>        JavaStreamingContext ssc <span class="token operator">=</span>             <span class="token keyword">new</span> <span class="token class-name">JavaStreamingContext</span><span class="token punctuation">(</span>sparkConf<span class="token punctuation">,</span> Durations<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        ssc.sparkContext().setLogLevel("WARN");</span>        <span class="token comment" spellcheck="true">/**         *  checkpoint 保存：         *        1.配置信息         *        2.DStream操作逻辑         *        3.job的执行进度         *      4.offset         */</span>        ssc<span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span>checkpointDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/**         * 监控的是HDFS上的一个目录，监控文件数量的变化     文件内容如果追加监控不到。         * 只监控文件夹下新增的文件，减少的文件时监控不到的，文件的内容有改动也监控不到。         */</span><span class="token comment" spellcheck="true">//        JavaDStream&lt;String> lines = ssc.textFileStream("hdfs://node1:9000/spark/sparkstreaming");</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> lines <span class="token operator">=</span> ssc<span class="token punctuation">.</span><span class="token function">textFileStream</span><span class="token punctuation">(</span><span class="token string">"./dataTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaDStream<span class="token operator">&lt;</span>String<span class="token operator">></span> words <span class="token operator">=</span>             lines<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> ones <span class="token operator">=</span>             words<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairDStream<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> counts <span class="token operator">=</span>            ones<span class="token punctuation">.</span><span class="token function">reduceByKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer i1<span class="token punctuation">,</span> Integer i2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> i1 <span class="token operator">+</span> i2<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        counts.print();</span>        DStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> dstream <span class="token operator">=</span> counts<span class="token punctuation">.</span><span class="token function">dstream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dstream<span class="token punctuation">.</span><span class="token function">saveAsTextFiles</span><span class="token punctuation">(</span><span class="token string">"./data/write/xxxxx"</span><span class="token punctuation">,</span><span class="token string">"yyyyyy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ssc<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7、相关配置"><a href="#7、相关配置" class="headerlink" title="7、相关配置"></a>7、相关配置</h2><p>预写日志:（receive模式中）</p><pre><code>spark.streaming.receiver.writeAheadLog.enable 默认 false 没有开启</code></pre><p>blockInterval:（receive模式中）</p><pre><code>spark.streaming.blockInterval 默认 200ms</code></pre><p>反压机制: （设置自动调整每一批次的数据量的理想范围，但调整的比较慢）</p><pre><code>spark.streaming.backpressure.enabled 默认 false</code></pre><p>每一批次接收数据速率:（receive模式中）</p><pre><code>spark.streaming.receiver.maxRate 默认没有设置</code></pre><p>每一分区接收数据速率 :（  direct模式）</p><pre><code>spark.streaming.kafka.maxRatePerpartition   默认没有设置</code></pre><h2 id="8、如何优雅的关闭Spark-Streaming作业"><a href="#8、如何优雅的关闭Spark-Streaming作业" class="headerlink" title="8、如何优雅的关闭Spark Streaming作业"></a>8、如何优雅的关闭Spark Streaming作业</h2><pre><code>spark.streaming.stopGracefullyOnShutdown  设置成true</code></pre><p>执行命令：</p><pre class="line-numbers language-shell"><code class="language-shell">kill -15/sigterm driverpid<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">SparkStreaming 是流式处理框架，是 Spark API 的扩展，支持可扩展、高吞吐量、容错的实时数据流处理</summary>
    
    
    
    <category term="Spark" scheme="https://sukie-sun.github.io/categories/Spark/"/>
    
    
    <category term="Spark框架" scheme="https://sukie-sun.github.io/tags/Spark%E6%A1%86%E6%9E%B6/"/>
    
    <category term="SparkStreaming" scheme="https://sukie-sun.github.io/tags/SparkStreaming/"/>
    
    <category term="流式处理框架" scheme="https://sukie-sun.github.io/tags/%E6%B5%81%E5%BC%8F%E5%A4%84%E7%90%86%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>Spark学习（五）</title>
    <link href="https://sukie-sun.github.io/2019/02/21/Spark(5)/"/>
    <id>https://sukie-sun.github.io/2019/02/21/Spark(5)/</id>
    <published>2019-02-20T16:00:00.000Z</published>
    <updated>2020-08-08T10:49:31.755Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、Spark"><a href="#一、Spark" class="headerlink" title="一、Spark"></a>一、Spark</h1><h2 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h2><p>基于 Spark 计算框架之上且兼容 Hive 语法的 SQL 执行引擎，</p><h2 id="2、特点"><a href="#2、特点" class="headerlink" title="2、特点"></a>2、特点</h2><ul><li>基于 Spark 的特性</li></ul><p>由于底层的计算采用了 Spark，性能比 MapReduce 的 Hive 普遍快 2 倍以上，当数据全部 load 在内存的话，将快 10 倍以上，因此 Shark 可以作为交互式查询应用服务来使用。</p><ul><li>基于 Hive的特性</li></ul><p>Shark 是完全兼容 Hive的语法，表结构以及UDF函数等，已有的HiveSql可以直接进行迁移至Shark上。 Shark 底层依赖于 Hive 的解析器，查询优化器。</p><ul><li>缺点</li></ul><p>由于 Shark 的整体设计架构对 Hive 的依赖性太强，难以支持其长远发展，比如不能和 Spark的其他组件进行很好的集成，无法满足 Spark 的一栈式解决大数据处理的需求。</p><h1 id="二、SparkSql"><a href="#二、SparkSql" class="headerlink" title="二、SparkSql"></a>二、SparkSql</h1><h2 id="1、SparkSQL介绍"><a href="#1、SparkSQL介绍" class="headerlink" title="1、SparkSQL介绍"></a>1、SparkSQL介绍</h2><p>Hive 是 Shark 的前身，Shark 是 SparkSQL 的前身</p><p>SparkSQL 特点</p><ul><li><p>其完全脱离了 Hive 的限制。</p></li><li><p>SparkSQL支持查询原生的RDD。</p><p>RDD是Spark平台的核心概念，是 Spark 能够高效的处理大数据的各种场景的基础。</p></li><li><p>能够在 Scala 中写 SQL 语句。</p></li></ul><p>支持简单的 SQL 语法检查，能够在Scala中写Hive语句访问Hive数据，并将结果取回作为RDD使用。</p><h2 id="2、Spark-on-Hive-和-Hive-on-Spark"><a href="#2、Spark-on-Hive-和-Hive-on-Spark" class="headerlink" title="2、Spark on Hive 和 Hive on Spark"></a>2、Spark on Hive 和 Hive on Spark</h2><p>**<code>Spark on Hive</code>**：</p><p> Hive 只作为储存角色，Spark 负责 sql 解析优化，执行。</p><p>数据源在hive上，解析引擎是sparksql，执行任务是spark</p><p>**<code>Hive on Spark</code>**：</p><p>Hive 即作为存储又负责 sql 的解析优化，Spark 负责执行。</p><p>数据源在hive上，解析引擎是hive，执行任务是spark</p><h2 id="3、DataFrame"><a href="#3、DataFrame" class="headerlink" title="3、DataFrame"></a>3、DataFrame</h2><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0e3717grfj30dq07amzi.jpg"></p><ul><li><p>分布式数据容器</p></li><li><p>DataFrame 的底层封装的是 RDD，只不过 RDD 的泛型是 Row 类型。</p></li><li><p>相当于RDD+schema  （数据+数据的结构信息）</p></li><li><p>与 Hive 类似，DataFrame 也支持嵌套数据类型（struct、array 和 map）</p></li><li><p>从 API 易用性的角度上 看， DataFrame API提供的是一套高层的关系操作，比函数式的 RDD API 要更加友好，门槛更低。</p></li></ul><h2 id="4、SparkSql-的数据源"><a href="#4、SparkSql-的数据源" class="headerlink" title="4、SparkSql 的数据源"></a>4、SparkSql 的数据源</h2><p> JSON 类型的字符串，JDBC、Parquent、Hive，HBASE、HDFS </p><h2 id="5、SparkSql底层架构"><a href="#5、SparkSql底层架构" class="headerlink" title="5、SparkSql底层架构"></a>5、SparkSql底层架构</h2><p>sql——&gt;逻辑计划——&gt;优化逻辑计划——&gt;物理计划——&gt;RDD（Spark任务）</p><h2 id="6、谓词下推"><a href="#6、谓词下推" class="headerlink" title="6、谓词下推"></a>6、谓词下推</h2><p><code>sql</code>:</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> table1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>table2<span class="token punctuation">.</span>score <span class="token keyword">from</span> table1 <span class="token keyword">join</span> table2 <span class="token keyword">on</span> table1<span class="token punctuation">.</span>id<span class="token operator">=</span>table2<span class="token punctuation">.</span>id <span class="token keyword">where</span> table1<span class="token punctuation">.</span>age <span class="token operator">></span> <span class="token number">50</span> <span class="token operator">and</span> table2<span class="token punctuation">.</span>score <span class="token operator">></span> <span class="token number">90</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>执行顺序</code> </p><p> join:t1,t2<br>过滤：where : t1.age&gt;50,t2.score&gt;90<br>列裁剪：from:  select:</p><p><strong><code>谓词下推</code></strong><br>先各自过滤：where<br>然后列裁剪：t1:name,id  ;  t2:score,id<br>join</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0e98ac1j9j30df09vt9h.jpg" alt="谓词下推"></p><h1 id="三、创建DataFrame的几种方式"><a href="#三、创建DataFrame的几种方式" class="headerlink" title="三、创建DataFrame的几种方式"></a>三、创建DataFrame的几种方式</h1><h2 id="1、读取Json格式文件创建DataFrame"><a href="#1、读取Json格式文件创建DataFrame" class="headerlink" title="1、读取Json格式文件创建DataFrame"></a>1、读取Json格式文件创建DataFrame</h2><p><code>注意：</code></p><blockquote><p>1、json文件中不能嵌套json格式的内容</p><p>2、读取json文件格式的两种方式：</p><p>3、dataFrame.show( )默认显示前20行数据，使用dataFrame.show(行数）可显示指定行数的数据</p><p>4、将DataFrame转换成RDD：</p><p>​          Java: df.javaRDD( )  </p><p>​         Scala: df.rdd</p><p>5、显示DataFrame的Schema信息（树形的形式）：df.printSchema(  )</p><p>6、dataFrame自带API操作dataFrame ,不常用</p><p>7、使用sql查询：</p><p>​         a，将DataFrame注册临时表： df.registerTemptable(“mytable”)   </p><p>​         b，使用sql： sqlContext.sql(“sql语句”)</p><p>8、df中的数据加载过之后，显示时，会默认将列按ASCII码进行排序</p></blockquote><p><code>Java：</code></p><pre class="line-numbers language-java"><code class="language-java">SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"jsonfile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>SparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建SQLContext（实现了序列化）</span>SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//文件格式：&amp;#123;"name":"zhangsan","age": 18&amp;#125;</span><span class="token comment" spellcheck="true">//读取json文件的两种方式,得到DataFrame（底层是RDD）</span>DataFrame df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"./data/jsonfile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//DataFrame df = sqlContext.read().json("./data/jsonfile");</span><span class="token comment" spellcheck="true">//显示df中的内容的两种情况（以二维表显示，空值用null代替，列自动按ASCII码排序）</span>df<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>df<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//df转换成RDD</span><span class="token comment" spellcheck="true">//RDD&lt;ROW> rdd = df.rdd()</span>JavaRDD<span class="token operator">&lt;</span>Row<span class="token operator">></span> javaRDD <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token function">javaRDD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//显示数据结构信息</span>df<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//自带操作DataFrame的API</span><span class="token comment" spellcheck="true">//select name from table</span>df<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//select name ,age+10 as addage from table</span>df<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>df<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">"addage"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//select name ,age from table where age>19</span>df<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>df<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//select age,count(*) from table group by age</span>df<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用SQL查询</span><span class="token comment" spellcheck="true">//将DataFrame注册成临时的一张表，这张表相当于临时注册到内存中，是逻辑上的表，不会雾化到磁盘</span>df<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DataFrame sqlDF <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"sekect * from table where name like 'zhang&amp;'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sqlDF<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Scala:</code></p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span><span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQlContext<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//读取json文件</span><span class="token keyword">val</span> df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token string">"./data/jsonfile"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//val df = sqlContext.read.format("json").load("./data/jsonfile)</span><span class="token comment" spellcheck="true">//将df转化成RDD</span><span class="token comment" spellcheck="true">//val rdd = df.rdd</span>df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>de<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//select * from table</span>df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>df<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//select name from table where age>19</span>df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>df<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>df<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>df<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>gt<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//select count(*) from table group by age</span>df<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>df<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用sql </span><span class="token comment" spellcheck="true">//注册临时表</span>df<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span><span class="token keyword">val</span> result <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select * from table"</span><span class="token punctuation">)</span>result<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、通过Json格式的RDD创建DataFrame"><a href="#2、通过Json格式的RDD创建DataFrame" class="headerlink" title="2、通过Json格式的RDD创建DataFrame"></a>2、通过Json格式的RDD创建DataFrame</h2><p><strong><code>Java</code></strong></p><pre class="line-numbers language-java"><code class="language-java">SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"jsonRdd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>JavaSparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//创建RDD</span>JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> nameRDD <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"&amp;#123;'name','zs','age','18'&amp;#125;"</span><span class="token punctuation">,</span><span class="token string">"&amp;#123;\"name\",\"ls\",\"age\",\"21\"&amp;#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> scoreRDD <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"&amp;#123;'name':'zs','score':'90'&amp;#125;"</span><span class="token punctuation">,</span><span class="token string">"&amp;#123;\"name\":\"ls\",\"score\":\"88\"&amp;#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将jsonRDD转换成DataFrame</span>DataFrame namedf <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>nameRDD<span class="token punctuation">)</span><span class="token punctuation">;</span>DataFrame scoredf <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>scoreRDD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//为df注册临时表</span>namedf<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"nameTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>scoredf<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"scoreTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用sql查询</span>DataFrame df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select nameTable.name,nameTable.age,"</span><span class="token operator">+</span>                             <span class="token string">"scoretable.score from nameTable join scoreTabel"</span><span class="token operator">+</span>                              <span class="token string">"on nameTable.name = scoreTable.name "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>df<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>Scala</code></strong></p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"jsonRdd"</span><span class="token punctuation">)</span><span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQLContext<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//创建RDD</span><span class="token keyword">val</span> nameRDD <span class="token operator">=</span> context<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span> <span class="token string">"&amp;#123;'name','zs','age','18'&amp;#125;"</span><span class="token punctuation">,</span><span class="token string">"&amp;#123;\"name\",\"ls\",\"age\",\"21\"&amp;#125;"</span><span class="token punctuation">)</span><span class="token keyword">val</span> scoreRDD <span class="token operator">=</span> context<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>                                                     <span class="token string">"&amp;#123;'name':'zs','score':'90'&amp;#125;"</span><span class="token punctuation">,</span><span class="token string">"&amp;#123;\"name\":\"ls\",\"score\":\"88\"&amp;#125;"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//获取dataFrame</span><span class="token keyword">val</span> namedf <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>json<span class="token punctuation">(</span>nameRDD<span class="token punctuation">)</span><span class="token keyword">val</span> scoredf <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>json<span class="token punctuation">(</span>scoreRDD<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//为DataFrame指定临时表</span>namedf<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"nameTable"</span><span class="token punctuation">)</span>scoredf<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"scoreTable"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//使用sql</span><span class="token keyword">val</span> df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select nameTable.name,nameTable.age,"</span><span class="token operator">+</span>                         <span class="token string">"scoretable.score from nameTable join scoreTabel"</span><span class="token operator">+</span>                         <span class="token string">"on nameTable.name = scoreTable.name "</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、非Json格式的文件创建DataFrame"><a href="#3、非Json格式的文件创建DataFrame" class="headerlink" title="3、非Json格式的文件创建DataFrame"></a>3、非Json格式的文件创建DataFrame</h2><h3 id="1）通过反射的方式将非json格式的RDD转换成DataFrame（不推荐）"><a href="#1）通过反射的方式将非json格式的RDD转换成DataFrame（不推荐）" class="headerlink" title="1）通过反射的方式将非json格式的RDD转换成DataFrame（不推荐）"></a>1）通过反射的方式将非json格式的RDD转换成DataFrame（不推荐）</h3><ul><li>自定义类要实现序列化</li><li>自定义类的访问级别是public</li><li>RDD转换成DataFrame后会根据映射按ASCII码排序</li><li>将DataFrame转换成RDD时，获取字段的范式有两种：<ul><li>1）row.getInt(0）；df.getString(1) 通过下标获取，返回Row类型的数据，注意列顺序问题（不推荐）</li><li>2）row.getAs(“列名”)  通过列名获取对应列值（推荐）</li></ul></li></ul><p><strong><code>Java</code></strong>:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>dataframe<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>    <span class="token keyword">private</span> String id <span class="token punctuation">;</span>    <span class="token keyword">private</span>  String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>        <span class="token keyword">public</span> String <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> Integer <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> age<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span>Integer age<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"Person [id="</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">", name="</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java">SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"RDD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>JavaSparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取RDD（文件格式：1,zhangsan,18）</span>JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> lineRDD <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"./data/person"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//反射</span>JavaRDD<span class="token operator">&lt;</span>Person<span class="token operator">></span> personRDD <span class="token operator">=</span>     lineRDD<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Funcation</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Person<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> Person <span class="token function">call</span><span class="token punctuation">(</span>String str<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Person person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            person<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> person<span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*传入Person.class后，sqlContext就通过反射的方式创建DataFrame因为在底层通过反射的方式可以获得Person类的所有field，再结合RDD，即可创建DataFrame*/</span><span class="token comment" spellcheck="true">//将RDD转换成DataFram</span>DataFrame df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token punctuation">(</span>personRDD<span class="token punctuation">,</span>Person<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>df<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>df<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DataFrame sqldf <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select * from table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sqldf<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//将DataFrame转换成RDD（两种方式）</span><span class="token comment" spellcheck="true">//因为排序的原因：df中列的顺序变为：age ， id ， name</span>JavaRDD<span class="token operator">&lt;</span>Row<span class="token operator">></span> javaRDD <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token function">javaRDD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>JavaRDD<span class="token operator">&lt;</span>Person<span class="token operator">></span> map <span class="token operator">=</span>     javaRDD<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>Row<span class="token punctuation">,</span>Person<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Person <span class="token function">call</span><span class="token punctuation">(</span>Row row<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Person p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        p.setId(row.getString(1));</span><span class="token comment" spellcheck="true">//        p.setName(row.getString(2));</span><span class="token comment" spellcheck="true">//        p.setAge(row.getInt(0));</span>        p<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>row<span class="token punctuation">.</span><span class="token function">getAs</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>row<span class="token punctuation">.</span><span class="token function">getAs</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>row<span class="token punctuation">.</span><span class="token function">getAs</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> p<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>map<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Person<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>Scala</code></strong></p><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span> conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"rddreflect"</span><span class="token punctuation">)</span> <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span> <span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQLContext<span class="token punctuation">(</span>sc<span class="token punctuation">)</span> <span class="token keyword">val</span> lineRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./data/person"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//文件格式：1,zhangsan,18</span><span class="token comment" spellcheck="true">//将RDD转换成DataFrame</span><span class="token keyword">val</span> personRDD <span class="token operator">=</span> linRDD<span class="token punctuation">.</span>map<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">val</span> person <span class="token operator">=</span> Person<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Intger<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> person<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将personRDD转化成DataFrame                     </span><span class="token keyword">val</span> df <span class="token operator">=</span> personRDD<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token punctuation">)</span> df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//将DataFrame转换成RDD</span><span class="token keyword">val</span> rdd <span class="token operator">=</span> df<span class="token punctuation">.</span>rdd<span class="token keyword">val</span> personRDD <span class="token operator">=</span> rdd<span class="token punctuation">.</span>map<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>   Person<span class="token punctuation">(</span>x<span class="token punctuation">.</span>getAs<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>getAs<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>getAs<span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> personRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>context<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2）动态创建Schema，将非json格式RDD转成DataFrame"><a href="#2）动态创建Schema，将非json格式RDD转成DataFrame" class="headerlink" title="2）动态创建Schema，将非json格式RDD转成DataFrame"></a>2）动态创建Schema，将非json格式RDD转成DataFrame</h3><p><strong><code>Java</code></strong></p><pre class="line-numbers language-java"><code class="language-java">SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"rddStruct"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> lineRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"./data/person"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//文件格式：1,zhangsan,18</span><span class="token comment" spellcheck="true">//将RDD转换成DataFrame</span><span class="token comment" spellcheck="true">//将RDD转成Row类型的RDD</span><span class="token keyword">final</span> JavaRDD<span class="token operator">&lt;</span>Row<span class="token operator">></span> rowRDD <span class="token operator">=</span>    lineRDD<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Row<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> Row <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>             val row <span class="token operator">=</span> RowFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>             s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>             s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> row<span class="token punctuation">;</span>       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//动态创建DataFrame的的元数据（Schema），字段的来源：字符串或外部数据库</span>List<span class="token operator">&lt;</span>StructField<span class="token operator">></span> asList <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>    DataTypes<span class="token punctuation">.</span><span class="token function">createStructField</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    DataTypes<span class="token punctuation">.</span><span class="token function">createStructField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>，    DataTypes<span class="token punctuation">.</span>createStructField（<span class="token string">"age"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>IntegerType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>StructType schema <span class="token operator">=</span> DataTypes<span class="token punctuation">.</span><span class="token function">createStructType</span><span class="token punctuation">(</span>asList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取DataFrame</span>DataFrame df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">createDataFrame</span><span class="token punctuation">(</span>rowRDD<span class="token punctuation">,</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>df<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>df<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将dataframe转换成RDD</span><span class="token comment" spellcheck="true">//JavaRDD&lt;Row> javaRDD = df.javaRDD();</span><span class="token comment" spellcheck="true">//    javaRDD.foreach(new VoidFunction&lt;Row>() &amp;#123;</span><span class="token comment" spellcheck="true">//            private static final long serialVersionUID = 1L;</span><span class="token comment" spellcheck="true">//            @Override</span><span class="token comment" spellcheck="true">//            public void call(Row row) throws Exception &amp;#123;</span><span class="token comment" spellcheck="true">//                System.out.println(row.getString(0));</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//                System.out.println(row);</span><span class="token comment" spellcheck="true">//            &amp;#125;</span><span class="token comment" spellcheck="true">//        &amp;#125;);</span>context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>Scala</code></strong></p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"rddStruct"</span><span class="token punctuation">)</span><span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQLContext<span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token keyword">val</span> lineRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./data/person"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//文件格式：1,zhangsan,18</span><span class="token comment" spellcheck="true">//将RDD转换成RowRDD</span><span class="token keyword">val</span> rowRDD <span class="token operator">=</span> lineRDD<span class="token punctuation">.</span>map<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> split <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>    RowFactory<span class="token punctuation">.</span>create<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>split<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Integer<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取schema</span><span class="token keyword">val</span> schema <span class="token operator">=</span> StructType<span class="token punctuation">(</span>List<span class="token punctuation">(</span>StructField<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span>StringType，<span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>StructField<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>StringType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>StructField<span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span>IntegerType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">val</span> df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>rowRDD<span class="token punctuation">,</span>shema<span class="token punctuation">)</span>df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>                      context<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4、读取parquet文件创建DataFrame"><a href="#4、读取parquet文件创建DataFrame" class="headerlink" title="4、读取parquet文件创建DataFrame"></a>4、读取parquet文件创建DataFrame</h2><p><strong><code>注意：</code></strong></p><ul><li><p>可以将 DataFrame 存储成 parquet 文件。保存成 parquet 文件的方式有两种</p></li><li><pre><code>df.write().mode(SaveMode.Overwrite)format(&quot;parquet&quot;).save(&quot;./sparksql/parquet&quot;);df.write().mode(SaveMode.Overwrite).parquet(&quot;./sparksql/parquet&quot;);</code></pre></li><li><p>SaveMode 指定文件保存时的模式。</p></li><li><blockquote><p>Overwrite：覆盖<br>Append：追加<br>ErrorIfExists：如果存在就报错<br>Ignore：如果存在就忽略</p></blockquote></li></ul><p><strong><code>Java</code></strong></p><pre class="line-numbers language-java"><code class="language-java">SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"parquet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> jsonRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"./data/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//读取json格式的文件</span>DataFrame df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>jsonRDD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//sqlContext.read().format("json").load("./spark/json");</span>df<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/** * 将DataFrame保存成parquet文件， * SaveMode指定存储文件时的保存模式: *  Overwrite：覆盖 *     Append:追加 *  ErrorIfExists:如果存在就报错 *     Ignore:如果存在就忽略 */</span><span class="token comment" spellcheck="true">// 保存成parquet文件有以下两种方式：</span>df<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parquet</span><span class="token punctuation">(</span><span class="token string">"./sparksql/parquet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//df.write().mode(SaveMode.Overwrite).format("parquet").save("data/parquet");</span> <span class="token comment" spellcheck="true">/**  * 加载parquet文件成DataFrame      * 加载parquet文件有以下两种方式：      */</span>  load <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parquet</span><span class="token punctuation">(</span><span class="token string">"data/parquet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//     DataFrame load = sqlContext.read().format("parquet").load("data/parquet");</span>load<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>Scala</code></strong></p><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"parquet"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>    <span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQLContext<span class="token punctuation">(</span>sc<span class="token punctuation">)</span>    <span class="token keyword">val</span> jsonRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"data/json"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>json<span class="token punctuation">(</span>jsonRDD<span class="token punctuation">)</span>    df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/**      * 将DF保存为parquet文件      */</span>    df<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"parquet"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"data/parquet"</span><span class="token punctuation">)</span>    df<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span><span class="token punctuation">.</span>parquet<span class="token punctuation">(</span><span class="token string">"data/parquet"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/**     * 读取parquet文件     */</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>parquet<span class="token punctuation">(</span><span class="token string">"data/parquet"</span><span class="token punctuation">)</span>    result <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"parquet"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"data/parquet"</span><span class="token punctuation">)</span>    result<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5、读取JDBC中的数据创建DataFrame（MySQL为例）"><a href="#5、读取JDBC中的数据创建DataFrame（MySQL为例）" class="headerlink" title="5、读取JDBC中的数据创建DataFrame（MySQL为例）"></a>5、读取JDBC中的数据创建DataFrame（MySQL为例）</h2><p>两种方式创建 DataFrame</p><p><strong><code>Java</code></strong></p><pre class="line-numbers language-java"><code class="language-java">        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         *     配置join或者聚合操作shuffle数据时分区的数量         */</span>        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"spark.sql.shuffle.partitions"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 第一种方式读取MySql数据库表，加载为DataFrame         */</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://127.0.0.1:3306/spark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span> <span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dbtable"</span><span class="token punctuation">,</span> <span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataFrame person <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"jdbc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        person<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        person<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 第二种方式读取MySql数据表加载为DataFrame         */</span>        DataFrameReader reader <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"jdbc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        reader<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://127.0.0.1:3306/spark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        reader<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span> <span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        reader<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        reader<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        reader<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"dbtable"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataFrame score <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        score<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        score<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataFrame result <span class="token operator">=</span>               sqlContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select person.id,person.name,person.age,score.score "</span>                        <span class="token operator">+</span> <span class="token string">"from person,score "</span>                        <span class="token operator">+</span> <span class="token string">"where person.name = score.name  and score.score> 90"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DataFrame df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select id,name,age,score from result where ag>18"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        df<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 将DataFrame结果保存到Mysql中         */</span>        Properties properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * SaveMode:         * Overwrite：覆盖         * Append:追加         * ErrorIfExists:如果存在就报错         * Ignore:如果存在就忽略         *         */</span>        result<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Append<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">jdbc</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://127.0.0.1:3306/spark"</span><span class="token punctuation">,</span> <span class="token string">"result2"</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----Finish----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>Scala</code></strong></p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>        <span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQLContext<span class="token punctuation">(</span>sc<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">/**         * 第一种方式读取Mysql数据库表创建DF         */</span>        <span class="token keyword">val</span> options <span class="token operator">=</span> <span class="token keyword">new</span> HashMap<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        options<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://192.168.100.111:3306/spark"</span><span class="token punctuation">)</span>        options<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span>        options<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"root"</span><span class="token punctuation">)</span>        options<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"1234"</span><span class="token punctuation">)</span>        options<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"dbtable"</span><span class="token punctuation">,</span><span class="token string">"person"</span><span class="token punctuation">)</span>        <span class="token keyword">val</span> person <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"jdbc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>        person<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>        person<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"person"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">/**         * 第二种方式读取Mysql数据库表创建DF         */</span>        <span class="token keyword">val</span> reader <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>read<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"jdbc"</span><span class="token punctuation">)</span>        reader<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://192.168.100.111:3306/spark"</span><span class="token punctuation">)</span>        reader<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span>        reader<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"root"</span><span class="token punctuation">)</span>        reader<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span><span class="token string">"1234"</span><span class="token punctuation">)</span>        reader<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"dbtable"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">)</span>        <span class="token keyword">val</span> score <span class="token operator">=</span> reader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>        score<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>        score<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span>        <span class="token keyword">val</span> result <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select person.id,person.name,score.score from                                        person,score where person.name = score.name"</span><span class="token punctuation">)</span>        result<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">/**         * 将数据写入到Mysql表中         */</span>        <span class="token keyword">val</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>        properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span>        properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"1234"</span><span class="token punctuation">)</span>        result<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Append<span class="token punctuation">)</span><span class="token punctuation">.</span>               jdbc<span class="token punctuation">(</span><span class="token string">"jdbc:mysql://192.168.100.111:3306/spark"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span>                sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6、读取Hive中的数据加载成DataFrame"><a href="#6、读取Hive中的数据加载成DataFrame" class="headerlink" title="6、读取Hive中的数据加载成DataFrame"></a>6、读取Hive中的数据加载成DataFrame</h2><ul><li><blockquote><p> HiveContext 是 SQLContext 的子类，连接 Hive 建议使用HiveContext</p></blockquote></li><li><blockquote><p>由于本地没有 Hive 环境，要提交到集群运行，提交命令：</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master spark://node00:7077,node01:7077--executor-cores 1--executor-memory 1G--total-executor-cores 1--class com.bd.sparksql.dataframe.CreateDFFromHive/usr/soft/spark-test.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote></li></ul><h3 id="代码详情"><a href="#代码详情" class="headerlink" title="代码详情"></a>代码详情</h3><h4 id="Java"><a href="#Java" class="headerlink" title="Java"></a><code>Java</code></h4><pre class="line-numbers language-java"><code class="language-java">SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"hive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//HiveContext是SQLContext的子类。（2.0之后就将两个类就合成一个类了）</span>HiveContext hiveContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiveContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//用于操作Hive上的数据</span><span class="token comment" spellcheck="true">//创建实例库</span>hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"CREATE database spark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//切换实例库</span>hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"USE spark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除已存在的表</span>hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"DROP TABLE IF EXISTS student_infos"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//在hive中创建student_infos表</span>hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE IF NOT EXISTS student_infos (name STRING,age INT) row format delimited fields terminated by '\t' "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//从本地加载数据到表中</span>hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"load data local inpath '/root/student_infos' into table student_infos"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"DROP TABLE IF EXISTS student_scores"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE IF NOT EXISTS student_scores (name STRING, score INT) row format delimited fields terminated by '\t'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"LOAD DATA "</span>                <span class="token operator">+</span> <span class="token string">"LOCAL INPATH '/root/student_scores'"</span>                <span class="token operator">+</span> <span class="token string">"INTO TABLE student_scores"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 查询表生成DataFrame         */</span><span class="token comment" spellcheck="true">//        DataFrame df = hiveContext.table("student_infos");//第二种读取Hive表加载DF方式</span>DataFrame goodStudentsDF <span class="token operator">=</span> hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"SELECT si.name, si.age, ss.score "</span>                <span class="token operator">+</span> <span class="token string">"FROM student_infos si "</span>                <span class="token operator">+</span> <span class="token string">"JOIN student_scores ss "</span>                <span class="token operator">+</span> <span class="token string">"ON si.name=ss.name "</span>                <span class="token operator">+</span> <span class="token string">"WHERE ss.score>=80"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将df注册成临时表，才能使用sql</span>        goodStudentsDF<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"goodstudent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataFrame result <span class="token operator">=</span> hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select * from goodstudent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 将结果保存到hive表 good_student_infos         */</span>        hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"DROP TABLE IF EXISTS good_student_infos"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodStudentsDF<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">saveAsTable</span><span class="token punctuation">(</span><span class="token string">"good_student_infos"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataFrame table <span class="token operator">=</span> hiveContext<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">"good_student_infos"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Row<span class="token punctuation">[</span><span class="token punctuation">]</span> goodStudentRows <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Row goodStudentRow <span class="token operator">:</span> goodStudentRows<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>go odStudentRow<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        sc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Scala"><a href="#Scala" class="headerlink" title="Scala"></a><code>Scala</code></h4><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"HiveSource"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/**     * HiveContext是SQLContext的子类。     */</span>    <span class="token keyword">val</span> hiveContext <span class="token operator">=</span> <span class="token keyword">new</span> HiveContext<span class="token punctuation">(</span>sc<span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"use spark"</span><span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"drop table if exists student_infos"</span><span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"create table if not exists student_infos (name string,age int) row format  delimited fields terminated by '\t'"</span><span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"load data local inpath '/root/test/student_infos' into table student_infos"</span><span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"drop table if exists student_scores"</span><span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"create table if not exists student_scores (name string,score int) row format delimited fields terminated by '\t'"</span><span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"load data local inpath '/root/test/student_scores' into table student_scores"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> df <span class="token operator">=</span> hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select si.name,si.age,ss.score from student_infos si,student_scores ss where si.name = ss.name"</span><span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"drop table if exists good_student_infos"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/**     * 将结果写入到hive表中     */</span>    df<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span><span class="token punctuation">.</span>saveAsTable<span class="token punctuation">(</span><span class="token string">"good_student_infos"</span><span class="token punctuation">)</span>    sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="关于序列化你要知道的！！"><a href="#关于序列化你要知道的！！" class="headerlink" title="关于序列化你要知道的！！"></a>关于序列化你要知道的！！</h1><h1 id="四、Spark-On-Hive-的配置"><a href="#四、Spark-On-Hive-的配置" class="headerlink" title="四、Spark On Hive 的配置"></a>四、Spark On Hive 的配置</h1><h2 id="Hive配置：-（在Linux端）"><a href="#Hive配置：-（在Linux端）" class="headerlink" title="**Hive配置：**（在Linux端）"></a>**<code>Hive配置：</code>**（在Linux端）</h2><h3 id="（1）在Spark客户端配置Spark-On-Hive"><a href="#（1）在Spark客户端配置Spark-On-Hive" class="headerlink" title="（1）在Spark客户端配置Spark  On  Hive"></a>（1）在Spark客户端配置Spark  On  Hive</h3><p>在Spark客户端安装包下spark-1.6.0/conf路径下创建hive-site.xml：</p><p>编辑内容：配置hive的metastore路径（即hive服务端的IP）</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>hive.metastore.uris<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>thrift://192.168.11.131:9083<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（2）启动-zookeeper-集群，启动-HDFS-集群。"><a href="#（2）启动-zookeeper-集群，启动-HDFS-集群。" class="headerlink" title="（2）启动 zookeeper 集群，启动 HDFS 集群。"></a>（2）启动 zookeeper 集群，启动 HDFS 集群。</h3><pre class="line-numbers language-shell"><code class="language-shell">zkServer.sh start  (3台)start-all.sh       (任一台)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>注意：</code></p><blockquote><p>由于我们这里是使用Spark作为计算框架 所以不需要启动yarn</p><p>启动yarn是在使用MapReduce作为计算框架时</p></blockquote><h3 id="（3）启动spark服务（在spark解压目录的-sbin路径下）"><a href="#（3）启动spark服务（在spark解压目录的-sbin路径下）" class="headerlink" title="（3）启动spark服务（在spark解压目录的/sbin路径下）"></a>（3）启动spark服务（在spark解压目录的/sbin路径下）</h3><pre class="line-numbers language-shell"><code class="language-shell">./start-all.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="（4）启动mysql服务"><a href="#（4）启动mysql服务" class="headerlink" title="（4）启动mysql服务"></a>（4）启动mysql服务</h3><p>(mysql  :node00     hive  ：服务端：node02    ； 客户端 ： node01)</p><ul><li>检查mysql服务是否启动：</li></ul><blockquote><p>命令：</p><pre><code>chkconfig</code></pre><p>显示：</p><blockquote><p>mysqld             0:off    1:off    2:off    3:off    4:off    5:off    6:off</p></blockquote><p>没有启动</p></blockquote><ul><li>启动mysql服务</li></ul><blockquote><p>命令：</p><pre><code>[root@node00 conf]# service mysqld startStarting mysqld:                                           [  OK  ]</code></pre></blockquote><ul><li>登录mysql</li></ul><blockquote><pre><code>[root@node00 conf]# mysql -u root -pEnter password: 123456mysql&gt; </code></pre></blockquote><h3 id="（5）启动-Hive服务端"><a href="#（5）启动-Hive服务端" class="headerlink" title="（5）启动 Hive服务端"></a>（5）启动 Hive服务端</h3><p>启动 Hive 的 metastore 服务</p><pre class="line-numbers language-shell"><code class="language-shell">#后台启动hive服务端hive --service metastore &#启动打印服务日志Start Hive MetaStore Server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（6）打开hive交互式页面-在任一台"><a href="#（6）打开hive交互式页面-在任一台" class="headerlink" title="（6）打开hive交互式页面(在任一台)"></a>（6）打开hive交互式页面(在任一台)</h3><pre><code>hive</code></pre><p>创建数据库spark</p><pre class="line-numbers language-sql"><code class="language-sql">hive<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> spark<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="（7）启动-SparkShell"><a href="#（7）启动-SparkShell" class="headerlink" title="（7）启动 SparkShell"></a>（7）启动 SparkShell</h3><p>读取 Hive 中的表总数，对比 hive 中查询同一表查询总数测试时间。</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-shell--master spark://node3:7077  ,node01:7077--executor-cores 1--executor-memory 1g--total-executor-cores 1import org.apache.spark.sql.hive.HiveContextval hc = new HiveContext(sc)hc.sql("show databases").showhc.sql("user spark").showhc.sql("select count(*) from spark.ods_cps_data").show./spark-shell--master spark://node3:7077  --executor-cores 1--executor-memory 1g--total-executor-cores 1import org.apache.spark.sql.hive.HiveContextval hc = new HiveContext(sc)hc.sql("show databases").showhc.sql("user spark").showhc.sql("select count(*) from spark.ods_cps_data").show<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>注意</code></strong></p><blockquote><p>如果使用 Spark on Hive 查询数据时，出现错误：</p><pre><code>Cause by: java.net.UknownHostException： XXX</code></pre><p>找不到 HDFS 集群路径，要在客户端机器 conf/spark-env.sh 中设置HDFS 的 路 径 ：</p><pre><code>HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop</code></pre></blockquote><h2 id="spark-On-hive：（在windows端）"><a href="#spark-On-hive：（在windows端）" class="headerlink" title="spark On hive：（在windows端）"></a><strong>spark On hive</strong>：（在windows端）</h2><h3 id="1、配置文件："><a href="#1、配置文件：" class="headerlink" title="1、配置文件："></a>1、<code>配置文件：</code></h3><p>在项目中新建文件夹conf（标记为资源文件）：</p><p>添加一下三个配置文件:（其中hive-site.xml文件用于连接hive 服务端， 其余两个文件用于连接hdfs）</p><ul><li><h4 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h4></li></ul><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token prolog">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?></span><span class="token comment" spellcheck="true">&lt;!--  Licensed under the Apache License, Version 2.0 (the "License");  you may not use this file except in compliance with the License.  You may obtain a copy of the License at    http://www.apache.org/licenses/LICENSE-2.0  Unless required by applicable law or agreed to in writing, software  distributed under the License is distributed on an "AS IS" BASIS,  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the License for the specific language governing permissions and  limitations under the License. See accompanying LICENSE file.--></span><span class="token comment" spellcheck="true">&lt;!-- Put site-specific property overrides in this file. --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.nameservices<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>Sukie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.ha.namenodes.Sukie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>nn1,nn2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.replication<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.namenode.rpc-address.Sukie.nn1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>node00:8020<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.namenode.rpc-address.Sukie.nn2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>node00:8020<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.namenode.http-address.Sukie.nn1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>node00:50070<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.namenode.http-address.Sukie.nn2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>node00:50070<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.data.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>/var/hadoop/dfs/data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.datanode.fsdataset.volume.choosing.policy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>org.apache.hadoop.hdfs.server.datanode.fsdataset.AvailableSpaceVolumeChoosingPolicy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.namenode.shared.edits.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>qjournal://node1:8485;node2:8485;node3:8485/Sukie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.journalnode.edits.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>/var/jn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.client.failover.proxy.provider.shsxt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.ha.fencing.methods<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>sshfence<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.ha.fencing.ssh.private-key-files<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>/root/.ssh/id_rsa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.ha.automatic-failover.enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.datanode.max.xcievers<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>4096<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.balance.bandwidthPerSec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>10485760<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.socket.timeout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>900000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.datanode.handler.count<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.namenode.handler.count<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>dfs.datanode.socket.write.timeout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>1800000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h4 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h4></li></ul><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token prolog">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?></span><span class="token comment" spellcheck="true">&lt;!--  Licensed under the Apache License, Version 2.0 (the "License");  you may not use this file except in compliance with the License.  You may obtain a copy of the License at    http://www.apache.org/licenses/LICENSE-2.0  Unless required by applicable law or agreed to in writing, software  distributed under the License is distributed on an "AS IS" BASIS,  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the License for the specific language governing permissions and  limitations under the License. See accompanying LICENSE file.--></span><span class="token comment" spellcheck="true">&lt;!-- Put site-specific property overrides in this file. --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>fs.defaultFS<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>hdfs://Sukie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>ha.zookeeper.quorum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>node1:2181,node2:2181,node3:2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>hadoop.tmp.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>/var/hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><h4 id="hive-site-xml"><a href="#hive-site-xml" class="headerlink" title="hive-site.xml"></a>hive-site.xml</h4></li></ul><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>hive.metastore.uris<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>thrift://192.168.11.131:9083<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2、本地运行"><a href="#2、本地运行" class="headerlink" title="2、本地运行"></a>2、本地运行</h3><p><code>注意bug</code></p><blockquote><p>一、若需要将上面类打包到Linux系统上运行时，代码中conf.setMaster(“local”）中setMaster(“local”)就不需要了</p><p>否则会报错：</p><p>xxxxxx</p></blockquote><blockquote><p>二、OOM(内存溢出)</p><p>Edit Configurations  —&gt;添加VM options的配置</p></blockquote><pre><code>-Xms800m -Xmx800m  -XX:PermSize=64M -XX:MaxNewSize=256m -XX:MaxPermSize=128m</code></pre><blockquote><p>三、java.io.IOException: Failed to delete: C:\Users\SunRise\AppData\Local\Temp\spark-64f2b5a7-f8b8-4da4-b1af-137bb278e3a4</p><p>临时目录 删除失败，不影响程序的正常运行</p></blockquote><blockquote><p>四、org.apache.hadoop.hive.ql.metadata.HiveException: copyFiles: error while checking/creating destination directory!!</p><p>数据加载失败，远程连接拒绝：因为我把core-site.xml  、 hdfs-site.xml  这两个资源文件删除了。</p><p>配置这两个作为资源文件时，注意在使用textFile( )时要取消，因为要避免从hdfs上拿文件</p></blockquote><h3 id="3、打包在Linux上运行"><a href="#3、打包在Linux上运行" class="headerlink" title="3、打包在Linux上运行"></a>3、打包在Linux上运行</h3><ul><li><h4 id="项目打包"><a href="#项目打包" class="headerlink" title="项目打包"></a>项目打包</h4></li></ul><blockquote><p>1、点击Project Structure—&gt;Artifacts—&gt; ‘+’—&gt;JAR—&gt;如图：所使用的的Spark包就不用打进去了，因为Linux中也有。</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0hfk3nqwfj30qg0g20tt.jpg"></p><p>2、点击Build—&gt;Build Project ,之后就会在指定路径下生成对应的jar包</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0hfjxuoi5j30vo0bxjsy.jpg"></p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0hfkaf6rej30r40czq4l.jpg"></p><p>3、将生成的jar包放在Linux系统上对应的Spark客户端节点上</p></blockquote><p><code>注意bug</code></p><ul><li><p>如果打包项目的时候，没有将hive-site.xml文件打包进去，运行时，会报错，说数据库不存在</p></li><li><blockquote><p>解决方法：将它打包进去，或者将该文件放在spark解压目录的conf路径下</p></blockquote></li></ul><p>启动spark，</p><pre><code>./start-all.sh</code></pre><p>启动提交前提：</p><ul><li>zookeeper集群启动</li><li>hdfs集群启动</li><li>hive服务端启动</li><li>spark集群启动</li></ul><p>启动提交（在node00上，保证要有，两个文件，+  运行jar包）</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit --master spark://node00:7077 --class com.bd.spark.java.sparkstream.CreateDFFromHive /usr/soft/spark-test.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>运行结果：</p><blockquote><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0hg723i9kj30qf0e50u8.jpg"></p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0hg5sximqj30qf0e5dhq.jpg"></p></blockquote><h1 id="五、悬而未决"><a href="#五、悬而未决" class="headerlink" title="五、悬而未决"></a>五、悬而未决</h1><h2 id="1、关于序列化的问题你要知道的"><a href="#1、关于序列化的问题你要知道的" class="headerlink" title="1、关于序列化的问题你要知道的"></a>1、关于序列化的问题你要知道的</h2><pre><code>测试java中以下几种情况下不被序列化的问题：1.反序列化时serializable 版本号不一致时会导致不能反序列化。2.子类中实现了serializable接口，父类中没有实现，父类中的变量不能被序列化,序列化后父类中的变量会得到null。注意：父类实现serializable接口,子类没有实现serializable接口时，子类可以正常序列化3.被关键字transient修饰的变量不能被序列化。4.静态变量不能被序列化，属于类，不属于方法和对象，所以不能被序列化。</code></pre><h2 id="2、储存-DataFrame"><a href="#2、储存-DataFrame" class="headerlink" title="2、储存 DataFrame"></a>2、储存 DataFrame</h2><ul><li><p>将 DataFrame 存储为 parquet 文件。</p></li><li><p>将 DataFrame 存储到 JDBC 数据库。</p></li><li><p>将 DataFrame 存储到 Hive 表。</p></li></ul><h1 id="六、自定义函数UDF和UDAF"><a href="#六、自定义函数UDF和UDAF" class="headerlink" title="六、自定义函数UDF和UDAF"></a>六、自定义函数UDF和UDAF</h1><h2 id="1、UDF-用户自定义函数"><a href="#1、UDF-用户自定义函数" class="headerlink" title="1、UDF:用户自定义函数"></a>1、UDF:用户自定义函数</h2><p><code>Java</code></p><pre class="line-numbers language-java"><code class="language-java">包：<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>DataFrame<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Row<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>RowFactory<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>SQLContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>UDF1<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>UDF2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>DataTypes<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>StructField<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>StructType<span class="token punctuation">;</span> main<span class="token operator">:</span>SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"udf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> paraRDD <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"zs1"</span><span class="token punctuation">,</span><span class="token string">"ls12"</span><span class="token punctuation">,</span><span class="token string">"ww123"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//rowRDD</span>        JavaRDD<span class="token operator">&lt;</span>Row<span class="token operator">></span> rowRDD <span class="token operator">=</span> paraRDD<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Row<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Row <span class="token function">call</span><span class="token punctuation">(</span>String v1<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> RowFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//schema</span>        List<span class="token operator">&lt;</span>StructField<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>StructField<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span><span class="token function">createStructField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        StructType schema <span class="token operator">=</span> DataTypes<span class="token punctuation">.</span><span class="token function">createStructType</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//DataFrame</span>        DataFrame df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">createDataFrame</span><span class="token punctuation">(</span>rowRDD<span class="token punctuation">,</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>        df<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"names"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//udf</span>      sqlContext<span class="token punctuation">.</span><span class="token function">udf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"StringLen"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">UDF1</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>              <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>IntegerType<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//udf2</span>      sqlContext<span class="token punctuation">.</span><span class="token function">udf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"StringLens"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UDF2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">,</span> Integer s2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>s2<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>IntegerType<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//使用sql</span>    sqlContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select name ,StringLens(name,100) as length from names"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Scala</code></p><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"udf"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>    <span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQLContext<span class="token punctuation">(</span>context<span class="token punctuation">)</span>    <span class="token keyword">val</span> rdd <span class="token operator">=</span> context<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">"zs1"</span><span class="token punctuation">,</span><span class="token string">"ls12"</span><span class="token punctuation">,</span><span class="token string">"ww123"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">val</span> rowRDD <span class="token operator">=</span> rdd<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>     RowFactory<span class="token punctuation">.</span>create<span class="token punctuation">(</span>x<span class="token punctuation">)</span>   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> field <span class="token operator">=</span> Array<span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span>createStructField<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> schema <span class="token operator">=</span> DataTypes<span class="token punctuation">.</span>createStructType<span class="token punctuation">(</span>field<span class="token punctuation">)</span>    <span class="token keyword">val</span> df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>rowRDD<span class="token punctuation">,</span>schema<span class="token punctuation">)</span>    df<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"names"</span><span class="token punctuation">)</span>    sqlContext<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">"StringLen"</span><span class="token punctuation">,</span><span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      x<span class="token punctuation">.</span>length    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    sqlContext<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">"StringLens"</span><span class="token punctuation">,</span><span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>y<span class="token operator">:</span>Integer<span class="token punctuation">)</span><span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      x<span class="token punctuation">.</span>length<span class="token operator">+</span>y    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>   sqlContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select name , StringLen(name) from names"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sqlContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select name,StringLens(name,100)from names"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    context<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、UDAF-用户自定义聚合函数"><a href="#2、UDAF-用户自定义聚合函数" class="headerlink" title="2、UDAF:用户自定义聚合函数"></a>2、UDAF:用户自定义聚合函数</h2><ul><li><blockquote><p> 实现 UDAF 函数如果要自定义类要实现UserDefinedAgg regateFunction 类</p></blockquote></li></ul><p>功能：实现统计相同值得个数</p><p>数据：</p><pre><code>     *     zhangsan     *     zhangsan     *     lisi     *     lisi     *     wangwu     *     wangwu     *     zhangsan     *     *     select count(*)  from user group by name</code></pre><p><code>Java</code></p><pre class="line-numbers language-java"><code class="language-java">        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"udaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        SQLContext sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//指定了两个分区</span> JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> rdd <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>       Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"lisi"</span><span class="token punctuation">,</span>                <span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>Row<span class="token operator">></span> rowRDD <span class="token operator">=</span> rdd<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Row<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Row <span class="token function">call</span><span class="token punctuation">(</span>String v1<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> RowFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>StructField<span class="token operator">></span> field <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        field<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span><span class="token function">createStructField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        StructType schema <span class="token operator">=</span> DataTypes<span class="token punctuation">.</span><span class="token function">createStructType</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>        DataFrame df  <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span><span class="token function">createDataFrame</span><span class="token punctuation">(</span>rowRDD<span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span>        df<span class="token punctuation">.</span><span class="token function">registerTempTable</span><span class="token punctuation">(</span><span class="token string">"names"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      sqlContext<span class="token punctuation">.</span><span class="token function">udf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"CountString"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDefinedAggregateFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//select name ,StringCount(name) as number from user group by name</span>            <span class="token comment" spellcheck="true">//初始化一个内部的自己定义的值,在Aggregate之前每组数据的初始化结果</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span>MutableAggregationBuffer buffer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//初始化buffer第0位置的元素为0</span>                buffer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"buffer initialize ----"</span><span class="token operator">+</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/**             * 更新 可以认为一个一个地将组内的字段值传递进来 实现拼接的逻辑             * buffer.getInt(0)获取的是上一次聚合后的值             * 相当于map端的combiner，combiner就是对每一个map task的处理结果进行一次小聚合             * 大聚和发生在reduce端.             * 这里即是:在进行聚合的时候，每当有新的值进来，对分组后的聚合如何进行计算             */</span>            <span class="token comment" spellcheck="true">//相当于分区内</span>            <span class="token comment" spellcheck="true">//buffer1:表示上一次的累加值   buffer2:本次传进来的值</span>            <span class="token comment" spellcheck="true">//将函数输入的参数理解为一行（Row）</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>MutableAggregationBuffer buffer<span class="token punctuation">,</span> Row arg1<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"class buffer :"</span><span class="token operator">+</span>buffer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-------"</span><span class="token operator">+</span>buffer<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"class  arg1:"</span><span class="token operator">+</span>arg1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-------"</span><span class="token operator">+</span>arg1<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                buffer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"update----buffer:"</span><span class="token operator">+</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">",arg1:"</span><span class="token operator">+</span>arg1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/**             * 合并 update操作，             可能是针对一个分组内的部分数据，在某个节点上发生的              但是可能一个分组内的数据，会分布在多个节点上处理             * 此时就要用merge操作，将各个节点上分布式拼接好的串，合并起来             * buffer1.getInt(0) : 大聚合的时候 上一次聚合后的值             * buffer2.getInt(0) : 本次计算传入进来的update的结果             * 这里即是：最后在分布式节点完成后需要进行全局级别的Merge操作             */</span>            <span class="token comment" spellcheck="true">//相当于分区之间</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span>MutableAggregationBuffer buffer1<span class="token punctuation">,</span> Row buffer2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"class buffer1 :"</span><span class="token operator">+</span>buffer1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"----"</span><span class="token operator">+</span>buffer1<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"class buffer2 :"</span><span class="token operator">+</span>buffer2<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"----"</span><span class="token operator">+</span>buffer2<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                buffer1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>buffer1<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>buffer2<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"merge：b1:"</span><span class="token operator">+</span>buffer1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">",buffer2:"</span><span class="token operator">+</span>buffer2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//指定输入字段的字段及类型</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> StructType <span class="token function">inputSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> DataTypes<span class="token punctuation">.</span><span class="token function">createStructType</span><span class="token punctuation">(</span>                        Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span><span class="token function">createStructField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 在进行聚合操作的时候所要处理的数据的结果的类型</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> StructType <span class="token function">bufferSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>               <span class="token keyword">return</span> DataTypes<span class="token punctuation">.</span><span class="token function">createStructType</span><span class="token punctuation">(</span>                       Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span><span class="token function">createStructField</span><span class="token punctuation">(</span><span class="token string">"buffer"</span><span class="token punctuation">,</span>DataTypes<span class="token punctuation">.</span>IntegerType<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//指定UDAF函数计算后返回的结果类型</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> DataType <span class="token function">dataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> DataTypes<span class="token punctuation">.</span>IntegerType<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//最后返回一个和DataType的类型要一致的类型，返回UDAF最后的计算结果</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Object <span class="token function">evaluate</span><span class="token punctuation">(</span>Row buffer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//确保一致性 一般用true,用以标记针对给定的一组输入，UDAF是否总是生成相同的结果。</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deterministic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sqlContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select name , CountString(name) from names"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Scala</code></p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkContext<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Row<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>RowFactory<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>SQLContext<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span>MutableAggregationBuffer<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span>UserDefinedAggregateFunction<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>DataType<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>DataTypes<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>IntegerType<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>StringType<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span>StructType<span class="token keyword">class</span> MyUDAF <span class="token keyword">extends</span> UserDefinedAggregateFunction  <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 为每个分组的数据执行初始化值</span>  <span class="token keyword">def</span> initialize<span class="token punctuation">(</span>buffer<span class="token operator">:</span> MutableAggregationBuffer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>     buffer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 每个组，有新的值进来的时候，进行分组对应的聚合值的计算</span>  <span class="token keyword">def</span> update<span class="token punctuation">(</span>buffer<span class="token operator">:</span> MutableAggregationBuffer<span class="token punctuation">,</span> input<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    buffer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> buffer<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 最后merger的时候，在各个节点上的聚合值，要进行merge，也就是合并</span>  <span class="token keyword">def</span> merge<span class="token punctuation">(</span>buffer1<span class="token operator">:</span> MutableAggregationBuffer<span class="token punctuation">,</span> buffer2<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    buffer1<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> buffer1<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>buffer2<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//输入数据的类型</span>  <span class="token keyword">def</span> inputSchema<span class="token operator">:</span> StructType <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    DataTypes<span class="token punctuation">.</span>createStructType<span class="token punctuation">(</span>        Array<span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span>createStructField<span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 聚合操作时，所处理的数据的类型</span>  <span class="token keyword">def</span> bufferSchema<span class="token operator">:</span> StructType <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    DataTypes<span class="token punctuation">.</span>createStructType<span class="token punctuation">(</span>        Array<span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span>createStructField<span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 最终函数返回值的类型</span>  <span class="token keyword">def</span> dataType<span class="token operator">:</span> DataType <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    DataTypes<span class="token punctuation">.</span>IntegerType  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 最后返回一个最终的聚合值   要和dataType的类型一一对应</span>  <span class="token keyword">def</span> evaluate<span class="token punctuation">(</span>buffer<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    buffer<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//保证数据一致性</span>  <span class="token keyword">def</span> deterministic<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token boolean">true</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> UDAF <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"udaf"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>    <span class="token keyword">val</span> sqlContext <span class="token operator">=</span> <span class="token keyword">new</span> SQLContext<span class="token punctuation">(</span>sc<span class="token punctuation">)</span>    <span class="token keyword">val</span> rdd <span class="token operator">=</span> sc<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"lisi"</span><span class="token punctuation">,</span><span class="token string">"wangwu"</span><span class="token punctuation">,</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> rowRDD <span class="token operator">=</span> rdd<span class="token punctuation">.</span>map <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>RowFactory<span class="token punctuation">.</span>create<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>       <span class="token keyword">val</span> schema <span class="token operator">=</span>DataTypes<span class="token punctuation">.</span>createStructType<span class="token punctuation">(</span>        Array<span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span>createStructField<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> df <span class="token operator">=</span> sqlContext<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>rowRDD<span class="token punctuation">,</span> schema<span class="token punctuation">)</span>    df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    df<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/**     * 注册一个udaf函数     */</span>    sqlContext<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">"StringCount"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> MyUDAF<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    sqlContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select name ,StringCount(name) from user group by name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="七、开窗函数-基于Hive的开窗函数"><a href="#七、开窗函数-基于Hive的开窗函数" class="headerlink" title="七、开窗函数(基于Hive的开窗函数)"></a>七、开窗函数(基于Hive的开窗函数)</h1><p><strong><code>注意：</code></strong></p><ul><li><p>row_number() 开窗函数是按照某个字段分组，然后取另一字段的前几个的值，相当于 分组取 topN</p></li><li><p>如果 SQL 语句里面使用到了开窗函数，那么这个 SQL 语句必须使用HiveContext 来执行，HiveContext 默认情况下在本地无法创建。</p></li><li><p>开窗函数格式：</p><pre class="line-numbers language-sql"><code class="language-sql">row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span>partitin <span class="token keyword">by</span> XXX <span class="token keyword">order</span> <span class="token keyword">by</span> XXX<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p><code>Java</code></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>DataFrame<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>SaveMode<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>HiveContext<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * row_number()开窗函数： * 主要是按照某个字段分组，然后取另一字段的前几个的值，相当于 分组取topN group by .... order by  .... limit 0, 5 ; * row_number() over (partition by xxx order by xxx desc) xxx * 注意： * 如果SQL语句里面使用到了开窗函数，那么这个SQL语句必须使用HiveContext来执行 * @author root * */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RowNumberWindowFun</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//-Xms800m -Xmx800m  -XX:PermSize=64M -XX:MaxNewSize=256m -XX:MaxPermSize=128m</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"windowfun"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"spark.sql.shuffle.partitions"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HiveContext hiveContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiveContext</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>        hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"use spark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"drop table if exists sales"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span>            <span class="token string">"create table if not exists sales (riqi string,leibie string,jine Int) "</span>            <span class="token operator">+</span> <span class="token string">"row format delimited fields terminated by '\t'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span>            <span class="token string">"load data local inpath './data/sales.txt' into table sales"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 开窗函数格式：         * 【 row_number() over (partition by XXX order by XXX) as rank】         * 注意：rank 从1开始         */</span>        <span class="token comment" spellcheck="true">/**         * 以类别分组，按每种类别金额降序排序，显示 【日期，种类，金额】 结果，如：         *          * 1 A 100         * 2 B 200         * 3 A 300         * 4 B 400         * 5 A 500         * 6 B 600         * 排序后：         * 5 A 500  --rank 1         * 3 A 300  --rank 2          * 1 A 100  --rank 3         * 6 B 600  --rank 1         * 4 B 400    --rank 2         * 2 B 200  --rank 3         *         * 2018 A 400     1         * 2017 A 500     2         * 2016 A 550     3         *         *         * 2016 A 550     1         * 2017 A 500     2         * 2018 A 400     3         *         */</span><span class="token comment" spellcheck="true">//无法取前三</span><span class="token comment" spellcheck="true">//hiveContext.sql("select riqi,leibie,jine,"</span><span class="token comment" spellcheck="true">//             + "row_number() over (partition by leibie order by jine desc) rank "</span><span class="token comment" spellcheck="true">//             + "from sales").show();</span>        DataFrame result <span class="token operator">=</span> hiveContext<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token string">"select riqi,leibie,jine,rank from ( select riqi,leibie,jine,"</span>    <span class="token operator">+</span> <span class="token string">"row_number() over (partition by leibie order by jine desc) rank from sales) t"</span><span class="token operator">+</span> <span class="token string">"where t.rank&lt;=3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 将结果保存到hive表sales_result         */</span>        result<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">saveAsTable</span><span class="token punctuation">(</span><span class="token string">"sales_result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Scala</code></p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkContext<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>HiveContext<span class="token keyword">object</span> RowNumberWindowFun <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"windowfun"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>    <span class="token keyword">val</span> hiveContext <span class="token operator">=</span> <span class="token keyword">new</span> HiveContext<span class="token punctuation">(</span>sc<span class="token punctuation">)</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"use spark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"drop table if exists sales"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>       <span class="token string">"create table if not exists sales (riqi string,leibie string,jine Int) "</span>       <span class="token operator">+</span> <span class="token string">"row format delimited fields terminated by '\t'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>            <span class="token string">"load data local inpath '/root/test/sales' into table sales"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 开窗函数格式：         * 【 rou_number() over (partitin by XXX order by XXX) 】         */</span>    <span class="token keyword">val</span> result <span class="token operator">=</span> hiveContext<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>        <span class="token string">"select riqi,leibie,jine from (select riqi,leibie,jine,"</span>                <span class="token operator">+</span><span class="token string">"row_number() over (partition by leibie order by jine desc) rank"</span>        <span class="token operator">+</span> <span class="token string">"from sales) t where t.rank&lt;=3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">SparkSql是基于 Spark 计算框架之上且兼容 Hive 语法的 SQL 执行引擎</summary>
    
    
    
    <category term="Spark" scheme="https://sukie-sun.github.io/categories/Spark/"/>
    
    
    <category term="SparkSql" scheme="https://sukie-sun.github.io/tags/SparkSql/"/>
    
    <category term="不同数据源" scheme="https://sukie-sun.github.io/tags/%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E6%BA%90/"/>
    
    <category term="封装RDD" scheme="https://sukie-sun.github.io/tags/%E5%B0%81%E8%A3%85RDD/"/>
    
  </entry>
  
  <entry>
    <title>Spark学习（四）</title>
    <link href="https://sukie-sun.github.io/2019/02/19/Spark(4)/"/>
    <id>https://sukie-sun.github.io/2019/02/19/Spark(4)/</id>
    <published>2019-02-18T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.793Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、广播变量"><a href="#一、广播变量" class="headerlink" title="一、广播变量"></a>一、广播变量</h1><h2 id="1、广播变量理解图"><a href="#1、广播变量理解图" class="headerlink" title="1、广播变量理解图"></a>1、广播变量理解图</h2><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0cxiwpy6gj30fy0h2tax.jpg"></p><h2 id="2、广播变量的使用"><a href="#2、广播变量的使用" class="headerlink" title="2、广播变量的使用"></a>2、广播变量的使用</h2><p>Java:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span>Broadcast<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 广播变量： * 1.不能将一个RDD使用广播变量广播出去，因为RDD是不存数据的，可以将RDD的结果广播出去。 * 2.广播变量只能在Driver端定义，不能在Executor端定义。 * 3.在Driver端可以修改广播变量的值，在Executor端不能修改广播变量的值。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BroadCast</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//List中已经实现了序列化，可以用于跨网络传输</span>        List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"hello bjsxt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//广播变量将list广播出去</span>        <span class="token keyword">final</span> Broadcast<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>String<span class="token operator">>></span> broadCastList <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> lines <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"data/word.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Boolean <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                                       <span class="token comment" spellcheck="true">//匿名内部类中使用的变量必须使用final修饰</span>                <span class="token keyword">return</span> broadCastList<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>String t<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Scala:</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"brocast"</span><span class="token punctuation">)</span><span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token keyword">val</span> list <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token string">"hello xasxt"</span><span class="token punctuation">)</span><span class="token keyword">val</span> broadCast <span class="token operator">=</span> sc<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token keyword">val</span> lineRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./words.txt"</span><span class="token punctuation">)</span>lineRDD<span class="token punctuation">.</span>filter <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>broadCast<span class="token punctuation">.</span>value<span class="token punctuation">)</span>    broadCast<span class="token punctuation">.</span>value<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> println<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、注意事项"><a href="#3、注意事项" class="headerlink" title="3、注意事项"></a>3、注意事项</h2><blockquote><ul><li>为什么使用广播变量</li></ul><ul><li>能不能将一个 RDD 使用广播变量广播出去？<br>不能，因为RDD是不存储数据的。可以将RDD的结果广播出去。</li><li>广播变量只能在 Driver 端定义，在Executor端使用，不能在 Executor 端定义。</li><li>在 Driver 端可以修改广播变量的值，在 Executor 端无法修改广播变量的值</li><li>代码中，算子内部执行是在Executor端，其余的在Driver端</li><li>系列化：用于机器之间跨网络传输时，要将文件序列化到磁盘才可完成传输</li><li>内存大会频繁的gc（垃圾回收）就会卡顿，如果内存还不够，就会报oom（内存溢出）</li></ul></blockquote><h1 id="二、累加器"><a href="#二、累加器" class="headerlink" title="二、累加器"></a>二、累加器</h1><h2 id="1、累加器理解图"><a href="#1、累加器理解图" class="headerlink" title="1、累加器理解图"></a>1、累加器理解图</h2><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0da58qfv9j30m40c4q9q.jpg"></p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0da61a9htj30lx0ebn4i.jpg"></p><h2 id="2、累加器的使用"><a href="#2、累加器的使用" class="headerlink" title="2、累加器的使用"></a>2、累加器的使用</h2><p>Java：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>Accumulator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>RDD<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 累加器在Driver端定义赋初始值和读取，在Executor端累加。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccumulatorOperator</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"accumulator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//获取累加器：初始值为0</span>        <span class="token keyword">final</span> Accumulator<span class="token operator">&lt;</span>Integer<span class="token operator">></span> accumulator <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sc<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"data/word.txt"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>String t<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                accumulator<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//不能再Executor端获取accumulator.value()来触发累加</span><span class="token comment" spellcheck="true">//                System.out.println(accumulator.value());</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>accumulator<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// accumulator.value 写法只能在driver端，excutor端的task只能用accumulator的写法来查看数据</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>accumulator<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Scala:</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"accumulator"</span><span class="token punctuation">)</span><span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token keyword">val</span> accumulator <span class="token operator">=</span> sc<span class="token punctuation">.</span>accumulator<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/*val count = 0sc.textFile("./words.txt").foreach &amp;#123; x =>&amp;#123;count+=1println("count:"+count)&amp;#125;&amp;#125; //結果count打印为0 ， 因为count未能序列化，无法实现跨网络传输*/</span>sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./words.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>accumulator<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>println<span class="token punctuation">(</span>accumulator<span class="token punctuation">.</span>value<span class="token punctuation">)</span>sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>注意：</code></p><ul><li>累加器在Driver端定义赋初始值，累加器只能在Driver端读取，在 Excutor 端更新。</li></ul><h1 id="三、SparkShuffle"><a href="#三、SparkShuffle" class="headerlink" title="三、SparkShuffle"></a>三、SparkShuffle</h1><h2 id="1、SparkShuffle-概念"><a href="#1、SparkShuffle-概念" class="headerlink" title="1、SparkShuffle 概念"></a>1、SparkShuffle 概念</h2><p>reduceByKey 会将上一个 RDD 中的每一个 key 对应的所有 value 聚合成一个 value，然后生成一个新的 RDD，元素类型是&lt;key,value&gt;对的形式，这样每一个 key 对应一个聚合起来的 value。</p><p><strong><code>问题</code>：</strong>聚合之前，每一个 key 对应的 value 不一定都是在一个 partition中，也不太可能在同一个节点上，因为 RDD 是分布式的弹性的数据集，RDD 的 partition 极有可能分布在各个节点上。</p><p><strong><code>如何聚合？</code></strong></p><ul><li>– – <strong>Shuffle Write</strong> ：上一个 stage 的每个 map task 就必须保证将自己处理的当前分区的数据相同的 key 写入一个分区文件中，可能会写入多个不同的分区文件中。</li><li>– – <strong>Shuffle Read</strong> ：reduce task 就会从上一个 stage 的所有 task 所在的机器上寻找属于自己的那些分区文件，这样就可以保证每一个 key 所对应的 value 都会汇聚到同一个节点上去处理和聚合。</li><li>Spark 中有两种 Shuffle 类型，HashShuffle 和 SortShuffle，Spark1.2之<code>前</code>是 <code>HashShuffle</code> 默认的分区器是 HashPartitioner，Spark1.2 引入<code>SortShuffle</code> 默认的分区器是 RangePartitioner。</li></ul><h2 id="2、HashShuffle"><a href="#2、HashShuffle" class="headerlink" title="2、HashShuffle"></a>2、HashShuffle</h2><h3 id="1-gt-普通机制"><a href="#1-gt-普通机制" class="headerlink" title="1&gt; 普通机制"></a>1&gt; <strong>普通机制</strong></h3><ul><li>普通机制示意图</li></ul><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0dax2jtxwj30qv0enwqa.jpg"></p><ul><li><p>执行流程<br>a) 每一个 map task 将不同结果写到不同的 buffer 中，每个buffer 的大小为 **<code>32K</code>**。buffer 起到数据缓存的作用。</p><p>b) 每个 buffer 文件最后对应一个磁盘小文件。</p><p>c) reduce task 来拉取对应的磁盘小文件。</p></li><li><p>总结<br>① .map task 的计算结果会根据分区器（默认是hashPartitioner）来决定写入到哪一个磁盘小文件中去。<br>ReduceTask 会去 Map 端拉取相应的磁盘小文件。<br>② .产生的磁盘小文件的个数：M（map task 的个数）*R（reduce task 的个数）</p></li><li><p>存在的问题<br> 产生的磁盘小文件过多，会导致以下问题：<br> a) 在 Shuffle Write 过程中会产生很多写磁盘小文件的对象。<br> b) 在 Shuffle Read 过程中会产生很多读取磁盘小文件的对象。<br> c) 在JVM堆内存中对象过多会造成频繁的gc,gc还无法解决运行所需要的内存 的话，就会 OOM。<br> d) 在数据传输过程中会有频繁的网络通信，频繁的网络通信出现通信故障的可能性大大增加，一旦网络通信出现了故障会导致 shuffle file cannot find 由于这个错误导致的 task 失败，TaskScheduler 不负责重试，由 DAGScheduler 负责重试 Stage。</p></li></ul><h3 id="2-gt-合并机制"><a href="#2-gt-合并机制" class="headerlink" title="2&gt; 合并机制"></a>2&gt; 合并机制</h3><p> 合并机制示意图</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0db1l3k43j30sd0euwov.jpg"></p><ul><li>总结<br>产生磁盘小文件的个数：C(core 的个数)*R（reduce 的个数）</li></ul><h2 id="3、SortShuffle"><a href="#3、SortShuffle" class="headerlink" title="3、SortShuffle"></a>3、SortShuffle</h2><h3 id="1-gt-普通机制-1"><a href="#1-gt-普通机制-1" class="headerlink" title="1&gt; 普通机制"></a>1&gt; 普通机制</h3><p> 普通机制示意图</p><p><img src="../images/sortShuffle%E6%99%AE%E9%80%9A%E6%9C%BA%E5%88%B6.jpg"></p><ul><li>执行流程</li></ul><p>a) map task 的计算结果会写入到一个内存数据结构里面，内存数据结构默认是 5M<br>b) 在 shuffle 的时候会有一个定时器，不定期的去估算这个内存结构的大小，当内存结构中的数据超过 5M 时，比如现在内存结构中的数据为 5.01M，那么他会申请 5.01*2-5=5.02M 内存给内存数据结构。<br>c) 如果申请成功不会进行溢写，如果申请不成功，这时候会发生溢写磁盘。<br>d) 在溢写之前内存结构中的数据会进行排序分区<br>e) 然后开始溢写磁盘，写磁盘是以batch的形式去写，一个batch是 1 万条数据，<br>f) map task 执行完成后，会将这些磁盘小文件合并成一个大的磁盘文件，同时生成一个索引文件。<br>g) reduce task 去 map 端拉取数据的时候，首先解析索引文件，根据索引文件再去拉取对应的数据。</p><ul><li>总结<br>产生磁盘小文件的个数： 2*M（map task 的个数）</li></ul><h3 id="2-gt-bypass-机制"><a href="#2-gt-bypass-机制" class="headerlink" title="2&gt;bypass 机制"></a>2&gt;bypass 机制</h3><p> bypass机制示意图</p><p>![](../images/sortShuffle byPass机制.jpg)</p><p> 总结<br>① .bypass 运行机制的触发条件如下：<br>shuffle  reduce  task 的 数 量 小 于  spark.shuffle.sort.bypassMergeThreshold 的参数值。这个 值默认是 200。<br>② .产生的磁盘小文件为：2*M（map task 的个数）</p><h2 id="4、Shuffle-文件寻址"><a href="#4、Shuffle-文件寻址" class="headerlink" title="4、Shuffle 文件寻址"></a>4、Shuffle 文件寻址</h2><h3 id="1-MapOutputTracker"><a href="#1-MapOutputTracker" class="headerlink" title="1)MapOutputTracker"></a>1)MapOutputTracker</h3><h3 id="2-BlockManager"><a href="#2-BlockManager" class="headerlink" title="2) BlockManager"></a>2) BlockManager</h3><h1 id="四、Spark-内存管理"><a href="#四、Spark-内存管理" class="headerlink" title="四、Spark 内存管理"></a>四、Spark 内存管理</h1><h2 id="1、静态内存管理分布图"><a href="#1、静态内存管理分布图" class="headerlink" title="1、静态内存管理分布图"></a>1、静态内存管理分布图</h2><h2 id="2、统一内存管理分布图"><a href="#2、统一内存管理分布图" class="headerlink" title="2、统一内存管理分布图"></a>2、统一内存管理分布图</h2><h2 id="3、reduce-中-OOM-如何处理？"><a href="#3、reduce-中-OOM-如何处理？" class="headerlink" title="3、reduce 中 OOM 如何处理？"></a>3、reduce 中 OOM 如何处理？</h2><h1 id="五、Shuffle-调优"><a href="#五、Shuffle-调优" class="headerlink" title="五、Shuffle  调优"></a>五、Shuffle  调优</h1><h2 id="1、SparkShuffle-调优配置项如何使用？"><a href="#1、SparkShuffle-调优配置项如何使用？" class="headerlink" title="1、SparkShuffle 调优配置项如何使用？"></a>1、SparkShuffle 调优配置项如何使用？</h2>]]></content>
    
    
    <summary type="html">Spark学习第四篇章：广播变量、累加器、SparkShuffle、spark内存管理、shuffle调优</summary>
    
    
    
    <category term="Spark" scheme="https://sukie-sun.github.io/categories/Spark/"/>
    
    
    <category term="广播" scheme="https://sukie-sun.github.io/tags/%E5%B9%BF%E6%92%AD/"/>
    
    <category term="累加器" scheme="https://sukie-sun.github.io/tags/%E7%B4%AF%E5%8A%A0%E5%99%A8/"/>
    
    <category term="github" scheme="https://sukie-sun.github.io/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>Spark学习（三）</title>
    <link href="https://sukie-sun.github.io/2019/02/18/Spark(3)/"/>
    <id>https://sukie-sun.github.io/2019/02/18/Spark(3)/</id>
    <published>2019-02-17T16:00:00.000Z</published>
    <updated>2020-08-09T12:22:57.733Z</updated>
    
    <content type="html"><![CDATA[<h1 id="案例一、统计网站-pv-和-uv统计"><a href="#案例一、统计网站-pv-和-uv统计" class="headerlink" title="案例一、统计网站 pv 和 uv统计"></a>案例一、统计网站 pv 和 uv统计</h1><h2 id="0、概念理解"><a href="#0、概念理解" class="headerlink" title="0、概念理解"></a>0、概念理解</h2><p><code>PV</code> 是网站分析的一个术语，用以衡量网站用户访问的网页的数量。</p><p>对于广告主，PV 值可预期它可以带来多少广告收入。一般来说，PV 与来访者的数量成正比，但是 PV 并不直接决定页面的真实来访者数量，如同一个来访者通过不断的刷新页面，也可以制造出非常高的 PV。</p><h2 id="1、什么是-PV-值"><a href="#1、什么是-PV-值" class="headerlink" title="1、什么是 PV 值"></a>1、什么是 PV 值</h2><p>PV （page view ）即页面浏览量或点击量，是衡量一个网站或网页用户访问量。</p><p>PV 值就是所有访问者在 24 小时（0 点到 24 点）内看了某个网站多少个页面或某个网页多少次。</p><p>PV 是指页面刷新的次数，每一次页面刷新，就算做一次 PV 流量。</p><h2 id="2、什么是UV-值"><a href="#2、什么是UV-值" class="headerlink" title="2、什么是UV 值"></a>2、什么是UV 值</h2><p>UV （unique visitor ）即独立访客数，指访问某个站点或点击某个网页的不同 IP 地址的人数。</p><p>在同一天内，UV  只记录第一次进入网站的具有独立IP  的访问者，在同一天内再次访问该网站则不计数。</p><p>UV 提供了一定时间内不同观众数量的统计指标，而没有反应出网站的全面活动。</p><p><code>PV</code></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>Function2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>deploy<span class="token punctuation">.</span>master<span class="token punctuation">.</span>Master<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestPV</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf sparkConf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sparkConf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"pv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>sparkConf<span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> lineRDD <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"./data/pvuvdata"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**求每个页面 PV         * 文件每一行的内容115.77.12.186    安徽    2017-10-10    1512012307084    5641635304912151098    www.suning.com         */</span>        <span class="token comment" spellcheck="true">//方法一：mapToPair().reduceByKey().foeach()</span>     lineRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String line<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>               String<span class="token punctuation">[</span><span class="token punctuation">]</span> str <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduceByKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>           <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer v1<span class="token punctuation">,</span> Integer v2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                   <span class="token keyword">return</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">;</span>           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>           <span class="token annotation punctuation">@Override</span>           <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> tuple2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>               System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tuple2<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//方法二:  mapToPair().groupByKey().foeach()</span>     JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>Integer<span class="token operator">>></span> groupByKeyRDD <span class="token operator">=</span>         lineRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>           <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String line<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>               String<span class="token punctuation">[</span><span class="token punctuation">]</span> str <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupByKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    groupByKeyRDD<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>Integer<span class="token operator">>>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>Integer<span class="token operator">>></span> tuple2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>               <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>               Iterator<span class="token operator">&lt;</span>Integer<span class="token operator">></span> iterator <span class="token operator">=</span> tuple2<span class="token punctuation">.</span>_2<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                   count<span class="token operator">++</span><span class="token punctuation">;</span>               <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>               System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"url : "</span> <span class="token operator">+</span> tuple2<span class="token punctuation">.</span>_1 <span class="token operator">+</span> <span class="token string">" value: "</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">//方法三： mapToPair().countByKey()-->对map遍历</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span>         lineRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>           <span class="token annotation punctuation">@Override</span>           <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String line<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>               String<span class="token punctuation">[</span><span class="token punctuation">]</span> str <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment" spellcheck="true">// url,1</span>               <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">countByKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span>String key <span class="token operator">:</span>map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>           System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"key : "</span> <span class="token operator">+</span> key  <span class="token operator">+</span> <span class="token string">"   value :"</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>UV</code></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span>Broadcast<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>deploy<span class="token punctuation">.</span>master<span class="token punctuation">.</span>Master<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>DAGScheduler<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashSet<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestUV</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">private</span>  <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf sparkConf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sparkConf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"uv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>sparkConf<span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> lineRDD <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"./data/pvuvdata"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">/**求每个网站 UV： 用IP唯一标识用户 ，注意去重         * 文件每一行的内容115.77.12.186    安徽    2017-10-10    1512012307084    5641635304912151098    www.suning.com         */</span>        <span class="token comment" spellcheck="true">//方法一：mapToPair().groupByKey().foreach()</span>        JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">>></span> rdd1 <span class="token operator">=</span>             lineRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                String url <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                String ip <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupByKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rdd1<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">>>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">>></span> tuple2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//set:无序，不可重复，所以它可以自动去重</span>                HashSet<span class="token operator">&lt;</span>Object<span class="token operator">></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Iterator<span class="token operator">&lt;</span>String<span class="token operator">></span> iterator <span class="token operator">=</span> tuple2<span class="token punctuation">.</span>_2<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tuple2<span class="token punctuation">.</span>_1  <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> set<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//方法二：mapToPair().ditinct().countByKey()-->遍历map</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span>             lineRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                String url <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                String ip <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">countByKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"key : "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"   value :"</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>-------------------------------------------------------------------------------------</code></pre><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sxt<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>core<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>RDD<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>&amp;#<span class="token number">123</span><span class="token punctuation">;</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> PVUV <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>        conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"pvuv"</span><span class="token punctuation">)</span>        <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>        <span class="token keyword">val</span> records <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"data/pvuvdata"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//pv</span>        records<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">val</span> fields <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span>            <span class="token punctuation">(</span>fields<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//uv</span>        <span class="token keyword">val</span> result<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> records<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">val</span> fields <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span>            <span class="token punctuation">(</span>fields<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span>        result<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">val</span> key <span class="token operator">=</span> x<span class="token punctuation">.</span>_1            <span class="token keyword">val</span> iteratable <span class="token operator">=</span> x<span class="token punctuation">.</span>_2            println<span class="token punctuation">(</span><span class="token string">"key : "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">" size : "</span> <span class="token operator">+</span> iteratable<span class="token punctuation">.</span>toSet<span class="token punctuation">.</span>size<span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>core<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>RDD<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>&amp;#<span class="token number">123</span><span class="token punctuation">;</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> PVUV2 <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">// "local[4]"  指定本地以及使用的核数     </span>        conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[4]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"pvuv"</span><span class="token punctuation">)</span>        <span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>        <span class="token keyword">val</span> linesRDD <span class="token operator">=</span> context<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"data/pvuvdata"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//pv</span>        <span class="token comment" spellcheck="true">//(www.jd.com,1000)</span>        linesRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">val</span> fields<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span>            <span class="token punctuation">(</span>fields<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x <span class="token operator">+</span> y<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//uv</span>        <span class="token comment" spellcheck="true">//(www.taobao.com,10.20.30.18)</span>        <span class="token keyword">val</span> groupRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> linesRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">val</span> fields <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span>            <span class="token punctuation">(</span>fields<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fields<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span>        groupRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">val</span> key  <span class="token operator">=</span> x<span class="token punctuation">.</span>_1            <span class="token keyword">val</span> size <span class="token operator">=</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>toSet<span class="token punctuation">.</span>size            <span class="token punctuation">(</span>key<span class="token punctuation">,</span>size<span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="案例二：二次排序"><a href="#案例二：二次排序" class="headerlink" title="案例二：二次排序"></a>案例二：二次排序</h1><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecondSortKey</span>  <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">,</span> Comparable<span class="token operator">&lt;</span>SecondSortKey<span class="token operator">></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> first<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> second<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> first<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFirst</span><span class="token punctuation">(</span><span class="token keyword">int</span> first<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>first <span class="token operator">=</span> first<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> second<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSecond</span><span class="token punctuation">(</span><span class="token keyword">int</span> second<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>second <span class="token operator">=</span> second<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">SecondSortKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> first<span class="token punctuation">,</span> <span class="token keyword">int</span> second<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>first <span class="token operator">=</span> first<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>second <span class="token operator">=</span> second<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>SecondSortKey o1<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> o1<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 5     6</span>            <span class="token comment" spellcheck="true">// this  &lt; o1</span>            <span class="token comment" spellcheck="true">// 6   5</span>            <span class="token comment" spellcheck="true">// this > o1</span>            <span class="token keyword">return</span> o1<span class="token punctuation">.</span><span class="token function">getSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">getSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/*if(getSecond() - o1.getSecond() == 0) &amp;#123;                return getThree() - o1.getThree();            &amp;#125;else &amp;#123;                return getSecond() - o1.getSecond();            &amp;#125;*/</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">return</span>  o1<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecondKeyTest</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf sparkConf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sparkConf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"SecondarySortTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>sparkConf<span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> secondRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"./data/secondSort.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*文件内容格式         * 1 3         * 1 4         * 2 3         */</span>        <span class="token comment" spellcheck="true">//maptoPair -->sortByKey -->foreach</span>        JavaPairRDD<span class="token operator">&lt;</span>SecondSortKey<span class="token punctuation">,</span> String<span class="token operator">></span> secRDD <span class="token operator">=</span>             secondRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> SecondSortKey<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>           <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>SecondSortKey<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String line<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                String<span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                SecondSortKey secondSortKey <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SecondSortKey</span><span class="token punctuation">(</span>                    Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>secondSortKey<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      secRDD<span class="token punctuation">.</span><span class="token function">sortByKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>SecondSortKey<span class="token punctuation">,</span> String<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>           <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>SecondSortKey<span class="token punctuation">,</span> String<span class="token operator">></span> tuple2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tuple2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-scala"><code class="language-scala"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="案例三：分组取topN"><a href="#案例三：分组取topN" class="headerlink" title="案例三：分组取topN"></a>案例三：分组取topN</h1><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sxt<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>PairFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>VoidFunction<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopN</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf<span class="token punctuation">;</span>        conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[5]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"TopOps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//hdfs://shsxt/wc.txt</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> linesRDD <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"data/scores.txt"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> List n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//      linesRDD.count();</span><span class="token comment" spellcheck="true">/*a 86 a 58  b 78*/</span>        JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> pairRDD <span class="token operator">=</span>         linesRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">/**                     *                     */</span>                 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>                 <span class="token annotation punctuation">@Override</span>                 <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String str<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        String<span class="token punctuation">[</span><span class="token punctuation">]</span> splited <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        String clazzName <span class="token operator">=</span> splited<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                        Integer score <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>splited<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span>clazzName<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>Integer<span class="token operator">>></span> groupByKeyRDD <span class="token operator">=</span>pairRDD<span class="token punctuation">.</span><span class="token function">groupByKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     groupByKeyRDD<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>Integer<span class="token operator">>>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">/**                     *                     */</span>                    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>                    <span class="token annotation punctuation">@Override</span>       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>Integer<span class="token operator">>></span> tuple<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        String clazzName <span class="token operator">=</span> tuple<span class="token punctuation">.</span>_1<span class="token punctuation">;</span>                        Iterator<span class="token operator">&lt;</span>Integer<span class="token operator">></span> iterator <span class="token operator">=</span> tuple<span class="token punctuation">.</span>_2<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">//取前三：大的放前，小的后移</span>                        Integer<span class="token punctuation">[</span><span class="token punctuation">]</span> top3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                            Integer score <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> top3<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>top3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                                    top3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">;</span>                                    <span class="token keyword">break</span><span class="token punctuation">;</span>                                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">></span> top3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> j <span class="token operator">></span> i<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                                        top3<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> top3<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                                    top3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">;</span>                                    <span class="token keyword">break</span><span class="token punctuation">;</span>                                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"class Name:"</span> <span class="token operator">+</span> clazzName<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Integer sscore <span class="token operator">:</span> top3<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sscore<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//     groupByKeyRDD.foreach(new VoidFunction&lt;Tuple2&lt;String, Iterable&lt;Integer>>>() &amp;#123;</span><span class="token comment" spellcheck="true">//            @Override</span><span class="token comment" spellcheck="true">//     public void call(Tuple2&lt;String, Iterable&lt;Integer>> tuple2) throws Exception &amp;#123;</span><span class="token comment" spellcheck="true">//                String key  = tuple2._1;</span><span class="token comment" spellcheck="true">//                Iterator&lt;Integer> iterator = tuple2._2.iterator();</span><span class="token comment" spellcheck="true">//                List list = IteratorUtils.toList(iterator);</span><span class="token comment" spellcheck="true">//                Collections.sort(list);</span><span class="token comment" spellcheck="true">//                for(int i=0;i&lt;Math.min(3,list.size());i++)&amp;#123;</span><span class="token comment" spellcheck="true">//                    // list.size = 3  list.get(2)</span><span class="token comment" spellcheck="true">//                    System.out.println(key + " " +  list.get(list.size()-i-1));</span><span class="token comment" spellcheck="true">//                &amp;#125;</span><span class="token comment" spellcheck="true">//            &amp;#125;</span><span class="token comment" spellcheck="true">//        &amp;#125;);</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>-----------------------------------------------------------------------------------</code></pre><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sxt<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>core<span class="token comment" spellcheck="true">/* * Licensed to the Apache Software Foundation (ASF) under one or more * contributor license agreements.  See the NOTICE file distributed with * this work for additional information regarding copyright ownership. * The ASF licenses this file to You under the Apache License, Version 2.0 * (the "License"); you may not use this file except in compliance with * the License.  You may obtain a copy of the License at * *    http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>&amp;#<span class="token number">123</span><span class="token punctuation">;</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Computes the PageRank of URLs from an input file. Input file should * be in format of: * URL         neighbor URL * URL         neighbor URL * URL         neighbor URL * ... * where URL and their neighbors are separated by space(s). */</span><span class="token keyword">object</span> SparkPageRank <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//    if (args.length &lt; 1) &amp;#123;</span>    <span class="token comment" spellcheck="true">//      System.err.println("Usage: SparkPageRank &lt;file> &lt;iter>")</span>    <span class="token comment" spellcheck="true">//      System.exit(1)</span>    <span class="token comment" spellcheck="true">//    &amp;#125;</span>    <span class="token keyword">val</span> sparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"PageRank"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[1]"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> iters <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//    val iters = if (args.length > 0) args(1).toInt else 10</span>    <span class="token keyword">val</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>sparkConf<span class="token punctuation">)</span>    <span class="token keyword">val</span> lines <span class="token operator">=</span> ctx<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"page.txt"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//根据边关系数据生成 邻接表 如：(1,(2,3,4,5)) (2,(1,5))..</span>    <span class="token keyword">val</span> links <span class="token operator">=</span> lines<span class="token punctuation">.</span>map<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> s <span class="token keyword">=></span>      <span class="token keyword">val</span> parts <span class="token operator">=</span> s<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\\s+"</span><span class="token punctuation">)</span>      <span class="token punctuation">(</span>parts<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>    links<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// (1,1.0) (2,1.0)..</span>    <span class="token keyword">var</span> ranks <span class="token operator">=</span> links<span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span>v <span class="token keyword">=></span> <span class="token number">1.0</span><span class="token punctuation">)</span>    ranks<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to iters<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// (1,((2,3,4,5), 1.0))</span>      <span class="token keyword">val</span> contribs <span class="token operator">=</span> links<span class="token punctuation">.</span>join<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>flatMap<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>urls<span class="token punctuation">,</span> rank<span class="token punctuation">)</span> <span class="token keyword">=></span>        <span class="token keyword">val</span> size <span class="token operator">=</span> urls<span class="token punctuation">.</span>size        urls<span class="token punctuation">.</span>map<span class="token punctuation">(</span>url <span class="token keyword">=></span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> rank <span class="token operator">/</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      ranks <span class="token operator">=</span> contribs<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span><span class="token punctuation">.</span>mapValues<span class="token punctuation">(</span><span class="token number">0.15</span> <span class="token operator">+</span> <span class="token number">0.85</span> <span class="token operator">*</span> _<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> output <span class="token operator">=</span> ranks<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//    output.foreach(tup => println(tup._1 + " has rank: " + tup._2 + "."))</span>    ctx<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="参数解释：spark-submit"><a href="#参数解释：spark-submit" class="headerlink" title="参数解释：spark-submit"></a>参数解释：spark-submit</h1><p>spark-submit -h</p><p>–master  （优先使用代码中的配置）</p><p>–name    （指定APPname）</p><p>–deploy mode  （默认为client，指定运行模式）</p><p>–jars （可以用来为代码添加所需要的jar包依赖）</p><p>IDEA代码打包：BUILD（注意避免jar包过大，可）</p><p>–files （添加代码所需的文件）</p><p>–conf （PROP=value）</p><p>–driver-memory</p><p>–executor-memory</p><p>–total-executor-core    （若不指明，就把所有的核均用完）</p><p>–queue</p><p>资源分配：</p><p>yarn  ： 分配到队列中 </p><pre class="line-numbers language-shell"><code class="language-shell">[root@node00 bin]# ./spark-submit -hUsage: spark-submit [options] <app jar | python file> [app arguments]Usage: spark-submit --kill [submission ID] --master [spark://...]Usage: spark-submit --status [submission ID] --master [spark://...]Options:  --master MASTER_URL         spark://host:port, mesos://host:port, yarn, or local.  --deploy-mode DEPLOY_MODE   Whether to launch the driver program locally("client")                               or on one of the worker machines inside the  cluster                                 ("cluster") (Default: client).  --class CLASS_NAME          Your application's main class (for Java / Scala apps).  --name NAME                 A name of your application.  --jars JARS                 Comma-separated (逗号分隔) list of local jars to include                               on the driver and executor classpaths.(Driver 和                                     executor 依赖的第三方 jar 包)  --packages                  Comma-separated list of maven coordinates of jars to                                 include on the driver and executor classpaths. Will                                 search the local maven repo, then maven central and                                 any additional remote repositories given by --                                       repositories. The format for the coordinates should be                               groupId:artifactId:version.  --exclude-packages          Comma-separated list of groupId:artifactId, to exclude                               while resolving the dependencies provided in --                                     packages to avoid dependency conflicts.  --repositories              Comma-separated list of additional remote repositories                               to search for the maven coordinates given with --                                   packages.  --py-files PY_FILES         Comma-separated list of .zip, .egg, or .py files to                                 place on the PYTHONPATH for Python apps.  --files FILES               Comma-separated list of files to be placed in the                                   working directory of each executor.  --conf PROP=VALUE           Arbitrary Spark configuration property.  --properties-file FILE      Path to a file from which to load extra properties. If                               not specified, this will look for conf/spark-                                       defaults.conf.  --driver-memory MEM         Memory for driver (e.g. 1000M, 2G) (Default: 1024M).  --driver-java-options       Extra Java options to pass to the driver.  --driver-library-path       Extra library path entries to pass to the driver.  --driver-class-path         Extra class path entries to pass to the driver. Note                                 that jars added with --jars are automatically included                               in the  classpath.  --executor-memory MEM       Memory per executor (e.g. 1000M, 2G) (Default: 1G).  --proxy-user NAME           User to impersonate when submitting the application.  --help, -h                  Show this help message and exit  --verbose, -v               Print additional debug output  --version,                  Print the version of current Spark Spark standalone with cluster deploy mode only:  --driver-cores NUM          Cores for driver (Default: 1). Spark standalone or Mesos with cluster deploy mode only:  --supervise                 If given, restarts the driver on failure.  --kill SUBMISSION_ID        If given, kills the driver specified.  --status SUBMISSION_ID      If given, requests the status of the driver specified. Spark standalone and Mesos only:  --total-executor-cores NUM  Total cores for all executors. Spark standalone and YARN only:  --executor-cores NUM        Number of cores per executor. (Default: 1 in YARN                                   mode, or all available cores on the worker in                                       standalone mode) YARN-only:  --driver-cores NUM          Number of cores used by the driver, only in cluster                                 mode (Default: 1).  --queue QUEUE_NAME          The YARN queue to submit to (Default: "default").  --num-executors NUM         Number of executors to launch (Default: 2).  --archives ARCHIVES         Comma separated list of archives to be extracted into                               the working directory of each executor.  --principal PRINCIPAL       Principal to be used to login to KDC, while running on                              secure HDFS.  --keytab KEYTAB             The full path to the file that contains the keytab for                               the principal specified above. This keytab will be                                   copied to the node running the Application Master via                               the Secure Distributed Cache, for renewing the login                                 tickets and the delegation tokens periodically.sc.textFile("hdfs://node00:8020/test.txt").flatMap(_.split(" ")).map((_,1)).reduceByKey(_+_).foreach(println)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Spark-Shell"><a href="#Spark-Shell" class="headerlink" title="Spark Shell"></a>Spark Shell</h1><h2 id="1、-概念："><a href="#1、-概念：" class="headerlink" title="1、 概念："></a>1、 概念：</h2><p>SparkShell 是 Spark 自带的一个快速原型开发工具，也可以说是Spark 的 scala REPL(Read-Eval-Print-Loop),即交互式 shell。支持使用 scala 语言来进行 Spark 的交互式编程。</p><h2 id="2、使用"><a href="#2、使用" class="headerlink" title="2、使用:"></a>2、使用:</h2><p>（配置从HDFS上获取文件）</p><p>(1)启动HDFS，上传文件</p><pre class="line-numbers language-shell"><code class="language-shell">zkServer.sh start   (3台)start-all.sh        (任一台)hadoop dfs -put test.txt /   (任一台：将test.txt文件上传至hdfs的根目录)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>(2)启动standalone集群：在/sbin路径下</p><pre class="line-numbers language-shell"><code class="language-shell">./start-all.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(3)在客户端上启动 spark-shell:</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-shell    (local模式：在控制台打印)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-shell --master spark://node00:7077   （client模式：控制台无打印，可通过web页面查看）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（4）运行 wordcount：</p><pre class="line-numbers language-scala"><code class="language-scala">sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"hdfs://Sunrise/test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_<span class="token operator">+</span>_<span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="三、参数解释：spark-shell"><a href="#三、参数解释：spark-shell" class="headerlink" title="三、参数解释：spark-shell"></a>三、参数解释：spark-shell</h2><pre class="line-numbers language-shell"><code class="language-shell">[root@node00 bin]# ./spark-shell -hUsage: ./bin/spark-shell [options]Options:  --master MASTER_URL         spark://host:port, mesos://host:port, yarn, or local.  --deploy-mode DEPLOY_MODE   Whether to launch the driver program locally                                         ("client") or on one of the worker machines inside the                               cluster ("cluster")(Default: client).  --class CLASS_NAME          Your application's main class (for Java / Scala apps).  --name NAME                 A name of your application.  --jars JARS                 Comma-separated list of local jars to include on the                                 driver and executor classpaths.  --packages                  Comma-separated list of maven coordinates of jars to                                 include on the driver and executor classpaths. Will                                 search the local maven repo, then maven central and                                 any additional remote repositories given by --                                       repositories. The format for thecoordinates should be                               groupId:artifactId:version.  --exclude-packages          Comma-separated list of groupId:artifactId, to exclude                               while  resolving the dependencies provided in --                                     packages to avoid dependency conflicts.  --repositories              Comma-separated list of additional remote repositories                               to search for the maven coordinates given with --                                   packages.  --py-files PY_FILES         Comma-separated list of .zip, .egg, or .py files to                                 place on the PYTHONPATH for Python apps.  --files FILES               Comma-separated list of files to be placed in the                                   working directory of each executor.  --conf PROP=VALUE           Arbitrary Spark configuration property.  --properties-file FILE      Path to a file from which to load extra properties. If                               not specified, this will look for conf/spark-                                       defaults.conf.  --driver-memory MEM         Memory for driver (e.g. 1000M, 2G) (Default: 1024M).  --driver-java-options       Extra Java options to pass to the driver.  --driver-library-path       Extra library path entries to pass to the driver.  --driver-class-path         Extra class path entries to pass to the driver. Note                                 that jars added with --jars are automatically included                               in the classpath.  --executor-memory MEM       Memory per executor (e.g. 1000M, 2G) (Default: 1G).  --proxy-user NAME           User to impersonate when submitting the application.  --help, -h                  Show this help message and exit  --verbose, -v               Print additional debug output  --version,                  Print the version of current Spark Spark standalone with cluster deploy mode only:  --driver-cores NUM          Cores for driver (Default: 1). Spark standalone or Mesos with cluster deploy mode only:  --supervise                 If given, restarts the driver on failure.  --kill SUBMISSION_ID        If given, kills the driver specified.  --status SUBMISSION_ID      If given, requests the status of the driver specified. Spark standalone and Mesos only:  --total-executor-cores NUM  Total cores for all executors. Spark standalone and YARN only:  --executor-cores NUM        Number of cores per executor. (Default: 1 in YARN                                   mode, or all available cores on the worker in                                       standalone mode) YARN-only:  --driver-cores NUM          Number of cores used by the driver, only in cluster                                 mode (Default: 1).  --queue QUEUE_NAME          The YARN queue to submit to (Default: "default").  --num-executors NUM         Number of executors to launch (Default: 2).  --archives ARCHIVES         Comma separated list of archives to be extracted into                               the working directory of each executor.  --principal PRINCIPAL       Principal to be used to login to KDC, while running on                              secure HDFS.  --keytab KEYTAB             The full path to the file that contains the keytab for                               the principal specified above. This keytab will be                                   copied to the node running the Application Master via                               the Secure Distributed Cache, for renewing the login                                 tickets and the delegation tokens periodically.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="SparkUI"><a href="#SparkUI" class="headerlink" title="SparkUI"></a>SparkUI</h1><h2 id="1、SparkUI-界面介绍"><a href="#1、SparkUI-界面介绍" class="headerlink" title="1、SparkUI 界面介绍"></a>1、SparkUI 界面介绍</h2><p>提交spark：在/bin路径下</p><pre class="line-numbers language-shell"><code class="language-shell"> ./spark-submit --master spark://node00:7077 --name sp --class org.apache.spark.example.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar --100<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>注意</code>：–name指代的参数在代码中也有配置，所以对同一参数均有配置时，以代码中的配置为主</p><p>浏览器页面访问：node00:8080  </p><p><code>页面显示</code></p><blockquote><p>点击：Application ID列中的值  →  Application  Detail UI  会显示查看不了事件日志</p><h3 id="Event-logging-is-not-enabled"><a href="#Event-logging-is-not-enabled" class="headerlink" title="Event logging is not enabled"></a>Event logging is not enabled</h3><p>No event logs were found for this application! To <a href="http://spark.apache.org/docs/latest/monitoring.html">enable event logging</a>, set spark.eventLog.enabled to true and spark.eventLog.dir to the directory to which your event logs are written.</p></blockquote><h2 id="2、配置-historyServer"><a href="#2、配置-historyServer" class="headerlink" title="2、配置 historyServer"></a>2、配置 historyServer</h2><ul><li>临时配置，对本次提交的应用程序起作用</li></ul><pre class="line-numbers language-shell"><code class="language-shell">./spark-shell --master spark://node00:7077--name myapp1--conf spark.eventLog.enabled=true--conf spark.eventLog.dir=hdfs://Sunrise/spark/test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>停止程序，在 Web Ui 中 Completed Applications 对应的ApplicationID 中能查看 history。</p><ul><li>spark-default.conf 配置文件中配置 HistoryServer，对所有提交的Application 都起作用</li></ul><p>在 客 户 端 节 点 ， 进 入 ../spark-1.6.0/conf/spark-defaults.conf 最后加入:</p><pre><code>#  开启记录事件日志的功能spark.eventLog.enabled true#  设置事件日志存储的目录spark.eventLog.dir hdfs://Sunrise/spark/test#  设置 HistoryServer  加载事件日志的位置spark.history.fs.logDirectory hdfs://Sunrise/spark/test# 日志优化选项, 压缩日志spark.eventLog.compress true</code></pre><ul><li>发送到其他节点（如果节点上没有以上配置，就不会有对应的作用）</li></ul><p>在HDFS上一定要先存在路径/spark/test</p><pre><code>#hdfs集群一定要启动hadoop dfs -mkdir -p /spark/test</code></pre><p><code>页面显示</code></p><blockquote><p>点击：Application ID列中的值  →  Application  Detail UI  就会有显示内容</p></blockquote><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0d8nkvqzrj310k06zmxl.jpg"></p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0d8r7qsrzj30q50apwgd.jpg"></p><ul><li>启动 HistoryServer：(在/sbin路径下)</li></ul><pre class="line-numbers language-shell"><code class="language-shell">./start-history-server.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（Sunrise在这里是HDFS集群的名字）</p><p>访问 HistoryServer：</p><p>node00:18080,之后所有提交的应用程序运行状况都会被记录。</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0d8t4eeftj30xj079go4.jpg"></p><h1 id="Master-HA"><a href="#Master-HA" class="headerlink" title="Master HA"></a>Master HA</h1><h2 id="1、Master-的高可用原理"><a href="#1、Master-的高可用原理" class="headerlink" title="1、Master 的高可用原理"></a>1、Master 的高可用原理</h2><p>Standalone 集群只有一个 Master，如果 Master 挂了就无法提交应用程序，但不影响正在执行的worker。</p><p>给 Master 进行高可用配置可以使用<strong>fileSystem</strong>(文件系统)和 <strong>zookeeper</strong>（分布式协调服务）。</p><ul><li><p>fileSystem 只有存储功能，可以存储 Master 的元数据信息，用fileSystem 搭建的 Master 高可用，在 Master 失败时，需要我们手动启动另外的备用 Master，这种方式不推荐使用。</p></li><li><p>zookeeper 有选举和存储功能，可以存储 Master 的元素据信息，使用zookeeper 搭建的 Master 高可用，当 Master 挂掉时，备用的 Master会自动切换，推荐使用这种方式搭建 Master 的 HA。</p></li></ul><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0d8unf1yfj30gn0beac3.jpg"></p><h2 id="2、Master-高可用搭建"><a href="#2、Master-高可用搭建" class="headerlink" title="2、Master 高可用搭建"></a>2、Master 高可用搭建</h2><ol><li>在 Spark Master 节点上配置主 Master，配置.spark1.6.0/conf/ spark-env.sh</li></ol><pre class="line-numbers language-sh"><code class="language-sh">export SPARK_DAEMON_JAVA_OPTS="-Dspark.deploy.recoveryMode=ZOOKEEPER-Dspark.deploy.zookeeper.url=node00:2181,node01:2181,node02:2181-Dspark.deploy.zookeeper.dir=/sparkmaster"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>发送到其他 worker 节点上</li></ol><pre class="line-numbers language-shell"><code class="language-shell">scp spark-env.sh node01:`pwd`.......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>找一台节点（非主 Master 节点:node01）配置备用 Master,修改spark-env.sh 配置节点上的 MasterIP</li></ol><pre class="line-numbers language-sh"><code class="language-sh">SPARK_MASTER_IP=192.168.198.130<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>启动集群之前启动 zookeeper 集群：</li></ol><pre><code>zkServer.sh start</code></pre><ol start="5"><li>启动 spark Standalone 集群，启动备用 Master</li></ol><p>node00:(在/sbin路径下)</p><pre><code>./start-all.sh</code></pre><p>node01:</p><pre><code>./start-master.sh</code></pre><ol start="6"><li>打开主 Master 和备用 Master WebUI 页面，观察状态</li></ol><p>主master：</p><blockquote><h3 id="1-6-0-Spark-Master-at-spark-192-168-198-128-7077"><a href="#1-6-0-Spark-Master-at-spark-192-168-198-128-7077" class="headerlink" title=" 1.6.0 Spark Master at spark://192.168.198.128:7077"></a><a href="http://node00:8080/"><img src="http://node00:8080/static/spark-logo-77x50px-hd.png" alt="img"> 1.6.0 </a>Spark Master at spark://192.168.198.128:7077</h3><ul><li><strong>URL:</strong> spark://192.168.198.128:7077</li><li><strong>REST URL:</strong> spark://192.168.198.128:6066 (cluster mode)</li><li><strong>Alive Workers:</strong> 2</li><li><strong>Cores in use:</strong> 2 Total, 0 Used</li><li><strong>Memory in use:</strong> 2.0 GB Total, 0.0 B Used</li><li><strong>Applications:</strong> 0 Running, 6 Completed</li><li><strong>Drivers:</strong> 0 Running, 0 Completed</li><li><strong>Status:</strong> ALIVE</li></ul></blockquote><p>备用master：</p><blockquote><h3 id="1-6-0-Spark-Master-at-spark-192-168-198-130-7077"><a href="#1-6-0-Spark-Master-at-spark-192-168-198-130-7077" class="headerlink" title=" 1.6.0 Spark Master at spark://192.168.198.130:7077"></a><a href="http://node01:8080/"><img src="http://node01:8080/static/spark-logo-77x50px-hd.png" alt="img"> 1.6.0 </a>Spark Master at spark://192.168.198.130:7077</h3><ul><li><strong>URL:</strong> spark://192.168.198.130:7077</li><li><strong>REST URL:</strong> spark://192.168.198.130:6066 (cluster mode)</li><li><strong>Alive Workers:</strong> 0</li><li><strong>Cores in use:</strong> 0 Total, 0 Used</li><li><strong>Memory in use:</strong> 0.0 B Total, 0.0 B Used</li><li><strong>Applications:</strong> 0 Running, 0 Completed</li><li><strong>Drivers:</strong> 0 Running, 0 Completed</li><li><strong>Status:</strong> ALIVE</li></ul></blockquote><ol start="3"><li><p>注意点<br>  主备切换过程中不能提交 Application。<br>  主备切换过程中不影响已经在集群中运行的 Application。因为<br> Spark 是粗粒度资源调度。</p></li><li><p>测试验证<br> 提交 SparkPi 程序，kill 主 Master 观察现象。</p></li></ol><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit --master spark://node00:7077,node01:7077 --class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar 10000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>显示：</code></p><blockquote><p>主备切换有时差，因为也不急</p><p>程序不受影响</p></blockquote>]]></content>
    
    
    <summary type="html">Spark学习第三篇章：Spark Core应用案例学习及spark shell提交和WebUI！</summary>
    
    
    
    <category term="Spark" scheme="https://sukie-sun.github.io/categories/Spark/"/>
    
    
    <category term="sparkcore应用案例" scheme="https://sukie-sun.github.io/tags/sparkcore%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B/"/>
    
    <category term="Spark shell" scheme="https://sukie-sun.github.io/tags/Spark-shell/"/>
    
    <category term="SparkUI" scheme="https://sukie-sun.github.io/tags/SparkUI/"/>
    
  </entry>
  
  <entry>
    <title>Spark学习（二）</title>
    <link href="https://sukie-sun.github.io/2019/02/17/Spark(2)/"/>
    <id>https://sukie-sun.github.io/2019/02/17/Spark(2)/</id>
    <published>2019-02-17T15:30:00.000Z</published>
    <updated>2020-08-08T06:10:17.589Z</updated>
    
    <content type="html"><![CDATA[<h1 id="三、集群搭建及测试"><a href="#三、集群搭建及测试" class="headerlink" title="三、集群搭建及测试"></a>三、集群搭建及测试</h1><h2 id="Standalone"><a href="#Standalone" class="headerlink" title="Standalone"></a><strong>Standalone</strong></h2><h3 id="1、下载安装包、解压"><a href="#1、下载安装包、解压" class="headerlink" title="1、下载安装包、解压"></a>1、下载安装包、解压</h3><p><a href="https://archive.apache.org/dist/spark/">Spark历史版本下载</a></p><p><code>注意</code>： 与Hadoop的版本保持对应。</p><p>此处使用： <a href="https://archive.apache.org/dist/spark/spark-1.6.0/spark-1.6.0-bin-hadoop2.6.tgz">spark-1.6.0-bin-hadoop2.6.tgz</a></p><pre class="line-numbers language-shell"><code class="language-shell">tar -zvxf spark-1.6.0-bin-hadoop2.6.tgz <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2、改名"><a href="#2、改名" class="headerlink" title="2、改名"></a>2、改名</h3><pre><code>mv spark-1.6.0-bin-hadoop2.6 spark-1.6.0</code></pre><h3 id="3、修改slaves"><a href="#3、修改slaves" class="headerlink" title="3、修改slaves"></a>3、修改slaves</h3><p>进入安装包的conf目录下，修改slaves.template文件，添加从节点。并保存。</p><pre class="line-numbers language-shell"><code class="language-shell">#备份cp slaves.template slavesvim slaves<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>常驻进程：master、worker</p></blockquote><p>配置slaves（与worker对应）</p><pre class="line-numbers language-sh"><code class="language-sh">node2node3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="4、修改-spark-env-sh"><a href="#4、修改-spark-env-sh" class="headerlink" title="4、修改 spark-env.sh"></a>4、修改 spark-env.sh</h3><p>改名（备份）</p><pre><code> cp spark-env.sh.template spark-env.sh</code></pre><p>配置spark-env.sh（注意与虚拟机实际配置对应）</p><pre class="line-numbers language-sh"><code class="language-sh">#locally#cluster#YARN client#standalone deploy#配置 java_home 路径JAVA_HOME=/usr/soft/jdk1.8.0_191#master 的 ipSPARK_MASTER_IP=192.168.198.128#提交任务的端口，默认是 7077SPARK_MASTER_PORT=7077#每个 worker 从节点能够支配的 core 的个数SPARK_WORKER_CORES=1#每个 worker 从节点能够支配的内存数SPARK_WORKER_MEMORY=1024m#配置yarnHADOOP_CONF_DIR=/usr/soft/hadoop-2.6.5/etc/hadoop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5、其他节点"><a href="#5、其他节点" class="headerlink" title="5、其他节点"></a>5、其他节点</h3><p>将spark解压文件发送到其他两个节点</p><pre class="line-numbers language-shell"><code class="language-shell">[root@node00 soft]# scp -r  spark-1.6.0-bin-hadoop2.6 node2:`pwd`[root@node00 soft]# scp -r  spark-1.6.0-bin-hadoop2.6 node3:`pwd`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>6、配置环境变量（可不配，因为bin路径中包含start-all ，该命令与hdfs中的命令会冲突）</p><h3 id="7、启动：-node1"><a href="#7、启动：-node1" class="headerlink" title="7、启动：(node1)"></a>7、启动：(node1)</h3><p>在spark的解压文件的/sbin 目录下</p><pre class="line-numbers language-shell"><code class="language-shell">./start-all.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>停止</p><pre class="line-numbers language-shell"><code class="language-shell">./stop-all.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>显示：</p><p>[root@node00 sbin]# ./start-all.sh<br>starting org.apache.spark.deploy.master.Master, logging to /usr/soft/spark-1.6.0-bin-hadoop2.6/logs/spark-root-org.apache.spark.deploymaster.Master-1-node00.out</p><p>node01: starting org.apache.spark.deploy.worker.Worker, logging to /usr/soft/spark-1.6.0-bin-hadoop2.6/logs/spark-root-org.apache.spar.deploy.worker.Worker-1-node01.out</p><p>node02: starting org.apache.spark.deploy.worker.Worker, logging to /usr/soft/spark-1.6.0-bin-hadoop2.6/logs/spark-root-org.apache.spar.deploy.worker.Worker-1-node02.out</p></blockquote><p>查看三台节点的进程</p><p>node00（命令启动的节点）</p><blockquote><pre class="line-numbers language-shell"><code class="language-shell">[root@node00 sbin]# jps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2343 Master<br>2408 Jps</p></blockquote><p>nose01(配置的从节点)</p><blockquote><pre class="line-numbers language-shell"><code class="language-shell">[root@node01 ~]# jps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2292 Jps<br>2229 Worker</p></blockquote><p>node02(从节点)</p><blockquote><pre class="line-numbers language-shell"><code class="language-shell">[root@node02 ~]# jps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>6216 Worker<br>6266 Jps</p></blockquote><p><code>注意：</code></p><blockquote><p>Worker在这里不是真正干活的进程，而是相当于Yarn中的NM。</p><p>它是负责管理所在节点资源的、向Master汇报所在节点的信息（如核数、内存数）</p><p>Master： 监控任务、分发任务、回收计算结果 </p></blockquote><h3 id="8、搭建客户端"><a href="#8、搭建客户端" class="headerlink" title="8、搭建客户端"></a>8、搭建客户端</h3><ul><li>将 spark 安装包原封不动的拷贝到一个新的节点上，然后，在新的节点上提交任务即可。</li></ul><p><code>注意：</code><strong>8080</strong> 是Spark WEBUI页面的端口 ； <strong>7077</strong> 是Spark任务提交的端口</p><p>web页面访问：ip:8080</p><ul><li>修改master的WEBUI端口，</li></ul><p>方法一（永久）：通过修改start-master.sh 文件（在/sbin目录下）</p><pre class="line-numbers language-shell"><code class="language-shell">vim  start-master.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>找到文件内容如下的部分：</p><pre><code>if [ &quot;$SPARK_MASTER_WEBUI_PORT&quot; = &quot;&quot; ]; then  SPARK_MASTER_WEBUI_PORT=8080fi</code></pre><p>方法二：在 Master 节点上导入临时环境变量，只作用于当前进程，重启就无效了。</p><pre class="line-numbers language-shell"><code class="language-shell">[root@node00 sbin]# export SPARK_MASTER_WEBUI_PORT=8080<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>删除临时变量</p><pre class="line-numbers language-shell"><code class="language-shell">[root@node00 sbin]# export -n SPARK_MASTER_WEBUI_PORT<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div align="center"><img src="/2019/02/17/Spark(2)/standalone.jpg" align="middle" alt="SparkWebUI"></div><h2 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h2><h3 id="1、步骤"><a href="#1、步骤" class="headerlink" title="1、步骤"></a>1、步骤</h3><p><strong>1。2。3。4。5。8。</strong>同standalone</p><p>不用Master和Worker，所以不用第7步，我们使用的是yarn中的RM和NM</p><h3 id="2、配置"><a href="#2、配置" class="headerlink" title="2、配置"></a>2、配置</h3><p>添加 HADOOP_CONF_DIR配置</p><p><code>（在使用Yarn时，就能找到关于hdfs的所有配置，其中就包括IP 和Port）</code></p><p>方式一：</p><p>编辑spark-env.sh文件</p><p>方式二：</p><pre class="line-numbers language-shell"><code class="language-shell"> export HADOOP_CONF_DIR=/usr/soft/hadoop-2.6.5/etc/hadoop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="测试：求π值"><a href="#测试：求π值" class="headerlink" title="测试：求π值"></a>测试：求π值</h2><p>Pi案例：</p><div align="center"><img src="/2019/02/17/Spark(2)/π.jpg" align="middle" alt="SparkWebUI"></div><h3 id="源码案例："><a href="#源码案例：" class="headerlink" title="源码案例："></a><strong>源码案例：</strong></h3><p>路径：在spark解压路径spark-1.6.0-bin-hadoop2.6中</p><p>spark-1.6.0-bin-hadoop2.6/examples/src/main/scala/org/apache/spark/examples/SparkPi.scala</p><p>原理：随机产生无穷多个点落入如上图形中，求落入圆中的概率：<br>$$<br>概率   p = π<em>r</em>r/(2r*2r)=π<br>$$</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/* * Licensed to the Apache Software Foundation (ASF) under one or more * contributor license agreements.  See the NOTICE file distributed with * this work for additional information regarding copyright ownership. * The ASF licenses this file to You under the Apache License, Version 2.0 * (the "License"); you may not use this file except in compliance with * the License.  You may obtain a copy of the License at * *    http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token comment" spellcheck="true">// scalastyle:off println</span><span class="token keyword">package</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>examples<span class="token keyword">import</span> scala<span class="token punctuation">.</span>math<span class="token punctuation">.</span>random<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>_<span class="token comment" spellcheck="true">/** Computes an approximation to pi */</span><span class="token keyword">object</span> SparkPi <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"Spark Pi"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// args 运行时传入的参数   slices 分区数量 (决定task数量)</span>    <span class="token keyword">val</span> slices <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> args<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt <span class="token keyword">else</span> <span class="token number">2</span>   <span class="token comment" spellcheck="true">//MaxValue 一个无限大的数   n   随机产生的十万个的数</span>    <span class="token keyword">val</span> n <span class="token operator">=</span> math<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token number">100000L</span> <span class="token operator">*</span> slices<span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">.</span>MaxValue<span class="token punctuation">)</span><span class="token punctuation">.</span>toInt <span class="token comment" spellcheck="true">// avoid overflow</span> <span class="token comment" spellcheck="true">//parallelize可以获得RDD  ，将1~n个数字放到RDD中</span> <span class="token comment" spellcheck="true">//val count :[Int] = spark.parallelize(1 until n, slices)     </span>    <span class="token keyword">val</span> count <span class="token operator">=</span> spark<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span><span class="token number">1</span> until n<span class="token punctuation">,</span> slices<span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> i <span class="token keyword">=></span>      <span class="token keyword">val</span> x <span class="token operator">=</span> random <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span>      <span class="token keyword">val</span> y <span class="token operator">=</span> random <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">*</span>x <span class="token operator">+</span> y<span class="token operator">*</span>y <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"Pi is roughly "</span> <span class="token operator">+</span> <span class="token number">4.0</span> <span class="token operator">*</span> count <span class="token operator">/</span> n<span class="token punctuation">)</span>    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// scalastyle:on println</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所需使用的jar包：spark-examples-1.6.0-hadoop2.6.0.jar</p><p>位置：解压目录的lib路径下</p><p>在任一节点的/bin路径下上执行如下命令：（node1）</p><h3 id="Standalone-提交命令"><a href="#Standalone-提交命令" class="headerlink" title="Standalone 提交命令:"></a><strong>Standalone</strong> 提交命令:</h3><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit    #提交spark --master spark://node3:7077   #spark主节点的地址和端口 --class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar 100   # 指明运行的jar包+路径 和 jar包中执行的包名+类名 100 为传入的参数./spark-submit --master spark://node3:7077 --class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar 100  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>显示：</code></p><p>提交命令的节点（node1主节点）</p><p>会显示执行日志、运算结果</p><pre class="line-numbers language-shell"><code class="language-shell">19/02/13 23:27:31 INFO scheduler.TaskSetManager: Starting task 999.0 in stage 0.0 (TID 999, node02, partition 999,PROCESS_LOCAL, 2158 bytes)19/02/13 23:27:31 INFO scheduler.TaskSetManager: Finished task 995.0 in stage 0.0 (TID 995) in 68 ms on node02 (996/1000)19/02/13 23:27:31 INFO scheduler.TaskSetManager: Finished task 997.0 in stage 0.0 (TID 997) in 131 ms on node01 (997/1000)19/02/13 23:27:31 INFO scheduler.TaskSetManager: Finished task 996.0 in stage 0.0 (TID 996) in 147 ms on node01 (998/1000)19/02/13 23:27:31 INFO scheduler.TaskSetManager: Finished task 999.0 in stage 0.0 (TID 999) in 112 ms on node02 (999/1000)19/02/13 23:27:31 INFO scheduler.TaskSetManager: Finished task 998.0 in stage 0.0 (TID 998) in 115 ms on node02 (1000/1000)19/02/13 23:27:31 INFO scheduler.DAGScheduler: ResultStage 0 (reduce at SparkPi.scala:36) finished in 79.202 s19/02/13 23:27:31 INFO scheduler.TaskSchedulerImpl: Removed TaskSet 0.0, whose tasks have all completed, from pool 19/02/13 23:27:31 INFO scheduler.DAGScheduler: Job 0 finished: reduce at SparkPi.scala:36, took 82.641779 sPi is roughly 3.14148344      #运算结果19/02/13 23:27:32 INFO handler.ContextHandler: stopped o.s.j.s.ServletContextHandler&#123;/metrics/json,null&#125;19/02/13 23:27:32 INFO handler.ContextHandler: stopped o.s.j.s.ServletContextHandler&#123;/stages/stage/kill,null&#125;19/02/13 23:27:32 INFO handler.ContextHandler: stopped o.s.j.s.ServletContextHandler&#123;/api,null&#125;。。。。。。。。。。。。。。。。。。。。。。。。。19/02/13 23:27:32 INFO handler.ContextHandler: stopped o.s.j.s.ServletContextHandler&#123;/jobs/json,null&#125;19/02/13 23:27:32 INFO handler.ContextHandler: stopped o.s.j.s.ServletContextHandler&#123;/jobs,null&#125;19/02/13 23:27:32 INFO ui.SparkUI: Stopped Spark web UI at http://192.168.198.128:404019/02/13 23:27:32 INFO cluster.SparkDeploySchedulerBackend: Shutting down all executors19/02/13 23:27:32 INFO cluster.SparkDeploySchedulerBackend: Asking each executor to shut down19/02/13 23:27:32 INFO spark.MapOutputTrackerMasterEndpoint: MapOutputTrackerMasterEndpoint stopped!19/02/13 23:27:33 INFO storage.MemoryStore: MemoryStore cleared19/02/13 23:27:33 INFO storage.BlockManager: BlockManager stopped19/02/13 23:27:33 INFO storage.BlockManagerMaster: BlockManagerMaster stopped19/02/13 23:27:33 INFO scheduler.OutputCommitCoordinator$OutputCommitCoordinatorEndpoint: OutputCommitCoordinator stopped!19/02/13 23:27:33 INFO remote.RemoteActorRefProvider$RemotingTerminator: Shutting down remote daemon.19/02/13 23:27:33 INFO remote.RemoteActorRefProvider$RemotingTerminator: Remote daemon shut down; proceeding with flushing remote transports.19/02/13 23:27:34 INFO spark.SparkContext: Successfully stopped SparkContext19/02/13 23:27:34 INFO util.ShutdownHookManager: Shutdown hook called19/02/13 23:27:34 INFO util.ShutdownHookManager: Deleting directory /tmp/spark-f7c2019e-10f4-4b31-9308-5a94603de11319/02/13 23:27:35 INFO util.ShutdownHookManager: Deleting directory /tmp/spark-f7c2019e-10f4-4b31-9308-5a94603de113/httpd-39b8b4b3-9b80-4247-9c7e-ed6bd2dc389f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在命令执行期间：</p><p>在三个节点敲如下命令：jps，会显示：</p><p>node1：</p><pre class="line-numbers language-shell"><code class="language-shell">[root@node1 ~]# jps4903 Jps2343 Master4764 SparkSubmit  #代表是提交spark的节点 (与主从无关)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>node2和node3：</p><pre class="line-numbers language-shell"><code class="language-shell">[root@node2 bin]# jps2229 Worker5096 CoarseGrainedExecutorBackend    #代表是干活的节点 （仅为从节点进程）5167 Jps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果提交命令的节点是从节点（node2），则在该节点上会显示执行日志、运算结果</p><p>则在提交过程中，敲命令：jps  该节点会显示</p><pre class="line-numbers language-shell"><code class="language-shell">[root@node2 ~]# jps5298 CoarseGrainedExecutorBackend  #代表是干活的节点 （仅为从节点进程）2229 Worker5323 Jps5213 SparkSubmit #代表是提交spark的节点 (与主从无关)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="YARN-提交命令："><a href="#YARN-提交命令：" class="headerlink" title="YARN 提交命令："></a><strong>YARN</strong> 提交命令：</h3><p>基于Hadoop ：</p><table><thead><tr><th align="center"></th><th align="center">NN</th><th align="center">DN</th><th align="center">JN</th><th align="center">ZKFC</th><th align="center">ZK</th><th align="center">RM</th><th align="center">NM</th><th align="center">Master</th><th align="center">slave</th></tr></thead><tbody><tr><td align="center">node1</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center"></td><td align="center">√</td><td align="center"></td><td align="center">√</td></tr><tr><td align="center">node2</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center"></td><td align="center">√</td></tr><tr><td align="center">node3</td><td align="center"></td><td align="center">√</td><td align="center">√</td><td align="center"></td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center">√</td><td align="center"></td></tr></tbody></table><p>启动zookeeper ：（3台）</p><pre class="line-numbers language-shell"><code class="language-shell">zkServer.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>启动hdfs ：（1台）</p><pre class="line-numbers language-shell"><code class="language-shell">start-all.sh     <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>相当于：Instead use start-dfs.sh and start-yarn.sh</p><p>启动resourcemanager ：(在RM的主节点上启动 ：1台)</p><pre class="line-numbers language-shell"><code class="language-shell">yarn-daemon.sh start resourcemanager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在任一节点的/bin路径下执行：（node01）</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master yarn #HADOOP_CONF_DIR配置使得在使用Yarn时能找到hdfs的所有配置，其中就有IP 和Port--class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar 100./spark-submit --master yarn --class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar 1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>显示</code></p><blockquote><ul><li><p>执行日志、计算结果会在执行提交命令的节点上显示</p></li><li><p>在命令提交过程中在三台节点上敲命令：jps 会显示</p></li></ul><p>node02：</p><p>[root@node02 ~]# jps<br>3406 DataNode<br>3491 JournalNode<br>1681 QuorumPeerMain<br>4133 CoarseGrainedExecutorBackend    # 真正干活的进程<br>4092 ExecutorLauncher     # 启动executor<br>3585 NodeManager<br>3942 SparkSubmit     #提交spark的进程<br>4217 Jps</p></blockquote><h1 id="四、Standalone-模式两种提交任务方式"><a href="#四、Standalone-模式两种提交任务方式" class="headerlink" title="四、Standalone 模式两种提交任务方式"></a>四、Standalone 模式两种提交任务方式</h1><h2 id="1、Standalone-client-提交任务方式"><a href="#1、Standalone-client-提交任务方式" class="headerlink" title="1、Standalone-client 提交任务方式"></a>1、Standalone-client 提交任务方式</h2><h3 id="1-命令提交"><a href="#1-命令提交" class="headerlink" title="(1)命令提交"></a>(1)命令提交</h3><ul><li>在/sbin路径下：</li></ul><pre class="line-numbers language-shell"><code class="language-shell">./start-all.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>提交spark</li></ul><p>方式一：</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master spark://node00:7077--class org.apache.spark.examples.SparkPi../lib/spark-examples-1.6.0-hadoop2.6.0.jar1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>方式二：</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master spark://node1:7077--deploy-mode client--class org.apache.spark.examples.SparkPi../lib/spark-examples-1.6.0-hadoop2.6.0.jar1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-执行原理图"><a href="#2-执行原理图" class="headerlink" title="(2)执行原理图"></a>(2)执行原理图</h3><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g09rz47usdj31b40vhq5r.jpg"></p><h3 id="3-执行流程"><a href="#3-执行流程" class="headerlink" title="(3)执行流程"></a>(3)执行流程</h3><blockquote><ol><li>client 模式提交任务后，会在客户端启动 Driver 进程。</li><li>Driver 会向 Master 申请启动 Application 启动的资源。</li><li>资源申请成功，Driver 端将 task 发送到 worker 端执行。</li><li>worker 将 task 执行结果返回到 Driver 端</li></ol></blockquote><h3 id="4-总结"><a href="#4-总结" class="headerlink" title="(4)总结"></a>(4)总结</h3><blockquote><ul><li><p>client 模式适用于测试调试程序。</p></li><li><p>Driver 进程是在客户端启动的，这里的客户端就是指提交应用程序的当前节点。</p></li><li><p>在 Driver 端可以看到 task 执行的情况。生产环境下不能使用 client 模式，</p></li></ul><p><code>是因为</code>：</p><p>假设要提交 100 个 application 到集群运行，Driver 每次都会在client 端启动，那么就会导致客户端 100 次网卡流量暴增的问题。</p></blockquote><h2 id="2、Standalone-cluster-提交任务方式"><a href="#2、Standalone-cluster-提交任务方式" class="headerlink" title="2、Standalone-cluster 提交任务方式"></a>2、Standalone-cluster 提交任务方式</h2><h3 id="（1）命令提交"><a href="#（1）命令提交" class="headerlink" title="（1）命令提交"></a>（1）命令提交</h3><ul><li>在/sbin路径下：</li></ul><pre class="line-numbers language-shell"><code class="language-shell">./start-all.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>提交spark</li></ul><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master spark://node00:7077--deploy-mode cluster--class org.apache.spark.examples.SparkPi../lib/spark-examples-1.6.0-hadoop2.6.0.jar1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>注意：</code></p><blockquote><p>Standalone-cluster 提交方式，应用程序使用的所有 jar 包和文件，必须保证所有的 worker 节点都要有，因为此种方式，spark 不会自动上传jar包。</p><p>Standalone-client 和yarn 模式会在提交命令的时候自动uploading  实现jar包共享，</p><p>解决方式：</p><p>1、将所有的依赖包和文件各放一份在 worker 节点上。</p><p>2、将所有的依赖包和文件打到同一个包中，然后放在 hdfs 上。(路径需指定为hdfs上的路径)</p><blockquote><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master spark://node00:7077--deploy-mode cluster--class org.apache.spark.examples.SparkPihdfs://Sunrise/lib/spark-examples-1.6.0-hadoop2.6.0.jar1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote></blockquote><h3 id="（2）执行原理图"><a href="#（2）执行原理图" class="headerlink" title="（2）执行原理图"></a>（2）执行原理图</h3><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g09rzbjqjlj310w0qcwgh.jpg"></p><h3 id="（3）执行流程"><a href="#（3）执行流程" class="headerlink" title="（3）执行流程"></a>（3）执行流程</h3><blockquote><ol><li>cluster 模式提交应用程序后，会向 Master 请求启动 Driver.</li><li>Master 接受请求，随机在集群一台节点启动 Driver 进程。</li><li>Driver 启动后为当前的应用程序申请资源。</li><li>Driver 端发送 task 到 worker 节点上执行。</li><li>worker 将执行情况和执行结果返回给 Driver 端。</li></ol></blockquote><h3 id="（4）总结"><a href="#（4）总结" class="headerlink" title="（4）总结"></a>（4）总结</h3><blockquote><p>Driver 进程是在集群某一台 Worker 上启动的，在客户端是无法查看 task 的执行情况的。假设要提交 100<br>个 application 到集群运行,每次 Driver 会随机在集群中某一台 Worker 上启动，那么这 100 次网卡流量暴<br>增的问题就散布在集群上</p></blockquote><h2 id="总结-Standalone"><a href="#总结-Standalone" class="headerlink" title="总结 Standalone"></a>总结 Standalone</h2><p>Standalone  两种方式提交任务，Driver  与集群的通信包括：</p><blockquote><ol><li>Driver 负责应用程序资源的申请</li><li>任务的分发。</li><li>结果的回收。</li><li>监控 task 执行情况。</li></ol></blockquote><h1 id="五、Yarn-模式两种提交任务方式"><a href="#五、Yarn-模式两种提交任务方式" class="headerlink" title="五、Yarn  模式两种提交任务方式"></a>五、Yarn  模式两种提交任务方式</h1><h2 id="1、yarn-client-提交任务方式"><a href="#1、yarn-client-提交任务方式" class="headerlink" title="1、yarn-client 提交任务方式"></a>1、yarn-client 提交任务方式</h2><h3 id="（1）命令提交-1"><a href="#（1）命令提交-1" class="headerlink" title="（1）命令提交"></a>（1）命令提交</h3><ul><li>提交spark</li></ul><p>方式一：</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master yarn--class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>方式二：</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master yarn–client--class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>方式三：</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master yarn--deploy-mode client--classorg.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（2）执行原理图-1"><a href="#（2）执行原理图-1" class="headerlink" title="（2）执行原理图"></a>（2）执行原理图</h3><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g09rzg6auij31750x4dj9.jpg"></p><h3 id="（3）执行流程-1"><a href="#（3）执行流程-1" class="headerlink" title="（3）执行流程"></a>（3）执行流程</h3><blockquote><ol><li>客户端提交一个 Application，在客户端启动一个 Driver 进程。</li><li>应用程序启动后会向 RS(ResourceManager)发送请求，启动AM(ApplicationMaster)的资源。</li><li>RS 收到请求，随机选择一台 NM(NodeManager)启动 AM。这里的 NM 相当于 Standalone 中的Worker 节点。</li><li>AM启动后，会向RS请求一批container资源，用于启动Executor.</li><li>RS 会找到一批 NM 返回给 AM,用于启动 Executor。</li><li>AM 会向 NM 发送命令启动 Executor。</li><li>Executor 启动后，会反向注册给 Driver，Driver 发送 task 到Executor,执行情况和结果返回给 Driver 端。</li></ol></blockquote><h3 id="（4）总结-1"><a href="#（4）总结-1" class="headerlink" title="（4）总结"></a>（4）总结</h3><blockquote><p>Yarn-client 模式同样是适用于测试，因为 Driver 运行在本地，Driver会与 yarn 集群中的 Executor 进行大量的通信，会造成客户机网卡流量的大量增加.</p></blockquote><blockquote><ul><li>ApplicationMaster  的作用：</li></ul><ol><li>为当前的 Application 申请资源</li><li>给 NodeManager 发送消息启动 Executor。</li></ol><ul><li>注意：</li></ul><p>ApplicationMaster 有 launchExecutor 和申请资源的功能，并没有作业调度的功能</p></blockquote><h2 id="2、yarn-cluster-提交任务方式"><a href="#2、yarn-cluster-提交任务方式" class="headerlink" title="2、yarn-cluster 提交任务方式"></a>2、yarn-cluster 提交任务方式</h2><h3 id="（1）命令提交-2"><a href="#（1）命令提交-2" class="headerlink" title="（1）命令提交"></a>（1）命令提交</h3><ul><li>提交spark</li></ul><p>方式一：</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master yarn--deploy-mode cluster--classorg.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>方式二:</p><pre class="line-numbers language-shell"><code class="language-shell">./spark-submit--master yarn-cluster--classorg.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（2）执行原理图-2"><a href="#（2）执行原理图-2" class="headerlink" title="（2）执行原理图"></a>（2）执行原理图</h3><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g09rzn3fuwj318x0weq60.jpg"></p><h3 id="（3）执行流程-2"><a href="#（3）执行流程-2" class="headerlink" title="（3）执行流程"></a>（3）执行流程</h3><blockquote><ol><li>客户机提交 Application 应用程序，发送请求到RS(ResourceManager),请求启动AM(ApplicationMaster)。</li><li>RS 收到请求后随机在一台 NM(NodeManager)上启动 AM（相当于 Driver 端）。</li><li>AM 启动，AM 发送请求到 RS，请求一批 container 用于启动Excutor。</li><li>RS 返回一批 NM 节点给 AM。</li><li>AM 连接到 NM,发送请求到 NM 启动 Excutor。</li><li>Excutor 反向注册到 AM 所在的节点的 Driver。Driver 发送 task到 Excutor。</li></ol></blockquote><h3 id="（4）总结-2"><a href="#（4）总结-2" class="headerlink" title="（4）总结"></a>（4）总结</h3><blockquote><p>Yarn-Cluster 主要用于生产环境中，</p><p>因为 Driver 运行在 Yarn 集群中某一台 nodeManager 中，每次提交任务的 Driver 所在的机器都是<br>随机的，不会产生某一台机器网卡流量激增的现象，</p><p>缺点是任务提交后不能看到日志。只能通过 yarn 查看日志。</p></blockquote><blockquote><ul><li>ApplicationMaster  的作用：</li></ul><ol><li>为当前的 Application 申请资源</li><li>给 NodeManger 发送消息启动 Excutor。</li><li>任务调度。</li></ol><ul><li>停止集群任务命令：yarn application -kill applicationID</li></ul></blockquote><h2 id="总结yarn"><a href="#总结yarn" class="headerlink" title="总结yarn"></a>总结yarn</h2><h1 id="六、术语解释"><a href="#六、术语解释" class="headerlink" title="六、术语解释"></a>六、术语解释</h1><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0bt4g8pk2j30h909ajtj.jpg"></p><h1 id="七、宽窄依赖"><a href="#七、宽窄依赖" class="headerlink" title="七、宽窄依赖"></a>七、宽窄依赖</h1><h2 id="1、窄依赖"><a href="#1、窄依赖" class="headerlink" title="1、窄依赖"></a>1、窄依赖</h2><p>父RDD的一个partition对应子RDD**<code>一个</code>**partition</p><p>父RDD的多个partition对应子RDD**<code>一个</code>**partition</p><p>不会产生shuffle</p><pre><code>mapflatmapfilterunion</code></pre><h2 id="2、宽依赖"><a href="#2、宽依赖" class="headerlink" title="2、宽依赖"></a>2、宽依赖</h2><p>父RDD的一个partition对应子RDD**<code>多个</code>**partition</p><p>会产生shuffle</p><p>会划分stage</p><pre><code>reduceByKeyjoingroupBy</code></pre><h1 id="八、stage"><a href="#八、stage" class="headerlink" title="八、stage"></a>八、stage</h1><h2 id="0、概念"><a href="#0、概念" class="headerlink" title="0、概念"></a>0、概念</h2><p>（1）Spark任务会根据RDD之间的依赖关系，形成一个DAG有向无环图，DAG会提交给DAGScheduler，DAGScheduler会把DAG划分相互依赖的多个stage，划分依据就是RDD之间的宽窄依赖关系：遇到宽依赖就划分stage</p><p>（2）stage内有一组并行的task组成，这些task将以taskSet的格式提交给TaskScheduler运行</p><p>（2）task运行时，stage之间的关系可能并行，也可能串行</p><h2 id="1、stage-切割规则"><a href="#1、stage-切割规则" class="headerlink" title="1、stage 切割规则"></a>1、stage 切割规则</h2><p>切割规则：从后往前，遇到宽依赖就切割 stage。</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0ae0bta21j30mh0fvn7b.jpg"></p><h2 id="2、stage-计算模式"><a href="#2、stage-计算模式" class="headerlink" title="2、stage 计算模式"></a>2、stage 计算模式</h2><p>pipeline 管道计算模式,pipeline 只是一种计算思想、模式。</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0ae32q68ij30mz08s3zo.jpg"></p><blockquote><ul><li>数据在内存中流转</li><li>数据一直在管道里面什么时候数据会落地？</li></ul><ol><li>对 RDD 进行持久化(cache、persisit)。</li><li>shuffle write 的时候。</li></ol></blockquote><blockquote><ul><li>什么决定task数</li></ul><p>Stage 的 的 task  并行度是由 stage 的最后一个RDD的分区数来决定的 （partition分区数决定task数）</p><p>同一个stage中的task计算逻辑可能不同</p></blockquote><blockquote><ul><li>如何改变 RDD  的分区数？</li></ul><p>宽依赖可改分区数；（因为此时数据已落地到磁盘）</p><p>textFile(“  ”,5)</p><p>reduceByKey(_ +_ , 5)</p><p>GroupByKey(4)</p></blockquote><blockquote><ul><li>测试验证 pipeline 计算模式</li></ul><p><code>注意：</code>textFile(“./wc.txt”)是通过文件获得RDD，parallelize()是通过转换参数内容获得RDD</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"pipeline"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token keyword">val</span> rdd <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">val</span> rdd1 <span class="token operator">=</span> rdd<span class="token punctuation">.</span>map <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span><span class="token string">"map--------"</span><span class="token operator">+</span>x<span class="token punctuation">)</span>       x      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">val</span> rdd2 <span class="token operator">=</span> rdd1<span class="token punctuation">.</span>filter <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>println<span class="token punctuation">(</span><span class="token string">"fliter********"</span><span class="token operator">+</span>x<span class="token punctuation">)</span><span class="token boolean">true</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>rdd2<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>print<span class="token operator">+</span><span class="token string">","</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//1,2,3,4</span>sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>显示：</code></p><p>map——–1</p><p>fliter**<strong>**</strong>1</p><p>map——–2</p><p>fliter**<strong>**</strong>2</p><p>map——–3</p><p>fliter**<strong>**</strong>3</p><p>map——–4</p><p>fliter**<strong>**</strong>4</p></blockquote><h1 id="九、Spark-资源调度和任务调度"><a href="#九、Spark-资源调度和任务调度" class="headerlink" title="九、Spark  资源调度和任务调度"></a>九、Spark  资源调度和任务调度</h1><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0ae6j5tccj30nb0ctq8y.jpg"></p><h2 id="1、概念解释"><a href="#1、概念解释" class="headerlink" title="1、概念解释"></a>1、概念解释</h2><ul><li><strong>DAGScheduler</strong>是任务调度的高层调度器，是一个对象</li></ul><blockquote><p> DAGScheduler 的主要作用就是</p><p>将DAG 根据 RDD 之间的宽窄依赖关系划分为一个个的 Stage，然后将这些Stage 以 TaskSet 的形式提交给 TaskScheduler</p></blockquote><ul><li><p><strong>TaskScheduler</strong> 是任务调度的低层调度器</p></li><li><p><strong>TaskSet</strong> 其实就是一个集合，里面封装的就是一个个的 task 任务,也就是 stage 中的并行度 task 任务</p></li></ul><p>Application→Job→Stage→Task</p><ul><li><strong>Spark推测执行机制</strong></li></ul><blockquote><p>如果有运行缓慢的task,那么TaskScheduler就会启动一个新的task（在不同节点的excutor上）来执行相同的处理逻辑，两个task中哪个task先执行结束，就以那个task的执行结果为准。</p><p>在 Spark 中推测执行默认是关闭的。</p><p>推测执行可以通过 spark.speculation 属性来配置。<br><code>注意：</code></p><ul><li><p>对于 ETL 类型要入数据库的业务要关闭推测执行机制，这样就不会有重复的数据入库。</p></li><li><p>如果遇到数据倾斜的情况，开启推测执行则有可能导致一直会有task重新启动处理相同的逻辑，任务可能一直处于处理不完的状态。（这时候task慢是因为数据量过多，而不是执行性能不行）</p></li></ul></blockquote><h2 id="2、Spark-资源调度和任务调度的流程："><a href="#2、Spark-资源调度和任务调度的流程：" class="headerlink" title="2、Spark 资源调度和任务调度的流程："></a>2、Spark 资源调度和任务调度的流程：</h2><blockquote><p>1、启动集群后，Worker 节点会向 Master 节点汇报资源情况，Master 掌握了集群资源情况。</p><p>2、当 Spark 提交一个 Application 后，根据 RDD 之间依赖关系将 Application 形成一个 DAG 有向无环图。</p><p>3、任务提交后，Spark 会在Driver 端创建两个对象：DAGScheduler 和 TaskScheduler，</p><p>DAGScheduler 将DAG 根据 RDD 之间的宽窄依赖关系划分为一个个的 Stage，然后将这些Stage 以 TaskSet 的形式提交给 TaskScheduler，</p><p>TaskSchedule 会遍历TaskSet 集合，拿到每个 task 后会将 task 发送到计算节点 Executor 中去执行（其实就是发送到 Executor 中的线程池 ThreadPool 去执行）。</p><p>task 在Executor 线程池中的运行情况会向 TaskScheduler 反馈，当 task 执行失败时，则由 TaskScheduler 负责重试，将 task 重新发送给 Executor 去执行，默认重试 3 次。如果重试 3 次依然失败，那么这个 task 所在的 stage 就失败了。</p><p>stage 失败了则由 DAGScheduler 来负责重试，重新发送 TaskSet 到TaskSchdeuler，Stage 默认重试 4 次。如果重试 4 次以后依然失败，那么这个 job 就失败了。job 失败了，Application 就失败了。</p><p>TaskScheduler 不仅能重试失败的 task,还会重试 straggling*&lt;落后，缓慢的&gt;*task（也就是执行速度比其他 task 慢太多的 task）。如果有运行缓慢的 task那么 TaskScheduler 会启动Spark 的推测执行机制先执行完，task 的执行结果为准。</p></blockquote><h2 id="3、资源调度和任务调度的流程图"><a href="#3、资源调度和任务调度的流程图" class="headerlink" title="3、资源调度和任务调度的流程图"></a>3、资源调度和任务调度的流程图</h2><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g0aeo4szikj30mt0bcgte.jpg"></p><h2 id="4、粗粒度资源申请和细粒度资源申请"><a href="#4、粗粒度资源申请和细粒度资源申请" class="headerlink" title="4、粗粒度资源申请和细粒度资源申请"></a>4、粗粒度资源申请和细粒度资源申请</h2><ul><li><p><strong>粗粒度资源申请</strong>(Spark）<br>在 Application 执行之前，将所有的资源申请完毕，当资源申请成功后，才会进行任务的调度，当所有的 task 执行完成后，才会释放这部分资源。</p><blockquote><ul><li><p><strong><code>优点：</code></strong></p><p>在 Application 执行之前，所有的资源都申请完毕，每一个task 直接使用资源就可以了，不需要 task 在执行前自己去申请资源，task 启动就快了，task 执行快了，stage 执行就快了，job 就快了，application 执行就快了。</p></li><li><p><strong><code>缺点：</code></strong></p><p>直到最后一个 task 执行完成才会释放资源，集群的资源无法充分利用。</p></li></ul></blockquote></li><li><p><strong>细粒度资源申请</strong><br>Application 执行之前不需要先去申请资源，而是直接执行，让 job中的每一个 task 在执行前自己去申请资源，task 执行完成就释放资源。</p><blockquote><p><strong><code>优点</code>：</strong></p><p>集群的资源可以充分利用。</p><p>**<code>缺点</code>**：</p><p>task 自己去申请资源，task 启动变慢，Application 的运行就响应的变慢了。</p></blockquote></li></ul>]]></content>
    
    
    <summary type="html">Spark的详细学习第二篇章:Apache Spark 主要架构概念介绍及环境搭建。</summary>
    
    
    
    <category term="Spark" scheme="https://sukie-sun.github.io/categories/Spark/"/>
    
    
    <category term="计算框架" scheme="https://sukie-sun.github.io/tags/%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>Spark学习（一）</title>
    <link href="https://sukie-sun.github.io/2019/02/16/Spark(1)/"/>
    <id>https://sukie-sun.github.io/2019/02/16/Spark(1)/</id>
    <published>2019-02-16T13:30:15.000Z</published>
    <updated>2020-08-09T11:28:45.803Z</updated>
    
    <content type="html"><![CDATA[<hr><h1 id="一、Spark简介"><a href="#一、Spark简介" class="headerlink" title="一、Spark简介"></a>一、Spark简介</h1><h2 id="1、什么是Spark？"><a href="#1、什么是Spark？" class="headerlink" title="1、什么是Spark？"></a>1、什么是Spark？</h2><blockquote><p>Lightning-fast unified analytics engine</p><p>Apache Spark 是专为大规模数据处理而设计的快速通用的计算引擎。</p></blockquote><p>用于逻辑回归算法：</p><p>快速(100倍)：能更好的的适用于数据挖掘与机器学习等需要迭代的算法（在计算结果的基础上再计算）；Job的中间结果值在内存中流转，不需要读取HDFS，屏蔽磁盘开销；DAG调度</p><p>mr：离线，（迭代时：磁盘IO，较慢）</p><p>storm：流式</p><blockquote><p>Spark是用Scala编写的，方便快速编程</p></blockquote><h2 id="2、与MapReduce的区别"><a href="#2、与MapReduce的区别" class="headerlink" title="2、与MapReduce的区别"></a>2、与MapReduce的区别</h2><ul><li>MapReduce</li></ul><div align="center"><img src="/2019/02/16/Spark(1)/mr.jpg" align="middle" alt="MapReduce底层原理"></div><div align="center"><img src="/2019/02/16/Spark(1)/mr1.jpg" align="middle" alt="MapeduceIO原理"></div><ul><li>Spark</li></ul><div align="center"><img src="/2019/02/16/Spark(1)/spark.jpg" align="middle" alt="SparkIO原理"></div><p>区别：</p><blockquote><p>同：分布式计算框架</p><p>不同：</p><ul><li>Spark基于内存，MR基于HDFS</li><li>Spark处理数据的能力是MR的十倍以上</li><li>Spark除了基于内存计算之外，还有DAG有向无环图来切分任务的执行顺序</li></ul></blockquote><p>Spark API  的使用语言</p><blockquote><p>Scala（很好）<br>Python(不错)<br>Java(…)</p></blockquote><h2 id="3、Spark运行模式"><a href="#3、Spark运行模式" class="headerlink" title="3、Spark运行模式"></a>3、Spark运行模式</h2><ul><li>local</li></ul><p>多用于本地测试，如在 eclipse，idea 中写程序测试</p><ul><li>standalone</li></ul><p>standalone是Spark自带的资源调度框架，它支持完全分布式</p><ul><li>yarn</li></ul><p>Hadoop生态圈的资源调度框架，Spark也是可以基于yarn来计算的</p><blockquote><p>基于yarn来进行资源调度，必须实现ApplicationMaster接口，Spark实现的这个接口，所以可以使用</p></blockquote><ul><li>mesos</li></ul><p>资源调度框架</p><h1 id="二、Sparkcore"><a href="#二、Sparkcore" class="headerlink" title="二、Sparkcore"></a>二、Sparkcore</h1><h2 id="1、RDD"><a href="#1、RDD" class="headerlink" title="1、RDD"></a>1、RDD</h2><h3 id="（1）概念："><a href="#（1）概念：" class="headerlink" title="（1）概念："></a>（1）概念：</h3><p>RDD(Resilient Distributed Dateset)弹性分布式数据集</p><h3 id="（2）五大特性"><a href="#（2）五大特性" class="headerlink" title="（2）五大特性"></a>（2）五大特性</h3><blockquote><ol><li>RDD 是由一系列的 partition 组成的。</li><li>函数是作用在每一个 partition（split）上的。</li><li>RDD 之间有一系列的依赖关系。</li><li>分区器是作用在 K,V 格式的 RDD 上。</li><li>RDD 提供一系列最佳的计算位置。</li></ol></blockquote><blockquote><ul><li><code>获取RDD的方式</code></li><li>parallelize()</li></ul><blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Distribute a local Scala collection to form an RDD</span>JavaRDD<span class="token operator">&lt;</span>T<span class="token operator">></span> rdd <span class="token operator">=</span> javaSparkContext<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">)</span>；JavaRDD<span class="token operator">&lt;</span>T<span class="token operator">></span> rdd <span class="token operator">=</span> javaSparkContext<span class="token punctuation">.</span><span class="token function">parallelize</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">,</span><span class="token keyword">int</span> numSlices<span class="token punctuation">)</span>；    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></blockquote><ul><li>parallelizePairs</li></ul><blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Distribute a local Scala collection to form an RDD</span>JavaPairRDD<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> rdd <span class="token operator">=</span>      javaSparkContext<span class="token punctuation">.</span><span class="token function">parallelizePairs</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">>></span> list<span class="token punctuation">)</span>；     JavaPairRDD<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> rdd <span class="token operator">=</span>      javaSparkContext<span class="token punctuation">.</span><span class="token function">parallelizePairs</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">>></span> list<span class="token punctuation">,</span><span class="token keyword">int</span> numSlices<span class="token punctuation">)</span>；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><ul><li>textFile(“./xx.txt”)   也可指定分区</li></ul></blockquote><h3 id="（3）RDD理解图"><a href="#（3）RDD理解图" class="headerlink" title="（3）RDD理解图"></a>（3）RDD理解图</h3><div align="center"><img src="/2019/02/16/Spark(1)/rdd1.jpg" align="middle" alt="rdd1原理"></div><p><code>理论注解</code></p><blockquote><ul><li><p>RDD  实际上不存储数据，这里方便理解，暂时理解为存储数据。</p></li><li><p>textFile 方法底层封装的是MR 读取文件的方式(先 split,再读取文件)，默认 split 大小是一个 block 大小。</p></li><li><p>RDD 提供计算最佳位置，体现了数据本地化。体现了大数据中“计算移动数据不移动”的理念。</p></li></ul><p>❔  哪里体现 RDD 的分布式？</p><p>👆  RDD 是由 Partition 组成，partition 是分布在不同节点上的。</p><p>❔  哪里体现 RDD 的弹性（容错）？</p><p>👆 partition 数量，大小没有限制,默认和split（block）一致，体现了 RDD 的弹性。<br>👆 RDD 之间依赖关系，可以基于上一个 RDD 重新计算出 RDD。</p><p>❔  什么是 K,V 格式的 RDD?</p><p>👆 如果 RDD 里面存储的数据都是二元组对象，那么这个 RDD 我们就叫做 K,V 格式的 RDD。</p><p>👆 MR有分区器（根据key值求hash，来决定数据存放在哪个分区中，所以分区器必须作用在K，V格式的RDD上）</p></blockquote><div align="center"><img src="/2019/02/16/Spark(1)/rdd.jpg" align="middle" alt="rdd关系"></div><h2 id="2、Spark任务执行原理"><a href="#2、Spark任务执行原理" class="headerlink" title="2、Spark任务执行原理"></a>2、Spark任务执行原理</h2><div align="center"><img src="/2019/02/16/Spark(1)/Spark任务执行原理.png" align="middle" alt="Spark任务执行原理"></div><div align="center"><img src="/2019/02/16/Spark(1)/Spark任务执行原理0.png" align="middle" alt="Spark任务执行原理"></div><p>Driver：（相当于ApplicationMaster）</p><p>Worker：（相当于NodeManager）</p><p>以上图中有四个机器节点，</p><p>Driver 和 Worker 是启动在节点上的进程，<br>运行在 JVM 中的进程。<br> Driver 与集群节点之间有频繁的通信。<br> Driver：任务的调度（监控任务、 负责任务(tasks)的分发和结果的回收）。如果 task<br>的计算结果非常大就不要回收了。会造成 oom。<br> Worker 是 Standalone 资源调度框架里面资源管理的从节点。也是JVM 进程。<br> Master 是 Standalone 资源调度框架里面资源管理的主节点。也是JVM 进程。</p><h2 id="3、Spark代码流程"><a href="#3、Spark代码流程" class="headerlink" title="3、Spark代码流程"></a>3、Spark代码流程</h2><h3 id="以用Scala编写WordCount为例"><a href="#以用Scala编写WordCount为例" class="headerlink" title="以用Scala编写WordCount为例"></a><code>以用Scala编写WordCount为例</code></h3><p>1、创建 SparkConf 对象<br> 可以设置 Application name。<br> 可以设置运行模式及资源需求。</p><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">/**          * 几种运行方式：          *   1.本地运行          *   2.yarn          *   3.standalone          *   4.mesos          */</span>  conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"wc"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、创建 SparkContext 对象</p><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token keyword">val</span>  context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3、基于 Spark 的上下文创建一个 RDD，对 RDD 进行处理。</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">//获取文件中每一行数据的ADD</span> <span class="token keyword">val</span> lineADD <span class="token operator">=</span> context<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./wc.txt"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//获取每一行数据按空格切分后的ADD</span> <span class="token keyword">val</span> wordADD <span class="token operator">=</span> lineADD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//获取每个单词加上,1 后的ADD（K,V格式）</span> <span class="token keyword">val</span> KVADD <span class="token operator">=</span> wordADD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//获取将相同key的value相加后的ADD（K,V格式），相当于Tuple2</span> <span class="token keyword">val</span> resultADD <span class="token operator">=</span> KVADD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x<span class="token operator">+</span>y<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//降序排序</span> <span class="token keyword">val</span> sortADD <span class="token operator">=</span> resultADD<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>4、应用程序中要有 Action 类算子来触发 Transformation 类算子执行。</p><pre class="line-numbers language-scala"><code class="language-scala">sortADD<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>5、关闭 Spark 上下文对象 SparkContext。</p><pre class="line-numbers language-scala"><code class="language-scala">context<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="4、Transformations-转换算子"><a href="#4、Transformations-转换算子" class="headerlink" title="4、Transformations 转换算子"></a>4、Transformations 转换算子</h2><h3 id="（1）概念"><a href="#（1）概念" class="headerlink" title="（1）概念"></a>（1）概念</h3><p>Transformations 类算子是一类算子（函数）叫做转换算子，如map,flatMap,reduceByKey 等。Transformations 算子是延迟执行，也叫懒加载执行。</p><blockquote><p>有action触发算子任务才能提交，才会执行runjob</p><p>算子必须作用在RDD上</p></blockquote><h3 id="（2）Transformation-类算子"><a href="#（2）Transformation-类算子" class="headerlink" title="（2）Transformation 类算子"></a>（2）Transformation 类算子</h3><blockquote><p>:arrow_up_small: <strong>filter</strong><br>过滤符合条件的记录数，true 保留，false 过滤掉。</p><p>🔼 <strong>contains</strong></p><p>作为条件，是否包含，返回true|false</p></blockquote><blockquote><p>:arrow_up_small:<strong>map</strong><br>将一个 RDD 中的每个数据项，通过 map 中的函数映射变为一个新的元素。<br>特点：输入一条，输出一条数据。</p><p>:black_joker: <strong>mapToPair</strong>   (Java)</p><p>将RDD（如lineRDD）转换成二元组</p><p>🃏 <strong>mapValues</strong></p><p>操作（K,V）RDD中的value     返回Tuple2&lt;&gt;</p><p>:arrow_up_small: <strong>flatMap</strong><br>先 map 后 flat。与 map 类似，每个输入项可以映射为 0 到多个输出项。</p><p>🔼 <strong>mapPartition</strong></p><p>与 map 类似，遍历的单位是每个 partition 上的数据。一进一出</p><p>🔼<strong>mapPartitionWithIndex</strong><br>类似于 mapPartitions,除此之外还会携带分区的索引值。</p><p>🔼 <strong>repartition</strong></p><p>repartition（3）</p><p>增加或减少分区.会产生shuffle</p><p>🔼<strong>coalesce</strong></p><p>coalesce(3,false)</p><p>常用于减少分区，第二个参数决定减少分区时是否产生shuffle：true 为产生 shuffle，false 不产生 shuffle。默认是 <code>false</code>。</p><p>如果 coalesce 设置的分区数比原来的 RDD 的分区数还多的话，第二个参数设置为 <code>false</code> 不会起作用，</p><p>如果设置成 true，效果和 repartition 一样。即 </p><p>repartition(numPartitions) = coalesce(numPartitions,true)</p></blockquote><blockquote><p>:arrow_up_small:<strong>sample</strong><br>随机抽样算子，根据传进去的小数按比例进行，有放回或者无放回的抽样。</p><p>:arrow_up_small:<strong>reduceByKey</strong><br>对于K，V格式的RDD，将key相同的RDD，对其value值根据相应的逻辑进行处理。</p><p>🔼<strong>reduceByKeyAndWindow</strong> (f1,f2,s1,s2)  </p><p>窗口函数</p><p>:arrow_up_small:<strong>sortByKey/sortBy</strong><br>作用在 K,V 格式的 RDD 上，对 key 进行升序或者降序排序。</p></blockquote><blockquote><p>:arrow_up_small:<strong>join / leftOuterJoin / rightOuterJoin / fullOuterJoin</strong></p><p>join ：保留公共元素 （K,V）</p><p>leftOutJoin ：保留左边的元素</p><p>rightOutJoin ：保留右边元素</p><p>fullOutJoin ：去重保留 （保留最大分区数）</p><p>作用在 K,V 格式的 RDD 上。根据 K 进行连接，对（K,V）join(K,W)返回（K,(V,W)）</p><ul><li>join 后的分区数与父 RDD 分区数多的那一个相同 </li></ul><p>🔼<strong>union</strong></p><p>都保留 （保留总分区数）</p><p>合并两个数据集。两个数据集的类型要一致。</p><ul><li>返回新的 RDD 的分区数是合并 RDD 分区数的总和。</li></ul><p>🔼<strong>intersection</strong></p><p>取两个数据集的交集</p><p>🔼 <strong>subtract</strong></p><p>取两个数据集的差集</p><p>🔼 <strong>distinct</strong>(map+reduceByKey+map)</p><p>去重</p></blockquote><blockquote><p>🔼 <strong>cogroup</strong></p><p>当调用类型（K,V）和（K，W）的数据上时，返回一个数据集（K，（Iterable<V>,Iterable<W>））</W></V></p><p>🔼<strong>groupByKey</strong><br>作用在 K，V 格式的 RDD 上。根据 Key 进行分组。返回（K，Iterable <V>）。</V></p></blockquote><blockquote><p>🔼<strong>zip</strong><br>将两个 RDD 中的元素（KV 格式/非 KV 格式）变成一个 KV 格式的 RDD,两个 RDD 的个数必须相同。</p><p>🔼<strong>zipWithIndex</strong><br>该函数将 RDD 中的元素和这个元素在 RDD 中的索引号（从 0 开始）组合成（K,V）对。</p><p>🔼</p></blockquote><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">object</span> WordCount <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"WC"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//用于了解集群</span>    <span class="token keyword">val</span> linesRDD <span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./words.txt"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//  lineRDD.filter(x=>&amp;#123;</span><span class="token comment" spellcheck="true">//            x.contains("sh")</span><span class="token comment" spellcheck="true">//        &amp;#125;).foreach(println)</span><span class="token comment" spellcheck="true">//  lineRDD.sample(true,0.2).foreach(println)</span><span class="token comment" spellcheck="true">//  lineRDD.map((_,1)).reduceByKey(_ + _).sortBy(_._2,false).foreach(println)</span><span class="token comment" spellcheck="true">//  lineRDD.map((_,1)).sortByKey().foreach(println)</span>    <span class="token keyword">val</span> wordRDD <span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>  <span class="token operator">=</span> linesRDD<span class="token punctuation">.</span>flatMap<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>lines <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      lines<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//匿名函数</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> KVRDD<span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> wordRDD<span class="token punctuation">.</span>map<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> result<span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> KVRDD<span class="token punctuation">.</span>reduceByKey<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"a:"</span><span class="token operator">+</span>a<span class="token operator">+</span><span class="token string">",b:"</span><span class="token operator">+</span>b<span class="token punctuation">)</span>        a<span class="token operator">+</span>b        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>补充</code></p><pre class="line-numbers language-java"><code class="language-java">    val conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"WC"</span><span class="token punctuation">)</span>    val context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//用于了解集群</span>   <span class="token comment" spellcheck="true">//parallelizePairs</span>   <span class="token comment" spellcheck="true">//join</span>Optional<span class="token punctuation">.</span><span class="token function">absent</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>optional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>optinal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5、Action-行动算子"><a href="#5、Action-行动算子" class="headerlink" title="5、Action 行动算子"></a>5、Action 行动算子</h2><h3 id="（1）概念-1"><a href="#（1）概念-1" class="headerlink" title="（1）概念"></a>（1）概念</h3><p>Action 类算子也是一类算子（函数）叫做行动算子，如foreach,collect，count 等。</p><p>Transformations 类算子是延迟执行，Action 类算子是触发执行（立即）。</p><blockquote><p>一个 application 应用程序中有几个 Action 类算子执行，就有几个 job 运行。</p></blockquote><h3 id="（2）Action-类算子"><a href="#（2）Action-类算子" class="headerlink" title="（2）Action 类算子"></a>（2）Action 类算子</h3><blockquote><p>:arrow_up_small: <strong>count</strong><br>返回数据集中的元素数。会在结果计算完成后回收到 Driver 端。</p><p>🔼<strong>countByKey</strong><br>作用到 K,V 格式的 RDD 上，根据 Key 计数相同 Key 的数据集元素。</p><p>🔼<strong>countByValue</strong><br>根据数据集每个元素相同的内容来计数。返回相同内容的元素对应的条数。</p><p>:arrow_up_small: <strong>take(n)</strong><br>返回一个包含数据集前 n 个元素的集合。<br>:arrow_up_small: <strong>first</strong><br>first=take(1),返回数据集中的第一个元素</p><p>🔼 <strong>collect</strong><br>将计算结果回收到 Driver 端。</p><p>:arrow_up_small: <strong>foreach</strong><br>循环遍历数据集中的每个元素，运行相应的逻辑。</p><p>:arrow_up_small: <strong>foreachPartition</strong></p><p>遍历的数据是每个 partition 的数据。所以传的参数为Iterator</p><p>:arrow_up_small:<strong>reduce</strong><br>根据聚合逻辑聚合数据集中的每个元素。</p></blockquote><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"transf"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>    <span class="token keyword">val</span> lineADD <span class="token operator">=</span> context<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./wc.txt"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> wordADD <span class="token operator">=</span> lineADD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// println(wordADD.count())</span><span class="token comment" spellcheck="true">//lineADD中数据回收</span>    <span class="token keyword">val</span> arr<span class="token operator">=</span> lineADD<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>    arr<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//  val takes: Array[String] = lineRDD.take(5)</span><span class="token comment" spellcheck="true">//  takes.foreach(println)</span><span class="token comment" spellcheck="true">//  val str: String = lineRDD.first()</span><span class="token comment" spellcheck="true">//  println(str)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6、控制算子"><a href="#6、控制算子" class="headerlink" title="6、控制算子"></a>6、控制算子</h2><h3 id="（1）概念：-1"><a href="#（1）概念：-1" class="headerlink" title="（1）概念："></a>（1）概念：</h3><ul><li>控制算子有三种，cache、persist、checkpoint</li><li>以上算子都可以将RDD 持久化，持久化的单位是 partition。</li><li>cache 和 persist 都是懒 执行的。</li><li>必须有一个 action 类算子触发执行。</li><li>cache 和 persist 算子的返回值可赋值给一个变量，在其他 job 中直接使用这个变量就是使用持久化的数据了</li><li>checkpoint 算子不仅能将 RDD 持久化到磁盘，还能切断 RDD 之间的依赖关系（所有父RDD）。</li><li><code>错误：</code>rdd.cache().count() 返回的不是持久化的 RDD，而是一个数值了。</li></ul><h3 id="（2）详解"><a href="#（2）详解" class="headerlink" title="（2）详解"></a>（2）详解</h3><blockquote><p>1️⃣<strong>​ cache</strong><br>默认将 RDD 的数据持久化到内存中。cache 是懒执行。</p><ul><li><code>注意</code>：</li></ul><p>chche () =persist()=persist(StorageLevel.Memory_Only)</p></blockquote><blockquote><p>2️⃣ <strong>persist</strong> </p><p>支持指定持久化级别</p><p>useOffHeap  使用堆外内存</p><p>disk、memory、offheap、deserialized（不序列化）、replication（副本数，默认为1）</p><p>序列化：压缩数据（节省空间，使用数据时要反序列化，会额外消耗CPU性能）</p><p>none 、disk_only、disk_only_2、memeory_only 、memeory_only _ser 、 memory_and_disk 、 memory_and_disk_2</p></blockquote><blockquote><p>3️⃣ <strong>checkpoint</strong>  </p><p>checkpoint 将 RDD 持久化到磁盘，还可以切断 RDD 之间的依赖关系。</p><ul><li>checkpoint 的执行原理：</li></ul><ol><li>当 RDD 的 job 执行完毕后，会从 finalRDD 从后往前回溯。</li><li>当回溯到某一个 RDD 调用了 checkpoint 方法，会对当前的RDD 做一个标记。</li><li>Spark 框架会自动启动一个新的 job，重新计算这个 RDD 的数据，将数据持久化到 HDFS 上。</li></ol><ul><li>优化：</li></ul><p>对 RDD 执行 checkpoint 之前，最好对这个 RDD 先执行cache，这样新启动的 job 只需要将内存中的数据拷贝到 HDFS上就可以，省去了重新计算这一步。</p></blockquote><p>持久化级别：如下</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g098pwwdc9j30f70aztbu.jpg"></p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> cocnf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppname<span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span><span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//设置CP在HDFS上的路径</span>context<span class="token punctuation">.</span>setCheckPointDir<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token keyword">val</span> lineADD <span class="token operator">=</span> context<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./countword.txt"</span><span class="token punctuation">)</span><span class="token keyword">val</span> time1 <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">val</span> c <span class="token operator">=</span>  lineADD<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">val</span> time2 <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">val</span> t1 <span class="token operator">=</span> time2 <span class="token operator">-</span> time1<span class="token comment" spellcheck="true">//做缓存(persisit（m_o）)</span>linelineADD <span class="token operator">=</span> lineADD<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//做持久化</span>lineADD<span class="token punctuation">.</span>persisit<span class="token punctuation">(</span>StorageLevel<span class="token punctuation">.</span>memory_only<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//checkpoint 容错,最好还有cache</span>lineADD<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">val</span> time3 <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">val</span> c <span class="token operator">=</span>  lineADD<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">val</span> time4 <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">val</span> t2 <span class="token operator">=</span> time4 <span class="token operator">-</span> time3<span class="token comment" spellcheck="true">//t1 远大于 t2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="WordCount"><a href="#WordCount" class="headerlink" title="WordCount"></a>WordCount</h2><h3 id="以用Java编写为例"><a href="#以用Java编写为例" class="headerlink" title="以用Java编写为例"></a><code>以用Java编写为例</code></h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>shsxt<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>java<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaPairRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaRDD<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>JavaSparkContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>function<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> scala<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCount</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        SparkConf conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"wc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaSparkContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> rdd <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"./wc.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> count <span class="token operator">=</span> rdd<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>String<span class="token operator">></span> collect <span class="token operator">=</span> rdd<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>String<span class="token operator">></span> take <span class="token operator">=</span> rdd<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String first <span class="token operator">=</span> rdd<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaRDD<span class="token operator">&lt;</span>String<span class="token operator">></span> wordRDD <span class="token operator">=</span> rdd<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String line<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                String<span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> list<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        wordRDD.map(new Function&lt;String>() &amp;#123;</span><span class="token comment" spellcheck="true">//            @Override</span><span class="token comment" spellcheck="true">//            public String call(String v1) throws Exception &amp;#123;</span><span class="token comment" spellcheck="true">//                return null;</span><span class="token comment" spellcheck="true">//            &amp;#125;</span><span class="token comment" spellcheck="true">//        &amp;#125;)</span>        JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> pairRDD <span class="token operator">=</span> wordRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>String word<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> resultRDD <span class="token operator">=</span> pairRDD<span class="token punctuation">.</span><span class="token function">reduceByKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function2</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span>Integer v1<span class="token punctuation">,</span> Integer v2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairRDD<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> reverseRDD <span class="token operator">=</span> resultRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> tuple2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>tuple2<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> tuple2<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairRDD<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> sortByKey <span class="token operator">=</span> reverseRDD<span class="token punctuation">.</span><span class="token function">sortByKey</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        JavaPairRDD<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> result <span class="token operator">=</span> sortByKey<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PairFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">,</span> String<span class="token punctuation">,</span> Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> tuple2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>tuple2<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> tuple2<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoidFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> tuple2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tuple2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Linx系统定时调度：</p><p>crontab</p><p>定时调度脚本文件</p><p>脚本文件中，编辑spark 提交命令</p><blockquote><p> <code>注意：</code>  脚本文件中的命令必须写它的完整路径，否则找不到此命令</p></blockquote>]]></content>
    
    
    <summary type="html">Spark的详细学习第一篇章:Apache Spark 是专为大规模数据处理而设计的快速通用的计算引擎。</summary>
    
    
    
    <category term="Spark" scheme="https://sukie-sun.github.io/categories/Spark/"/>
    
    
    <category term="计算引擎" scheme="https://sukie-sun.github.io/tags/%E8%AE%A1%E7%AE%97%E5%BC%95%E6%93%8E/"/>
    
    <category term="基于内存" scheme="https://sukie-sun.github.io/tags/%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98/"/>
    
    <category term="RDD算子" scheme="https://sukie-sun.github.io/tags/RDD%E7%AE%97%E5%AD%90/"/>
    
  </entry>
  
  <entry>
    <title>List方法</title>
    <link href="https://sukie-sun.github.io/2019/02/16/List%E6%96%B9%E6%B3%95/"/>
    <id>https://sukie-sun.github.io/2019/02/16/List%E6%96%B9%E6%B3%95/</id>
    <published>2019-02-15T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.762Z</updated>
    
    <content type="html"><![CDATA[<pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">def</span> <span class="token operator">+</span><span class="token punctuation">(</span>elem<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>前置一个元素列表<span class="token keyword">def</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">(</span>x<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>在这个列表的开头添加的元素。<span class="token keyword">def</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">(</span>prefix<span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>增加了一个给定列表中该列表前面的元素。<span class="token keyword">def</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">(</span>x<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>增加了一个元素x在列表的开头<span class="token keyword">def</span> addString<span class="token punctuation">(</span>b<span class="token operator">:</span> StringBuilder<span class="token punctuation">)</span><span class="token operator">:</span> StringBuilder追加列表的一个字符串生成器的所有元素。<span class="token keyword">def</span> addString<span class="token punctuation">(</span>b<span class="token operator">:</span> StringBuilder<span class="token punctuation">,</span> sep<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> StringBuilder追加列表的使用分隔字符串一个字符串生成器的所有元素。<span class="token keyword">def</span> apply<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> A选择通过其在列表中索引的元素<span class="token keyword">def</span> contains<span class="token punctuation">(</span>elem<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>测试该列表中是否包含一个给定值作为元素。<span class="token keyword">def</span> copyToArray<span class="token punctuation">(</span>xs<span class="token operator">:</span> Array<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> len<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>列表的副本元件阵列。填充给定的数组xs与此列表中最多len个元素，在位置开始。<span class="token keyword">def</span> distinct<span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>建立从列表中没有任何重复的元素的新列表。<span class="token keyword">def</span> drop<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回除了第n个的所有元素。<span class="token keyword">def</span> dropRight<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回除了最后的n个的元素<span class="token keyword">def</span> dropWhile<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>丢弃满足谓词的元素最长前缀。<span class="token keyword">def</span> endsWith<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">(</span>that<span class="token operator">:</span> Seq<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>测试列表是否使用给定序列结束。<span class="token keyword">def</span> equals<span class="token punctuation">(</span>that<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>equals方法的任意序列。比较该序列到某些其他对象。<span class="token keyword">def</span> exists<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>测试谓词是否持有一些列表的元素。<span class="token keyword">def</span> filter<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回列表满足谓词的所有元素。<span class="token keyword">def</span> forall<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>测试谓词是否持有该列表中的所有元素。<span class="token keyword">def</span> foreach<span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Unit</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>应用一个函数f以列表的所有元素。<span class="token keyword">def</span> head<span class="token operator">:</span> A选择列表的第一个元素<span class="token keyword">def</span> indexOf<span class="token punctuation">(</span>elem<span class="token operator">:</span> A<span class="token punctuation">,</span> from<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span>经过或在某些起始索引查找列表中的一些值第一次出现的索引。<span class="token keyword">def</span> init<span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回除了最后的所有元素<span class="token keyword">def</span> intersect<span class="token punctuation">(</span>that<span class="token operator">:</span> Seq<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>计算列表和另一序列之间的多重集交集。<span class="token keyword">def</span> isEmpty<span class="token operator">:</span> <span class="token builtin">Boolean</span>测试列表是否为空<span class="token keyword">def</span> iterator<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>A<span class="token punctuation">]</span>创建一个新的迭代器中包含的可迭代对象中的所有元素<span class="token keyword">def</span> last<span class="token operator">:</span> A返回最后一个元素<span class="token keyword">def</span> lastIndexOf<span class="token punctuation">(</span>elem<span class="token operator">:</span> A<span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span>之前或在一个给定的最终指数查找的列表中的一些值最后一次出现的索引<span class="token keyword">def</span> length<span class="token operator">:</span> <span class="token builtin">Int</span>返回列表的长度<span class="token keyword">def</span> map<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> B<span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>B<span class="token punctuation">]</span>通过应用函数以g这个列表中的所有元素构建一个新的集合<span class="token keyword">def</span> max<span class="token operator">:</span> A查找最大的元素<span class="token keyword">def</span> min<span class="token operator">:</span> A查找最小元素<span class="token keyword">def</span> mkString<span class="token operator">:</span> <span class="token builtin">String</span>显示列表的字符串中的所有元素<span class="token keyword">def</span> mkString<span class="token punctuation">(</span>sep<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span>显示的列表中的字符串中使用分隔串的所有元素<span class="token keyword">def</span> reverse<span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回新列表，在相反的顺序元素<span class="token keyword">def</span> sorted<span class="token punctuation">[</span>B <span class="token operator">></span><span class="token operator">:</span> A<span class="token punctuation">]</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>根据排序对列表进行排序<span class="token keyword">def</span> startsWith<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">(</span>that<span class="token operator">:</span> Seq<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>测试该列表中是否包含给定的索引处的给定的序列<span class="token keyword">def</span> sum<span class="token operator">:</span> A概括这个集合的元素<span class="token keyword">def</span> tail<span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回除了第一的所有元素<span class="token keyword">def</span> take<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回前n个元素<span class="token keyword">def</span> takeRight<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回最后n个元素<span class="token keyword">def</span> toArray<span class="token operator">:</span> Array<span class="token punctuation">[</span>A<span class="token punctuation">]</span>列表以一个数组变换<span class="token keyword">def</span> toBuffer<span class="token punctuation">[</span>B <span class="token operator">></span><span class="token operator">:</span> A<span class="token punctuation">]</span><span class="token operator">:</span> Buffer<span class="token punctuation">[</span>B<span class="token punctuation">]</span>列表以一个可变缓冲器转换<span class="token keyword">def</span> toMap<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token punctuation">]</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token punctuation">]</span>此列表的映射转换<span class="token keyword">def</span> toSeq<span class="token operator">:</span> Seq<span class="token punctuation">[</span>A<span class="token punctuation">]</span>列表的序列转换<span class="token keyword">def</span> toSet<span class="token punctuation">[</span>B <span class="token operator">></span><span class="token operator">:</span> A<span class="token punctuation">]</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>B<span class="token punctuation">]</span>列表到集合变换<span class="token keyword">def</span> toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span>列表转换为字符串<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Scala中List的方法</summary>
    
    
    
    <category term="Scala" scheme="https://sukie-sun.github.io/categories/Scala/"/>
    
    
    <category term="List" scheme="https://sukie-sun.github.io/tags/List/"/>
    
  </entry>
  
  <entry>
    <title>Map方法</title>
    <link href="https://sukie-sun.github.io/2019/02/16/Map%E6%96%B9%E6%B3%95/"/>
    <id>https://sukie-sun.github.io/2019/02/16/Map%E6%96%B9%E6%B3%95/</id>
    <published>2019-02-15T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.771Z</updated>
    
    <content type="html"><![CDATA[<pre class="line-numbers language-scala"><code class="language-scala">Scala Map 方法下表列出了 Scala Map 常用的方法：序号    方法及描述<span class="token keyword">def</span> <span class="token operator">++</span><span class="token punctuation">(</span>xs<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回一个新的 Map，新的 Map xs 组成<span class="token keyword">def</span> <span class="token operator">-</span><span class="token punctuation">(</span>elem1<span class="token operator">:</span> A<span class="token punctuation">,</span> elem2<span class="token operator">:</span> A<span class="token punctuation">,</span> elems<span class="token operator">:</span> A<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回一个新的 Map<span class="token punctuation">,</span> 移除 key 为 elem1<span class="token punctuation">,</span> elem2 或其他 elems。<span class="token keyword">def</span> <span class="token operator">--</span><span class="token punctuation">(</span>xs<span class="token operator">:</span> GTO<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回一个新的 Map<span class="token punctuation">,</span> 移除 xs 对象中对应的 key<span class="token keyword">def</span> get<span class="token punctuation">(</span>key<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>B<span class="token punctuation">]</span>返回指定 key 的值<span class="token keyword">def</span> iterator<span class="token operator">:</span> Iterator<span class="token punctuation">[</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">]</span>创建新的迭代器，并输出 key<span class="token operator">/</span>value 对<span class="token keyword">def</span> addString<span class="token punctuation">(</span>b<span class="token operator">:</span> StringBuilder<span class="token punctuation">)</span><span class="token operator">:</span> StringBuilder将 Map 中的所有元素附加到StringBuilder，可加入分隔符<span class="token keyword">def</span> addString<span class="token punctuation">(</span>b<span class="token operator">:</span> StringBuilder<span class="token punctuation">,</span> sep<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> StringBuilder将 Map 中的所有元素附加到StringBuilder，可加入分隔符<span class="token keyword">def</span> apply<span class="token punctuation">(</span>key<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> B返回指定键的值，如果不存在返回 Map 的默认方法<span class="token keyword">def</span> clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>从一个 Map 复制到另一个 Map<span class="token keyword">def</span> contains<span class="token punctuation">(</span>key<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>如果 Map 中存在指定 key，返回 <span class="token boolean">true</span>，否则返回 <span class="token boolean">false</span>。<span class="token keyword">def</span> copyToArray<span class="token punctuation">(</span>xs<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>复制集合到数组<span class="token keyword">def</span> count<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span>计算满足指定条件的集合元素数量<span class="token keyword">def</span> default<span class="token punctuation">(</span>key<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> B定义 Map 的默认值，在 key 不存在时返回。<span class="token keyword">def</span> drop<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回丢弃前n个元素新集合<span class="token keyword">def</span> dropRight<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回丢弃最后n个元素新集合<span class="token keyword">def</span> dropWhile<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>从左向右丢弃元素，直到条件p不成立<span class="token keyword">def</span> empty<span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回相同类型的空 Map<span class="token keyword">def</span> equals<span class="token punctuation">(</span>that<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>如果两个 Map 相等<span class="token punctuation">(</span>key<span class="token operator">/</span>value 均相等<span class="token punctuation">)</span>，返回<span class="token boolean">true</span>，否则返回<span class="token boolean">false</span><span class="token keyword">def</span> exists<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>判断集合中指定条件的元素是否存在<span class="token keyword">def</span> filter<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回满足指定条件的所有集合<span class="token keyword">def</span> filterKeys<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回符合指定条件的的不可变 Map<span class="token keyword">def</span> find<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">]</span>查找集合中满足指定条件的第一个元素<span class="token keyword">def</span> foreach<span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Unit</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>将函数应用到集合的所有元素<span class="token keyword">def</span> init<span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回所有元素，除了最后一个<span class="token keyword">def</span> isEmpty<span class="token operator">:</span> <span class="token builtin">Boolean</span>检测 Map 是否为空<span class="token keyword">def</span> keys<span class="token operator">:</span> Iterable<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回所有的key<span class="token operator">/</span>p<span class="token operator">></span><span class="token keyword">def</span> last<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span>返回最后一个元素<span class="token keyword">def</span> max<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span>查找最大元素<span class="token keyword">def</span> min<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span>查找最小元素<span class="token keyword">def</span> mkString<span class="token operator">:</span> <span class="token builtin">String</span>集合所有元素作为字符串显示<span class="token keyword">def</span> product<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span>返回集合中数字元素的积。<span class="token keyword">def</span> remove<span class="token punctuation">(</span>key<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>B<span class="token punctuation">]</span>移除指定 key<span class="token keyword">def</span> retain<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">type</span>如果符合满足条件的返回 <span class="token boolean">true</span><span class="token keyword">def</span> size<span class="token operator">:</span> <span class="token builtin">Int</span>返回 Map 元素的个数<span class="token keyword">def</span> sum<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span>返回集合中所有数字元素之和<span class="token keyword">def</span> tail<span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回一个集合中除了第一元素之外的其他元素<span class="token keyword">def</span> take<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回前 n 个元素<span class="token keyword">def</span> takeRight<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回后 n 个元素<span class="token keyword">def</span> takeWhile<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">]</span>返回满足指定条件的元素<span class="token keyword">def</span> toArray<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">]</span>集合转数组<span class="token keyword">def</span> toBuffer<span class="token punctuation">[</span>B <span class="token operator">></span><span class="token operator">:</span> A<span class="token punctuation">]</span><span class="token operator">:</span> Buffer<span class="token punctuation">[</span>B<span class="token punctuation">]</span>返回缓冲区，包含了 Map 的所有元素<span class="token keyword">def</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回 List，包含了 Map 的所有元素<span class="token keyword">def</span> toSeq<span class="token operator">:</span> Seq<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回 Seq，包含了 Map 的所有元素<span class="token keyword">def</span> toSet<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回 Set，包含了 Map 的所有元素<span class="token keyword">def</span> toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span>返回字符串对象<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Scala中Map的方法</summary>
    
    
    
    <category term="Scala" scheme="https://sukie-sun.github.io/categories/Scala/"/>
    
    
    <category term="Map" scheme="https://sukie-sun.github.io/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>Set方法</title>
    <link href="https://sukie-sun.github.io/2019/02/16/Set%E6%96%B9%E6%B3%95/"/>
    <id>https://sukie-sun.github.io/2019/02/16/Set%E6%96%B9%E6%B3%95/</id>
    <published>2019-02-15T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.784Z</updated>
    
    <content type="html"><![CDATA[<pre class="line-numbers language-scala"><code class="language-scala">Scala Set 常用方法下表列出了 Scala Set 常用的方法：序号    方法及描述<span class="token keyword">def</span> <span class="token operator">+</span><span class="token punctuation">(</span>elem<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>为集合添加新元素，x并创建一个新的集合，除非元素已存在<span class="token keyword">def</span> <span class="token operator">-</span><span class="token punctuation">(</span>elem<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>移除集合中的元素，并创建一个新的集合<span class="token keyword">def</span> contains<span class="token punctuation">(</span>elem<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>如果元素在集合中存在，返回 <span class="token boolean">true</span>，否则返回 <span class="token boolean">false</span>。<span class="token keyword">def</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>that<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回两个集合的交集<span class="token keyword">def</span> <span class="token operator">&amp;</span><span class="token operator">~</span><span class="token punctuation">(</span>that<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回两个集合的差集<span class="token keyword">def</span> <span class="token operator">+</span><span class="token punctuation">(</span>elem1<span class="token operator">:</span> A<span class="token punctuation">,</span> elem2<span class="token operator">:</span> A<span class="token punctuation">,</span> elems<span class="token operator">:</span> A<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>通过添加传入指定集合的元素创建一个新的不可变集合<span class="token keyword">def</span> <span class="token operator">++</span><span class="token punctuation">(</span>elems<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>合并两个集合<span class="token keyword">def</span> <span class="token operator">-</span><span class="token punctuation">(</span>elem1<span class="token operator">:</span> A<span class="token punctuation">,</span> elem2<span class="token operator">:</span> A<span class="token punctuation">,</span> elems<span class="token operator">:</span> A<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>通过移除传入指定集合的元素创建一个新的不可变集合<span class="token keyword">def</span> addString<span class="token punctuation">(</span>b<span class="token operator">:</span> StringBuilder<span class="token punctuation">)</span><span class="token operator">:</span> StringBuilder将不可变集合的所有元素添加到字符串缓冲区<span class="token keyword">def</span> addString<span class="token punctuation">(</span>b<span class="token operator">:</span> StringBuilder<span class="token punctuation">,</span> sep<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> StringBuilder将不可变集合的所有元素添加到字符串缓冲区，并使用指定的分隔符<span class="token keyword">def</span> apply<span class="token punctuation">(</span>elem<span class="token operator">:</span> A<span class="token punctuation">)</span>检测集合中是否包含指定元素<span class="token keyword">def</span> count<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span>计算满足指定条件的集合元素个数<span class="token keyword">def</span> copyToArray<span class="token punctuation">(</span>xs<span class="token operator">:</span> Array<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> len<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>复制不可变集合元素到数组<span class="token keyword">def</span> diff<span class="token punctuation">(</span>that<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>比较两个集合的差集<span class="token keyword">def</span> drop<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">]</span>返回丢弃前n个元素新集合<span class="token keyword">def</span> dropRight<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回丢弃最后n个元素新集合<span class="token keyword">def</span> dropWhile<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>从左向右丢弃元素，直到条件p不成立<span class="token keyword">def</span> equals<span class="token punctuation">(</span>that<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>equals 方法可用于任意序列。用于比较系列是否相等。<span class="token keyword">def</span> exists<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>判断不可变集合中指定条件的元素是否存在。<span class="token keyword">def</span> filter<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>输出符合指定条件的所有不可变集合元素。<span class="token keyword">def</span> find<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>A<span class="token punctuation">]</span>查找不可变集合中满足指定条件的第一个元素<span class="token keyword">def</span> forall<span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>查找不可变集合中满足指定条件的所有元素<span class="token keyword">def</span> foreach<span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Unit</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>将函数应用到不可变集合的所有元素<span class="token keyword">def</span> head<span class="token operator">:</span> A获取不可变集合的第一个元素<span class="token keyword">def</span> init<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回所有元素，除了最后一个<span class="token keyword">def</span> intersect<span class="token punctuation">(</span>that<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>计算两个集合的交集<span class="token keyword">def</span> isEmpty<span class="token operator">:</span> <span class="token builtin">Boolean</span>判断集合是否为空<span class="token keyword">def</span> iterator<span class="token operator">:</span> Iterator<span class="token punctuation">[</span>A<span class="token punctuation">]</span>创建一个新的迭代器来迭代元素<span class="token keyword">def</span> last<span class="token operator">:</span> A返回最后一个元素<span class="token keyword">def</span> map<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token keyword">=></span> B<span class="token punctuation">)</span><span class="token operator">:</span> immutable<span class="token punctuation">.</span>Set<span class="token punctuation">[</span>B<span class="token punctuation">]</span>通过给定的方法将所有元素重新计算<span class="token keyword">def</span> max<span class="token operator">:</span> A查找最大元素<span class="token keyword">def</span> min<span class="token operator">:</span> A查找最小元素<span class="token keyword">def</span> mkString<span class="token operator">:</span> <span class="token builtin">String</span>集合所有元素作为字符串显示<span class="token keyword">def</span> mkString<span class="token punctuation">(</span>sep<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span>使用分隔符将集合所有元素作为字符串显示<span class="token keyword">def</span> product<span class="token operator">:</span> A返回不可变集合中数字元素的积。<span class="token keyword">def</span> size<span class="token operator">:</span> <span class="token builtin">Int</span>返回不可变集合元素的数量<span class="token keyword">def</span> splitAt<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span>Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">,</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span>把不可变集合拆分为两个容器，第一个由前 n 个元素组成，第二个由剩下的元素组成<span class="token keyword">def</span> subsetOf<span class="token punctuation">(</span>that<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>如果集合A中含有子集B返回 <span class="token boolean">true</span>，否则返回<span class="token boolean">false</span><span class="token keyword">def</span> sum<span class="token operator">:</span> A返回不可变集合中所有数字元素之和<span class="token keyword">def</span> tail<span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回一个不可变集合中除了第一元素之外的其他元素<span class="token keyword">def</span> take<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回前 n 个元素<span class="token keyword">def</span> takeRight<span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span>Set<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回后 n 个元素<span class="token keyword">def</span> toArray<span class="token operator">:</span> Array<span class="token punctuation">[</span>A<span class="token punctuation">]</span>将集合转换为数组<span class="token keyword">def</span> toBuffer<span class="token punctuation">[</span>B <span class="token operator">></span><span class="token operator">:</span> A<span class="token punctuation">]</span><span class="token operator">:</span> Buffer<span class="token punctuation">[</span>B<span class="token punctuation">]</span>返回缓冲区，包含了不可变集合的所有元素<span class="token keyword">def</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回 List，包含了不可变集合的所有元素<span class="token keyword">def</span> toMap<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token punctuation">]</span><span class="token operator">:</span> Map<span class="token punctuation">[</span>T<span class="token punctuation">,</span> U<span class="token punctuation">]</span>返回 Map，包含了不可变集合的所有元素<span class="token keyword">def</span> toSeq<span class="token operator">:</span> Seq<span class="token punctuation">[</span>A<span class="token punctuation">]</span>返回 Seq，包含了不可变集合的所有元素<span class="token keyword">def</span> toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span>返回一个字符串，以对象来表示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Scala中Set的方法</summary>
    
    
    
    <category term="Scala" scheme="https://sukie-sun.github.io/categories/Scala/"/>
    
    
    <category term="Set" scheme="https://sukie-sun.github.io/tags/Set/"/>
    
  </entry>
  
  <entry>
    <title>String 方法</title>
    <link href="https://sukie-sun.github.io/2019/02/16/String%E6%96%B9%E6%B3%95/"/>
    <id>https://sukie-sun.github.io/2019/02/16/String%E6%96%B9%E6%B3%95/</id>
    <published>2019-02-15T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.803Z</updated>
    
    <content type="html"><![CDATA[<pre class="line-numbers language-scala"><code class="language-scala"><span class="token builtin">String</span> 方法char charAt<span class="token punctuation">(</span>int index<span class="token punctuation">)</span>返回指定位置的字符  从<span class="token number">0</span>开始int compareTo<span class="token punctuation">(</span>Object o<span class="token punctuation">)</span>比较字符串与对象int compareTo<span class="token punctuation">(</span><span class="token builtin">String</span> anotherString<span class="token punctuation">)</span>按字典顺序比较两个字符串int compareToIgnoreCase<span class="token punctuation">(</span><span class="token builtin">String</span> str<span class="token punctuation">)</span>按字典顺序比较两个字符串，不考虑大小写<span class="token builtin">String</span> concat<span class="token punctuation">(</span><span class="token builtin">String</span> str<span class="token punctuation">)</span>将指定字符串连接到此字符串的结尾boolean contentEquals<span class="token punctuation">(</span>StringBuffer sb<span class="token punctuation">)</span>将此字符串与指定的 StringBuffer 比较。static <span class="token builtin">String</span> copyValueOf<span class="token punctuation">(</span>char<span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span>返回指定数组中表示该字符序列的 <span class="token builtin">String</span>static <span class="token builtin">String</span> copyValueOf<span class="token punctuation">(</span>char<span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> int offset<span class="token punctuation">,</span> int count<span class="token punctuation">)</span>返回指定数组中表示该字符序列的 <span class="token builtin">String</span>boolean endsWith<span class="token punctuation">(</span><span class="token builtin">String</span> suffix<span class="token punctuation">)</span>测试此字符串是否以指定的后缀结束boolean equals<span class="token punctuation">(</span>Object anObject<span class="token punctuation">)</span>将此字符串与指定的对象比较boolean equalsIgnoreCase<span class="token punctuation">(</span><span class="token builtin">String</span> anotherString<span class="token punctuation">)</span>将此 <span class="token builtin">String</span> 与另一个 <span class="token builtin">String</span> 比较，不考虑大小写byte getBytes<span class="token punctuation">(</span><span class="token punctuation">)</span>使用平台的默认字符集将此 <span class="token builtin">String</span> 编码为 byte 序列，并将结果存储到一个新的 byte 数组中byte<span class="token punctuation">[</span><span class="token punctuation">]</span> getBytes<span class="token punctuation">(</span><span class="token builtin">String</span> charsetName使用指定的字符集将此 <span class="token builtin">String</span> 编码为 byte 序列，并将结果存储到一个新的 byte 数组中void getChars<span class="token punctuation">(</span>int srcBegin<span class="token punctuation">,</span> int srcEnd<span class="token punctuation">,</span> char<span class="token punctuation">[</span><span class="token punctuation">]</span> dst<span class="token punctuation">,</span> int dstBegin<span class="token punctuation">)</span>将字符从此字符串复制到目标字符数组int hashCode<span class="token punctuation">(</span><span class="token punctuation">)</span>返回此字符串的哈希码<span class="token number">16</span>    int indexOf<span class="token punctuation">(</span>int ch<span class="token punctuation">)</span>返回指定字符在此字符串中第一次出现处的索引（输入的是ascii码值）int indexOf<span class="token punctuation">(</span>int ch<span class="token punctuation">,</span> int fromIndex<span class="token punctuation">)</span>返返回在此字符串中第一次出现指定字符处的索引，从指定的索引开始搜索int indexOf<span class="token punctuation">(</span><span class="token builtin">String</span> str<span class="token punctuation">)</span>返回指定子字符串在此字符串中第一次出现处的索引int indexOf<span class="token punctuation">(</span><span class="token builtin">String</span> str<span class="token punctuation">,</span> int fromIndex<span class="token punctuation">)</span>返回指定子字符串在此字符串中第一次出现处的索引，从指定的索引开始<span class="token builtin">String</span> intern<span class="token punctuation">(</span><span class="token punctuation">)</span>返回字符串对象的规范化表示形式int lastIndexOf<span class="token punctuation">(</span>int ch<span class="token punctuation">)</span>返回指定字符在此字符串中最后一次出现处的索引int lastIndexOf<span class="token punctuation">(</span>int ch<span class="token punctuation">,</span> int fromIndex<span class="token punctuation">)</span>返回指定字符在此字符串中最后一次出现处的索引，从指定的索引处开始进行反向搜索int lastIndexOf<span class="token punctuation">(</span><span class="token builtin">String</span> str<span class="token punctuation">)</span>返回指定子字符串在此字符串中最右边出现处的索引int lastIndexOf<span class="token punctuation">(</span><span class="token builtin">String</span> str<span class="token punctuation">,</span> int fromIndex<span class="token punctuation">)</span>返回指定子字符串在此字符串中最后一次出现处的索引，从指定的索引开始反向搜索int length<span class="token punctuation">(</span><span class="token punctuation">)</span>返回此字符串的长度boolean matches<span class="token punctuation">(</span><span class="token builtin">String</span> regex<span class="token punctuation">)</span>告知此字符串是否匹配给定的正则表达式boolean regionMatches<span class="token punctuation">(</span>boolean ignoreCase<span class="token punctuation">,</span> int toffset<span class="token punctuation">,</span> <span class="token builtin">String</span> other<span class="token punctuation">,</span> int ooffset<span class="token punctuation">,</span> int len<span class="token punctuation">)</span>测试两个字符串区域是否相等<span class="token number">28</span>    boolean regionMatches<span class="token punctuation">(</span>int toffset<span class="token punctuation">,</span> <span class="token builtin">String</span> other<span class="token punctuation">,</span> int ooffset<span class="token punctuation">,</span> int len<span class="token punctuation">)</span>测试两个字符串区域是否相等<span class="token builtin">String</span> replace<span class="token punctuation">(</span>char oldChar<span class="token punctuation">,</span> char newChar<span class="token punctuation">)</span>返回一个新的字符串，它是通过用 newChar 替换此字符串中出现的所有 oldChar 得到的<span class="token builtin">String</span> replaceAll<span class="token punctuation">(</span><span class="token builtin">String</span> regex<span class="token punctuation">,</span> <span class="token builtin">String</span> replacement使用给定的 replacement 替换此字符串所有匹配给定的正则表达式的子字符串<span class="token builtin">String</span> replaceFirst<span class="token punctuation">(</span><span class="token builtin">String</span> regex<span class="token punctuation">,</span> <span class="token builtin">String</span> replacement<span class="token punctuation">)</span>使用给定的 replacement 替换此字符串匹配给定的正则表达式的第一个子字符串<span class="token builtin">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split<span class="token punctuation">(</span><span class="token builtin">String</span> regex<span class="token punctuation">)</span>根据给定正则表达式的匹配拆分此字符串<span class="token builtin">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split<span class="token punctuation">(</span><span class="token builtin">String</span> regex<span class="token punctuation">,</span> int limit<span class="token punctuation">)</span>根据匹配给定的正则表达式来拆分此字符串boolean startsWith<span class="token punctuation">(</span><span class="token builtin">String</span> prefix<span class="token punctuation">)</span>测试此字符串是否以指定的前缀开始boolean startsWith<span class="token punctuation">(</span><span class="token builtin">String</span> prefix<span class="token punctuation">,</span> int toffset<span class="token punctuation">)</span>测试此字符串从指定索引开始的子字符串是否以指定前缀开始。CharSequence subSequence<span class="token punctuation">(</span>int beginIndex<span class="token punctuation">,</span> int endIndex<span class="token punctuation">)</span>返回一个新的字符序列，它是此序列的一个子序列<span class="token builtin">String</span> substring<span class="token punctuation">(</span>int beginIndex<span class="token punctuation">)</span>返回一个新的字符串，它是此字符串的一个子字符串<span class="token builtin">String</span> substring<span class="token punctuation">(</span>int beginIndex<span class="token punctuation">,</span> int endIndex<span class="token punctuation">)</span>返回一个新字符串，它是此字符串的一个子字符串char<span class="token punctuation">[</span><span class="token punctuation">]</span> toCharArray<span class="token punctuation">(</span><span class="token punctuation">)</span>将此字符串转换为一个新的字符数组<span class="token builtin">String</span> toLowerCase<span class="token punctuation">(</span><span class="token punctuation">)</span>使用默认语言环境的规则将此 <span class="token builtin">String</span> 中的所有字符都转换为小写<span class="token builtin">String</span> toLowerCase<span class="token punctuation">(</span>Locale locale<span class="token punctuation">)</span>使用给定 Locale 的规则将此 <span class="token builtin">String</span> 中的所有字符都转换为小写<span class="token builtin">String</span> toString<span class="token punctuation">(</span><span class="token punctuation">)</span>返回此对象本身（它已经是一个字符串！）<span class="token builtin">String</span> toUpperCase<span class="token punctuation">(</span><span class="token punctuation">)</span>使用默认语言环境的规则将此 <span class="token builtin">String</span> 中的所有字符都转换为大写<span class="token builtin">String</span> toUpperCase<span class="token punctuation">(</span>Locale locale<span class="token punctuation">)</span>使用给定 Locale 的规则将此 <span class="token builtin">String</span> 中的所有字符都转换为大写<span class="token builtin">String</span> trim<span class="token punctuation">(</span><span class="token punctuation">)</span>删除指定字符串的首尾空白符static <span class="token builtin">String</span> valueOf<span class="token punctuation">(</span>primitive data <span class="token keyword">type</span> x<span class="token punctuation">)</span>返回指定类型参数的字符串表示形式<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Scala中String的方法</summary>
    
    
    
    <category term="Scala" scheme="https://sukie-sun.github.io/categories/Scala/"/>
    
    
    <category term="String" scheme="https://sukie-sun.github.io/tags/String/"/>
    
  </entry>
  
  <entry>
    <title>数组方法</title>
    <link href="https://sukie-sun.github.io/2019/02/16/%E6%95%B0%E7%BB%84%E6%96%B9%E6%B3%95/"/>
    <id>https://sukie-sun.github.io/2019/02/16/%E6%95%B0%E7%BB%84%E6%96%B9%E6%B3%95/</id>
    <published>2019-02-15T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.839Z</updated>
    
    <content type="html"><![CDATA[<pre class="line-numbers language-scala"><code class="language-scala">方法和描述<span class="token keyword">def</span> apply<span class="token punctuation">(</span> x<span class="token operator">:</span> T<span class="token punctuation">,</span> xs<span class="token operator">:</span> T<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span>创建指定对象 T 的数组<span class="token punctuation">,</span> T 的值可以是 <span class="token builtin">Unit</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">Float</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Char</span><span class="token punctuation">,</span> <span class="token builtin">Short</span><span class="token punctuation">,</span> <span class="token builtin">Byte</span><span class="token punctuation">,</span> <span class="token builtin">Boolean</span>。<span class="token keyword">def</span> concat<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> xss<span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span>合并数组<span class="token keyword">def</span> copy<span class="token punctuation">(</span> src<span class="token operator">:</span> <span class="token builtin">AnyRef</span><span class="token punctuation">,</span> srcPos<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dest<span class="token operator">:</span> <span class="token builtin">AnyRef</span><span class="token punctuation">,</span> destPos<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> length<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span>复制一个数组到另一个数组上。相等于 Java<span class="token symbol">'s</span> System<span class="token punctuation">.</span>arraycopy<span class="token punctuation">(</span>src<span class="token punctuation">,</span> srcPos<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> destPos<span class="token punctuation">,</span> length<span class="token punctuation">)</span>。<span class="token keyword">def</span> empty<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span>返回长度为 <span class="token number">0</span> 的数组<span class="token keyword">def</span> iterate<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> start<span class="token operator">:</span> T<span class="token punctuation">,</span> len<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> f<span class="token operator">:</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token keyword">=></span> T <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span>返回指定长度数组，每个数组元素为指定函数的返回值。以上实例数组初始值为 <span class="token number">0</span>，长度为 <span class="token number">3</span>，计算函数为a<span class="token keyword">=></span>a<span class="token operator">+</span><span class="token number">1</span>：scala<span class="token operator">></span> Array<span class="token punctuation">.</span>iterate<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token keyword">=></span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>res1<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">def</span> fill<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> n<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token punctuation">(</span>elem<span class="token operator">:</span> <span class="token keyword">=></span> T<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span>返回数组，长度为第一个参数指定，同时每个元素使用第二个参数进行填充。<span class="token keyword">def</span> fill<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> n1<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> elem<span class="token operator">:</span> <span class="token keyword">=></span> T <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">]</span>返回二数组，长度为第一个参数指定，同时每个元素使用第二个参数进行填充。<span class="token keyword">def</span> ofDim<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> n1<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span>创建指定长度的数组<span class="token keyword">def</span> ofDim<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> n1<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">]</span>创建二维数组<span class="token keyword">def</span> ofDim<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> n1<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> n3<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>创建三维数组<span class="token keyword">def</span> range<span class="token punctuation">(</span> start<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> step<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span>创建指定区间内的数组，step 为每个元素间的步长<span class="token keyword">def</span> range<span class="token punctuation">(</span> start<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span>创建指定区间内的数组<span class="token keyword">def</span> tabulate<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> n<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token keyword">=></span> T<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span>返回指定长度数组，每个数组元素为指定函数的返回值，默认从 <span class="token number">0</span> 开始。以上实例返回 <span class="token number">3</span> 个元素：scala<span class="token operator">></span> Array<span class="token punctuation">.</span>tabulate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a <span class="token keyword">=></span> a <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span>res0<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token keyword">def</span> tabulate<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span> n1<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span> <span class="token keyword">=></span> T<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">]</span>返回指定长度的二维数组，每个数组元素为指定函数的返回值，默认从 <span class="token number">0</span> 开始。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Scala中Array的方法</summary>
    
    
    
    <category term="Scala" scheme="https://sukie-sun.github.io/categories/Scala/"/>
    
    
    <category term="Array" scheme="https://sukie-sun.github.io/tags/Array/"/>
    
  </entry>
  
  <entry>
    <title>面试问题总结</title>
    <link href="https://sukie-sun.github.io/2019/02/16/%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"/>
    <id>https://sukie-sun.github.io/2019/02/16/%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/</id>
    <published>2019-02-15T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.840Z</updated>
    
    <content type="html"><![CDATA[<pre><code>悲观锁 + 乐观锁悲观锁（Pessimistic Lock）每次获取数据的时候，都会担心数据被修改，所以每次操作数据前都会进行加锁（读锁、写锁、行锁等），确保在自己在使用数据过程中，数据戹被其他进程修改，使用完成后再对数据进行解锁。由于数据被上了所，期间对数据进行读写的其他进程都需等待。在Java中，synchronized的思想也是悲观锁。乐观锁（Optimistic Lock）每次获取数据的时候，都不会担心数据被修改，所以每次获取数据的时候都不会进行加锁，但在更新数据的时候需要判断数据是否被别人修改。如果数据被其他线程更改，就不进行数据更新。如果数据没有被其他线程更改，就进行数据更新。因为数据没有进行加锁，期间数据可以被进行读写操作。一般会使用版本机制或CAS操作实现。 version方式：一般是在数据表中加上一个数据版本号version字段，表示数据被修改的次数，当数据被修改时，version值会加一。当线程A要更新数据值时，在读取数据的同时也会读取version值，在提交更新时，若刚才读取到的version值与当前数据库中的version值相等，才更新，否则重试更新操作，直到更新成功SQL：update table set x=x+1, version=version+1 where id=#&amp;#123;id&amp;#125; and version=#&amp;#123;version&amp;#125;;   CAS操作方式： 即compare and swap 或者 compare and set，涉及到三个操作数，数据所在的内存值，预期值，新值。当需要更新时，判断当前内存值与之前取到的值是否相等，若相等，则用新值更新，若失败则重试，一般情况下是一个自旋操作，即不断的重试。适用场景：悲观锁：适合写操作频繁的场景。如果用于读操作频繁的场景，每次读取都进行加锁，会增加大量锁的开销，降低系统吞吐率。乐观锁：适合读操作频繁的场景如果用于写操作频繁的场景，数据发生冲突的可能性就会增加，为例保证数据的一致性，应用层需要不断的重新获取数据，这样就带来了大量的查询操作，降低系统的吞吐率。</code></pre>]]></content>
    
    
    <summary type="html">知识盲区</summary>
    
    
    
    <category term="Scala" scheme="https://sukie-sun.github.io/categories/Scala/"/>
    
    
    <category term="Map" scheme="https://sukie-sun.github.io/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>Scala学习</title>
    <link href="https://sukie-sun.github.io/2019/02/15/Scala%E5%AD%A6%E4%B9%A0/"/>
    <id>https://sukie-sun.github.io/2019/02/15/Scala%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-02-14T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.782Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、Scala官网6个特征。"><a href="#一、Scala官网6个特征。" class="headerlink" title="一、Scala官网6个特征。"></a>一、Scala官网6个特征。</h1><h2 id="简捷，快速"><a href="#简捷，快速" class="headerlink" title="简捷，快速"></a>简捷，快速</h2><h2 id="1、Java"><a href="#1、Java" class="headerlink" title="1、Java"></a>1、Java</h2><ul><li>与Java无缝整合，运行在JVM上，编译形成.class文件</li></ul><h2 id="2、类型"><a href="#2、类型" class="headerlink" title="2、类型"></a>2、类型</h2><ul><li>类型自动推断:var 变量类型   val 常量类型<br> （var  s = 1 自动推断s 为int类型 ）<br>  dos窗口运行Scala语言（cmd  - &gt;scala）  </li></ul><h2 id="3、并发"><a href="#3、并发" class="headerlink" title="3、并发"></a>3、并发</h2><ul><li>底层有actor，天生用于高并发和分布式</li></ul><h2 id="4、继承"><a href="#4、继承" class="headerlink" title="4、继承"></a>4、继承</h2><ul><li>trait 特征特质（Java中接口和抽象类的结合体？？？两者区别？？单继承多实现）<br>​    静态语言  （Java静态语言  shell 、Python动态语言）</li></ul><h2 id="5、匹配"><a href="#5、匹配" class="headerlink" title="5、匹配"></a>5、匹配</h2><ul><li>模式匹配:(Java中的switch case类型必须一致)可匹配多种类型</li></ul><h2 id="6、高阶"><a href="#6、高阶" class="headerlink" title="6、高阶"></a>6、高阶</h2><ul><li>高阶函数（函数式编程）函数可以作为参数传入方法中（Jdk 8 stream流，莱姆塔表达式）</li></ul><p>​       工具类中方法为静态的</p><h1 id="二、Scala安装"><a href="#二、Scala安装" class="headerlink" title="二、Scala安装"></a>二、Scala安装</h1><h2 id="1、windows安装-配置环境变量"><a href="#1、windows安装-配置环境变量" class="headerlink" title="1、windows安装,配置环境变量"></a>1、windows安装,配置环境变量</h2><p>Ø  官网下载scala2.10：（因为spark需要的是这个版本的Scala）</p><p><a href="http://www.scala-lang.org/download/2.10.4.html">http://www.scala-lang.org/download/2.10.4.html</a> </p><p>Ø  下载好后安装。双击msi包安装,记住安装的路径。</p><p>Ø  配置环境变量（和配置jdk一样）</p><ul><li><p>新建SCALA_HOME</p></li><li><p>编辑Path变量，在后面追加如下：</p><pre><code>;%SCALA_HOME%\bin</code></pre></li></ul><p>Ø  打开cmd,输入：</p><pre><code>scala  - version </code></pre><p>看是否显示版本号，确定是否安装成功</p><p><img src="images/Scala.jpg"></p><h2 id="2、eclipse-配置scala插件"><a href="#2、eclipse-配置scala插件" class="headerlink" title="2、eclipse 配置scala插件"></a>2、eclipse 配置scala插件</h2><p>Ø  下载插件（一定要对应eclipse版本下载）,并解压</p><p><a href="http://scala-ide.org/download/prev-stable.html">http://scala-ide.org/download/prev-stable.html</a></p><p><img src="images/eclipse.jpg"></p><p>Ø  将解压目录下的features和plugins两个文件夹拷贝到eclipse安装目录中的”dropins/scala”目录下。</p><p>进入dropins，新建scala文件夹，将两个文件夹拷贝到“dropins/scala”下</p><h2 id="3、Scala编辑器：scala-ide"><a href="#3、Scala编辑器：scala-ide" class="headerlink" title="3、Scala编辑器：scala ide"></a>3、Scala编辑器：scala ide</h2><p>下载网址：<a href="http://scala-ide.org/download/sdk.html">http://scala-ide.org/download/sdk.html</a> </p><h2 id="4、Idea-中配置scala插件"><a href="#4、Idea-中配置scala插件" class="headerlink" title="4、Idea 中配置scala插件"></a>4、Idea 中配置scala插件</h2><p>Ø  打开idea,close项目后，点击Configure-&gt;Plugins</p><p>Ø  搜索scala，点击Install安装</p><p>Ø  设置jdk，打开Project Structure,点击new 选择安装好的jdk路径</p><p>Ø 新建Scala项目</p><p><img src="images/s1.jpg"></p><p><img src="images/s2.jpg"></p><h1 id="三、Scala基础语法"><a href="#三、Scala基础语法" class="headerlink" title="三、Scala基础语法"></a>三、Scala基础语法</h1><h2 id="1、数据类型"><a href="#1、数据类型" class="headerlink" title="1、数据类型"></a>1、数据类型</h2><p><img src="images/s4.jpg"></p><p><img src="images/s5.jpg"></p><h2 id="2、变量和常量的声明"><a href="#2、变量和常量的声明" class="headerlink" title="2、变量和常量的声明"></a><strong>2</strong>、<strong>变量和常量的声明</strong></h2><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token comment" spellcheck="true">/**     * 定义变量和常量     * 变量 :用 var 定义 ，可修改      * 常量 :用 val 定义，不可修改     */</span>    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">"zhangsan"</span>    println<span class="token punctuation">(</span>name<span class="token punctuation">)</span>    name <span class="token operator">=</span><span class="token string">"lisi"</span>    println<span class="token punctuation">(</span>name<span class="token punctuation">)</span>    <span class="token keyword">val</span> gender <span class="token operator">=</span> <span class="token string">"m"</span><span class="token comment" spellcheck="true">//    gender = "m"//错误，不能给常量再赋值</span><span class="token comment" spellcheck="true">// 定义变量或者常量的时候，也可以写上返回的类型，一般省略，如：val a:Int = 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、类和对象"><a href="#3、类和对象" class="headerlink" title="3、类和对象"></a><strong>3、</strong>类和对象</h2><p>Ø  创建类</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">class</span> Person<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">val</span> name <span class="token operator">=</span> <span class="token string">"zhangsan"</span>  <span class="token keyword">val</span> age <span class="token operator">=</span> <span class="token number">18</span>  <span class="token keyword">def</span> sayName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token string">"my name is "</span><span class="token operator">+</span> name  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Ø  创建对象</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">object</span> Lesson_Class <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>   <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> person <span class="token operator">=</span> <span class="token keyword">new</span> Person<span class="token punctuation">(</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>person<span class="token punctuation">.</span>sayName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Ø  伴生类和伴生对象</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">class</span> Person<span class="token punctuation">(</span>xname <span class="token operator">:</span><span class="token builtin">String</span> <span class="token punctuation">,</span> xage <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> name <span class="token operator">=</span> Person<span class="token punctuation">.</span>name  <span class="token keyword">val</span> age <span class="token operator">=</span> xage  <span class="token keyword">var</span> gender <span class="token operator">=</span> <span class="token string">"m"</span>  <span class="token keyword">def</span> <span class="token keyword">this</span><span class="token punctuation">(</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>g<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>age<span class="token punctuation">)</span>    gender <span class="token operator">=</span> g  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> sayName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token string">"my name is "</span><span class="token operator">+</span> name  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> Person <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">val</span> name <span class="token operator">=</span> <span class="token string">"zhangsanfeng"</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> person <span class="token operator">=</span> <span class="token keyword">new</span> Person<span class="token punctuation">(</span><span class="token string">"wagnwu"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">"f"</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>person<span class="token punctuation">.</span>sayName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>person<span class="token punctuation">.</span>gender<span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>注意</code></p><blockquote><ul><li><p>建议类名首字母大写 ，方法首字母小写，类和方法命名建议符合驼峰命名法。</p></li><li><p>.一行结束，不需要分号。如果一行里有多个语句，则之间用分号隔开。</p></li><li><p>scala 中的object是单例对象，相当于java中的工具类，它里面的方法可以看成都是static静态的。object不可以传参数。另：Trait不可以传参数</p></li><li><p>scala中的class类默认可以传参数，默认的传参数就是默认的构造函数。</p><p>重写构造函数的时候，必须要先调用默认的构造函数。</p></li><li><p>class 类属性自带getter ，setter方法。</p></li><li><p>使用object时，不用new，使用class时要new ,并且new的时候，class中除了方法不执行，其他都执行。</p></li><li><p>如果在同一个文件中，object对象和class类的名称相同，则这个对象就是这个类的伴生对象，class称为object对象的伴生类，object 称为class类的伴生对象，他们可以直接访问对方的私有变量。</p></li></ul></blockquote><h2 id="3-if-else"><a href="#3-if-else" class="headerlink" title="3.  if else"></a><strong>3.</strong>  <strong>if else</strong></h2><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token comment" spellcheck="true">/**     * if else      */</span>    <span class="token keyword">val</span> age <span class="token operator">=</span><span class="token number">18</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>age <span class="token operator">&lt;</span> <span class="token number">18</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"no allow"</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">18</span><span class="token operator">&lt;=</span>age<span class="token operator">&amp;&amp;</span>age<span class="token operator">&lt;=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"allow with other"</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"allow self"</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-for-while-do…while"><a href="#4-for-while-do…while" class="headerlink" title="4.   for ,while,do…while"></a><strong>4.</strong>   for ,while,do…while</h2><ul><li>to和until 的用法（不带步长，带步长区别）</li></ul><pre class="line-numbers language-scala"><code class="language-scala">  <span class="token comment" spellcheck="true">/**          * to和until          * 例：          * 1 to 10 返回1到10的Range数组，包含10          * 1 until 10 返回1到10 Range数组 ，不包含10          */</span>              println<span class="token punctuation">(</span><span class="token number">1</span> to <span class="token number">10</span> <span class="token punctuation">)</span><span class="token comment" spellcheck="true">//打印： Range(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)      </span>println<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//同上</span>println<span class="token punctuation">(</span><span class="token number">1</span> to <span class="token punctuation">(</span><span class="token number">10</span> <span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//步长为2，从1开始打印： Range(1, 3, 5, 7, 9)      </span>println<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//同上</span>println<span class="token punctuation">(</span><span class="token number">1</span> until <span class="token number">10</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//不包含最后一个数，打印1,2,3,4,5,6,7,8,9     </span>println<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//同上          </span>println<span class="token punctuation">(</span><span class="token number">1</span> until <span class="token punctuation">(</span><span class="token number">10</span> <span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//步长为2，从1开始打印，打印1,4,7       </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建for循环</li></ul><pre class="line-numbers language-scala"><code class="language-scala">   <span class="token comment" spellcheck="true">/**     * for 循环     *      */</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">10</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建多层for循环</li></ul><pre class="line-numbers language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">//可以分号隔开，写入多个list赋值的变量，构成多层for循环</span>    <span class="token comment" spellcheck="true">//scala中 不能写count++ count-- 只能写count+</span>    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">10</span><span class="token punctuation">;</span> j <span class="token keyword">&lt;-</span> <span class="token number">1</span> until <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span><span class="token string">"i="</span><span class="token operator">+</span> i <span class="token operator">+</span><span class="token string">",    j="</span><span class="token operator">+</span>j<span class="token punctuation">)</span>      count <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//例子： 打印小九九</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> until <span class="token number">10</span> <span class="token punctuation">;</span>j <span class="token keyword">&lt;-</span> <span class="token number">1</span> until <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">>=</span>j<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          print<span class="token punctuation">(</span>i <span class="token operator">+</span><span class="token string">" * "</span> <span class="token operator">+</span> j <span class="token operator">+</span> <span class="token string">" = "</span><span class="token operator">+</span> i<span class="token operator">*</span>j<span class="token operator">+</span><span class="token string">"    "</span><span class="token punctuation">)</span>              <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span>j <span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//九九乘法表</span>     <span class="token comment" spellcheck="true">//方法一</span><span class="token comment" spellcheck="true">//      for(i&lt;- 1 to 9 )&amp;#123;</span><span class="token comment" spellcheck="true">//        for (j &lt;- 1 to i)&amp;#123;</span><span class="token comment" spellcheck="true">//          print(j+"*"+i+"="+i*j+"\t")</span><span class="token comment" spellcheck="true">//        &amp;#125;</span><span class="token comment" spellcheck="true">//        println()</span><span class="token comment" spellcheck="true">//      &amp;#125;</span>    <span class="token comment" spellcheck="true">//方法二</span><span class="token comment" spellcheck="true">//    for(i&lt;- 1 to 9 )&amp;#123;</span><span class="token comment" spellcheck="true">//      for (j&lt;- 1 to 9)&amp;#123;</span><span class="token comment" spellcheck="true">//        if(j&lt;=i)&amp;#123;</span><span class="token comment" spellcheck="true">//          print(j+"*"+i+"="+i*j+"\t")</span><span class="token comment" spellcheck="true">//        &amp;#125;</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//        if(i==j)println()</span><span class="token comment" spellcheck="true">//      &amp;#125;</span><span class="token comment" spellcheck="true">//    &amp;#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>for循环中可以加条件判断，分号隔开</li></ul><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token comment" spellcheck="true">//可以在for循环中加入条件判断</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">10</span> <span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>scala中不能使用count++，count只能使用count = count+1 ，count += 1</p></li><li><p>while循环，while（）{}，do {}while()</p></li></ul><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token comment" spellcheck="true">//将for中的符合条件的元素通过yield关键字返回成一个集合</span>    <span class="token keyword">val</span> list <span class="token operator">=</span> <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">10</span>  <span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">yield</span> i <span class="token comment" spellcheck="true">//&lt;-  后面是一个集合</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> w <span class="token keyword">&lt;-</span> list <span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/**     * while 循环     */</span>    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span>     <span class="token keyword">while</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"第"</span><span class="token operator">+</span>index<span class="token operator">+</span><span class="token string">"次while 循环"</span><span class="token punctuation">)</span>      index <span class="token operator">+=</span> <span class="token number">1</span>     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> index <span class="token operator">=</span> <span class="token number">0</span>     <span class="token keyword">do</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        index <span class="token operator">+=</span><span class="token number">1</span>         println<span class="token punctuation">(</span><span class="token string">"第"</span><span class="token operator">+</span>index<span class="token operator">+</span><span class="token string">"次do while 循环"</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>index <span class="token operator">&lt;</span><span class="token number">100</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="四、Scala函数"><a href="#四、Scala函数" class="headerlink" title="四、Scala函数"></a>四、Scala函数</h1><h2 id="1、函数定义"><a href="#1、函数定义" class="headerlink" title="1、函数定义"></a>1、函数定义</h2><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">def</span> fun <span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>   println<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>fun<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">def</span> fun1 <span class="token punctuation">(</span>a <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token punctuation">,</span> b <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span> a<span class="token operator">+</span>b    println<span class="token punctuation">(</span>fun1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>语法解释</code></p><blockquote><ul><li>函数定义语法 用def来定义</li><li>可以定义传入的参数，要指定传入参数的类型</li><li>scala中函数中如果返回返回值类型为Unit ，即无返回值</li></ul><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">def</span> add<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        x<span class="token operator">+</span>y    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//写返回值类型是=时，一定要记得写 ：（冒号）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>scala中函数有返回值时，可以写return，也可以不写return：</p></li><li><ul><li>省略return的时候，函数自动回将最后一行的表达式的值，作为返回值</li></ul></li></ul><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token keyword">def</span> max<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">></span>y<span class="token punctuation">)</span>          x      <span class="token keyword">else</span>         y    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> println<span class="token punctuation">(</span>max<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>结果显示：<span class="token number">7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>* * 如果函数有retrun,则必须写返回类型。</code></pre><pre class="line-numbers language-scala"><code class="language-scala">  <span class="token keyword">def</span> min<span class="token punctuation">(</span>m<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>n<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>m<span class="token operator">></span>n<span class="token punctuation">)</span>        <span class="token keyword">return</span> n      <span class="token keyword">else</span>        <span class="token keyword">return</span> m    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>min<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>* scala中函数有返回值时，可以写返回值的类型，也可以省略，因为scala可以类型自动推断，有时候不能省略，必须写，* * 比如在递归函数中或者函数的返回值是函数类型的时候。</code></pre><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token keyword">def</span> num<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>                <span class="token number">1</span>            <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                x <span class="token operator">*</span> num<span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>* 函数定义的时候，如果去掉 = ，那么这个方法返回类型必定是Unit的。     这种说法无论方法体里面什么逻辑都成立，scala可以把任意类型转换为Unit。     假设，里面的逻辑最后返回了一个string，那么这个返回值会被转换成Unit，并且值会被丢弃。     则相当于，函数就将返回值去掉，即无返回值。* &#123;&#125;里的代码，如果只有一行，则可以省略&#123;&#125;*  传递给方法的参数可以在方法中使用，并且scala规定方法的传过来的参数为val类型，不能修改，不是var。</code></pre></blockquote><h2 id="2、递归函数"><a href="#2、递归函数" class="headerlink" title="2、递归函数"></a>2、递归函数</h2><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token comment" spellcheck="true">/**     * 递归函数      * 5的阶乘     */</span>    <span class="token keyword">def</span> fun2<span class="token punctuation">(</span>num <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>        num      <span class="token keyword">else</span>         num <span class="token operator">*</span> fun2<span class="token punctuation">(</span>num<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    print<span class="token punctuation">(</span>fun2<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、包含参数默认值的函数"><a href="#3、包含参数默认值的函数" class="headerlink" title="3、包含参数默认值的函数"></a>3、<strong>包含参数默认值的函数</strong></h2><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token comment" spellcheck="true">/**     * 包含默认参数值的函数     * 注意：     * 1.默认值的函数中，如果传入的参数个数与函数定义相同，则传入的数值会覆盖默认值     * 2.如果不想覆盖默认值，传入的参数个数小于定义的函数的参数，则需要指定参数名称     */</span>    <span class="token keyword">def</span> fun3<span class="token punctuation">(</span>a <span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>b<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    fun3<span class="token punctuation">(</span>b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4、可变参数个数的函数"><a href="#4、可变参数个数的函数" class="headerlink" title="4、可变参数个数的函数"></a><strong>4</strong>、可变参数个数的函数</h2><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token comment" spellcheck="true">/**     * 可变参数个数的函数     * 注意：多个参数逗号分开     */</span>    <span class="token keyword">def</span> fun4<span class="token punctuation">(</span>elem <span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">for</span><span class="token punctuation">(</span>e <span class="token keyword">&lt;-</span> elem<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        sum <span class="token operator">+=</span> e      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      sum    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>fun4<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5、匿名函数"><a href="#5、匿名函数" class="headerlink" title="5、匿名函数"></a><strong>5、</strong>匿名函数</h2><ul><li><p>有参匿名函数</p></li><li><p>无参匿名函数</p></li><li><p>有返回值的匿名函数</p></li></ul><blockquote><p>可以将匿名函数返回给val定义的值</p><p>匿名函数不能显式声明函数的返回类型</p></blockquote><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token comment" spellcheck="true">//有参数匿名函数</span>    <span class="token keyword">val</span> fun1 <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">:</span> <span class="token builtin">Int</span> ， b <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    value1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//无参数匿名函数</span>    <span class="token keyword">val</span> fun2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span><span class="token string">"啦啦啦"</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    fun2<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//有返回值的匿名函数</span>    <span class="token keyword">val</span> fun3 <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>b<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      a<span class="token operator">+</span>b    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>fun3<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6、-嵌套函数"><a href="#6、-嵌套函数" class="headerlink" title="6、 嵌套函数"></a><strong>6、</strong> <strong>嵌套函数</strong></h2><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token comment" spellcheck="true">/**     * 嵌套函数     * 例如：嵌套函数求5的阶乘     */</span>    <span class="token keyword">def</span> fun5<span class="token punctuation">(</span>num<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">def</span> fun6<span class="token punctuation">(</span>a<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>b<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          b        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          fun6<span class="token punctuation">(</span>a<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>a<span class="token operator">*</span>b<span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      fun6<span class="token punctuation">(</span>num<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>fun5<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7、偏应用函数"><a href="#7、偏应用函数" class="headerlink" title="7、偏应用函数"></a><strong>7、偏应用函数</strong></h2><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date    <span class="token comment" spellcheck="true">/**     * 偏应用函数是一种表达式     * 不需要提供函数需要的所有参数，     * 只需要提供部分，或不提供所需参数。     */</span>    <span class="token keyword">def</span> log<span class="token punctuation">(</span>date <span class="token operator">:</span>Date<span class="token punctuation">,</span> s <span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span><span class="token string">"date is "</span><span class="token operator">+</span> date <span class="token operator">+</span><span class="token string">",log is "</span><span class="token operator">+</span> s<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> date <span class="token operator">=</span> <span class="token keyword">new</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span>    log<span class="token punctuation">(</span>date <span class="token punctuation">,</span><span class="token string">"log1"</span><span class="token punctuation">)</span>    log<span class="token punctuation">(</span>date <span class="token punctuation">,</span><span class="token string">"log2"</span><span class="token punctuation">)</span>    log<span class="token punctuation">(</span>date <span class="token punctuation">,</span><span class="token string">"log3"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//想要调用log，以上变化的是第二个参数，可以用偏应用函数处理,来优化log方法</span>   <span class="token comment" spellcheck="true">/* 绑定第一个 date 参数，    * 第二个参数使用下划线(_)替换缺失的参数列表，    * 并把这个新的函数值的索引的赋给变量。    */</span>    <span class="token keyword">val</span> logWithDate <span class="token operator">=</span> log<span class="token punctuation">(</span>date<span class="token punctuation">,</span>_<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>    logWithDate<span class="token punctuation">(</span><span class="token string">"log11"</span><span class="token punctuation">)</span>    logWithDate<span class="token punctuation">(</span><span class="token string">"log22"</span><span class="token punctuation">)</span>    logWithDate<span class="token punctuation">(</span><span class="token string">"log33"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8、高阶函数"><a href="#8、高阶函数" class="headerlink" title="8、高阶函数"></a>8、<strong>高阶函数</strong></h2><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token comment" spellcheck="true">/**     * 高阶函数:就是操作其他函数的函数     * 函数的参数是函数             * 或者函数的返回是函数             * 或者函数的参数和返回都是函数     */</span><span class="token comment" spellcheck="true">//函数作为参数或者返回累心时，只需指明函数中的类型    </span>    <span class="token comment" spellcheck="true">//函数的参数是函数：</span>    <span class="token comment" spellcheck="true">//f : (Int,Int) =>Int  （两个Int型参数、Int型返回值）</span>    <span class="token keyword">def</span> hightFun<span class="token punctuation">(</span>f <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span><span class="token builtin">Int</span><span class="token punctuation">,</span> a<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      f<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> f<span class="token punctuation">(</span>v1 <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>v2<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Int</span>  <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      v1<span class="token operator">+</span>v2    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>hightFun<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">//***************</span>   <span class="token keyword">def</span> test1<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> a <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">100</span>            a <span class="token operator">*</span> f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>   <span class="token keyword">def</span> sum<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            x <span class="token operator">-</span> y        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>     println<span class="token punctuation">(</span>test6<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//------------------------------------------------</span>    <span class="token comment" spellcheck="true">//函数的返回值类型为函数 ：(Int,Int)=>Int  f2</span>    <span class="token comment" spellcheck="true">//1，2,3,4相加</span>    <span class="token keyword">def</span> hightFun2<span class="token punctuation">(</span>a <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>b<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token keyword">=></span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">def</span> f2 <span class="token punctuation">(</span>v1<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>v2<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        v1<span class="token operator">+</span>v2<span class="token operator">+</span>a<span class="token operator">+</span>b      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      f2    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>hightFun2<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">//***********</span>    <span class="token keyword">def</span> test2<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">def</span> concat<span class="token punctuation">(</span>y<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                x <span class="token operator">+</span> <span class="token string">" !! "</span> <span class="token operator">+</span> y            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            concat        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> concat<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token keyword">=></span> <span class="token builtin">String</span> <span class="token operator">=</span> test2<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//        println(test2(5)(7))</span> <span class="token comment" spellcheck="true">//-------------------------------------------------   </span>    <span class="token comment" spellcheck="true">//函数的参数是函数:  f : (Int ,Int) => Int)</span>    <span class="token comment" spellcheck="true">//函数的返回是函数:  (Int,Int) => Int</span>    <span class="token keyword">def</span> hightFun3<span class="token punctuation">(</span>f <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span> <span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      f    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>     println<span class="token punctuation">(</span>hightFun3<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>hightFun3<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>a<span class="token operator">+</span>b<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//以上这句话还可以写成这样</span>    <span class="token comment" spellcheck="true">//如果函数的参数在方法体中只使用了一次 那么可以写成_表示</span>    println<span class="token punctuation">(</span>hightFun3<span class="token punctuation">(</span>_<span class="token operator">+</span>_<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">//**********</span>    <span class="token keyword">def</span> test3<span class="token punctuation">(</span>y<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=></span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> sum <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> y            <span class="token keyword">def</span> sum4<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                x <span class="token operator">+</span> sum            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            sum4        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        def f2 (x: Int) =&amp;#123;</span><span class="token comment" spellcheck="true">//            x + 10</span><span class="token comment" spellcheck="true">//        &amp;#125;</span>        <span class="token keyword">val</span> f <span class="token operator">=</span> test3<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>x <span class="token operator">+</span> <span class="token number">10</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//        println(f(5))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="9、柯里化函数"><a href="#9、柯里化函数" class="headerlink" title="9、柯里化函数"></a>9、柯里化函数</h2><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token comment" spellcheck="true">/**     * 柯里化函数     * 可以理解为高阶函数的简化     */</span>    <span class="token keyword">def</span> fun1<span class="token punctuation">(</span>a <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>b<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>d<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      a<span class="token operator">+</span>b<span class="token operator">+</span>c<span class="token operator">+</span>d    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>fun1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">//*******</span>   <span class="token keyword">def</span> fun<span class="token punctuation">(</span>a <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>c<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            a<span class="token operator">+</span>c        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>fun<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="五、字符串"><a href="#五、字符串" class="headerlink" title="五、字符串"></a>五、字符串</h1><h2 id="1、string-stringBuilder-可变"><a href="#1、string-stringBuilder-可变" class="headerlink" title="1、string  | stringBuilder (可变)"></a>1、string  | stringBuilder (可变)</h2><h2 id="2、操作方法"><a href="#2、操作方法" class="headerlink" title="2、操作方法"></a>2、操作方法</h2><p>Ø  比较:equals</p><p>Ø  比较忽略大小写:equalsIgnoreCase</p><p>Ø  indexOf：如果字符串中有传入的assci码对应的值，返回下标</p><pre class="line-numbers language-scala"><code class="language-scala">    <span class="token comment" spellcheck="true">/**     * String &amp;&amp; StringBuilder     */</span>    <span class="token keyword">val</span> str <span class="token operator">=</span> <span class="token string">"abcd"</span>    <span class="token keyword">val</span> str1 <span class="token operator">=</span> <span class="token string">"ABCD"</span>    println<span class="token punctuation">(</span>str<span class="token punctuation">.</span>indexOf<span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>str<span class="token punctuation">.</span>indexOf<span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>str<span class="token operator">==</span>str1<span class="token punctuation">)</span>    println<span class="token punctuation">(</span>str<span class="token punctuation">.</span>equals<span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>str<span class="token punctuation">.</span>equalsIgnoreCase<span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/**     * compareToIgnoreCase     *      * 如果参数字符串等于此字符串，则返回值 0；     * 如果此字符串小于字符串参数，则返回一个小于 0 的值；     * 如果此字符串大于字符串参数，则返回一个大于 0 的值。     *      */</span>    println<span class="token punctuation">(</span>str<span class="token punctuation">.</span>compareToIgnoreCase<span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> strBuilder <span class="token operator">=</span> <span class="token keyword">new</span> StringBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//括号可省</span>    strBuilder<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//一个 + 只能跟单个字符且必须用单引号，否则无效 </span><span class="token comment" spellcheck="true">//    strBuilder.+('d')</span>    strBuilder<span class="token operator">+</span> <span class="token string">'d'</span><span class="token comment" spellcheck="true">//    strBuilder.+=('h')</span>    strBuilder<span class="token operator">+=</span> <span class="token string">'h'</span> <span class="token comment" spellcheck="true">//两个+ 可跟多个字符且必须用双引号</span><span class="token comment" spellcheck="true">//    strBuilder.++=("efg")</span>    strBuilder<span class="token operator">++</span><span class="token operator">=</span> <span class="token string">"efg"</span><span class="token comment" spellcheck="true">//StringBuilder可以追加浮点数</span>    strBuilder<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>    strBuilder<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">18f</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>strBuilder<span class="token punctuation">)</span> println<span class="token punctuation">(</span>strBuilder<span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="六、集合"><a href="#六、集合" class="headerlink" title="六、集合"></a>六、集合</h1><h2 id="1、数组"><a href="#1、数组" class="headerlink" title="1、数组"></a>1、数组</h2><h3 id="（1）创建一维数组"><a href="#（1）创建一维数组" class="headerlink" title="（1）创建一维数组"></a>（1）创建一维数组</h3><pre class="line-numbers language-scala"><code class="language-scala"> <span class="token comment" spellcheck="true">/**     * 创建数组两种方式：     * 1.new Array[String](3)     * 2.直接Array     */</span>    <span class="token comment" spellcheck="true">//创建类型为Int 长度为3的数组</span>    <span class="token keyword">val</span> arr1 <span class="token operator">=</span> <span class="token keyword">new</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//创建String 类型的数组，直接赋值</span>    <span class="token keyword">val</span> arr2 <span class="token operator">=</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"s100"</span><span class="token punctuation">,</span><span class="token string">"s200"</span><span class="token punctuation">,</span><span class="token string">"s300"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//赋值</span>    arr1<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">100</span>    arr1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">200</span>    arr1<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">300</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（2）数组遍历"><a href="#（2）数组遍历" class="headerlink" title="（2）数组遍历"></a>（2）数组遍历</h3><pre class="line-numbers language-scala"><code class="language-scala">   <span class="token comment" spellcheck="true">/**     * 遍历两种方式     * for     * foreach     */</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> arr1<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          println<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    arr1<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>i <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>s <span class="token keyword">&lt;-</span> arr2<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    arr2<span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>       x <span class="token keyword">=></span> println<span class="token punctuation">(</span>x<span class="token punctuation">)</span>     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（3）数组操作"><a href="#（3）数组操作" class="headerlink" title="（3）数组操作"></a>（3）数组操作</h3><pre class="line-numbers language-scala"><code class="language-scala">Array<span class="token punctuation">.</span>concat：合并数组Array<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span>“shsxt”<span class="token punctuation">)</span>：创建初始值的定长数组<span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">val</span> a <span class="token operator">=</span> <span class="token keyword">new</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>        a<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>        a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>        a<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token comment" spellcheck="true">//判断数组中符合条件的元素的个数</span><span class="token comment" spellcheck="true">//        val n = a.count(x=>&amp;#123;</span><span class="token comment" spellcheck="true">//            if(x>2)</span><span class="token comment" spellcheck="true">//                true</span><span class="token comment" spellcheck="true">//            else</span><span class="token comment" spellcheck="true">//                false</span><span class="token comment" spellcheck="true">//        &amp;#125;)</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//        println(n)</span>        <span class="token keyword">val</span> b <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//将两个数组的元素合并在一个新的数组中</span>        <span class="token keyword">val</span> ints <span class="token operator">=</span> Array<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//遍历数组</span>        ints<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//创建包含5个指定元素的数组</span>        <span class="token keyword">val</span> strings <span class="token operator">=</span> Array<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"shsxt"</span><span class="token punctuation">)</span>        strings<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//        for(i &lt;- a)&amp;#123;</span><span class="token comment" spellcheck="true">//            println(i)</span><span class="token comment" spellcheck="true">//        &amp;#125;</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//        val b = Array(4,5,6)</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//        for(i &lt;- b)&amp;#123;</span><span class="token comment" spellcheck="true">//            println(i)</span><span class="token comment" spellcheck="true">//        &amp;#125;</span><span class="token comment" spellcheck="true">//        a.foreach(x=> &amp;#123; println(x) &amp;#125; )</span><span class="token comment" spellcheck="true">//        a.foreach(println(_))</span><span class="token comment" spellcheck="true">//         a.foreach(println)</span><span class="token comment" spellcheck="true">//        val c = new Array[Array[Int]](3)</span><span class="token comment" spellcheck="true">//        c(0) = Array(1,2,3)</span><span class="token comment" spellcheck="true">//        c(1) = Array(4,5,6)</span><span class="token comment" spellcheck="true">//        c(2) = Array(7,8,9)</span><span class="token comment" spellcheck="true">//        c.foreach(x=>&amp;#123;</span><span class="token comment" spellcheck="true">//            x.foreach(y=>&amp;#123;</span><span class="token comment" spellcheck="true">//                print(y + "\t")</span><span class="token comment" spellcheck="true">//            &amp;#125;)</span><span class="token comment" spellcheck="true">//            println()</span><span class="token comment" spellcheck="true">//        &amp;#125;)</span><span class="token comment" spellcheck="true">//        for(i&lt;-c)&amp;#123;</span><span class="token comment" spellcheck="true">//            for(j &lt;-i)&amp;#123;</span><span class="token comment" spellcheck="true">//                print(j + "\t")</span><span class="token comment" spellcheck="true">//            &amp;#125;</span><span class="token comment" spellcheck="true">//            println()</span><span class="token comment" spellcheck="true">//        &amp;#125;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="（4）创建二维数组"><a href="#（4）创建二维数组" class="headerlink" title="（4）创建二维数组"></a>（4）创建二维数组</h3><pre class="line-numbers language-scala"><code class="language-scala">  <span class="token comment" spellcheck="true">/**     * 创建二维数组和遍历     */</span>    <span class="token keyword">val</span> arr3 <span class="token operator">=</span> <span class="token keyword">new</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    arr3<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">=</span>Array<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">)</span>    arr3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span>Array<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">,</span><span class="token string">"5"</span><span class="token punctuation">,</span><span class="token string">"6"</span><span class="token punctuation">)</span>    arr3<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">=</span>Array<span class="token punctuation">(</span><span class="token string">"7"</span><span class="token punctuation">,</span><span class="token string">"8"</span><span class="token punctuation">,</span><span class="token string">"9"</span><span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until arr3<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">for</span><span class="token punctuation">(</span>j <span class="token keyword">&lt;-</span> <span class="token number">0</span> until arr3<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        print<span class="token punctuation">(</span>arr3<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"    "</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>arr <span class="token keyword">&lt;-</span> arr3 <span class="token punctuation">;</span>i <span class="token keyword">&lt;-</span> arr<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">%</span><span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      print<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">"    "</span><span class="token punctuation">)</span>      count <span class="token operator">+=</span><span class="token number">1</span>     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    arr3<span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> arr  <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      arr<span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> println <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> arr4 <span class="token operator">=</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Array<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    arr4<span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> arr <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      arr<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>i <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span>i<span class="token punctuation">)</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"-------"</span><span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>arr <span class="token keyword">&lt;-</span> arr4<span class="token punctuation">;</span>i <span class="token keyword">&lt;-</span> arr<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、list"><a href="#2、list" class="headerlink" title="2、list"></a>2、list</h2><h2 id="（1）创建list"><a href="#（1）创建list" class="headerlink" title="（1）创建list"></a>（1）创建list</h2><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> list <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>备注</code>  Nil      长度为0的list</p><h2 id="（2）list遍历"><a href="#（2）list遍历" class="headerlink" title="（2）list遍历"></a>（2）list遍历</h2><blockquote><p>foreach ，for</p></blockquote><h2 id="（3）list操作"><a href="#（3）list操作" class="headerlink" title="（3）list操作"></a>（3）list操作</h2><pre class="line-numbers language-scala"><code class="language-scala">  <span class="token comment" spellcheck="true">//创建</span>    <span class="token keyword">val</span> list <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//遍历</span>    list<span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> println<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//    list.foreach &amp;#123; println&amp;#125;</span>    <span class="token comment" spellcheck="true">//filter 过滤元素</span>    <span class="token keyword">val</span> list1  <span class="token operator">=</span> list<span class="token punctuation">.</span>filter <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> x<span class="token operator">></span><span class="token number">3</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    list1<span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> println<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//count  计算符合条件的元素个数</span>    <span class="token keyword">val</span> value <span class="token operator">=</span> list1<span class="token punctuation">.</span>count <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> x<span class="token operator">></span><span class="token number">3</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//map 对元素操作 如切分</span>    <span class="token keyword">val</span> nameList <span class="token operator">=</span> List<span class="token punctuation">(</span>            <span class="token string">"hello shsxt"</span><span class="token punctuation">,</span>            <span class="token string">"hello xasxt"</span><span class="token punctuation">,</span>            <span class="token string">"hello shsxt"</span>        <span class="token punctuation">)</span>    <span class="token keyword">val</span> mapResult<span class="token operator">:</span>List<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> nameList<span class="token punctuation">.</span>map<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>         x <span class="token keyword">=></span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    mapResult<span class="token punctuation">.</span>foreach<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>println<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//flatmap 将元素压扁平,先map再flat</span>    <span class="token keyword">val</span> flatMapResult <span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> nameList<span class="token punctuation">.</span>flatMap<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    flatMapResult<span class="token punctuation">.</span>foreach <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> println <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="images/map.jpg"></p><h2 id="3、set"><a href="#3、set" class="headerlink" title="3、set"></a>3、set</h2><p><code>注意：</code>set集合自动去重</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">val</span> s <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">val</span> s1 <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">1</span>，<span class="token number">2</span>，<span class="token number">3</span>，<span class="token number">4</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//遍历时，自动去重</span>s<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span>x<span class="token keyword">&lt;-</span> s<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>println<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//交集</span><span class="token keyword">val</span> inse <span class="token operator">=</span> s<span class="token punctuation">.</span>intersect<span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token keyword">val</span> ins <span class="token operator">=</span> s<span class="token punctuation">.</span>&amp;<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>inse<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>inse<span class="token punctuation">.</span>foreach<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>println<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//差集</span><span class="token keyword">val</span> di <span class="token operator">=</span> s<span class="token punctuation">.</span>diff<span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token keyword">val</span> de <span class="token operator">=</span> s<span class="token punctuation">.</span>&amp;<span class="token operator">~</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//子集:s是不是s1的子集</span><span class="token keyword">val</span> boo<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>subsetof<span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//max ,min</span><span class="token keyword">val</span> max <span class="token operator">=</span> s<span class="token punctuation">.</span>max<span class="token keyword">val</span> min <span class="token operator">=</span> s<span class="token punctuation">.</span>minprintln<span class="token punctuation">(</span>max <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> min<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//转成数组，list</span>s<span class="token punctuation">.</span>toArray<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>s<span class="token punctuation">.</span>toList<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//mkString , 元素以！分隔拼成字符串</span>println<span class="token punctuation">(</span>s<span class="token punctuation">.</span>mkString<span class="token punctuation">)</span>println<span class="token punctuation">(</span>s<span class="token punctuation">.</span>mkstring<span class="token punctuation">(</span><span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4、map"><a href="#4、map" class="headerlink" title="4、map"></a>4、map</h2><pre class="line-numbers language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">//map创建时，若key相同，则都会被后一个key覆盖</span><span class="token keyword">val</span> map <span class="token operator">=</span>Map（<span class="token string">"1"</span><span class="token operator">-</span><span class="token operator">></span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token operator">-</span><span class="token operator">></span><span class="token string">"b"</span>）<span class="token comment" spellcheck="true">//获取map值</span>println<span class="token punctuation">(</span>map<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>println<span class="token punctuation">(</span>map<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//获取指定key，若没有，就用另一个指定值代替</span>println<span class="token punctuation">(</span>map<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">,</span><span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">val</span> res <span class="token operator">=</span> map<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token string">"800"</span><span class="token punctuation">)</span>println<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//遍历map</span><span class="token comment" spellcheck="true">//x为map中的一组键值对</span><span class="token keyword">for</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token operator">></span> map<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>println<span class="token punctuation">(</span><span class="token string">"key:"</span><span class="token operator">+</span>x<span class="token punctuation">.</span>_1<span class="token operator">+</span><span class="token string">",value:"</span><span class="token operator">+</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>map<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> println<span class="token punctuation">(</span><span class="token string">"key:"</span><span class="token operator">+</span>x<span class="token punctuation">.</span>_1<span class="token operator">+</span><span class="token string">",value:"</span><span class="token operator">+</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//遍历key</span><span class="token keyword">val</span> keyIteratable <span class="token operator">=</span> map<span class="token punctuation">.</span>keyskeyIteratable<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>k<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>println<span class="token punctuation">(</span><span class="token string">"key"</span><span class="token operator">+</span>k<span class="token operator">+</span><span class="token string">",value"</span><span class="token operator">+</span>map<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//遍历value</span><span class="token keyword">val</span> valueIteratable <span class="token operator">=</span> map<span class="token punctuation">.</span>valuesvalueIteratable<span class="token punctuation">.</span>foreach<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>v<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token operator">+</span>v<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//合并map</span><span class="token keyword">val</span> map1 <span class="token operator">=</span> Map（<span class="token punctuation">(</span><span class="token number">1</span>，<span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">)</span>）<span class="token keyword">val</span> map2 <span class="token operator">=</span> Map（<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"aa"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"bb"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"cc"</span><span class="token punctuation">)</span>）map1<span class="token punctuation">.</span>+<span class="token operator">+</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>map1<span class="token punctuation">.</span>+<span class="token operator">+</span><span class="token operator">:</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span><span class="token punctuation">.</span>oreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//map操作方法</span><span class="token comment" spellcheck="true">//filter:过滤，留下符合条件的元素</span><span class="token keyword">val</span> result <span class="token operator">=</span> map<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token boolean">true</span><span class="token keyword">else</span>    <span class="token boolean">false</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>result<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>map<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//count：统计符合条件的元素个数</span><span class="token keyword">val</span> countResult <span class="token operator">=</span> map<span class="token punctuation">.</span>count（x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      x<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>）println<span class="token punctuation">(</span>countResult<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//contains：判断map中是否包含某个key</span>map<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//exist：判断符合条件的元素是存在</span><span class="token comment" spellcheck="true">//若遇到条件返回结果为true，就停止迭代</span>map<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">if</span>（x<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>println<span class="token punctuation">(</span><span class="token string">"存在喽"</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span>println<span class="token punctuation">(</span><span class="token string">"不存在喽"</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5、元组Tuple"><a href="#5、元组Tuple" class="headerlink" title="5、元组Tuple"></a>5、元组Tuple</h2><p>同：与列表类似</p><p>不同：元组可以包含不同类型的元素；元组的值是通过将单个值包含在圆括号中构成</p><p><code>注意：</code>Tuple最多支持22个参数</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">//元素个数取决于Tuple后面的数字</span><span class="token keyword">val</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> Tuple1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">val</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> Tuple2<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">val</span> t3 <span class="token operator">=</span> Tuple3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token keyword">val</span> t5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span>，<span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">val</span> t22 <span class="token operator">=</span> <span class="token keyword">new</span> Tuple22<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//获取元组中的值 ：用  ._XX  </span>println（t5<span class="token punctuation">.</span>_4）<span class="token keyword">val</span> t <span class="token operator">=</span> Tuple2<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>println<span class="token punctuation">(</span>t<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//元组遍历：元素迭代器</span><span class="token keyword">val</span> interator <span class="token operator">=</span> t5<span class="token punctuation">.</span>productorInteratorinterator<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span><span class="token keyword">while</span><span class="token punctuation">(</span>interator<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span>intrator<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//元素翻转 swap， 只针对二元数组</span>println<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>swap<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//转换成字符串</span>println<span class="token punctuation">(</span>t5<span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="七、trait"><a href="#七、trait" class="headerlink" title="七、trait"></a>七、trait</h1><p>Scala：只有extends  ，可以继承多个Trait</p><p>Scala Trait(特征) 相当于 Java 的接口和抽象类的结合</p><p>可以定义属性和方法</p><p><code>注意：</code></p><ul><li>若继承的多个trait中包含同名的属性和方法，就必须在在类中使用<code>override</code> 重新定义</li><li>若重新定义的属性是使用<code>var</code>定义的则会报错，所以必须是使用<code>val</code>定义的属性才可使用override</li><li>trait中不能传参数</li></ul><p><code>举例</code>：trait中带属性带方法实现</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">trait</span> Read<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">"read"</span>    <span class="token keyword">val</span> age <span class="token operator">=</span> <span class="token number">18</span>    <span class="token keyword">def</span> read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"read---"</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">trait</span> Write<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">"write"</span>     <span class="token keyword">val</span> age <span class="token operator">=</span> <span class="token number">19</span>    <span class="token keyword">def</span> write<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"write----"</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">class</span> Human <span class="token keyword">extends</span> Read <span class="token keyword">with</span> Write<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//前提name必须是用val定义的</span>  <span class="token comment" spellcheck="true">//  override var name  = "person"</span>    <span class="token keyword">override</span> <span class="token keyword">val</span> age <span class="token operator">=</span> <span class="token number">20</span>    name  <span class="token operator">=</span> <span class="token string">"person"</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> Trait<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">val</span> human <span class="token operator">=</span> <span class="token keyword">new</span> Human<span class="token punctuation">(</span><span class="token punctuation">)</span>         println<span class="token punctuation">(</span>human<span class="token punctuation">.</span>name<span class="token punctuation">)</span>        human<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        human<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>举例</code>：trait中带方法不实现</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">trait</span> Equal<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//抽象方法</span>    <span class="token keyword">def</span> isEqual<span class="token punctuation">(</span>p<span class="token operator">:</span>Point<span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Boolean</span>    <span class="token keyword">def</span> isNoEqual<span class="token punctuation">(</span>p<span class="token operator">:</span>Point<span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token operator">!</span>isEqual<span class="token punctuation">(</span>p<span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">class</span> Point<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Equal <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> xx <span class="token operator">=</span> x    <span class="token keyword">var</span> yy <span class="token operator">=</span> y    <span class="token keyword">override</span> <span class="token keyword">def</span> isEqual <span class="token punctuation">(</span>p<span class="token operator">:</span>Point<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>       p<span class="token punctuation">.</span>xx <span class="token operator">==</span> xx <span class="token operator">&amp;</span> p<span class="token punctuation">.</span>yy <span class="token operator">==</span>yy     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> isEqule<span class="token punctuation">(</span>p<span class="token operator">:</span><span class="token builtin">Any</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    p<span class="token punctuation">.</span>isInstanceOf<span class="token punctuation">[</span>Point<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>Point<span class="token punctuation">]</span><span class="token punctuation">.</span>xx<span class="token operator">==</span>xx  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> Trait2<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>       <span class="token keyword">val</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> Point<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>       <span class="token keyword">val</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> Point<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>       ptintln<span class="token punctuation">(</span>p1<span class="token punctuation">.</span>isNoEqual<span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span>       ptintln<span class="token punctuation">(</span>p1<span class="token punctuation">.</span>isEqual<span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="八、模式匹配match"><a href="#八、模式匹配match" class="headerlink" title="八、模式匹配match"></a>八、模式匹配match</h1><p>1、概念理解</p><ul><li>一个模式匹配包含多个备选项，且每个都以关键字case开始</li><li>每个备选项都包含一个模式和多个表达式，且用箭头符号 =&gt; 隔开了模式和表达式。</li><li>Ø 模式匹配不仅可以匹配值还可以匹配类型</li><li>Ø  从上到下顺序匹配，如果匹配到则不再往下匹配</li><li>Ø  都匹配不上时，会匹配到case_ ,相当于default</li><li>Ø  match 的最外面的”{ }”可以去掉看成一个语句</li></ul><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">object</span> Match<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>       <span class="token keyword">val</span> p1 <span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3f</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">,</span><span class="token string">"abc"</span><span class="token punctuation">,</span><span class="token number">55d</span><span class="token punctuation">)</span>        p1<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            println<span class="token punctuation">(</span>mymatch<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> mymatch<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>             x <span class="token keyword">match</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"4"</span> <span class="token keyword">=></span>println<span class="token punctuation">(</span><span class="token string">"macth 4--"</span><span class="token punctuation">)</span>            <span class="token keyword">case</span> x<span class="token operator">:</span><span class="token builtin">String</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"match String"</span><span class="token punctuation">)</span>            <span class="token keyword">case</span> <span class="token number">1</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"1--"</span><span class="token punctuation">)</span>            <span class="token keyword">case</span> <span class="token number">2</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"2--"</span><span class="token punctuation">)</span>            <span class="token keyword">case</span> <span class="token number">3f</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"3f--"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//      case x :Double => println("type is Double")</span>            <span class="token keyword">case</span> _ <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"no match--"</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="九、样例类"><a href="#九、样例类" class="headerlink" title="九、样例类"></a>九、样例类</h1><p>1、概念理解</p><ul><li><p>使用了case关键字的类定义就是样例类(case classes)</p></li><li><p>样例类是种特殊的类。实现了类构造参数的getter方法（构造参数默认被声明为val），当构造参数是声明为var类型的，它将帮你实现setter和getter方法。</p><p>Ø  样例类默认帮你实现了toString,equals，copy和hashCode等方法。</p><p>Ø  样例类可以new, 也可以不用new</p></li></ul><p>2、举例：结合模式匹配的代码</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">object</span> Match2<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> zs <span class="token operator">=</span> <span class="token keyword">new</span> Woman<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">"zs"</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>zs<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token string">" : "</span><span class="token operator">+</span> zs <span class="token punctuation">.</span> name<span class="token punctuation">)</span>     <span class="token keyword">val</span> mm <span class="token operator">=</span> Woman<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">"meimei"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> nn <span class="token operator">=</span> Woman<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">"meimei"</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>mm<span class="token punctuation">.</span>equals<span class="token punctuation">(</span>zs<span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>mm<span class="token punctuation">.</span>equals<span class="token punctuation">(</span>nn<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> wo <span class="token operator">=</span> List<span class="token punctuation">(</span>ls<span class="token punctuation">,</span>mm<span class="token punctuation">)</span>    wo<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x<span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            x <span class="token keyword">match</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> x<span class="token operator">:</span>Woman <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"match Woman--"</span><span class="token punctuation">)</span>                <span class="token keyword">case</span> Woman<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">"ls"</span><span class="token punctuation">)</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"ls"</span><span class="token punctuation">)</span>                <span class="token keyword">case</span> Woman<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">"mm"</span><span class="token punctuation">)</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"mm"</span><span class="token punctuation">)</span>                <span class="token keyword">case</span> Woman<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">"zs"</span><span class="token punctuation">)</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"zs"</span><span class="token punctuation">)</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">case</span> <span class="token keyword">class</span> Woman <span class="token punctuation">(</span>age<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="十、Actor-Model"><a href="#十、Actor-Model" class="headerlink" title="十、Actor Model"></a>十、<strong>Actor Model</strong></h1><p>\1.    概念理解</p><p>Actor Model是用来编写并行计算或分布式系统的高层次抽象（类似java中的Thread）让程序员不必为多线程模式下共享锁而烦恼,被用在Erlang 语言上, 高可用性99.9999999 % 一年只有31ms 宕机Actors将状态和行为封装在一个轻量的进程/线程中，但是不和其他Actors分享状态，每个Actors有自己的世界观，当需要和其他Actors交互时，通过发送事件和消息，发送是异步的，非堵塞的(fire-andforget)，发送消息后不必等另外Actors回复，也不必暂停，每个Actors有自己的消息队列，进来的消息按先来后到排列，这就有很好的并发策略和可伸缩性，可以建立性能很好的事件驱动系统。</p><p>Actor的特征：</p><p>Ø  ActorModel是消息传递模型,基本特征就是消息传递</p><p>Ø  消息发送是异步的，非阻塞的</p><p>Ø  消息一旦发送成功，不能修改</p><p>Ø  Actor之间传递时，自己决定决定去检查消息，而不是一直等待，是异步非阻塞的</p><p>什么是Akka</p><p>Akka 是一个用 Scala 编写的库，用于简化编写容错的、高可伸缩性的 Java 和Scala 的 Actor 模型应用，底层实现就是Actor,Akka是一个开发库和运行环境，可以用于构建高并发、分布式、可容错、事件驱动的基于JVM的应用。使构建高并发的分布式应用更加容易。</p><p>spark1.6版本之前，spark分布式节点之间的消息传递使用的就是Akka，底层也就是actor实现的。1.6之后使用的netty传输。</p><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">class</span> MyActor <span class="token keyword">extends</span> Actor<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">override</span> <span class="token keyword">def</span> act<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span><span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> receive <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">"hello"</span><span class="token keyword">=></span>println<span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>          <span class="token keyword">case</span> x<span class="token operator">:</span><span class="token builtin">String</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"save String ="</span><span class="token operator">+</span> x<span class="token punctuation">)</span>        <span class="token keyword">case</span> x<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"save Int"</span><span class="token punctuation">)</span>        <span class="token keyword">case</span> _ <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"save default"</span><span class="token punctuation">)</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> Actor<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> actor <span class="token operator">=</span> <span class="token keyword">new</span> MyActor<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//启动</span>        actor<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//发送消息</span>        actor <span class="token operator">!</span> <span class="token string">"hello"</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> Msg<span class="token punctuation">(</span>actor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> WoActor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Actor<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    oevrride <span class="token keyword">def</span> act<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            receive <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> msg<span class="token operator">:</span>Msg <span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    msg<span class="token punctuation">.</span>mes <span class="token comment" spellcheck="true">//收到的消息</span>                    msg<span class="token punctuation">.</span>actor <span class="token comment" spellcheck="true">//回复的消息</span>                    println<span class="token punctuation">(</span><span class="token string">"too"</span><span class="token punctuation">)</span>                    msg<span class="token punctuation">.</span>actor <span class="token operator">!</span> <span class="token string">"hahaha"</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">class</span> HuActor<span class="token punctuation">(</span>wo<span class="token operator">:</span>WoActor<span class="token punctuation">)</span> <span class="token keyword">extends</span> Actor<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    oevrride <span class="token keyword">def</span> act<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            receive <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token string">"hello"</span> <span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    println<span class="token punctuation">(</span><span class="token string">"too"</span><span class="token punctuation">)</span>                    <span class="token keyword">val</span> msg <span class="token operator">=</span> Msg<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">"rrr"</span><span class="token punctuation">)</span>                    wo <span class="token operator">!</span> msg                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                               <span class="token keyword">case</span> <span class="token string">"rrr"</span> <span class="token keyword">=></span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                    println<span class="token punctuation">(</span><span class="token string">"uuu"</span><span class="token punctuation">)</span>                   <span class="token keyword">val</span> msg <span class="token operator">=</span> Msg<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">"heheh"</span><span class="token punctuation">)</span>                    wo <span class="token operator">!</span> msg                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>     <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> Actor2<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>     <span class="token keyword">val</span> woman <span class="token operator">=</span> <span class="token keyword">new</span> WoActor<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> human <span class="token operator">=</span> <span class="token keyword">new</span> HuActor<span class="token punctuation">(</span>woman<span class="token punctuation">)</span>        human<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>        woman<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>        human <span class="token operator">!</span> <span class="token string">"hello"</span>          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-scala"><code class="language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> Message<span class="token punctuation">(</span>actor<span class="token operator">:</span>Actor<span class="token punctuation">,</span>msg<span class="token operator">:</span><span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token keyword">class</span> Actor1 <span class="token keyword">extends</span> Actor<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> act<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      receive<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">case</span>  msg <span class="token operator">:</span>Message <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>          println<span class="token punctuation">(</span><span class="token string">"i sava msg! = "</span><span class="token operator">+</span> msg<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>          msg<span class="token punctuation">.</span>actor<span class="token operator">!</span><span class="token string">"i love you too !"</span>          <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> msg <span class="token operator">:</span><span class="token builtin">String</span> <span class="token keyword">=></span> println<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>        <span class="token keyword">case</span>  _ <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"default msg!"</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">class</span> Actor2<span class="token punctuation">(</span>actor <span class="token operator">:</span>Actor<span class="token punctuation">)</span> <span class="token keyword">extends</span> Actor<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  actor <span class="token operator">!</span> Message<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">"i love you !"</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> act<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            receive<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>              <span class="token keyword">case</span> msg <span class="token operator">:</span><span class="token builtin">String</span> <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"i love you too !"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                  println<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>                 actor<span class="token operator">!</span> <span class="token string">"could we have a date !"</span>                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>              <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>              <span class="token keyword">case</span>  _ <span class="token keyword">=></span> println<span class="token punctuation">(</span><span class="token string">"default msg!"</span><span class="token punctuation">)</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">object</span> Lesson_Actor2 <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> actor1 <span class="token operator">=</span> <span class="token keyword">new</span> Actor1<span class="token punctuation">(</span><span class="token punctuation">)</span>    actor1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> actor2 <span class="token operator">=</span> <span class="token keyword">new</span> Actor2<span class="token punctuation">(</span>actor1<span class="token punctuation">)</span>    actor2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="十一、WordCount"><a href="#十一、WordCount" class="headerlink" title="十一、WordCount"></a>十一、WordCount</h1><pre class="line-numbers language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">//在lib文件中添加spark的jar包 ，并addLib</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkConf<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>SparkContext<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>RDD<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span>RDD<span class="token punctuation">.</span>rddToPairRDDFunctions<span class="token keyword">object</span> WordCount <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>    conf<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"WC"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//用于了解集群</span>    <span class="token comment" spellcheck="true">//RDD:集合 ，抽象的</span>    <span class="token keyword">val</span> lines <span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">"./words.txt"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//方式一：</span>    <span class="token keyword">val</span> word <span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>  <span class="token operator">=</span> lines<span class="token punctuation">.</span>flatMap<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>lines <span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      lines<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//匿名函数</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> pairs<span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> word<span class="token punctuation">.</span>map<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> x <span class="token keyword">=></span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//map :一进一出    flatmap：一进多出    x：每个单词</span>    <span class="token keyword">val</span> result<span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pairs<span class="token punctuation">.</span>reduceByKey<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token keyword">=></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        println<span class="token punctuation">(</span><span class="token string">"a:"</span><span class="token operator">+</span>a<span class="token operator">+</span><span class="token string">",b:"</span><span class="token operator">+</span>b<span class="token punctuation">)</span>        a<span class="token operator">+</span>b    <span class="token comment" spellcheck="true">//相当于  a = a + b用于下一个统计</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//优化：排序  false（降序）  第一个_ 代表每个元素</span>    result<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//方式二：简化写法</span>    lines<span class="token punctuation">.</span>flatMap <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> _<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">.</span>map <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_<span class="token operator">+</span>_<span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Scala的详细学习</summary>
    
    
    
    <category term="Scala" scheme="https://sukie-sun.github.io/categories/Scala/"/>
    
    
    <category term="编程语言" scheme="https://sukie-sun.github.io/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/"/>
    
    <category term="静态" scheme="https://sukie-sun.github.io/tags/%E9%9D%99%E6%80%81/"/>
    
    <category term="JVM" scheme="https://sukie-sun.github.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>Redis学习</title>
    <link href="https://sukie-sun.github.io/2019/02/14/Redis%E5%AD%A6%E4%B9%A0/"/>
    <id>https://sukie-sun.github.io/2019/02/14/Redis%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-02-13T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.779Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、Redis的简介"><a href="#一、Redis的简介" class="headerlink" title="一、Redis的简介"></a>一、Redis的简介</h1><h2 id="1、前情提要"><a href="#1、前情提要" class="headerlink" title="1、前情提要"></a>1、前情提要</h2><p><strong>磁盘数据库</strong>： </p><p> MySQL（关系型数据库）<br> Hbase</p><p><img src="images/redis1.jpg"></p><p><strong>内存数据库</strong>：<br>  Redis<br>  memcached<br>  （成本高、性能好、读写速度快、数据安全性低、直接把值放到内存里面，内存数据库就直接把值取到）</p><p><img src="images/redis2.jpg"></p><h2 id="2、用作数据库、缓存和消息中间件"><a href="#2、用作数据库、缓存和消息中间件" class="headerlink" title="2、用作数据库、缓存和消息中间件"></a>2、用作数据库、缓存和消息中间件</h2><blockquote><p>二八法则：80%是经常被查询，使用内存数据库做缓存中间件，读取性能高</p></blockquote><h1 id="二、Redis的特点"><a href="#二、Redis的特点" class="headerlink" title="二、Redis的特点"></a>二、Redis的特点</h1><h2 id="1、数据结构丰富"><a href="#1、数据结构丰富" class="headerlink" title="1、数据结构丰富"></a>1、数据结构丰富</h2><p>Redis虽然是键值对数据库，但他支持多种类型的数据结构（主要是不同类型的value）</p><blockquote><p>字符串、散列（hashes），列表（lists），集合（sets），有序集合（sorted sets）</p></blockquote><p><img src="images/redis0.jpg"></p><h2 id="2、数据的持久化"><a href="#2、数据的持久化" class="headerlink" title="2、数据的持久化"></a>2、数据的持久化</h2><p>Redis 支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载到内存进行使用</p><h2 id="3、数据的备份"><a href="#3、数据的备份" class="headerlink" title="3、数据的备份"></a>3、数据的备份</h2><p>Redis 支持数据的备份，即 master-slave 模式的数据备份。</p><h1 id="三、Redis的安装"><a href="#三、Redis的安装" class="headerlink" title="三、Redis的安装"></a>三、Redis的安装</h1><h2 id="1、下载安装包"><a href="#1、下载安装包" class="headerlink" title="1、下载安装包"></a>1、下载安装包</h2><p>redis-3.2.9.tar.gz </p><p>网址：<a href="http://www.redis.cn/download.html">http://www.redis.cn/download.html</a></p><h2 id="2、依赖软件安装"><a href="#2、依赖软件安装" class="headerlink" title="2、依赖软件安装"></a>2、依赖软件安装</h2><pre><code>yum install gcc tcl -y</code></pre><h2 id="3、解压-redis"><a href="#3、解压-redis" class="headerlink" title="3、解压 redis"></a>3、解压 redis</h2><p>并进入解压目录</p><pre><code>tar -zvxf redis-3.2.9.tar.gz </code></pre><h2 id="4、-执行-编译命令"><a href="#4、-执行-编译命令" class="headerlink" title="4、 执行 编译命令"></a>4、 执行 编译命令</h2><p>（<code>注意：</code>当前路径下需包含 makefile文件  ： 用于手动编译）</p><pre><code>make &amp;&amp; make install</code></pre><h2 id="5、修改-redis-的配置文件"><a href="#5、修改-redis-的配置文件" class="headerlink" title="5、修改 redis 的配置文件"></a>5、修改 redis 的配置文件</h2><p> redis.config ( 先 备份一个原厂配置文件)</p><pre class="line-numbers language-shell"><code class="language-shell">vim redis.config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>修改运行模式为后台运行（如果为no，启动redis-server后，控制台就会卡在启动状态）daemonize守护进程</li></ul><pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">daemonize</span> <span class="token attr-value">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>指定redis数据持久化的路径(在执行redis-cli命令的当前路径，会生成dump.rdb文件)</li></ul><pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">dir</span> <span class="token attr-value">  ./</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>使用默认的 redis.conf 文件，redis 默认只能通过 127.0.0.1:6379 这个地址访问，这样就只能在本机上操作了</li><li>想要远程操作，需要修改redis.conf 这个配置文件，在配置文件中添加相应的 ip 地址， 在bind 127.0.0.1 后面追加</li></ul><pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">bind</span> <span class="token attr-value">127.0.0.1 192.168.198.128</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="6、启动server服务"><a href="#6、启动server服务" class="headerlink" title="6、启动server服务"></a>6、启动server服务</h2><p>（如在redis的解压目录下）</p><blockquote><p>命令： redis-server 配置文件的地址</p></blockquote><pre class="line-numbers language-shell"><code class="language-shell"> redis-server redis-conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>终止服务：（查询redis进程号，然后，kill该进程）</p><pre><code>ps -ef | grep rediskill 进程号</code></pre><h2 id="7、启动客户端服务"><a href="#7、启动客户端服务" class="headerlink" title="7、启动客户端服务"></a>7、启动客户端服务</h2><pre class="line-numbers language-shell"><code class="language-shell">redis-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>客户端命令格式：redis-cli –h host –p port</p><p>显示：</p><blockquote><p>127.0.0.1:6379&gt; </p></blockquote><h1 id="四、Redis的使用"><a href="#四、Redis的使用" class="headerlink" title="四、Redis的使用"></a>四、Redis的使用</h1><h2 id="0、前情提要"><a href="#0、前情提要" class="headerlink" title="0、前情提要"></a>0、前情提要</h2><p>Redis的key 值是二进制安全的，这意味着可以用任何二进制序列作为 key值。</p><h2 id="1、切换数据库（实例）"><a href="#1、切换数据库（实例）" class="headerlink" title="1、切换数据库（实例）"></a>1、切换数据库（实例）</h2><blockquote><p>select databaseid 默认共有 16 个实例库，</p><p>登录时是 ID 为0 的数据库，总共有 16 个</p></blockquote><pre><code>select 0</code></pre><h2 id="2、Key操作："><a href="#2、Key操作：" class="headerlink" title="2、Key操作："></a>2、Key操作：</h2><p>（前提：是针对已经存在key）</p><blockquote><p>KEYS pattern<br>查找所有符合给定模式 pattern 的 key 。</p><pre class="line-numbers language-shell"><code class="language-shell">keys * <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>列出所有Key</p></blockquote><blockquote><p>EXISTS  key<br>检查给定 key 是否存在。</p><pre><code>EXISTS  name</code></pre><p>若显示0，则不存在；若显示1，则存在</p></blockquote><blockquote><p>EXPIRE key seconds<br>为给定 key 设置生存时间，当 key 过期时(生存时间为 0 )，它会被自动删除。</p><pre><code>EXPIRE age 1</code></pre><p>若设置成功，显示1；显示0 ，则为失败，可能是该key不存在</p></blockquote><blockquote><p>TTL key<br>以秒为单位，返回给定 key 的剩余生存时间</p></blockquote><blockquote><p>MOVE key db</p><p>将当前数据库的 key 移动到给定的数据库 db 当中。<br>如果当前数据库(源数据库)和给定数据库(目标数据库)有相同名字的给定 key ，或者 key 不存在于当前数据库，那么 MOVE 没有任何效果</p><pre><code> move name 1</code></pre><p>name 是数据库0中已存在的key，移动到数据库1中后，0中就不存在该key</p></blockquote><blockquote><p>TYPE key</p><p>返回 key 所储存的值的类型。</p></blockquote><blockquote><pre><code>DEL key [key ...]</code></pre><p>删除给定的一个或多个 key 。不存在的 key 会被忽略</p></blockquote><h2 id="3、String-操作"><a href="#3、String-操作" class="headerlink" title="3、String  操作"></a>3、String  操作</h2><p>字符串是一种最基本的 Redis 值类型。Redis 字符串是二进制安全的，这<br>意味着一个 Redis 字符串能包含任意类型的数据</p><blockquote><pre><code>SET key value [EX seconds][PX milliseconds] [NX|XX]</code></pre><p> EX 设置过期时间，秒，等同于 SETEX key seconds value<br> PX 设置过期时间，毫秒，等同于 PSETEX key milliseconds value<br> NX 键不存在，才能设置，等同于 SETNX key value<br> XX 键存在时，才能设置</p></blockquote><p><code>注意</code></p><p>将字符串值 value 关联到 key 。<br>如果 key 已经持有其他值， SET 就覆写旧值，无视类型。<br>对于某个原本带有生存时间（TTL）的键来说， 当 SET 命令成功在这个键上执行时， 这个键原有的 TTL 将被清除。</p><blockquote><pre><code>GET key</code></pre><p>返回 key 所关联的字符串值。如果 key 不存在那么返回特殊值 nil 。<br>假如 key 储存的值不是字符串类型，返回一个错误，因为 GET 只能<br>用于处理字符串值</p></blockquote><blockquote><pre><code>APPEND key value</code></pre><p>如果 key 已经存在并且是一个字符串， APPEND 命令将 value 追加到 key 原来的值的末尾。<br>如果 key 不存在， APPEND 就简单地将给定 key 设为 value ，就像执行 SET key value 一样。</p></blockquote><blockquote><pre><code>STRLEN key</code></pre><p>返回 key 所储存的字符串值的长度。<br>当 key 储存的不是字符串值时，返回一个错误。</p></blockquote><blockquote><pre><code>INCR key</code></pre><p>将 key 中储存的数字值增一，并显示。<br>如果 key 不存在，那么 key 的值会先被初始化为 0 ，然后再执行INCR 操作。<br>如果值包含错误的类型，或字符串类型的值不能表示为数字，那么返回一个错误。</p><p><code>错误：</code></p><p>(error) ERR value is not an integer or out of range</p></blockquote><blockquote><pre><code>INCRBY key increment</code></pre><p>将 key 所储存的值加上增量 increment ，并显示。<br>如果 key 不存在，那么 key 的值会先被初始化为 0 ，然后再执行INCRBY 命令。<br>如果值包含错误的类型，或字符串类型的值不能表示为数字，那么返回一个错误。</p></blockquote><blockquote><pre><code>DECR key</code></pre><p>将 key 中储存的数字值减一。</p><pre><code>DECRBY key decrement</code></pre><p>将 key 所储存的值减去减量 decrement 。</p></blockquote><blockquote><pre><code> GETRANGE key start end</code></pre><p>返回 key 中字符串值的子字符串，字符串的截取范围由 start 和end 两个偏移量决定(包括 start 和 end 在内)。<br>负数偏移量表示从字符串最后开始计数， -1 表示最后一个字符， -2 表示倒数第二个，以此类推</p></blockquote><blockquote><pre><code>SETRANGE key offset value</code></pre><p>用 value 参数覆写(overwrite)给定 key 所储存的字符串值，从偏移量 offset 开始。<br>不存在的 key 当作空白字符串处理。</p></blockquote><blockquote><pre><code>SETEX key  seconds value</code></pre><p>将值 value 关联到 key ，并将 key 的生存时间设为 seconds<br>如果 key 已经存在， SETEX 命令将覆写旧值。<br>这个命令类似于以下两个命令：</p><pre><code>SET key valueEXPIRE key seconds # 设置生存时间</code></pre></blockquote><blockquote><p>不同之处是， SETEX 是一个原子性(atomic)操作，关联值和设置生存时间两个动作会在同一时间内完成，该命令在 Redis 用作缓存时，非常实用。</p></blockquote><blockquote><pre class="line-numbers language-shell"><code class="language-shell">SETNX key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将 key 的值设为 value ，当且仅当 key 不存在。<br>若给定的 key 已经存在，则 SETNX 不做任何动作。<br>SETNX 是『SET if Not eXists』(如果不存在，则 SET)的简写。</p></blockquote><blockquote><pre><code>MGET key [key ...]</code></pre><p>返回所有(一个或多个)给定 key 的值。<br>如果给定的 key 里面，有某个 key 不存在，那么这个 key 返回特殊值 nil 。因此，该命令永不失败</p></blockquote><blockquote><pre><code>MSET key value [key value ...]</code></pre><p>同时设置一个或多个 key-value 对。<br>如果某个给定 key 已经存在，那么 MSET 会用新值覆盖原来的旧值，如果这不是你所希望的效果，请考虑使用 MSETNX 命令：它只会在所有给定 key 都不存在的情况下进行设置操作。</p></blockquote><blockquote><pre><code>MSETNX key value [key value ...]</code></pre><p>同时设置一个或多个 key-value 对，当且仅当所有给定 key 都不存在。<br>即使只有一个给定 key 已存在， MSETNX 也会拒绝执行所有给定 key 的设置操作。<br>MSETNX 是原子性的，因此它可以用作设置多个不同 key 表示不同字段(field)的唯一性逻辑对象(unique logic object)，所有字段要么全被设置，要么全不被设置。</p></blockquote><h2 id="4、-List-操作"><a href="#4、-List-操作" class="headerlink" title="4、 List 操作"></a>4、 List 操作</h2><blockquote><pre><code>LPUSH key value [value ...]</code></pre><p>将一个或多个值 value 插入到列表 key 的表头。（从左边插入）<br>如果有多个 value 值，那么各个 value 值按从左到右的顺序依次 插 入 到 表 头 ：</p><p> 比 如 说 ，</p><p> 对 空 列 表 mylist  执 行 命令 LPUSH mylist a b c ，列表的值将是 c b a ，</p><p>这等同于原 子 性 地 执行 LPUSH mylist a 、 LPUSH mylist b 和 LPUSH mylistc 三个命令。</p></blockquote><blockquote><pre><code>RPUSH key value [value ...]</code></pre><p>将一个或多个值 value 插入到列表 key 的表尾。（从右边插入）<br>如果有多个 value 值，那么各个 value 值按从左到右的顺序依次 插 入 到 表 尾 ： </p><p>比 如 对 一 个 空 列 表 mylist  执行 RPUSH mylist a b c ，得出的结果列表为 a b c ，</p><p>等同于 执 行 命令 RPUSH mylist a 、 RPUSH mylist b 、 RPUSH mylist c 。</p></blockquote><blockquote><pre><code>LRANGE key  start stop</code></pre><p>返 回 列 表 key  中 指 定 区 间 内 的 元 素 ， 区 间 以 偏 移量 start 和 stop 指定。（从左至右）<br>下标(index)参数 start 和 stop 都以 0 为底，也就是说，以 0 表示列表的第一个元素，以 1 表示列表的第二个元素，以此类推。-1 表示最后一个元素</p></blockquote><blockquote><pre><code>LPOP key</code></pre><p>移除并返回列表 key 的头元素。（从列表key的左边开始弹出元素）</p><pre><code>RPOP key</code></pre><p>移除并返回列表 key 的尾元素。（从列表key的右边开始弹出元素）</p></blockquote><p><code>备注：</code></p><blockquote><p>同向为栈，异向为队列<br>栈（lpush  lpop  ； rpush  rpop）</p><p>队列（lpush  rpop ； rpush   lpop  ）</p><p>ArrayList : 数组（查找快，增删慢）<br>LinkList  : 链表（查找慢，增删快）</p></blockquote><blockquote><pre><code>LINDEX key index</code></pre><p>返回列表 key 中，下标为 index 的元素。<br>下标(index)参数 start 和 stop 都以 0 为底，也就是说，以 0 表示列表的第一个元素，以 1 表示列表的第二个元素，以此类推。<br>你也可以使用负数下标，以 -1 表示列表的最后一个元素， -2 表示列表的倒数第二个元素，以此类推</p></blockquote><blockquote><pre><code>LLEN key</code></pre><p>返回列表 key 的长度。<br>如果 key 不存在，则 key 被解释为一个空列表，返回 0 .</p><pre><code>LREM key count value</code></pre><p>根据参数 count 的值，移除列表中与参数 value 相等的元素。<br>count 的值可以是以下几种：<br>count &gt; 0 : 从表头开始向表尾搜索，移除与 value 相等的元<br>素，数量为 count 。<br>count &lt; 0 : 从表尾开始向表头搜索，移除与 value 相等的元<br>素，数量为 count 的绝对值。<br>count = 0 : 移除表中所有与 value 相等的值。</p></blockquote><blockquote><pre><code>LTRIM key start stop</code></pre><p>对一个列表进行修剪(trim)，就是说，让列表只保留指定区间内的元素，</p><p>不在指定区间之内的元素都将被删除。<br>举 个 例 子 ， 执 行 命 令 LTRIM list 0 2 ， 表 示 只 保 留 列表 list 的前三个元素，其余元素全部删除</p></blockquote><blockquote><pre><code>RPOPLPUSH source  destination</code></pre><p>命令 RPOPLPUSH 在一个原子时间内，执行以下两个动作：<br>将列表 source 中的最后一个元素(尾元素)弹出，并返回给客户端。将 source  弹 出 的 元 素 插 入 到 列 表 destination  ， 作为 destination 列表的的头元素。<br>举 个 例 子 ， </p><p>你 有 两 个 列表 source  和 destination  ， source  列 表 有 元素 a, b, c ， destination 列表有元素 x, y, z ，执行 RPOPLPUSH sourcedestination 之后， source 列表包含元素 a, b ， destination 列表包含元素 c, x, y, z ，并且元素 c 会被返回给客户端。</p></blockquote><blockquote><pre><code>LSET key index value</code></pre><p>将列表 key 下标为 index 的元素的值设置为 value 。<br>当 index 参数超出范围，或对一个空列表( key 不存在)进行 LSET 时，返回一个错误。</p></blockquote><blockquote><pre><code>LINSERT key BEFORE|AFTER pivot value</code></pre><p>将值 value 插入到列表 key 当中，位于值 pivot 之前或之后。<br>当 pivot 不存在于列表 key 时，不执行任何操作。<br>当 key 不存在时， key 被视为空列表，不执行任何操作。</p></blockquote><h2 id="5、Set操作"><a href="#5、Set操作" class="headerlink" title="5、Set操作"></a>5、Set操作</h2><blockquote><pre><code>SADD key member [member ...]</code></pre><p>将一个或多个 member 元素加入到集合 key 当中（无序），已经存在于集合的 member 元素将被忽略。<br>假如 key 不存在，则创建一个只包含 member 元素作成员的集合。</p></blockquote><blockquote><pre><code>SMEMBERS key</code></pre><p>返回集合 key 中的所有成员。</p><p>不存在的 key 被视为空集合。</p><pre><code>SISMEMBER key member</code></pre><p>判断 member 元素是否是集合 key 的成员。</p></blockquote><blockquote><pre><code>SCARD key</code></pre><p>返回集合 key 的基数(集合中元素的数量)。</p></blockquote><blockquote><pre><code>SREM key member [member ...]</code></pre><p>移 除 集 合 key 中 的 一 个 或 多 个 member 元 素 ， 不 存 在的 member 元素会被忽略。</p><pre><code>SPOP key （抽奖场景）</code></pre><p>移除并返回集合中的一个随机元素。<br>如果只想获取一个随机元素，但不想该元素从集合中被移除的话，可以使用 SRANDMEMBER 命令。</p><pre><code>SMOVE source destination member</code></pre><p>将 member 元素从 source 集合移动到 destination 集合。<br>SMOVE 是原子性操作。<br>如果 source 集合不存在或不包含指定的 member 元素，<br>则 SMOVE 命令不执行任何操作，仅返回 0 。否则， member 元素从 source 集合中被移除，并添加到 destination 集合中去。<br>当 destination 集合已经包含 member 元素时， SMOVE 命令只是简单地将 source 集合中的 member 元素删除。<br>当 source 或 destination 不是集合类型时，返回一个错误。</p></blockquote><blockquote><pre><code>SDIFF key [key ...]</code></pre><p>求差集：从第一个 key 的集合中去除其他集合和自己的交集部分</p><p>sdiff求两个set的差集，有先后顺序，以靠前的为基准，列出前一个set有的，而后一个set没有的元素</p></blockquote><blockquote><pre><code>SINTER key [key  ...] （微博求共同关注场景）</code></pre><p>返回一个集合的全部成员，该集合是所有给定集合的交集。<br>不存在的 key 被视为空集。<br>当给定集合当中有一个空集时，结果也为空集(根据集合运算定律)。</p><pre><code>SUNION key [key ...]</code></pre><p>返回一个集合的全部成员，该集合是所有给定集合的并集。<br>不存在的 key 被视为空集。</p></blockquote><h2 id="6、Sorted-set操作"><a href="#6、Sorted-set操作" class="headerlink" title="6、Sorted set操作"></a>6、Sorted set操作</h2><p>类似 Sets,但是每个字符串元素都关联到一个叫 score 浮动数值。里面的元素总是通过 score 进行着排序，所以不同的是，它是可以检索的一系列元素。</p><p><code>注意：</code></p><blockquote><p>在 set 基础上，加上 score 值，</p><p>之前 set 是key value1 value2….<br>现在 Zset 是 key score1 value1 score2 value2</p></blockquote><blockquote><pre><code>ZADD key score member [[score member][score member] ...]</code></pre><p>将 一 个 或 多 个 member 元 素 及 其 score 值 加 入 到 有 序集 key 当中。</p><p><code>显示</code></p><p>redis&gt; ZADD page_rank 9 baidu.com 8 bing.com 10 google.com<br>(integer) 2<br>redis&gt; ZRANGE page_rank 0 -1 WITHSCORES</p><ol><li>“bing.com”</li><li>“8”</li><li>“baidu.com”</li><li>“9”</li><li>“google.com”</li><li>“10”</li></ol></blockquote><blockquote><pre><code>ZRANGE key start stop [WITHSCORES]</code></pre><p>返回有序集 key 中，指定区间内的成员。<br>其中成员的位置按 score 值递增(从小到大)来排序。<br>具有相同 score 值的成员按字典序(lexicographical order )来排列。<br>如果你需要成员按 score 值递减(从大到小)来排列，请使用 ZREVRANGE 命令。<br>下标参数 start 和 stop 都以 0 为底，</p><p>也就是说，以 0 表示有序集第一个成员，以 1 表示有序集第二个成员，以此类推。<br>你也可以使用负数下标，以 -1 表示最后一个成员， -2 表示倒数第二个成员，以此类推。<br>超出范围的下标并不会引起错误。<br>比 如 说 ， 当 start 的 值 比 有 序 集 的 最 大 下 标 还 要 大 ， 或是 start &gt; stop 时， ZRANGE 命令只是简单地返回一个空列表。<br>另一方面，假如 stop 参数的值比有序集的最大下标还要大，那么Redis 将 stop 当作最大下标来处理。<br>可以通过使用 WITHSCORES 选项，来让成员和它的 score 值一并返回，</p><p>返回列表以 value1,score1, …, valueN,scoreN 的格式表示。</p></blockquote><blockquote><pre><code>ZREVRANGE key start stop [WITHSCORES]( ( 音乐排行榜场景) )</code></pre><p>返回有序集 key 中，指定区间内的成员。<br>其中成员的位置按 score 值递减(从大到小)来排列。</p></blockquote><blockquote><pre><code>ZREM key member [member ...]</code></pre><p>移除有序集 key 中的一个或多个成员，不存在的成员将被忽略。</p><pre><code>ZREMRANGEBYSCORE key min max</code></pre><p>移除有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。</p></blockquote><blockquote><pre><code>ZSCORE key member</code></pre><p>返回有序集 key 中，成员 member 的 score 值。</p><pre><code>ZCARD key</code></pre><p>返回有序集 key 的基数（包含的元素的个数）。</p><pre><code>ZCOUNT key min max</code></pre><p>返回有序集 key 中， score 值在 min 和 max 之间(默认包括 score 值等于 min 或 max )的成员的数量。</p><pre><code>ZRANK key member</code></pre><p>返回有序集 key 中，成员 member 的 score 值。<br>ZCARD key<br>返回有序集 key 的基数（包含的元素的个数）。<br>ZCOUNT key min max<br>返回有序集 key 中， score 值在 min 和 max 之间(默认包括 score 值等于 min 或 max )的成员的数量。<br>ZRANK key member</p><p>返回有序集 key 中成员 member 的排名。其中有序集成员按 score 值递增(从小到大)顺序排列。</p></blockquote><h2 id="7、-Hash-操作-（散列）"><a href="#7、-Hash-操作-（散列）" class="headerlink" title="7、 Hash  操作  （散列）"></a>7、 Hash  操作  （散列）</h2><p>KV 模式不变，但是 V 是一个键值对</p><blockquote><pre><code>HSET key field value</code></pre><p>将哈希表 key 中的域 field 的值设为 value 。</p></blockquote><blockquote><pre><code>HGET key field</code></pre><p>返回哈希表 key 中给定域 field 的值。</p></blockquote><blockquote><pre><code>HMSET key field value [field value ...]</code></pre><p>同时将多个 field-value (域-值)对设置到哈希表 key 中。<br>此命令会覆盖哈希表中已存在的域。</p><pre><code>HMGET key field [field ...]</code></pre><p>返回哈希表 key 中，一个或多个给定域的值。</p><pre><code>HGETALL key</code></pre><p>返回哈希表 key 中，所有的域和值。</p></blockquote><blockquote><pre><code>HKEYS key</code></pre><p>返回哈希表 key 中的所有域。</p><pre><code>HVALS key</code></pre><p>返回哈希表 key 中所有域的值。</p></blockquote><blockquote><pre><code>HSETNX key field value</code></pre><p>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在。<br>若域 field 已经存在，该操作无效。</p></blockquote><blockquote><pre><code>HEXISTS key field</code></pre><p>查看哈希表 key 中，给定域 field 是否存在。</p></blockquote><blockquote><pre><code>HDEL key field [field ...]</code></pre><p>删除哈希表 key 中的一个或多个指定域，不存在的域将被忽略。</p></blockquote><blockquote><pre><code>HINCRBY key field increment</code></pre><p>为哈希表 key 中的域 field 的值加上增量 increment 。<br>增量也可以为负数，相当于对给定域进行减法操作。</p></blockquote><blockquote><pre><code>HINCRBYFLOAT key field increment</code></pre><p>增加浮点数<br>场景：用户维度统计<br>统计数包括：关注数、粉丝数、喜欢商品数、发帖数<br>用户为 Key，不同维度为 Field，Value 为统计数</p></blockquote><h1 id="五、Redis-的持久化"><a href="#五、Redis-的持久化" class="headerlink" title="五、Redis 的持久化"></a>五、Redis 的持久化</h1><h2 id="1、Redis-持久化方式"><a href="#1、Redis-持久化方式" class="headerlink" title="1、Redis  持久化方式"></a>1、Redis  持久化方式</h2><ul><li><p>RDB 持久化可以在指定的时间间隔内生成数据集的时间点快照（point-in-time snapshot）。</p></li><li><p>AOF 持久化记录服务器执行的所有写操作命令，并在服务器启动时，通过重新执行这些命令来还原数据集。 </p><p>AOF 文件中的命令全部以 Redis协议的格式来保存，新命令会被追加到文件的末尾。 </p><p>Redis 还可以在后台对 AOF 文件进行重写（rewrite），使得 AOF 文件的体积不会超出保<br>存数据集状态所需的实际大小。</p></li><li><p>Redis 还可以同时使用 AOF 持久化和 RDB 持久化。 </p><p>在这种情况下， 当 Redis 重启时， 它会优先使用 AOF 文件来还原数据集， </p><p>因为 AOF 文件保存的数据集通常比 RDB 文件所保存的数据集更完整。</p></li><li><p>你甚至可以关闭持久化功能，让数据只在服务器运行时存在。</p></li></ul><h2 id="2、Rdb"><a href="#2、Rdb" class="headerlink" title="2、Rdb:"></a>2、Rdb:</h2><p>（1）在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的 snapshot 快照，它恢复时就是将快照文件直接读到内存里。</p><p>Rdb 保存的是 dump.rdb 文件</p><p>（2）如何触发 RDB 快照</p><p>Save：save 时只管保存，其他不管，全部阻塞。<br>Bgsave：redis 会在后台进行快照操作，快照操作的同时还可以响应客户端的请求，可以通过 lastsave 命令获取最后一次成功执行快照的时间。</p><p>（3）如何停止</p><p>静态停止：将配置文件里的 RDB 保存规则改为 save “”<br>动态停止 ：</p><blockquote><p> config set save “ ”</p></blockquote><h2 id="3、AOF"><a href="#3、AOF" class="headerlink" title="3、AOF"></a>3、AOF</h2><p>(Append Only File)</p><p>（1）以日志的形式来记录每个写操作，将 redis 执行过的所有写指令记录下来(读操作不记录)。只许追加文件但不可以改写文件，redis 启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次一完成数据恢复工作。<br>======APPEND ONLY MODE======<br>开启 aof ：appendonly yes (默认是 no)</p><p>（2）Aof  策略</p><p>Appendfsync 参数：</p><p>Always ：同步持久化 每次发生数据变更会被立即记录到磁盘，性能较差<br>但数据完整性较好。<br>Everysec： 出厂默认推荐，异步操作，每秒记录，如果一秒宕机，有数<br>据丢失<br>No：从不 fsync ：将数据交给操作系统来处理。更快，也更不安全的选<br>择。</p><p>（3）Rewrite</p><p><code>概念</code>：AOF 采用文件追加方式，文件会越来越来大为避免出现此种情况，<br>新增了重写机制，aof 文件的大小超过所设定的阈值时，redis 就会自动将 aof文件的内容压缩，只保留可以恢复数据的最小指令集，可以使用命令<br>bgrewirteaof。</p><p><code>触发机制</code>：redis 会记录上次重写的 aof 的大小，默认的配置当 aof 文件大小为上次 rewrite 后大小的一倍且文件大于 64M 触发。</p><p><code>重写原理：</code>aof 文件持续增长而大时，会 fork 出一条新进程来将文件重写<br>(也就是先写临时文件最后再 rename)，遍历新进程的内存中的数据，每条记录有一条 set 语句，重写 aof 文件的操作，并没有读取旧的的 aof 文件，而是将整个内存的数据库内容用命令的方式重写了一个新的 aof 文件，这点和快照有点类似。</p><blockquote><p>no-appendfsync-on-rewrite no : </p><p>重写时是否可以运用 Appendfsync 用默认 no 即可，保证数据安全</p><p>auto-aof-rewrite-percentage 倍数  设置基准值<br>auto-aof-rewrite-min-size   设置基准值大小</p></blockquote><p>（4）flushall<br>刷新内存中的数据，即清空数据<br>可通过删除aof文件中该操作的记录来恢复数据<br>rdb文件无法实现数据恢复</p><p>（5）aof 特点</p><p>aof优点：<br>可用于数据恢复<br>缺点：<br>体积大，速度慢</p><p>aof文件体积会越来越大</p><p>（6）aof文件优化<br>重写：当文件大小达到一定阈值，启动压缩文件</p><blockquote><p>netstat -anpt<br>查看所有端口的使用情况</p></blockquote><h2 id="4、备份-Redis-数据"><a href="#4、备份-Redis-数据" class="headerlink" title="4、备份 Redis  数据"></a>4、备份 Redis  数据</h2><p><code>建议：</code><br>创建一个定期任务（cron job）， 每小时将一个 RDB 文件备份到一个文件<br>夹， 并且每天将一个 RDB 文件备份到另一个文件夹。<br>确保快照的备份都带有相应的日期和时间信息， 每次执行定期任务脚本<br>时， 使用 find 命令来删除过期的快照： 比如说， 你可以保留最近 48 小时<br>内的每小时快照， 还可以保留最近一两个月的每日快照。<br>至少每天一次， 将 RDB 备份到你的数据中心之外， 或者至少是备份到你<br>运行 Redis 服务器的物理机器之外。</p><h1 id="六、Redis-主从复制"><a href="#六、Redis-主从复制" class="headerlink" title="六、Redis  主从复制"></a>六、Redis  主从复制</h1><h2 id="0、前情提要-1"><a href="#0、前情提要-1" class="headerlink" title="0、前情提要"></a>0、前情提要</h2><p>Redis 支持简单且易用的主从复制（master-slave replication）功能， 该功能可以让从服务器(slave server)成为主服务器(masterserver)的精确复制品 。</p><h2 id="1、关于-Redis-复制功能的几个重要方面："><a href="#1、关于-Redis-复制功能的几个重要方面：" class="headerlink" title="1、关于 Redis 复制功能的几个重要方面："></a>1、关于 Redis 复制功能的几个重要方面：</h2><ul><li>Redis 使用异步复制。</li><li>一个主服务器可以有多个从服务器。</li><li>不仅主服务器可以有从服务器， 从服务器也可以有自己的从服务器，<br>多个从服务器之间可以构成一个图状结构。</li><li>复制功能不会阻塞主服务器： 即使有一个或多个从服务器正在进行初次<br>同步， 主服务器也可以继续处理命令请求。不过， 在从服务器删除旧版本数据集并载入新版本数据集的那段时间内， 连接请求会被阻塞。</li><li>复制功能可以单纯地用于数据冗余（data redundancy）， 也可以通过让多个从服务器处理只读命令请求来提升扩展性（scalability）： 比如说， 繁重的 SORT 命令可以交给附属节点去运行。</li></ul><h2 id="2、从服务器配置"><a href="#2、从服务器配置" class="headerlink" title="2、从服务器配置"></a>2、从服务器配置</h2><p>方式一：编辑配置文件</p><p>（永久生效）</p><blockquote><p>添加主服务器的IP</p><p>slaveof 192.168.198.128 6379</p></blockquote><p>方式二：调用 SLAVEOF 命令，输入主服务器的 IP 和端口，然后同步就会开始</p><p><code>前提：</code>主从服务器的redis-server均启动了</p><p>（仅适用于当前线程的服务，同步时，会将自己原来的key值数据清空，并且在主服务器页面会显示关于从服务器的日志信息）</p><blockquote><p>127.0.0.1:6379&gt; SLAVEOF 192.168.198.128 6379</p></blockquote><p>若想取消该服务器的主从关系，使用如下命令，且还会保存当前数据</p><blockquote><p>127.0.0.1:6379&gt; SLAVEOF no one</p></blockquote><p>连接远程节点的redis服务（端口默认为6379）</p><blockquote><p>redis-cli -h 192.168.198.128 </p></blockquote><h2 id="3、只读服务器"><a href="#3、只读服务器" class="headerlink" title="3、只读服务器"></a>3、只读服务器</h2><p>从 Redis 2.6 开始， 从服务器支持<code>只读模式</code>， 并且该模式为从服务器的默认模式。<br>  只读模式配置</p><blockquote><p>方式一：由 redis.conf 文件中的 slave-read-only 选项控制</p><p>slave-read-only yes</p><p>方式二：通过 CONFIG SET 命令来开启或关闭这个模式</p></blockquote><p>  只读从服务器会拒绝执行任何写命令， 所以不会出现因为操作失误而将数据不小心写入到了从服务器的情况。</p><p>  另外，对一个从属服务器执行命令 SLAVEOF NO ONE 将使得这个从属服务器关闭复制功能，并从从属服务器转变回主服务器，原来同步所得的数据集不会被丢弃。</p><p>  利用『 SLAVEOF NO ONE 不会丢弃同步所得数据集』这个特性，可以在主服务器失败的时候，将从属服务器用作新的主服务器，从而实现无间断运行。</p><h2 id="4、从服务器相关配置："><a href="#4、从服务器相关配置：" class="headerlink" title="4、从服务器相关配置："></a>4、从服务器相关配置：</h2><p>设置密码：</p><p>​     主服务器：</p><blockquote><p>通过 requirepass 选项设置密码</p></blockquote><p>​     从服务器：</p><p>方式一：</p><blockquote><p>服务器正在运行，使用客户端输入以下命令：<br>config set masterauth <password></password></p></blockquote><p>方式二：</p><blockquote><p>将它加入到配置文件中：<br>masterauth <password></password></p></blockquote><h2 id="5、主服务器配置"><a href="#5、主服务器配置" class="headerlink" title="5、主服务器配置"></a>5、主服务器配置</h2><p>只在有至少 N  个从服务器的情况下，才执行写操作</p><p>从 Redis 2.8 开始， 为了保证数据的安全性，可以通过配置， 让主服务器只在有至少 N 个当前已连接从服务器的情况下， 才执行写命令。</p><blockquote><p>min-slaves-to-write <number of slaves><br>min-slaves-max-lag <number of seconds></number></number></p></blockquote><p>至少有 min-slaves-to-write 个从服务器， 并且这些服务器的延迟值都少于 min-slaves-max-lag 秒， 那么主服务器就会执行客户端请求的写操作。</p><h1 id="七、Redis-sentinel-哨兵"><a href="#七、Redis-sentinel-哨兵" class="headerlink" title="七、Redis-sentinel( 哨兵)"></a>七、Redis-sentinel( 哨兵)</h1><h2 id="0、前情提要-2"><a href="#0、前情提要-2" class="headerlink" title="0、前情提要"></a>0、前情提要</h2><p>Redis 的 Sentinel 系统用于管理多个 Redis 服务器，该系统执行以下三个任务：</p><ul><li><p>监控（Monitoring）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</p></li><li><p>提醒（Notification）： 当被监控的某个 Redis 服务器出现问题时，Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</p></li><li><p>自动故障迁移（Automatic failover）： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时，集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</p></li><li><p>Redis Sentinel 是一个分布式系统，你可以在一个架构中运行多个 Sentinel 进程， 这些进程使用流言协议（gossipprotocols)来接收关于主服务器是否下线的信息， 并使用投票协议（agreement protocols）来决定是否执行自动故障迁移，以及选择哪个从服务器作为新的主服务器。</p></li></ul><h2 id="1、启动-Sentinel"><a href="#1、启动-Sentinel" class="headerlink" title="1、启动 Sentinel"></a>1、启动 Sentinel</h2><p>方式一：</p><p>对于 redis-sentinel 程序， 可以用以下命令来启动Sentinel 系统：</p><blockquote><p>redis-sentinel  /path/to/sentinel.conf</p></blockquote><p>方式二：</p><p>对于 redis-server 程序， 你可以用以下命令来启动一个运行在 Sentinel 模式下的 Redis 服务器：</p><blockquote><p>redis- - server /path/to/sentinel.conf  – sentinel</p></blockquote><p><code>注意：</code></p><blockquote><p>启动 Sentinel 实例必须指定相应的配置文件， 系统会使用配置文件来保存 Sentinel 的当前状态， 并在 Sentinel 重启时通过载入配置文件来进行状态还原。如果启动 Sentinel 时没有指定相应的配置文件， 或者指定的配置文件不可写（not writable）， 那么 Sentinel 会拒绝启动。</p></blockquote><h2 id="2-、配置-Sentinel"><a href="#2-、配置-Sentinel" class="headerlink" title="2  、配置 Sentinel"></a>2  、配置 Sentinel</h2><p>Redis 源码中包含了一个名为 sentinel.conf 的文件，这个文件是一个带有详细注释的 Sentinel 配置文件示例。<br>运行一个 Sentinel 所需的最少配置如下所示：</p><pre><code>sentinel monitor mymaster  192.168.198.128 6379 2 sentinel down-after-milliseconds mymaster 30000sentinel failover-timeout mymaster 180000sentinel parallel-syncs mymaster 1protected-mode no / bind  本机  IP</code></pre><p><code>注意：</code>主服务器无密码时，记得在 sentinel 配置里配上bind 本机 ip ，或者关掉保护模式 protected-mode no</p><p><code>配置解释：</code></p><blockquote><p>第一行配置指示 Sentinel 去监视一个名为 mymaster 的主服务器， 这个主服务器的 IP 地址为 127.0.0.1 ， 端口号为 6379 ， 而将这个主服务器判断为失效至少需要 2 个Sentinel 同意 （只要同意 Sentinel 的数量不达标，自动故障迁移就不会执行）。</p></blockquote><blockquote><p>down-after-milliseconds 选项</p><p>指定了 Sentinel 认为服务器已经断线所需的毫秒数。</p><p>如果服务器在给定的毫秒数之内， 没有返回 Sentinel发送的 PING 命令的回复， 或者返回一个错误， 那么 Sentinel 将这个服务器标记为主观下线</p></blockquote><blockquote><p>parallel-syncs 选项指定了在执行故障转移时， 最多可以有多少个从服务器同时对新的主服务器进行同步， 这个数字越小， 完成故障转移所需的时间就越长。</p><p>你可以通过将这个值设为 1 来保证每次只有一个从服务器处于不能处理命令请求的状态。</p></blockquote><h1 id="八、Redis集群"><a href="#八、Redis集群" class="headerlink" title="八、Redis集群"></a>八、Redis集群</h1><h2 id="1-集群简介"><a href="#1-集群简介" class="headerlink" title="1  集群简介"></a>1  集群简介</h2><p>Redis 集群可以在多个 Redis 节点之间进行数据共享；</p><p>Redis 集群不支持那些需要同时处理多个键的 Redis 命令；</p><p>因为执行这些命令需要在多个 Redis 节点之间移动数据， 并且在高负载的情况下， 这些命令将降低 Redis 集群的性能， 并导致不可预测的行为。比如：有 name1 和 name2 两个节点，命令 del name1 name2 要同时删除这个 key,就不能写在一起，得<br>分开写。</p><p>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p><p>Redis 集群提供了以下两个好处：</p><ul><li>将数据自动切分（split）到多个节点的能力。</li><li>当集群中的一部分节点失效或者无法进行通讯时， 仍然可以继续处理命令请求的能力。</li></ul><h2 id="2-集群数据共享"><a href="#2-集群数据共享" class="headerlink" title="2  集群数据共享"></a>2  集群数据共享</h2><p>Redis 集群使用数据分片（sharding）而非一致性哈希来实现： 一个 Redis 集群包含 16384 个哈希槽（hash slot），数据库中的每个键都属于这 16384 个哈希槽的其中一个， 集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16校验和 。</p><p>集群中的每个节点负责处理一部分哈希槽。 </p><p>举个例子， 一个集群可以有三个哈希槽， 其中：<br> 节点 A 负责处理 0 号至 5500 号哈希槽。<br> 节点 B 负责处理 5501 号至 11000 号哈希槽。<br> 节点 C 负责处理 11001 号至 16384 号哈希槽。</p><p>这种将哈希槽分布到不同节点的做法使得用户可以很容易地向集群中添加或者删除节点。 比如说：<br> 如果用户将新节点 D 添加到集群中， 那么集群只需要将节点A 、B 、 C 中的某些槽移动到节点 D 就可以了。<br> 与此类似， 如果用户要从集群中移除节点 A ， 那么集群只需要将节点 A 中的所有哈希槽移动到节点 B 和节点 C ， 然后再移除空白（不包含任何哈希槽）的节点 A 就可以了。因为将一个哈希槽从一个节点移动到另一个节点不会造成节点阻塞， 所以无论是添加新节点还是移除已存在节点， 又或者改变某个节点包含的哈希槽数量， 都不会造成集群下线。</p><p>3  集群的主从复制：<br>为了使得集群在一部分节点下线或者无法与集群的大多数节<br>点进行通讯的情况下， 仍然可以正常运作， Redis 集群对节点<br>使用了主从复制功能： 集群中的每个节点都有 1 个至 N 个复制<br>品，其中一个复制品为主节点， 而其余的 N-1 个复制品为从<br>节点。<br>在之前列举的节点 A 、B 、C 的例子中， 如果节点 B 下线<br>了， 那么集群将无法正常运行， 因为集群找不到节点来处理<br>5501 号至 11000 号的哈希槽。<br>另一方面， 假如在创建集群的时候（或者至少在节点 B 下<br>线之前）， 我们为主节点 B 添加了从节点 B1 ， 那么当主节点<br>B 下线的时候， 集群就会将 B1 设置为新的主节点， 并让它代</p><h2 id="5-集群搭建"><a href="#5-集群搭建" class="headerlink" title="5  集群搭建"></a>5  集群搭建</h2><p>要让集群正常运作至少需要 3 个主节点， 不过在刚开始试用集群功能时， 强烈建议使用六个节点：</p><p>其中三个为主节点，而其余三个则是各个主节点的从节点。<br>集群规划：3 个主节点，3 个从节点。<br>配置文件：</p><pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">port</span> <span class="token attr-value">7000</span><span class="token comment" spellcheck="true">##cluster-enabled 选项用于开实例的集群模式</span><span class="token attr-name">cluster-enabled</span> <span class="token attr-value">yes</span><span class="token comment" spellcheck="true">##cluster-conf-file 选项则设定了保存节点配置文件的路</span><span class="token comment" spellcheck="true">##径， 默认值为 nodes.conf</span><span class="token attr-name">cluster-config-file</span> <span class="token attr-value">nodes.conf</span><span class="token attr-name">cluster-node-timeout</span> <span class="token attr-value">5000</span><span class="token attr-name">appendonly</span> <span class="token attr-value">yes</span><span class="token attr-name">daemonize</span> <span class="token attr-value">yes</span><span class="token attr-name">protected-mode</span> <span class="token attr-value">no</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Redis的详细学习</summary>
    
    
    
    <category term="内存数据库" scheme="https://sukie-sun.github.io/categories/%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="Linux系统环境" scheme="https://sukie-sun.github.io/tags/Linux%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83/"/>
    
    <category term="Redis" scheme="https://sukie-sun.github.io/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Storm学习</title>
    <link href="https://sukie-sun.github.io/2019/01/29/Storm%E5%AD%A6%E4%B9%A0/"/>
    <id>https://sukie-sun.github.io/2019/01/29/Storm%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-01-28T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.802Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、Storm简介"><a href="#一、Storm简介" class="headerlink" title="一、Storm简介"></a>一、Storm简介</h1><p>官网：<a href="http://storm.apache.org/">Storm</a></p><h2 id="1、Storm-："><a href="#1、Storm-：" class="headerlink" title="1、Storm ："></a>1、Storm ：</h2><p>流式计算处理框架</p><h2 id="2、-特点："><a href="#2、-特点：" class="headerlink" title="2、 特点："></a>2、 特点：</h2><ul><li><p>实时</p></li><li><p>分布式</p></li><li><p>高容错</p></li><li><p>storm常驻内存（7*24h:意味着永久运行，需人为关闭）</p><ul><li><p>在Web UI 界面点击kill</p></li><li><p>命令kill</p><pre><code>bin/storm kill &lt;topologyName&gt;</code></pre></li></ul></li></ul><ul><li>数据不经过磁盘，在内存中处理</li><li>高可靠性：异常处理、消息可靠性保障机制</li><li>可维护性：StormUI图形化监控接口 </li></ul><h2 id="3、应用"><a href="#3、应用" class="headerlink" title="3、应用"></a>3、应用</h2><p>（1）流式处理：（异步）</p><p>​     客户端提交数据进行计算，并不会等待计算结果</p><p>举例：</p><ul><li><p>逐条处理：ETL（用于数据清洗）</p></li><li><p>统计分析</p><ul><li><p>例：计算PV、UV、访问热点 以及 某些数据的聚合、 加和、平均等等</p><ul><li><p>客户端提交数据以后，计算完成结果存储到redis 、 hbase 、 MySQL或其他MQ中</p></li><li><p>客户端并不关心最终结果是多少</p></li></ul></li></ul></li></ul><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1s4bm9fv3j30wj04et90.jpg"></p><p>（2）实时请求应答服务：（同步）</p><p>   客户端提交数据后，等待取得计算结果并返回给客户端</p><p>Drpc机制</p><p>举例：</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1s4blxd7vj30tv07pdg6.jpg"></p><h1 id="二、Storm架构"><a href="#二、Storm架构" class="headerlink" title="二、Storm架构"></a>二、Storm架构</h1><p>（从进程角度）</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1s3u2sboxj30gw0cs0tr.jpg"></p><h2 id="1、nimbus-主"><a href="#1、nimbus-主" class="headerlink" title="1、nimbus : (主)"></a>1、nimbus : (主)</h2><p>接收客户端提交的请求；</p><p>资源调度、任务分配、接收jar包</p><h2 id="2、supervisor：-从"><a href="#2、supervisor：-从" class="headerlink" title="2、supervisor：(从)"></a>2、supervisor：(从)</h2><p>– 接收nimbus分配的任务、启停worker（当前supervisor上worker数量由配置文件设定）</p><p>– 默认配置4个work进程</p><h2 id="3、worker"><a href="#3、worker" class="headerlink" title="3、worker"></a>3、worker</h2><p>– 运行具体处理运算组件的进程（每个Worker对应执行一个Topology的子集）<br>– worker任务类型，即spout任务、bolt任务两种<br>– 启动executor<br>（executor即worker JVM进程中的一个java线程，一般默认每个executor负责执行一个task任务）</p><p>– 与_ack 个数一致</p><h2 id="4、zookeeper"><a href="#4、zookeeper" class="headerlink" title="4、zookeeper"></a>4、zookeeper</h2><p>– 负责主从的通信</p><p>– 存储心跳信息、任务信息</p><p>– 实现主从的解耦，使nimbus对备份要求不高</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1s3u2wb3yj30ib0c0400.jpg"></p><h1 id="三、Storm编程模型"><a href="#三、Storm编程模型" class="headerlink" title="三、Storm编程模型"></a>三、Storm编程模型</h1><p><img src="https://upload-images.jianshu.io/upload_images/2826805-0fdf7e8af9608fce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p><img src="images/storm3.jpg"></p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1s4bm1hivj30o70e7q3y.jpg"></p><h2 id="1、Topology"><a href="#1、Topology" class="headerlink" title="1、Topology"></a>1、<strong>Topology</strong></h2><p>（DAG有向无环图的实现）</p><blockquote><p>是对Storm实时计算逻辑的封装，由一系列通过数据流相互关联的Spout、Bolt组成的拓扑结构</p></blockquote><blockquote><p>生命周期：</p><p>此拓扑结构只要启动，就会在集群中一直运行，直到手动将其kill，否则不会终止。</p><p>（与MapReduce中Job的区别，MR中Job在计算完成后就会终止）</p></blockquote><h2 id="2、spout"><a href="#2、spout" class="headerlink" title="2、spout"></a>2、<strong>spout</strong></h2><p>（数据源：发送数据）</p><blockquote><p>一般会从指定的数据源读取元祖（Tuple）发送到拓扑（Topology）中</p><ul><li><p>一个Spout可以发送多个Stream</p><p>（通过OutputFieldDeclare的declare方法声明不同的数据流，发送数据时通过SpoutOutputCollector中的emit方法指定 StreamId将数据发送出去）</p></li><li><p>Spout中的核心方法是nextTuple，该方法会被Storm线程不断调用、主动从数据源拉取数据、再通过emit方法将数据生成元祖（Tuple）发送给之后的Bolt计算</p></li></ul></blockquote><h2 id="3、bolt"><a href="#3、bolt" class="headerlink" title="3、bolt"></a>3、<strong>bolt</strong></h2><p>（数据处理组件：计算数据，个数不限）</p><blockquote><p>单个Bolt可实现简单的任务或数据流转换</p><p>复杂的场景需要多个Bolt分多个步骤完成</p><ul><li><p>一个Bolt可以发送多个Stream</p><p>（通过OutputFieldDeclare的declare方法声明不同的数据流，发送数据时通过SpoutOutputCollector中的emit方法指定 StreamId将数据发送出去）</p></li><li><p>Bolt中的核心方法是execute，该方法通过接收一个元组数据、实现核心业务逻辑</p></li></ul></blockquote><h2 id="4、tuple"><a href="#4、tuple" class="headerlink" title="4、tuple"></a>4、<strong>tuple</strong></h2><p>（Stream中最小的数据组成单位）</p><h2 id="5、Stream"><a href="#5、Stream" class="headerlink" title="5、Stream"></a>5、<strong>Stream</strong></h2><p>（数据流）</p><blockquote><ul><li>从Spout中传递数据给Bolt、上一个Bolt传递数据给下一个Bolt，这样形成的数据通道叫做Stream</li></ul><ul><li>Stream声明时需要给其指定Id（默认为Default，实际开发中多使用单一数据流，无需指定StreamId）</li></ul></blockquote><h2 id="6、Stream-Grouping"><a href="#6、Stream-Grouping" class="headerlink" title="6、Stream Grouping"></a>6、<strong>Stream Grouping</strong></h2><p>– 数据流分组（即数据分发策略）</p><h2 id="7、-数据传输"><a href="#7、-数据传输" class="headerlink" title="7、 数据传输"></a>7、 数据传输</h2><p>– ZMQ<br>​             – ZeroMQ 开源的消息传递框架，并不是一个MessageQueue<br>– Netty<br>​            – Netty是基于NIO的网络框架，更加高效。（之所以Storm 0.9版本之后使用Netty，是因为ZMQ的license和Storm的license不兼容。）</p><h1 id="四、Storm安装部署"><a href="#四、Storm安装部署" class="headerlink" title="四、Storm安装部署"></a>四、Storm安装部署</h1><h2 id="完全分布式"><a href="#完全分布式" class="headerlink" title="完全分布式"></a>完全分布式</h2><p>环境：zookeeper集群（node00，node01，node02）</p><p>1、解压安装</p><p>版本：apache-storm-0.10.0.tar.gz</p><pre class="line-numbers language-shell"><code class="language-shell">tar -zvxf apache-storm-0.10.0.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2、在storm目录中创建logs目录</p><pre class="line-numbers language-shell"><code class="language-shell">mkdir logs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3、编辑配置文件解压路径/config/storm.yaml</p><pre><code>storm.zookeeper.servers:- &quot;node00&quot;- &quot;node01&quot;- &quot;node02&quot;storm.local.dir: &quot;/opt/storm&quot;nimbus.host: “node00&quot;supervisor.slots.ports:- 6700- 6701- 6702- 6703</code></pre><p>将安装包发送到其他节点</p><p>4、启动服务</p><p>（1）启动zookeeper‘</p><pre><code>zkServer.sh start</code></pre><p>（2）启动nimbus（在node00上：storm安装目录下）</p><pre><code>nohup ./bin/storm nimbus &gt;&gt; ./logs/nimbus.out 2&gt;&amp;1 &amp;</code></pre><p><code>nohup</code>:防止被操作系统意外挂起</p><p><code>2&gt;&amp;1</code>：标准错误输出重定向</p><p><code>&amp;</code>：后台运行</p><p>（3）启动supervisor（在node01 ，node02上：storm安装目录下）</p><pre><code>./bin/storm supervisor&gt;&gt; ./logs/supervisor.out 2&gt;&amp;1 &amp;</code></pre><p>（4） 启动Logviewer</p><pre class="line-numbers language-shell"><code class="language-shell"> ./bin/storm logviewer &<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>UI界面查看：</p><p> 查看日志：<a href="http://node00:8000/log?file=wc-1-1523947796-worker-6703.log">http://node00:8000/log?file=wc-1-1523947796-worker-6703.log</a></p><p>（5）查看进程 ：jps</p><p>显示：</p><p>node00：</p><blockquote><p>[root@node00 apache-storm-0.10.0]# jps<br>8869 QuorumPeerMain<br>9093 Jps<br>9083 config_value</p></blockquote><p>node01 、 node02</p><blockquote><p>[root@node01 apache-storm-0.10.0]# jps<br>7280 config_value<br>7290 Jps<br>7230 QuorumPeerMain</p></blockquote><p>且三个节点的logs目录下也相应的生成了指定的日志文件</p><p>5、Storm UI（从浏览器访问，在前台页面上查看详情）</p><p>（1）启动服务（可在node00节点：storm安装目录）</p><pre class="line-numbers language-shell"><code class="language-shell">./bin/storm ui >> ./logs/ui.out 2>&1 &<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（2）浏览器访问（Storm UI在哪台节点启动，就访问哪台节点）</p><blockquote><p><a href="http://node00:8080/">http://node00:8080</a></p></blockquote><p>6、运行jar</p><pre class="line-numbers language-shell"><code class="language-shell">##查看帮助bin/storm -h##查看指定命令的帮助bin/storm  help jar##运行jar包bin/storm jar <jar包所在路径> <包名+类名> <参数：topologyName><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="五、Storm重点概念详解"><a href="#五、Storm重点概念详解" class="headerlink" title="五、Storm重点概念详解"></a>五、Storm重点概念详解</h1><h2 id="1、Storm-Grouping-–-数据流分组（即数据分发策略）"><a href="#1、Storm-Grouping-–-数据流分组（即数据分发策略）" class="headerlink" title="1、Storm Grouping – 数据流分组（即数据分发策略）"></a>1、Storm Grouping – 数据流分组（即数据分发策略）</h2><p>• 1. Shuffle Grouping<br>– 随机分组，随机派发stream里面的tuple，保证每个bolt task接收到的tuple数目大致相同。<br>– 轮询，平均分配</p><p>• 2. Fields Grouping<br>– 按字段分组，比如，按”user-id”这个字段来分组，那么具有同样”user-id”的 tuple 会被分到相同的Bolt里的一个task， 而不同的”user-id”则可能会被分配到不同的task。</p><p>• 3. All Grouping<br>– 广播发送，对于每一个tuple，所有的bolts都会收到</p><p>• 4. Global Grouping<br>– 全局分组，把tuple分配给task id最低的task 。</p><pre class="line-numbers language-java"><code class="language-java">        TopologyBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopologyBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">setSpout</span><span class="token punctuation">(</span><span class="token string">"spout"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MySpout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//         shuffleGrouping其实就是随机往下游去发,不自觉的做到了负载均衡</span><span class="token comment" spellcheck="true">//        builder.setBolt("bolt", new MyBolt(),2).shuffleGrouping("spout");</span>        <span class="token comment" spellcheck="true">// fieldsGrouping其实就是MapReduce里面理解的Shuffle,根据fields求hash来取模</span><span class="token comment" spellcheck="true">//      builder.setBolt("bolt", new MyBolt(), 2).fieldsGrouping("spout", new Fields("session_id"));</span>        <span class="token comment" spellcheck="true">// 只往一个里面发,往taskId小的那个里面去发送</span>        builder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"bolt"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">globalGrouping</span><span class="token punctuation">(</span><span class="token string">"spout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 等于shuffleGrouping</span><span class="token comment" spellcheck="true">//        builder.setBolt("bolt", new MyBolt(), 2).noneGrouping("spout");</span>        <span class="token comment" spellcheck="true">// 广播下游的所有task都能收到数据</span>        builder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"bolt"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allGrouping</span><span class="token punctuation">(</span><span class="token string">"spout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>———————————————————-以上为常用grouping策略————————————————————–</p><p>• 5. None Grouping<br>– 不分组，这个分组的意思是说stream不关心到底怎样分组。目前这种分组和Shuffle grouping是一样的效果。<br>有一点不同的是storm会把使用none grouping的这个bolt放到这个bolt的订阅者同一个线程里面去执行（未来Storm如果可能的话会这样设计）。</p><p>• 6. Direct Grouping（很少用）<br>– 指向型分组， 这是一种比较特别的分组方法，用这种分组意味着消息（tuple）的发送者指定由消息接收者的那个task处理这个消息。只有被声明为 Direct Stream 的消息流可以声明这种分组方法。而且这种消息tuple必须使用 emitDirect 方法来发射。消息处理者可以通过 TopologyContext 来获取处理它的消息的task的id<br>(OutputCollector.emit方法也会返回task的id)</p><p>• 7. Local or shuffle grouping<br>– 本地或随机分组。如果目标bolt有一个或者多个task与源bolt的task在同一个工作进程中，tuple将会被随机发送给这些同进程中的tasks。否则，和普通的Shuffle Grouping行为一致</p><p>• 8.customGrouping<br>– 自定义，相当于mapreduce那里自己去实现一个partition一样。</p><h2 id="2、并发机制"><a href="#2、并发机制" class="headerlink" title="2、并发机制"></a>2、并发机制</h2><h3 id="1、-Worker-processes"><a href="#1、-Worker-processes" class="headerlink" title="1、 Worker processes"></a>1、 Worker processes</h3><ul><li>Worker – 进程<ul><li>一个Topology拓扑会包含一个或多个Worker（每个Worker进程只能从属于一个特定的Topology）、</li><li>这些Worker进程会并行跑在集群中不同的服务器上，即一个Topology拓扑其实是由并行运行在Storm集群中<br>多台服务器上的进程所组成</li></ul></li></ul><h3 id="2、Executors-threads"><a href="#2、Executors-threads" class="headerlink" title="2、Executors (threads)"></a>2、Executors (threads)</h3><ul><li>Executor – 线程<ul><li>Executor是由Worker进程中生成的一个线程</li><li>每个Worker进程中会运行拓扑当中的一个或多个Executor线程</li><li>一个Executor线程中可以执行一个或多个Task任务（默认每个Executor只执行一个Task任务），但是这些Task任务都是对应着同一个组件（Spout、Bolt）。</li></ul></li></ul><h3 id="3、Task"><a href="#3、Task" class="headerlink" title="3、Task"></a>3、Task</h3><ul><li>Tasks – 任务<ul><li>实际执行数据处理的最小单元</li><li>每个task即为一个Spout或者一个Bolt</li><li>Task数量在整个Topology生命周期中保持不变，Executor数量可以变化或手动调整</li><li>（默认情况下，Task数量和Executor是相同的，即每个Executor线程中默认运行一个Task任务）</li></ul></li></ul><h3 id="4、-设置Worker进程数"><a href="#4、-设置Worker进程数" class="headerlink" title="4、 设置Worker进程数"></a>4、 设置Worker进程数</h3><pre class="line-numbers language-java"><code class="language-java">Config<span class="token punctuation">.</span><span class="token function">setNumWorkers</span><span class="token punctuation">(</span><span class="token keyword">int</span> workers<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="5、设置Executor线程数"><a href="#5、设置Executor线程数" class="headerlink" title="5、设置Executor线程数"></a>5、设置Executor线程数</h3><pre class="line-numbers language-java"><code class="language-java">TopologyBuilder<span class="token punctuation">.</span><span class="token function">setSpout</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> IRichSpout spout<span class="token punctuation">,</span> Number parallelism_hint<span class="token punctuation">)</span>TopologyBuilder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> IRichBolt bolt<span class="token punctuation">,</span> Number parallelism_hint<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//其中， parallelism_hint即为executor线程数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="6、-设置Task数量"><a href="#6、-设置Task数量" class="headerlink" title="6、 设置Task数量"></a>6、 设置Task数量</h3><pre class="line-numbers language-java"><code class="language-java">ComponentConfigurationDeclarer<span class="token punctuation">.</span><span class="token function">setNumTasks</span><span class="token punctuation">(</span>Number val<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 例：共2 worker ， 3 excutor ， 5  task</span>Config conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>conf<span class="token punctuation">.</span><span class="token function">setNumWorkers</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//2 个work进程</span>TopologyBuilder topologyBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopologyBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>topologyBuilder<span class="token punctuation">.</span><span class="token function">setSpout</span><span class="token punctuation">(</span><span class="token string">"spout"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MySpout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 1 个excutor线程 ， 1个 task</span>topologyBuilder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"green-bolt"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GreenBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 2 个excutor线程 ， </span><span class="token punctuation">.</span><span class="token function">setNumTasks</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// 4  个task</span><span class="token punctuation">.</span><span class="token function">shuffleGrouping</span><span class="token punctuation">(</span>"blue<span class="token operator">-</span>spout<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7、-Rebalance-–-再平衡"><a href="#7、-Rebalance-–-再平衡" class="headerlink" title="7、 Rebalance – 再平衡"></a>7、 Rebalance – 再平衡</h3><p>– 即，动态调整Topology拓扑的Worker进程数量、以及Executor线程数量<br>• 支持两种调整方式：<br>– 1、通过Storm UI<br>– 2、通过Storm CLI</p><h4 id="通过Storm-CLI动态调整："><a href="#通过Storm-CLI动态调整：" class="headerlink" title="通过Storm CLI动态调整："></a>通过Storm CLI动态调整：</h4><p>– 例：</p><pre class="line-numbers language-shell"><code class="language-shell">bin/storm rebalance mytopology -n 5 -e blue-spout=3 -e yellow-bolt=10##将mytopology拓扑worker进程数量调整为5个##“ blue-spout ” 所使用的线程数量调整为3个##“ yellow-bolt ”所使用的线程数量调整为10个<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、通信机制-–-Worker内部的消息传递机制"><a href="#3、通信机制-–-Worker内部的消息传递机制" class="headerlink" title="3、通信机制 – Worker内部的消息传递机制"></a>3、通信机制 – Worker内部的消息传递机制</h2><h4 id="•-Worker进程间的数据通信"><a href="#•-Worker进程间的数据通信" class="headerlink" title="• Worker进程间的数据通信"></a>• Worker进程间的数据通信</h4><p>– ZMQ<br>– ZeroMQ 开源的消息传递框架，并不是一个MessageQueue<br>– Netty<br>– Netty是基于NIO的网络框架，更加高效。（之所以Storm 0.9版本之后使用Netty，是因为ZMQ的license和Storm的license不兼容。）</p><h4 id="•-Worker内部的数据通信"><a href="#•-Worker内部的数据通信" class="headerlink" title="• Worker内部的数据通信"></a>• Worker内部的数据通信</h4><p>– Disruptor<br>– 实现了“队列”的功能。<br>– 可以理解为一种事件监听或者消息处理机制，即在队列当中一边由生产者放入消息数据，另一边消费者并行取出消息数据处理。</p><h2 id="4、容错机制"><a href="#4、容错机制" class="headerlink" title="4、容错机制"></a>4、容错机制</h2><h3 id="1、集群节点宕机"><a href="#1、集群节点宕机" class="headerlink" title="1、集群节点宕机"></a>1、集群节点宕机</h3><p>– Nimbus服务器<br>• 单点故障？<br>– 非Nimbus服务器<br>• 故障时，该节点上所有Task任务都会超时，Nimbus会将这些Task任务重新分配到其他服务器上运行</p><h3 id="2、进程挂掉"><a href="#2、进程挂掉" class="headerlink" title="2、进程挂掉"></a>2、进程挂掉</h3><p>– Worker<br>• 挂掉时，Supervisor会重新启动这个进程。如果启动过程中仍然一直失败，并且无法向Nimbus发送心跳，Nimbus会将该Worker重新分配到其他服务器上</p><p>– Supervisor<br>• 无状态（所有的状态信息都存放在Zookeeper中来管理），不影响已经在运行的worker，但是在当前节点worker如果挂掉就无法重启，可以在另一台supervisor节点重启worker<br>• 快速失败（每当遇到任何异常情况，都会自动毁灭）</p><p>– Nimbus<br>• 无状态（所有的状态信息都存放在Zookeeper中来管理）<br>• 快速失败（每当遇到任何异常情况，都会自动毁灭）</p><h3 id="3、消息的完整性"><a href="#3、消息的完整性" class="headerlink" title="3、消息的完整性"></a>3、消息的完整性</h3><p>– 从Spout中发出的Tuple，以及基于他所产生Tuple（例如上个例子当中Spout发出的句子，以及句子当中单词的tuple等）<br>– 由这些消息就构成了一棵tuple树<br>– 当这棵tuple树发送完成，并且树当中每一条消息都被正确处理，就表明spout发送消息被“完整处理”，即消息的完整性</p><h3 id="4、-Acker-–-消息完整性的实现机制"><a href="#4、-Acker-–-消息完整性的实现机制" class="headerlink" title="4、 Acker – 消息完整性的实现机制"></a>4、 Acker – 消息完整性的实现机制</h3><p>给每条数据添加唯一标记ID ， 对于每条数据的发送或接收，都响应给Acker ，通过异或（同为0 ， 异为1） 从而确认消息是否完整</p><p>– Storm的拓扑当中特殊的一些任务</p><p>– 负责跟踪每个Spout发出的Tuple的DAG（有向无环图）</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//核心代码</span><span class="token comment" spellcheck="true">/*AckTest.class*/</span>        TopologyBuilder topologyBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopologyBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setSpout</span><span class="token punctuation">(</span><span class="token string">"ack"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">AckSpout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"splitbolt"</span><span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">AckSplitBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shuffleGrouping</span><span class="token punctuation">(</span><span class="token string">"ack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"countbolt"</span><span class="token punctuation">,</span>               <span class="token keyword">new</span> <span class="token class-name">AckCountBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fieldsGrouping</span><span class="token punctuation">(</span><span class="token string">"splitbolt"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Config conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">setMessageTimeoutSecs</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        LocalCluster localCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        localCluster<span class="token punctuation">.</span><span class="token function">submitTopology</span><span class="token punctuation">(</span><span class="token string">"acktest"</span><span class="token punctuation">,</span>conf<span class="token punctuation">,</span>topologyBuilder<span class="token punctuation">.</span><span class="token function">createTopology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*AckSpout.class*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AckSpout</span> <span class="token keyword">implements</span> <span class="token class-name">IRichSpout</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    SpoutOutputCollector collector<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//缓存map...</span>    Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> map <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    String<span class="token punctuation">[</span><span class="token punctuation">]</span> lines <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token string">"i love shsxt"</span><span class="token punctuation">,</span>            <span class="token string">"i hate you"</span><span class="token punctuation">,</span>            <span class="token string">"haha xixi xixi"</span><span class="token punctuation">,</span>            <span class="token string">"xidada is good"</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>    Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// id 用以标志发送的每条数据</span>    <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span>Map conf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> SpoutOutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>collector <span class="token operator">=</span> collector<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nextTuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        String line <span class="token operator">=</span> lines<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>        id<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     *  如果数据被完整处理，此时调用ack方法，并把msgid穿进去     * @param msgId     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ack</span><span class="token punctuation">(</span>Object msgId<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msgId <span class="token operator">+</span> <span class="token string">" 执行成功....并删除缓存"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>msgId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 如果数据未被完整处理，即处理失败，则调用fail方法。     * 失败的时候从缓存map里重发数据     * @param msgId     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fail</span><span class="token punctuation">(</span>Object msgId<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行失败，重发...  msgid: "</span> <span class="token operator">+</span> msgId<span class="token punctuation">)</span><span class="token punctuation">;</span>        collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>msgId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>msgId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        declarer<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"line"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*AckSplitBolt.class*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AckSplitBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichBolt</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    OutputCollector collector <span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span>Map stormConf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> OutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>collector <span class="token operator">=</span> collector<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple input<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        String line <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getStringByField</span><span class="token punctuation">(</span><span class="token string">"line"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> split<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//继续跟踪数据</span>            collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        collector<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//      collector.fail(input);</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        declarer<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*AckCountBolt.class*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AckCountBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichBolt</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Integer<span class="token operator">></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    OutputCollector collector<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span>Map stormConf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> OutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>collector <span class="token operator">=</span> collector<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple input<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        String word <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getStringByField</span><span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Integer integer <span class="token operator">=</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>integer<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            integer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            integer<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span>integer<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>word <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> integer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//告诉ack 此tuple接受成功</span>        collector<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5、与MapReduce的区别"><a href="#5、与MapReduce的区别" class="headerlink" title="5、与MapReduce的区别"></a>5、与MapReduce的区别</h2><table><thead><tr><th align="center">Storm</th><th align="center">MapReduce</th></tr></thead><tbody><tr><td align="center">流式处理</td><td align="center">批处理</td></tr><tr><td align="center">（毫）秒级</td><td align="center">分钟级</td></tr><tr><td align="center">DAG模型</td><td align="center">Map+Reduce模型</td></tr><tr><td align="center">常驻内存运行</td><td align="center">反复启停</td></tr><tr><td align="center">进程、线程常驻内存运行，数据不进入磁盘，数据通过网络传递</td><td align="center">为TB、PB级别数据设计的批处理计算框架</td></tr></tbody></table><h2 id="6、和Spark-Streaming的区别"><a href="#6、和Spark-Streaming的区别" class="headerlink" title="6、和Spark Streaming的区别"></a>6、和Spark Streaming的区别</h2><table><thead><tr><th align="center">Storm</th><th align="center">Spark Streaming</th></tr></thead><tbody><tr><td align="center">流式处理</td><td align="center">微批处理</td></tr><tr><td align="center">（毫）秒级</td><td align="center">秒级</td></tr><tr><td align="center">成熟稳定</td><td align="center">稳定性改进中</td></tr><tr><td align="center">独立系统，专为流式计算设计</td><td align="center">Spark核心的一种计算模型<br>能与其他组件很好的结合</td></tr><tr><td align="center">数据传输模式更为简单，很多地方也更为高效</td><td align="center">将RDD做的很小来用小的批处理来接近流式处理</td></tr><tr><td align="center">并不是不能做批处理，<br>它也可以来做微批处理，来提高吞吐</td><td align="center">基于内存和DAG</td></tr></tbody></table><p><strong>小记</strong></p><p>1、storm源码中包含后缀名为<code>.clj</code>的文件，这是一种Clojure编程语言，它是一种运行在JVM上的Lisp方言。而Lisp是一种以表达性和功能强大著称的编程语言。</p><p>2、阿里巴巴在Storm的基础上使用Java代码并做了相关的改进，开发了JStorm，和Storm一样都是开源的。（反哺行为，包括将Flink→Blink）</p><p>3、   at-least        至少处理一次</p><p>​       exactly-once 有且只有一次</p><h2 id="7、Storm-架构设计与Hadoop架构对比"><a href="#7、Storm-架构设计与Hadoop架构对比" class="headerlink" title="7、Storm 架构设计与Hadoop架构对比"></a>7、Storm 架构设计与Hadoop架构对比</h2><table><thead><tr><th align="center"></th><th align="center">Storm</th><th align="center">Hadoop</th></tr></thead><tbody><tr><td align="center">主节点</td><td align="center">Nimbus</td><td align="center">ResourceManager</td></tr><tr><td align="center">从节点</td><td align="center">Supervisor</td><td align="center">NodeManager</td></tr><tr><td align="center">应用程序</td><td align="center">Topology</td><td align="center">Job</td></tr><tr><td align="center">工作进程</td><td align="center">Child</td><td align="center">Worker</td></tr><tr><td align="center">计算模型</td><td align="center">Map/Reduce</td><td align="center">Spout/Bolt</td></tr></tbody></table><h1 id="六、Storm-API-（数据累加）"><a href="#六、Storm-API-（数据累加）" class="headerlink" title="六、Storm API （数据累加）"></a>六、Storm API （数据累加）</h1><p>MyTopology.class</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>Config<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>LocalCluster<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>generated<span class="token punctuation">.</span>StormTopology<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>TopologyBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTopology</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//数据累加... spout  bolt</span>        TopologyBuilder topologyBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopologyBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setSpout</span><span class="token punctuation">(</span><span class="token string">"myspout"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">MySpout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//shuffleGrouping（）表示将前一个bolt和后一个spout连接</span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"mybolt"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">MyBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shuffleGrouping</span><span class="token punctuation">(</span><span class="token string">"myspout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        StormTopology topology <span class="token operator">=</span> topologyBuilder<span class="token punctuation">.</span><span class="token function">createTopology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Config config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        LocalCluster localCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        localCluster<span class="token punctuation">.</span><span class="token function">submitTopology</span><span class="token punctuation">(</span><span class="token string">"sum"</span><span class="token punctuation">,</span>config<span class="token punctuation">,</span>topology<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>MySpout.class</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>spout<span class="token punctuation">.</span>SpoutOutputCollector<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>IRichSpout<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseRichSpout<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Fields<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Values<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySpout</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichSpout</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    SpoutOutputCollector collector<span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 初始化方法。。框架在执行任务的时候，会先执行此方法     * @param conf   可以得到spout的配置     * @param context 上下文环境     * @param collector  往下游发送数据...     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span>Map conf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> SpoutOutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>       <span class="token keyword">this</span><span class="token punctuation">.</span>collector <span class="token operator">=</span> collector<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/***     * 此方法是spout的核心方法。     * 框架会一直（无限）调用这个方法，每当调用此方法时，我们应该往下游发送数据     *     *  mysout = new Myspout()     *     *  mysout.open(conf,context,collector)     *     *     *  while(ture)&amp;#123;     *      mysout.nextTuple()     *  &amp;#125;     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nextTuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">/*与下面的“number”对应        *若new Values(i，"zs")        *那么就是"number","name"        */</span>        collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"spout 发送.."</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 当需要往下游发送数据时，就要声明字段个数和字段名字。     * @param declarer     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        declarer<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"number"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> MyBolt.class</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>OutputCollector<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>IRichBolt<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseRichBolt<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichBolt</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sum<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * bolt 初始化方法。。     * @param stormConf     * @param context     * @param collector     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span>Map stormConf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> OutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * bolt 中 最核心的方法     * 框架会一直调用此方法，每次调用就传一个数据进来。     * @param input     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple input<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        Integer integer <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        input.getIntegerByField("number");</span>        sum <span class="token operator">+=</span>integer<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"excute : "</span> <span class="token operator">+</span> integer  <span class="token operator">+</span>  <span class="token string">"   sum : "</span> <span class="token operator">+</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1s5fu1zxjj31280gfq6k.jpg"></p><h1 id="七、Storm-API-（单词统计）"><a href="#七、Storm-API-（单词统计）" class="headerlink" title="七、Storm API （单词统计）"></a>七、Storm API （单词统计）</h1><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1s3u24s62j30pw03wmxc.jpg"></p><p>WordCountToplogy.class</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>Config<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>LocalCluster<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>StormSubmitter<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>generated<span class="token punctuation">.</span>AlreadyAliveException<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>generated<span class="token punctuation">.</span>InvalidTopologyException<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>TopologyBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Fields<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCountToplogy</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 一对一 线程与task     *  thread0 = new Thread(new bolt0)     *  thread0.start()     *  run()&amp;#123;     *      while(true)&amp;#123;     *           bolt0.excute(tuple)     *      &amp;#125;     *  &amp;#125;     *  thread1 = new Thread ( new bolt1)     *     *  run()&amp;#123;     *       while(true)&amp;#123;     *           bolt1.excute(tuple)     *      &amp;#125;     *  &amp;#125;     *  new Thread (new bolt2)     * @param args     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        TopologyBuilder topologyBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopologyBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setSpout</span><span class="token punctuation">(</span><span class="token string">"wcspout"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">WordCountSpout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//5 在这里指并行度，即task个数</span><span class="token comment" spellcheck="true">//shuffleGrouping() 将bolt 连接至指定的spout之后</span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"splitbolt"</span><span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">SplitBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shuffleGrouping</span><span class="token punctuation">(</span><span class="token string">"wcspout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//并行度 6 </span><span class="token comment" spellcheck="true">//fieldsGrouping() 将bolt 连接至指定 的bolt之后，按指定字段grouping      </span>        topologyBuilder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"countbolt"</span><span class="token punctuation">,</span>                 <span class="token keyword">new</span> <span class="token class-name">CountBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fieldsGrouping</span><span class="token punctuation">(</span><span class="token string">"splitbolt"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Config config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        config<span class="token punctuation">.</span><span class="token function">setNumWorkers</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                StormSubmitter<span class="token punctuation">.</span><span class="token function">submitTopology</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> topologyBuilder<span class="token punctuation">.</span><span class="token function">createTopology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlreadyAliveException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidTopologyException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            LocalCluster localCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            localCluster<span class="token punctuation">.</span><span class="token function">submitTopology</span><span class="token punctuation">(</span><span class="token string">"mytopology"</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> topologyBuilder<span class="token punctuation">.</span><span class="token function">createTopology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>WordCountSpout.class</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>spout<span class="token punctuation">.</span>SpoutOutputCollector<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseRichSpout<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Fields<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Values<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCountSpout</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichSpout</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    SpoutOutputCollector collector<span class="token punctuation">;</span>    String<span class="token punctuation">[</span><span class="token punctuation">]</span> lines <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token string">"i love learning"</span><span class="token punctuation">,</span>            <span class="token string">"i miss you "</span><span class="token punctuation">,</span>            <span class="token string">"sxt is good"</span><span class="token punctuation">,</span>            <span class="token string">"good good study day day up"</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>    Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span>Map conf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> SpoutOutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>collector <span class="token operator">=</span> collector<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nextTuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>lines<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        String line <span class="token operator">=</span> lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>        collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        declarer<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"line"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>SplitBolt.class</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>OutputCollector<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseRichBolt<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Fields<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Values<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SplitBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichBolt</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    OutputCollector collector<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span>Map stormConf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> OutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>collector <span class="token operator">=</span> collector<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"split ----- "</span>  <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple input<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        String line <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>String word <span class="token operator">:</span> words<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        declarer<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CountBolt.class</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>OutputCollector<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseRichBolt<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichBolt</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Integer<span class="token operator">></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span>Map stormConf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> OutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"countbolt ---- "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple input<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        String word <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getStringByField</span><span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            Integer integer <span class="token operator">=</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>            integer<span class="token operator">++</span><span class="token punctuation">;</span>            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span>integer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" --  "</span> <span class="token operator">+</span> word<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="八、Flume-Kafka-Storm架构设计"><a href="#八、Flume-Kafka-Storm架构设计" class="headerlink" title="八、Flume+Kafka+Storm架构设计"></a>八、Flume+Kafka+Storm架构设计</h1><p>• 采集层：实现日志收集，使用负载均衡策略<br>• 消息队列：作用是解耦及不同速度系统缓冲<br>• 实时处理单元：用Storm来进行数据处理，最终数据流入DB中<br>• 展示单元：数据可视化，使用WEB框架展示</p><p>• 美团Flume架构<br>– <a href="http://tech.meituan.com/mt-log-system-arch.html">http://tech.meituan.com/mt-log-system-arch.html</a><br>• Flume的负载均衡<br>– <a href="http://flume.apache.org/FlumeUserGuide.html#load-balancing-sink-processor">http://flume.apache.org/FlumeUserGuide.html#load-balancing-sink-processor</a></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>Config<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>LocalCluster<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>spout<span class="token punctuation">.</span>SchemeAsMultiScheme<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>OutputCollector<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>BasicOutputCollector<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>TopologyBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseBasicBolt<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseRichBolt<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Fields<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple<span class="token punctuation">;</span><span class="token keyword">import</span> backtype<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Values<span class="token punctuation">;</span><span class="token keyword">import</span> storm<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>KafkaSpout<span class="token punctuation">;</span><span class="token keyword">import</span> storm<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>SpoutConfig<span class="token punctuation">;</span><span class="token keyword">import</span> storm<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>StringScheme<span class="token punctuation">;</span><span class="token keyword">import</span> storm<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>ZkHosts<span class="token punctuation">;</span><span class="token keyword">import</span> storm<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>bolt<span class="token punctuation">.</span>KafkaBolt<span class="token punctuation">;</span><span class="token keyword">import</span> storm<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>bolt<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>FieldNameBasedTupleToKafkaMapper<span class="token punctuation">;</span><span class="token keyword">import</span> storm<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>bolt<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>DefaultTopicSelector<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * This topology demonstrates Storm's stream groupings and multilang * capabilities. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogFilterTopology</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FilterBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBasicBolt</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple tuple<span class="token punctuation">,</span> BasicOutputCollector collector<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            String line <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Accept:  "</span> <span class="token operator">+</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 包含ERROR的行留下</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"ERROR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filterbolt:  "</span> <span class="token operator">+</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>                collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 定义message提供给后面FieldNameBasedTupleToKafkaMapper使用</span>            declarer<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        TopologyBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopologyBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// https://github.com/apache/storm/tree/master/external/storm-kafka</span>        <span class="token comment" spellcheck="true">// config kafka spout，话题</span>        String topic <span class="token operator">=</span> <span class="token string">"kafkatest"</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//kafka集群所使用的zookeeper集群</span>        ZkHosts zkHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkHosts</span><span class="token punctuation">(</span><span class="token string">"node01:2181,node02:2181,node03:2181"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//   /kafka_storm，偏移量offset的根目录，记录队列取到了哪里</span>        SpoutConfig spoutConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpoutConfig</span><span class="token punctuation">(</span>zkHosts<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> <span class="token string">"/kafka_storm"</span><span class="token punctuation">,</span> <span class="token string">"test_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 对应一个应用</span>        List<span class="token operator">&lt;</span>String<span class="token operator">></span> zkServers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zkHosts<span class="token punctuation">.</span>brokerZkStr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String host <span class="token operator">:</span> zkHosts<span class="token punctuation">.</span>brokerZkStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            zkServers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//storm的zookeeper集群地址</span>        spoutConfig<span class="token punctuation">.</span>zkServers <span class="token operator">=</span> zkServers<span class="token punctuation">;</span>        spoutConfig<span class="token punctuation">.</span>zkPort <span class="token operator">=</span> <span class="token number">2181</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 是否从头开始消费</span>        spoutConfig<span class="token punctuation">.</span>forceFromStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        spoutConfig<span class="token punctuation">.</span>socketTimeoutMs <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// StringScheme将字节流转解码成某种编码的字符串</span>        spoutConfig<span class="token punctuation">.</span>scheme <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchemeAsMultiScheme</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        KafkaSpout kafkaSpout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaSpout</span><span class="token punctuation">(</span>spoutConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// set kafka spout</span>        builder<span class="token punctuation">.</span><span class="token function">setSpout</span><span class="token punctuation">(</span><span class="token string">"kafka_spout"</span><span class="token punctuation">,</span> kafkaSpout<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// set bolt</span>        builder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"filter"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FilterBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shuffleGrouping</span><span class="token punctuation">(</span><span class="token string">"kafka_spout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 数据写出</span>        <span class="token comment" spellcheck="true">// set kafka bolt</span>        <span class="token comment" spellcheck="true">// withTopicSelector使用缺省的选择器指定写入的topic： LogError</span>        <span class="token comment" spellcheck="true">// withTupleToKafkaMapper tuple==>kafka的key和message</span>        KafkaBolt kafka_bolt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaBolt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withTopicSelector</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultTopicSelector</span><span class="token punctuation">(</span><span class="token string">"Log_error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">withTupleToKafkaMapper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FieldNameBasedTupleToKafkaMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">setBolt</span><span class="token punctuation">(</span><span class="token string">"kafka_bolt"</span><span class="token punctuation">,</span> kafka_bolt<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shuffleGrouping</span><span class="token punctuation">(</span><span class="token string">"filter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Config conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// set producer properties.</span>        Properties props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"metadata.broker.list"</span><span class="token punctuation">,</span> <span class="token string">"node01:9092,node02:9092,node03:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * Kafka生产者ACK机制 0 ： 生产者不等待Kafka broker完成确认，继续发送下一条数据         *         * 1:生产者等待消息在leader接收成功确认之后，继续发送下一条数据         *         * -1 ：生产者等待消息在follower副本接收到数据确认之后，继续发送下一条数据         *         */</span>        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request.required.acks"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"serializer.class"</span><span class="token punctuation">,</span> <span class="token string">"kafka.serializer.StringEncoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kafka.broker.properties"</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        conf.put(Config.STORM_ZOOKEEPER_SERVERS, Arrays.asList(new String[] &amp;#123; "node1", "node2", "node3" &amp;#125;));</span>        <span class="token comment" spellcheck="true">// 本地方式运行</span>        LocalCluster localCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        localCluster<span class="token punctuation">.</span><span class="token function">submitTopology</span><span class="token punctuation">(</span><span class="token string">"mytopology"</span><span class="token punctuation">,</span> conf<span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">createTopology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"====================haha======================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">Storm的详细学习</summary>
    
    
    
    <category term="分布式框架" scheme="https://sukie-sun.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="Storm，流式处理框架" scheme="https://sukie-sun.github.io/tags/Storm%EF%BC%8C%E6%B5%81%E5%BC%8F%E5%A4%84%E7%90%86%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>Kafka学习</title>
    <link href="https://sukie-sun.github.io/2019/01/28/Kafka%E5%AD%A6%E4%B9%A0/"/>
    <id>https://sukie-sun.github.io/2019/01/28/Kafka%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-01-27T16:00:00.000Z</published>
    <updated>2020-08-07T14:28:32.823Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、Kafka简介"><a href="#一、Kafka简介" class="headerlink" title="一、Kafka简介"></a>一、Kafka简介</h1><p>Kafka是一个高吞吐量、低延迟分布式的消息队列系统。</p><p>特点：每秒钟可以处理几十万条消息，他的低延迟最低只有几毫秒。</p><p>官网：<a href="https://kafka.apache.org/">https://kafka.apache.org/</a></p><p>底层使用Scala语言实现。</p><p>注意：</p><p>1、A streaming platform has three key capabilities:</p><ul><li>Publish and subscribe to streams of records, similar to a message queue or enterprise messaging system.</li><li>Store streams of records in a fault-tolerant durable way.</li><li>Process streams of records as they occur.</li></ul><p>2、Kafka is generally used for two broad classes of applications:</p><ul><li>Building real-time streaming data pipelines that reliably get data between systems or applications</li><li>Building real-time streaming applications that transform or react to the streams of data</li></ul><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1qq5c9zntj30hf0e7gnl.jpg"></p><p>3、First a few concepts:</p><ul><li>Kafka is run as a cluster on one or more servers that can span multiple datacenters.</li><li>The Kafka cluster stores streams of <em>records</em> in categories called <em>topics</em>.</li><li>Each record consists of a key, a value, and a timestamp.</li></ul><p>4、Kafka has four core APIs:</p><ul><li>The <a href="https://kafka.apache.org/documentation.html#producerapi">Producer API</a> allows an application to publish a stream of records to one or more Kafka topics.</li><li>The <a href="https://kafka.apache.org/documentation.html#consumerapi">Consumer API</a> allows an application to subscribe to one or more topics and process the stream of records produced to them.</li><li>The <a href="https://kafka.apache.org/documentation/streams">Streams API</a> allows an application to act as a <em>stream processor</em>, consuming an input stream from one or more topics and producing an output stream to one or more output topics, effectively transforming the input streams to output streams.</li><li>The <a href="https://kafka.apache.org/documentation.html#connect">Connector API</a> allows building and running reusable producers or consumers that connect Kafka topics to existing applications or data systems. For example, a connector to a relational database might capture every change to a table.</li></ul><p>5、其他</p><ul><li>Kafka Cluster 中有多个Broker服务器，每个类型的消息被定义为<code>topic</code></li><li>同一个topic内部的消息按照一定的key 和算法被分区（partition）存储到不同的Broker上</li><li>Producer 和consumer 可以在不同的Broker上生产或消费topic</li></ul><p>6、概念理解</p><ul><li><p>Topics and Logs：</p><ul><li>Topic 即为每条发布到 Kafka 集群的消息都有一个类别，topic在 Kafka 中可以由多个消费者订阅、消费。</li><li>每个 topic 包含一个或多个 partition（分区），partition 数量可以在创建 topic 时指定，每个分区日志中记录了该分区的数据以及索引信息。</li><li>Kafka 只保证一个分区内的消息有序，不能保证一个主题的不同分区之间的消息有序。为一个主题分配一个分区，才能保证所有消息绝对有序。</li><li>分区会给每个消息记录分配一个顺序 ID 号（偏移量）， 能够唯一地标识该分区中的每个记录。Kafka 集群保留所有发布的记录，不管这个记录有没有被消费过，Kafka 提供相应策略通过配置从而对旧数据处理。</li></ul><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1qr0t4gc1j30e108edgs.jpg"></p><ul><li>每个消费者唯一保存的元数据信息就是消费者当前消费日志的位移位置。位移位置是由消费者控制，消费者可以通过修改偏移量读取任何位置的数据。</li></ul><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1qr8l7bkrj30dn07xaan.jpg"></p></li><li><p>Producers – 生产者<br>指定 topic 来发送消息到 Kafka Broker</p></li><li><p>Consumers – 消费者<br>根据 topic 消费相应的消息</p></li><li><p>Topic – 消息主题（类型）<br> 一个 topic 可以有多个 partition，分布在不同的 broker server 上</p></li></ul><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1g1qrbi5tyuj30h008aabe.jpg"></p><p>7、注意：</p><ul><li>consumer自己维护消费消息的offset</li><li>每一个consumer都有对应的group</li><li>group内是queue消费模型<ul><li>每个consumer消费不同的partition</li><li>一个消息被一个group消费一次</li></ul></li><li>group间是publish—subscribe消费模型<ul><li>每个group独立消费，互补影响</li><li>一个消息被各个group消费一次</li></ul></li></ul><p>8、Kafka使用场景（允许数据丢失）</p><ul><li><p>日志收集：收集各log ， 开放给各个consumer ， 如hbase， hadoop ， solr</p></li><li><p>消息系统： 群发消息</p></li><li><p>用户活动跟踪： 记录用户行为发布到topic中，提供给consumer做实时监控分析，或装载到hadoop，数仓中做离线分析</p></li><li><p>运营指标 ： 记录运营监控数据</p></li><li><p>流式处理 ： SparkStreaming ， storm</p></li></ul><h1 id="二、Kafka集群的部署和安装"><a href="#二、Kafka集群的部署和安装" class="headerlink" title="二、Kafka集群的部署和安装"></a>二、Kafka集群的部署和安装</h1><h2 id="1、集群规划："><a href="#1、集群规划：" class="headerlink" title="1、集群规划："></a>1、集群规划：</h2><p>zookeeper ： 三台（Kafka是分布式消息队列 ， 依赖zookeeper）</p><p>kafka  :  三台  node1、node2、node3</p><h2 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h2><p>安装zookeeper （详见zookeeper学习.md）</p><p>安装Kafka </p><p>下载压缩包（官网地址：<a href="http://kafka.apache.org/downloads.html%EF%BC%89">http://kafka.apache.org/downloads.html）</a></p><h3 id="解压："><a href="#解压：" class="headerlink" title="解压："></a>解压：</h3><pre class="line-numbers language-shell"><code class="language-shell">tar -zxvf kafka_2.10-0.9.0.1.tgz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="修改配置文件："><a href="#修改配置文件：" class="headerlink" title="修改配置文件："></a>修改配置文件：</h3><p>config/server.properties</p><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">## broker.id broker集群中唯一标识id，0、1、2、3 依次增长（broker即 Kafka 集群中的一台服务器）</span><span class="token comment" spellcheck="true">## 注：当前Kafka 集群共三台节点，分别为：node1、node2、node3。对应的 broker.id 分别为 0、1、2。</span><span class="token attr-name"> broker.id</span><span class="token punctuation">=</span><span class="token attr-value">0</span><span class="token comment" spellcheck="true"> ## zookeeper.connect: zk 集群地址列表</span><span class="token attr-name"> zookeeper.connect</span><span class="token punctuation">=</span><span class="token attr-value">node1:2181、node2:2181、node3:2181</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将当前 node1 服务器上的 Kafka 目录同步到其他 node2、node3 服务器上。</p><h2 id="3、启动kafka集群"><a href="#3、启动kafka集群" class="headerlink" title="3、启动kafka集群"></a>3、启动kafka集群</h2><p>A、启动 Zookeeper 集群。</p><pre class="line-numbers language-shell"><code class="language-shell">zkServer.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>B、启动 Kafka 集群。<br>分别在三台服务器上执行以下命令启动：</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-server-start.sh config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="4、测试"><a href="#4、测试" class="headerlink" title="4、测试"></a>4、测试</h2><p>创建话题（kafka-topics.sh –help 查看帮助手册）</p><p>1、创建 topic：</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-topics.sh --zookeeper node1:2181,node2:2181,node3:2181 --create --replication-factor 2 --partitions 3 --topic test#参数说明#--replication-factor ：指定每个分区的复制因子个数，默认 1 个## 副本有主从之分 ， 且副本分别放在不同的broker节点上#--partitions ：指定当前创建的 kafka 分区数量，默认为 1 个#--topic ：指定新建 topic 的名称<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、查看 topic 列表：</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-topics.sh --zookeeper node1:2181,node2:2181,node3:2181 --list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3、查看“test”topic 描述：</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-topics.sh --zookeeper node1:2181,node2:2181,node3:2181 --describe --topic test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>–Isr （ in_synchronized_replication ）: 代表数据同步的节点</p><p>4、创建消费者：</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-console-producer.sh --broker-list node1:9092,node2:9092,node3:9092 --topic test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后，在当前节点的控制台输入任何内容，表作为生产的topic</p><p>5、创建消费者：（另选一台节点）</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-console-consumer.sh --zookeeper node1:2181,node2:2181,node3:2181 --from-beginning --topic test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>此时，在控制台会打印出消费的topic</p><p>消费的消息的offset存放在zookeeper中，使用<code>get + 路径</code> 命令 获取对应分区的offset</p><p>注：<br>查看帮助手册：</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-console-consumer.sh help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="三、-Flume-amp-amp-Kafka的结合"><a href="#三、-Flume-amp-amp-Kafka的结合" class="headerlink" title="三、 Flume &amp; &amp; Kafka的结合"></a>三、 Flume &amp; &amp; Kafka的结合</h1><h2 id="1、Flume-安装"><a href="#1、Flume-安装" class="headerlink" title="1、Flume  安装"></a>1、Flume  安装</h2><p>（详见Flume学习.md）</p><h2 id="2、Flume-Kafka"><a href="#2、Flume-Kafka" class="headerlink" title="2、Flume + Kafka"></a>2、Flume + Kafka</h2><p>A、启动 Kafka 集群。</p><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-server-start.sh config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>B、配置 Flume 集群，并启动 Flume 集群。</p><pre class="line-numbers language-shell"><code class="language-shell">bin/flume-ng agent -n a1 -c conf -f conf/fk.conf -Dflume.root.logger=DEBUG,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Flume 配置文件 fk.conf 内容如下：</p><pre><code>a1.sources = r1a1.sinks = k1a1.channels = c1# Describe/configure the sourcea1.sources.r1.type = avroa1.sources.r1.bind = node3a1.sources.r1.port = 41414# Describe the sinka1.sinks.k1.type = org.apache.flume.sink.kafka.KafkaSinka1.sinks.k1.topic = testflumea1.sinks.k1.brokerList = node1:9092,node2:9092,node3:9092a1.sinks.k1.requiredAcks = 1a1.sinks.k1.batchSize = 20a1.sinks.k1.channel = c1# Use a channel which buffers events in memorya1.channels.c1.type = memorya1.channels.c1.capacity = 1000000a1.channels.c1.transactionCapacity = 10000# Bind the source and sink to the channela1.sources.r1.channels = c1a1.sinks.k1.channel = c1</code></pre><h2 id="3-、测试"><a href="#3-、测试" class="headerlink" title="3 、测试"></a>3 、测试</h2><ul><li><p>分别启动 Zookeeper、Kafka、Flume 集群。</p></li><li><p>创建 topic：</p></li></ul><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-topics.sh --zookeeper node1:2181,node2:2181,node3:2181 --create --replication-factor 2 --partitions 3 --topic testflume<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>启动消费者：</li></ul><pre class="line-numbers language-shell"><code class="language-shell">bin/kafka-console-consumer.sh --zookeeper node1:2181,node2:2181,node3:2181 --from-beginning --topic testflume<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>运行“RpcClientDemo”代码，通过 rpc 请求发送数据到 Flume 集群。Flume 中 source 类型为 AVRO 类型，此时通过 Java 发送 rpc 请求，测试数据是否传入 Kafka</li><li>其中，Java 发送 Rpc 请求 Flume 代码示例如下：<br>（参考 Flume 官方文档：<a href="http://flume.apache.org/FlumeDeveloperGuide.html%EF%BC%89">http://flume.apache.org/FlumeDeveloperGuide.html）</a></li></ul><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>Event<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>EventDeliveryException<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>api<span class="token punctuation">.</span>RpcClient<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>api<span class="token punctuation">.</span>RpcClientFactory<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>event<span class="token punctuation">.</span>EventBuilder<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span>Charset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*** Flume官网案例* http://flume.apache.org/FlumeDeveloperGuide.html* @author root*/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcClientDemo</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>MyRpcClientFacade client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRpcClientFacade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Initialize client with the remote Flume agent's host and port</span>client<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"node1"</span><span class="token punctuation">,</span> <span class="token number">41414</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Send 10 events to the remote Flume agent. That agent should be</span><span class="token comment" spellcheck="true">// configured to listen with an AvroSource.</span>String sampleData <span class="token operator">=</span> <span class="token string">"Hello Flume!"</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>client<span class="token punctuation">.</span><span class="token function">sendDataToFlume</span><span class="token punctuation">(</span>sampleData<span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送数据："</span> <span class="token operator">+</span> sampleData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>client<span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">MyRpcClientFacade</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token keyword">private</span> RpcClient client<span class="token punctuation">;</span><span class="token keyword">private</span> String hostname<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>String hostname<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Setup the RPC connection</span><span class="token keyword">this</span><span class="token punctuation">.</span>hostname <span class="token operator">=</span> hostname<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> RpcClientFactory<span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Use the following method to create a thrift client (instead of the</span><span class="token comment" spellcheck="true">// above line):</span><span class="token comment" spellcheck="true">// this.client = RpcClientFactory.getThriftInstance(hostname,port);</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendDataToFlume</span><span class="token punctuation">(</span>String data<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Create a Flume Event object that encapsulates the sample data</span>Event event <span class="token operator">=</span> EventBuilder<span class="token punctuation">.</span><span class="token function">withBody</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Send the event</span><span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>client<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EventDeliveryException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// clean up and recreate the client</span>client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>client <span class="token operator">=</span> null<span class="token punctuation">;</span>client <span class="token operator">=</span> RpcClientFactory<span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Use the following method to create a thrift client (instead of</span><span class="token comment" spellcheck="true">// the above line):</span><span class="token comment" spellcheck="true">// this.client =RpcClientFactory.getThriftInstance(hostname, port);</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Close the RPC connection</span>client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="四、Kafka数据丢失问题和重复消费问题"><a href="#四、Kafka数据丢失问题和重复消费问题" class="headerlink" title="四、Kafka数据丢失问题和重复消费问题"></a>四、Kafka数据丢失问题和重复消费问题</h1><h2 id="1、为什么会丢失？"><a href="#1、为什么会丢失？" class="headerlink" title="1、为什么会丢失？"></a>1、为什么会丢失？</h2><p>Kafka ， 高吞吐 ， 一次能处理几十万条数据，</p><p>（1）生产数据时：</p><p>因为服务器（生产者）发送数据给Kafka后，kafka 将数据写入内存后，就直接返回操作成功的消息（ack机制 : 1（默认值）而ack机制 : 0 时，不用管是否操作成功，就发第二条），然后再发第二条，避免的磁盘I/O带来的延迟，可是，这样不安全，万一此时该节点宕机，数据就丢失了。</p><p>而为了解决数据丢失，可以在数据写入内存时，备份到其他节点,再返回操作成功的消息（ack机制 : -1）。</p><p>（2）消费数据时：</p><p>Client消费数据过程中，（频率很短）先更新了消费offset， 再处理数据（如100），结果宕机，那么重启后就会从下一个offset（如101）开始消费消息，那么100这条数据就丢失了。</p><p>解决方案：关闭自动提交  ， 改为 ， 手动提交，保证数据处理完毕后再提交消费offset。但是，解决了数据丢失，提高了性能消耗</p><h2 id="2、数据重复消费问题"><a href="#2、数据重复消费问题" class="headerlink" title="2、数据重复消费问题"></a>2、数据重复消费问题</h2><p>因为Client（消费者）设置定时（频率很长）向zookeeper更新消费消息的offset，（如100 ， 120） 如果在没达到定的时间（如120），client就宕机了，重启后会重新去zookeeper上查询offset， 那么在定的时间之前的消息offset（100到120之间）就不存在，Client就会重新（从100）开始消费，就造成了重复消费问题。</p><p>解决方案：关闭自动定时提交  ， 改为 ， 手动提交，保证数据处理完毕后再提交消费offset。但是，解决重复消费，提高了性能消耗。</p><h2 id="3、注意"><a href="#3、注意" class="headerlink" title="3、注意"></a>3、注意</h2><p>使用解决方案时，要注意业务的要求，是否能允许数据丢失和重复消费问题</p><h2 id="4、API"><a href="#4、API" class="headerlink" title="4、API"></a>4、API</h2><p>​    high level api<br>​    简单，不灵活<br>​     simple api<br>​    复杂，但灵活</p>]]></content>
    
    
    <summary type="html">Kafka的详细学习第一篇章:Kafka是一个高吞吐量、低延迟分布式的消息队列系统。</summary>
    
    
    
    <category term="Kafka" scheme="https://sukie-sun.github.io/categories/Kafka/"/>
    
    
    <category term="分布式" scheme="https://sukie-sun.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    <category term="消息队列系统" scheme="https://sukie-sun.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch学习</title>
    <link href="https://sukie-sun.github.io/2019/01/25/Elasticsearch%E5%AD%A6%E4%B9%A0/"/>
    <id>https://sukie-sun.github.io/2019/01/25/Elasticsearch%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-01-24T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.739Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、Elasticsearch是什么"><a href="#一、Elasticsearch是什么" class="headerlink" title="一、Elasticsearch是什么"></a>一、Elasticsearch是什么</h1><p><a href="https://ideas.spkcn.com/software/os/windows/687.html">https://ideas.spkcn.com/software/os/windows/687.html</a></p><h2 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h2><ul><li><p>一个基于Lucene的、实时的、分布式搜索和分析引擎</p></li><li><p>应用于云计算中。</p></li><li><p>实时搜索、稳定、可靠、快速</p></li><li><p>安装方便</p></li><li><p>基于Restful接口</p></li></ul><h2 id="2、和Lucene的关系"><a href="#2、和Lucene的关系" class="headerlink" title="2、和Lucene的关系"></a>2、和Lucene的关系</h2><ul><li>Lucene 是一个库。必须使用Java开发。工作原理复杂</li><li>Elasticsearch使用Java开发，以Lucene为核心实现索引和搜索功能。通过简单的Restful API隐藏Lucene的复杂性，简化了全文搜索。</li></ul><h2 id="3、和SOLR对比"><a href="#3、和SOLR对比" class="headerlink" title="3、和SOLR对比"></a>3、和SOLR对比</h2><ul><li><p>热度逐渐远高于solr</p></li><li><p>平均查询速度快于solr倍</p></li><li><p>ES的优势：</p><p>a）Elasticsearch是分布式的。不需要其他组件，分发是实时的，被叫做”Push replication”。</p><p>b）Elasticsearch 完全支持 Apache Lucene 的接近实时的搜索。</p><p>处理多租户（multitenancy）不需要特殊配置，而Solr则需要更多的高级设置。</p><p>c）Elasticsearch 采用 Gateway 的概念，使得备份更加简单。</p><p>d）各节点组成对等的网络结构，某些节点出现故障时会自动分配其他节点代替其进行工作。</p></li></ul><h2 id="4、与关系型数据库对比"><a href="#4、与关系型数据库对比" class="headerlink" title="4、与关系型数据库对比"></a>4、与关系型数据库对比</h2><ul><li>结构相似</li></ul><table><thead><tr><th align="center">database（数据库）</th><th align="center">index（索引库）</th></tr></thead><tbody><tr><td align="center">table（表）</td><td align="center">type（类型）</td></tr><tr><td align="center">row（行）</td><td align="center">document（文档）</td></tr><tr><td align="center">column（列）</td><td align="center">field（字段）</td></tr></tbody></table><ul><li><p>一个ES集群可以有多个索引库。每个索引库包含很多种类型，类型中又包含了很多文档，每个文档又包含很多字段</p></li><li><p>传统数据库为特定列增加一个索引。Elasticsearch和Lucene使用一种叫做倒排索引(inverted index)的数据结构来达到相同目的</p></li><li><p>倒排索引：</p><ul><li>源于实际应用中需要根据属性的值来查找记录。</li><li>种索引表中的每一项都包括一个属性值和具有该属性值的各记录的地址。</li><li>不是由记录来确定属性值，而是由属性值来确定记录的位置</li></ul></li></ul><p>​      </p><h1 id="二、安装与部署"><a href="#二、安装与部署" class="headerlink" title="二、安装与部署"></a>二、安装与部署</h1><p>环境要求：JDK版本为1.7及以上</p><p>下载位置：<a href="https://www.elastic.co/downloads/">系列产品</a></p><p>1、在安装目录下的config 目录下：编辑elasticsearch.yml文件</p><p>编辑内容： (注意要顶格写，冒号后面要加一个空格)</p><pre><code>a)    Cluster.name:  shsxt              (同一集群要一样)b)    Node.name：node-1                 (同一集群要不一样)c)    Network.Host: 192.168.1.194        (这里不能写127.0.0.1)d)    防止脑裂的配置discovery.zen.ping.multicast.enabled: falsediscovery.zen.ping_timeout: 120sclient.transport.ping_timeout: 60sdiscovery.zen.ping.unicast.hosts: [&quot;192.168.1.191&quot;,&quot;192.168.1.192&quot;, &quot;192.168.1.193&quot;]</code></pre><p>然后，将安装包发送到其他节点，再根据所在节点，进行相应的配置</p><p>2、启动 （开几台起几台）</p><p>ES_HOME/bin/elasticsearch     （ctrl + C 结束服务）</p><p>ES_HOME/bin/elasticsearch -d(后台运行)     （前提页面结束服务或者kill 杀死进程）</p><p><code>启动权限问题</code></p><p>1、启动后会报错，说不能在root用户下执行，所以我们需要添加新用户来执行启动</p><p>（分别在3台节点上）</p><pre><code>useradd espasswd（设置密码）chown —R es:es filename(路径/ES的解压文件)（修改ES安装文件的权限为用户es）su es（切换用户为es）再执行启动命令</code></pre><p>显示：（在启动的所有节点上都会显示出所选举的master节点，此处为node0）</p><pre><code>2019-01-26 03:22:40,594cluster.service           detected_master &amp;#123;node0&amp;#125;&amp;#123;GOmO6SISRHexhlbqcddx9w&amp;#125;&amp;#123;192.168.198.128&amp;#125;&amp;#123;192.168.198.128:9300&amp;#125;, added &amp;#123;&amp;#123;node0&amp;#125;&amp;#123;GOmO6SISRHexhlbqcddx9w&amp;#125;&amp;#123;192.168.198.128&amp;#125;&amp;#123;192.168.198.128:9300&amp;#125;,&amp;#123;node2&amp;#125;&amp;#123;blKR0BxaQ92QjmPuMlPaRw&amp;#125;&amp;#123;192.168.198.131&amp;#125;&amp;#123;192.168.198.131:9300&amp;#125;,&amp;#125;, reason: zen-disco-receive(from master [&amp;#123;node0&amp;#125;&amp;#123;GOmO6SISRHexhlbqcddx9w&amp;#125;&amp;#123;192.168.198.128&amp;#125;&amp;#123;192.168.198.128:9300&amp;#125;])</code></pre><p>4.访问</p><pre><code>浏览器访问 http://localhost:9200</code></pre><p><code>注意</code></p><blockquote><p>9200  : 是HTTP协议所访问的端口，即从浏览器端访问的port</p><p>9300  ：是Java API访问端口</p></blockquote><h1 id="ES整合hive"><a href="#ES整合hive" class="headerlink" title="ES整合hive"></a>ES整合hive</h1><p>创建Hive映射ES的外表</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>es_analysis_order<span class="token punctuation">`</span><span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'from deserializer'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> string <span class="token keyword">COMMENT</span> <span class="token string">'from deserializer'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>sum_2000<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">COMMENT</span> <span class="token string">'from deserializer'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>sum_3000<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">COMMENT</span> <span class="token string">'from deserializer'</span><span class="token punctuation">,</span>   <span class="token punctuation">`</span>day<span class="token punctuation">`</span> <span class="token keyword">int</span> <span class="token keyword">COMMENT</span> <span class="token string">'from deserializer'</span><span class="token punctuation">)</span><span class="token keyword">ROW</span> FORMAT SERDE   <span class="token string">'org.elasticsearch.hadoop.hive.EsSerDe'</span> STORED <span class="token keyword">BY</span>   <span class="token string">'org.elasticsearch.hadoop.hive.EsStorageHandler'</span> <span class="token keyword">WITH</span> SERDEPROPERTIES <span class="token punctuation">(</span>   <span class="token string">'serialization.format'</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">)</span>TBLPROPERTIES <span class="token punctuation">(</span>  <span class="token string">'es.mapping.id'</span><span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">,</span>   <span class="token string">'es.mapping.names'</span><span class="token operator">=</span><span class="token string">'user_id:user_id,sum_2000:sum_2000,sum_3000:sum_3000,day:day'</span><span class="token punctuation">,</span>   <span class="token string">'es.nodes'</span><span class="token operator">=</span><span class="token string">'10.10.65.198,10.10.151.212,10.10.114.206'</span><span class="token punctuation">,</span>   <span class="token string">'es.port'</span><span class="token operator">=</span><span class="token string">'9200'</span><span class="token punctuation">,</span>   <span class="token string">'es.resource'</span><span class="token operator">=</span><span class="token string">'behaviors/order_user'</span><span class="token punctuation">,</span>   <span class="token string">'es.write.operation'</span><span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="三、REST风格"><a href="#三、REST风格" class="headerlink" title="三、REST风格"></a>三、REST风格</h1><h2 id="1、简介-1"><a href="#1、简介-1" class="headerlink" title="1、简介"></a>1、简介</h2><p><strong>表现层状态转换</strong>（<a href="https://zh.wikipedia.org/wiki/%E8%8B%B1%E8%AF%AD">英语</a>：<strong>Representational State Transfer</strong>，<a href="https://zh.wikipedia.org/wiki/%E7%B8%AE%E5%AF%AB">缩写</a>：<strong>REST</strong>）</p><pre><code>一种万维网软件架构风格，目的是便于不同软件/程序在网络（例如互联网）中互相传递信息。表现层状态转换是根基于超文本传输协议(HTTP)之上而确定的一组约束和属性，是一种设计提供万维网络服务的软件构建风格。匹配或兼容于这种架构风格(简称为 REST 或 RESTful)的网络服务，允许客户端发出以统一资源标识符访问和操作网络资源的请求，而与预先定义好的无状态操作集一致化。因此表现层状态转换提供了在互联网络的计算系统之间，彼此资源可交互使用的协作性质(interoperability)。相对于其它种类的网络服务，例如 SOAP服务则是以本身所定义的操作集，来访问网络上的资源。</code></pre><p>要点：</p><pre><code>需要注意的是，REST是设计风格而不是标准。REST通常基于使用HTTP，URI，和XML以及HTML这些现有的广泛流行的协议和标准。* 资源是由URI来指定。* 对资源的操作包括获取、创建、修改和删除资源，这些操作正好对应HTTP协议提供的GET、POST、PUT和DELETE方法。* 通过操作资源的表现形式来操作资源。* 资源的表现形式则是XML或者HTML，取决于读者是机器还是人，是消费web服务的客户软件还是web浏览器。当然也可以是任何其他的格式，例如JSON。</code></pre><blockquote><p>URI  ： 统一资源标识符</p><p>URL  ： 全球资源定位器</p></blockquote><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1fzj3dsu1n9j30ha09vn0p.jpg"></p><h2 id="2、Rest操作"><a href="#2、Rest操作" class="headerlink" title="2、Rest操作"></a>2、Rest操作</h2><p>REST的操作分为以下几种：</p><p>– GET：获取对象的当前状态；</p><p>– PUT：改变对象的状态；</p><p>– POST：创建对象；</p><p>– DELETE：删除对象；</p><p>– HEAD：获取头信息。</p><h2 id="3、ES内置的REST接口"><a href="#3、ES内置的REST接口" class="headerlink" title="3、ES内置的REST接口"></a>3、ES内置的REST接口</h2><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1fzj3feth0wj30fe08taci.jpg"></p><h1 id="四、CURL命令"><a href="#四、CURL命令" class="headerlink" title="四、CURL命令"></a>四、CURL命令</h1><p>-X  指定http请求的方法</p><p>-HEAD  GET POST  PUT DELETE</p><p>-d  指定要传输的数据</p><h2 id="1、索引库的创建与删除"><a href="#1、索引库的创建与删除" class="headerlink" title="1、索引库的创建与删除"></a>1、索引库的创建与删除</h2><p>创建索引库：（PUT/POST都可以）</p><pre><code>curl -XPUT http://192.168.198.128:9200/sukie/</code></pre><p>显示：（成功了）</p><blockquote><p>[root@node00 ~]# curl -XPUT <a href="http://192.168.198.128:9200/sukie/">http://192.168.198.128:9200/sukie/</a><br>{“acknowledged”:true}[root@node00 ~]# </p></blockquote><p>删除索引库：</p><pre><code>curl -XDELETE http://192.168.198.128:9200/sukie/</code></pre><h2 id="2、创建document"><a href="#2、创建document" class="headerlink" title="2、创建document"></a>2、创建document</h2><pre><code>(注意格式：JSON  （英文状态下）)curl -XPUT http://192.168.198.128:9200/sukie/employee/2?pretty -d &#39;&amp;#123; &quot;first_name&quot; : &quot;john&quot;, &quot;last_name&quot; : &quot;smith&quot;, &quot;age&quot; : 25, &quot;love&quot; : &quot;I love to go rock climbing&quot;, &quot;address&quot;: &quot;shanghai&quot;&amp;#125;&#39;</code></pre><p>==employee==  ： 在此处为type（类型）</p><p>==1==  ： 在此处为id</p><p>==pretty==： 表示以良好格式显示结果</p><p>显示：</p><blockquote><pre><code>[root@node00 ~]# curl -XPUT http://192.168.198.128:9200/sukie/employee/2?pretty -d &#39;&amp;#123; &quot;first_name&quot; : &quot;john&quot;, &quot;last_name&quot; : &quot;smith&quot;, &quot;age&quot; : 25, &quot;love&quot; : &quot;I love to go rock climbing&quot;, &quot;address&quot;: &quot;shanghai&quot;&amp;#125;&#39;&amp;#123;  &quot;_index&quot; : &quot;sukie&quot;,  &quot;_type&quot; : &quot;employee&quot;,   &quot;_id&quot; : &quot;2&quot;,   &quot;_version&quot; : 1,  &quot;_shards&quot; : &amp;#123;    &quot;total&quot; : 2,    &quot;successful&quot; : 2,   &quot;failed&quot; : 0  &amp;#125;,   &quot;created&quot; : true&amp;#125;[root@node00 ~]# </code></pre></blockquote><pre><code>curl -XPOST http://192.168.198.128:9200/sukie/employee -d &#39;&amp;#123; &quot;first_name&quot; : &quot;john&quot;, &quot;last_name&quot; : &quot;smith&quot;, &quot;age&quot; : 25, &quot;about&quot; : &quot;I love to go rock climbing&quot;&amp;#125;&#39;</code></pre><p>==未指定id==</p><p>如：（必须使用POST）</p><pre><code>命令：curl -XPOST http://localhost:9200/sukie/employee -d &#39;&amp;#123;&quot;first_name&quot; : &quot;John&quot;&amp;#125;&#39;</code></pre><p>若：（使用PUT会报错）</p><pre><code>命令：curl -XPUT http://localhost:9200/sukie/employee -d &#39;&amp;#123;&quot;first_name&quot; : &quot;John&quot;&amp;#125;&#39; 会报错</code></pre><p><code>创建索引注意事项</code></p><blockquote><ul><li>索引库名称必须要全部**<code>小写</code><strong>，</strong><code>不</code><strong>能以下划线开头，也</strong><code>不</code>**能包含逗号</li><li>如果没有明确指定索引数据的ID，那么es会自动生成一个随机的ID，这时需要使用POST方式，PUT方式会出错</li></ul></blockquote><h2 id="3、更新document"><a href="#3、更新document" class="headerlink" title="3、更新document"></a>3、更新document</h2><pre><code>curl -XPUT http://192.168.198.128:9200/sukie/employee/2 -d &#39;&amp;#123; &quot;first_name&quot; : &quot;god bin&quot;, &quot;last_name&quot; : &quot;pang&quot;, &quot;age&quot; : 38, &quot;about&quot; : &quot;I love to go rock climbing&quot;, &quot;address&quot;: &quot;shanghai&quot;&amp;#125;&#39;</code></pre><pre><code>curl -XPOST http://192.168.198.128:9200/sukie/employee?pretty -d &#39;&amp;#123; &quot;first_name&quot; : &quot;john&quot;, &quot;last_name&quot; : &quot;smith&quot;, &quot;age&quot; : 25, &quot;about&quot; : &quot;I love to go rock climbing&quot;&amp;#125;&#39;</code></pre><p>显示：</p><pre><code>[root@node00 ~]# curl -XPOST http://192.168.198.128:9200/sukie/employee?pretty -d &#39;&amp;#123; &gt; &quot;first_name&quot; : &quot;john&quot;, &gt; &quot;last_name&quot; : &quot;smith&quot;, &gt; &quot;age&quot; : 25, &gt; &quot;about&quot; : &quot;I love to go rock climbing&quot;&gt; &amp;#125;&#39;&amp;#123;  &quot;_index&quot; : &quot;sukie&quot;,  &quot;_type&quot; : &quot;employee&quot;,   &quot;_id&quot; : &quot;AWiFmf347KNgqTe_uJ4-&quot;,    ==自动生成的id==   &quot;_version&quot; : 1,  &quot;_shards&quot; : &amp;#123;    &quot;total&quot; : 2,     &quot;successful&quot; : 2,    &quot;failed&quot; : 0  &amp;#125;,   &quot;created&quot; : true&amp;#125;[root@node00 ~]# </code></pre><p>put  ： 必须指定id   ，若id存在，这更新数据（全局更新）；若id不存在，则新增数据</p><pre><code>curl -XPUT http://localhost:9200/sukie/employee/1 -d &#39;&amp;#123;&quot;city&quot;:&quot;beijing&quot;,&quot;car&quot;:&quot;BMW&quot;&amp;#125;&#39;</code></pre><p><code>注意;</code>执行更新操作时：</p><p>– ES首先将旧的文档标记为删除状态 </p><p>– 然后添加新的文档 </p><p>– 旧的文档不会立即消失，但是你也无法访问 </p><p>– ES会在你继续添加更多数据的时候在后台清理已经标记为删除状态的文档</p><hr><p>post  ： id若不指定，会自动生成随机的id</p><p>​                id若指定，就实现局部更新操作（添加新字段或更新已有字段）</p><pre><code> curl -XPOST http://localhost:9200/sukie/employee/1/_update -d &#39;&amp;#123;&quot;doc&quot;:&amp;#123;&quot;city&quot;:&quot;beijing&quot;,  “sex”:”male”&amp;#125;&amp;#125;&#39;</code></pre><p>（同一个索引库，会默认创建5个分片，用以实现分布式搜索；</p><p>   每个分片均另外还有一个副本分布在不同的另一个节点上，用以提高可靠性和查询速率）</p><p>==注意==</p><hr><p>同一个索引库中不同的文档之间若用相同的字段，则这个字段的数据类型必须是一致的；</p><p>字段的数据类型是由第一次推送数据是确定</p><hr><h2 id="4、普通查询索引"><a href="#4、普通查询索引" class="headerlink" title="4、普通查询索引"></a>4、普通查询索引</h2><pre><code>– 根据员工id查询 curl -XGET http://localhost:9200/sukie/employee/1?pretty– 在任意的查询字符串中添加pretty参数，es可以得到易于识别的json结果。 – curl后添加-i 参数，这样你就能得到反馈头文件curl -i XGET http://localhost:9200/sukie/employee/1?pretty– 检索文档中的一部分，如果只需要显示指定字段curl -XGET http://localhost:9200/sukie/employee/1?_source=name,age 如果只需要source的数据 curl -XGET http://localhost:9200/sukie/employee/1/_source?pretty– 查询所有curl -XGET http://localhost:9200/sukie/employee/_search?pretty – 根据条件进行查询 curl -XGET http://localhost:9200/sukie/employee/_search?q=last_name:smith</code></pre><h2 id="5-DSL查询"><a href="#5-DSL查询" class="headerlink" title="5.DSL查询"></a>5.DSL查询</h2><p>DSL查询 •Domain Specific Language </p><p>– 领域特定语言 </p><pre><code>curl -XGET http://localhost:9200/shsxt/employee/_search?pretty -d &#39;&amp;#123;&quot;query&quot;:&amp;#123;&quot;match&quot;:&amp;#123;&quot;last_name&quot;:&quot;smith&quot;&amp;#125;&amp;#125;&amp;#125;&#39;</code></pre><p>#对多个field发起查询：multi_match</p><pre><code>curl -XGET http://localhost:9200/shsxt/employee/_search?pretty -d &#39;&amp;#123; &quot;query&quot;:  &amp;#123;&quot;multi_match&quot;:   &amp;#123;    &quot;query&quot;:&quot;bin&quot;,    &quot;fields&quot;:[&quot;last_name&quot;,&quot;first_name&quot;]   &amp;#125;  &amp;#125;&amp;#125;&#39;</code></pre><p>复合查询，must，must_not, should </p><p>must： AND   </p><p>must_not：NOT</p><p>should：OR</p><pre><code>curl -XGET http://192.168.78.101:9200/shsxt/employee/_search?pretty -d &#39;&amp;#123; &quot;query&quot;:  &amp;#123;&quot;bool&quot; :   &amp;#123;    &quot;must&quot; :      &amp;#123;&quot;match&quot;:      &amp;#123;&quot;first_name&quot;:&quot;bin&quot;&amp;#125;     &amp;#125;,    &quot;must&quot; :      &amp;#123;&quot;match&quot;:      &amp;#123;&quot;age&quot;:37&amp;#125;     &amp;#125;   &amp;#125;  &amp;#125;&amp;#125;&#39;</code></pre><p>查询first_name=bin的，并且年龄不在20岁到30岁之间的</p><pre><code>curl -XGET http://192.168.78.101:9200/shsxt/employee/_search -d &#39;&amp;#123; &quot;query&quot;:  &amp;#123;&quot;bool&quot; :   &amp;#123;   &quot;must&quot; :    &amp;#123;&quot;term&quot; :      &amp;#123; &quot;first_name&quot; : &quot;bin&quot; &amp;#125;    &amp;#125;   ,   &quot;must&quot; :     &amp;#123;&quot;range&quot;:     &amp;#123;&quot;age&quot; : &amp;#123; &quot;from&quot; : 30, &quot;to&quot; : 40 &amp;#125;    &amp;#125;   &amp;#125;   &amp;#125;  &amp;#125;&amp;#125;&#39;</code></pre><h2 id="6-删除索引"><a href="#6-删除索引" class="headerlink" title="6.删除索引"></a>6.删除索引</h2><pre><code>curl -XDELETE http://localhost:9200/shsxt/employee/1?pretty</code></pre><p>• 如果文档存在，es会返回200 ok的状态码，found属性值为 true，_version属性的值+1 </p><p>• found属性值为false，但是_version属性的值依然会+1，这个就是内部管理的一部分，它保证了我们在多个节点间的不同操作的顺序都被正确标记了 </p><p>• 注意：删除一个文档也不会立即生效，它只是被标记成已删除。 Elasticsearch将会在你之后添加更多索引的时候才会在后台进行删除内容的清理</p><h1 id="五、Elasticsearch插件安装"><a href="#五、Elasticsearch插件安装" class="headerlink" title="五、Elasticsearch插件安装"></a>五、Elasticsearch插件安装</h1><h2 id="1、head"><a href="#1、head" class="headerlink" title="1、head"></a>1、head</h2><p>（至少一台）</p><p>方式一：</p><p>在bin目录下执行</p><pre><code>./plugin install mobz/elasticsearch-head</code></pre><p>来安装head插件</p><p>方式二：</p><p>使用elasticsearch-head-master.zip文件安装</p><p>在bin目录下执行</p><pre><code>./plugin install file:/usr/soft/elasticsearch-head-master.zip</code></pre><p>来安装head插件</p><p>方式三：</p><p>将elasticsearch-head-master.zip挤压解压安装后的包拷贝到elasticsearch安装目录的plugins目录下</p><p>安装后启动elasticsearch（至少2台）</p><p>访问<a href="http://ip:9200/_plugin/head">http://ip:9200/_plugin/head</a></p><h2 id="2-Kibana"><a href="#2-Kibana" class="headerlink" title="2.Kibana"></a>2.Kibana</h2><p>（1台）</p><blockquote><p>它是一个基于浏览器页面的ES前端展示工具，是为ES提供日志分析的web接口，可用它对日志进行高效的搜索、可视化、分析等操作。</p></blockquote><p>解压安装,然后修改配置文件config/kibana.yml的elasticsearch.url属性即可</p><h2 id="3、Marvel"><a href="#3、Marvel" class="headerlink" title="3、Marvel"></a>3、Marvel</h2><blockquote><p>Marvel插件可以帮助使用者监控elasticsearch的运行状态，不过这个插件需要license。安装完license后可以安装marvel的agent，agent会收集elasticsearch的运行状态</p></blockquote><p><strong>Step 1:</strong> <strong>Install Marvel into Elasticsearch:(3</strong>台<strong>es</strong>都装)</p><p>Es_home/bin/plugin install license<br> Es_home/bin/plugin install marvel-agent</p><p>（注意：Es_home/plugins 目录的权限问题，是否为当前用户的）</p><p><strong>Step 2:</strong> **Install Marvel into Kibana(**在kibana机器上安)</p><p>Kibana_home/bin/kibana plugin –install elasticsearch/marvel/latest</p><p><strong>Step 3: Start Elasticsearch and Kibana</strong></p><p>bin/elasticsearch</p><p>bin/kibana</p><p><strong>Step 4: 浏览器访问</strong>  <a href="http://node00:5601/app/marvel">http://node00:5601/app/marvel</a></p><p>==注意：多台节点的时间同步==</p><h2 id="4、分词器安装"><a href="#4、分词器安装" class="headerlink" title="4、分词器安装"></a>4、分词器安装</h2><p>从地址<a href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p><p>下载elasticsearch中文分词器</p><p>（1）在安装好的elasticsearch中在plugins目录下新建ik目录</p><p>（2）将此zip包拷贝到ik目录下</p><p>（3）将权限修改为elasticsearch启动用户的权限</p><p>（4）过unzip命令解压缩：</p><pre><code>unzip  elasticsearch-analysis-ik-1.8.0.zip</code></pre><p>（5）每台机器都这样操作，重新启动elasticsearch集群</p><p><code>例子：</code></p><p>a. 创建索引库</p><pre><code>curl -XPUT http://localhost:9200/ik</code></pre><p>b. 设置mapping</p><pre><code>curl -XPOST http://localhost:9200/ik/ikType/_mapping -d&#39;&amp;#123;        &quot;properties&quot;: &amp;#123;            &quot;content&quot;: &amp;#123;                &quot;type&quot;: &quot;string&quot;,                &quot;index&quot;:&quot;analyzed&quot;,                &quot;analyzer&quot;: &quot;ik_max_word&quot;,                &quot;search_analyzer&quot;: &quot;ik_max_word&quot;            &amp;#125;       &amp;#125;&amp;#125;&#39;</code></pre><p>c.  插入数据</p><pre><code>curl -XPOST http://localhost:9200/ik/ikType/1 -d&#39;&amp;#123;&quot;content&quot;:&quot;美国留给伊拉克的是个烂摊子吗&quot;&amp;#125;&#39;curl -XPOST http://localhost:9200/ik/ikType/2 -d&#39;&amp;#123;&quot;content&quot;:&quot;公安部：各地校车将享最高路权&quot;&amp;#125;&#39;curl -XPOST http://localhost:9200/ik/ikType/3 -d&#39;&amp;#123;&quot;content&quot;:&quot;中韩渔警冲突调查：韩警平均每天扣1艘中国渔船&quot;&amp;#125;&#39;curl -XPOST http://localhost:9200/ik/ikType/4 -d&#39;&amp;#123;&quot;content&quot;:&quot;中国驻洛杉矶领事馆遭亚裔男子枪击 嫌犯已自首&quot;&amp;#125;&#39;</code></pre><p>d. 查询</p><pre><code>curl -XGET http://localhost:9200/ik/ikType/_search?pretty  -d&#39;&amp;#123;    &quot;query&quot; : &amp;#123; &quot;term&quot; : &amp;#123; &quot;content&quot; : &quot;中国&quot; &amp;#125;&amp;#125;   &amp;#125;&#39;</code></pre><p>本地分片</p><p>只在主分片</p><p>优先主分片</p><p>只在某个节点分片</p><p>指定几个节点分片</p><p>优先指定分片</p><p>脑裂：</p><p>集群中出现两个master；1、负载过高时，master所在的节点负责管理和检索，忙不过来了，slaves节点就选出了另一个master；（功能解耦，用两台节点分别负责一个模块；一个放master，一个放data）；</p><p>2、网络波动，节点间的通信出现问题，超时连接，另一台master就又被选出来了;(解决：异地服务器）；</p><p>优化：</p><p>系统最大文件打开数量（默认1024个）</p><p>ES JVM内存大小（256m，1g，最好设为相同值）</p><p>【256m用满了，启动垃圾回收机制，然后扩容；弹性伸缩，因为GC会影响性能。】</p><p>设置mlockall来锁定物理进程true</p><p>【Linux：swap交换区（磁盘空间：存放不用的内存）】</p><p>分片数要合理</p><p>单个分片存储：20g~30g</p><p>个数=数据总量/20g</p><p>再建一个索引库，因为支持多个索引库检索</p><p>副本：数据迁移时，先设置为0，网络和磁盘IO可以降低。</p><p>segment分片存储时的片段设为1 </p><p>删除文档时，添加del标记，到客户端时再过滤。</p><p>hash取余再放到对应的分片</p>]]></content>
    
    
    <summary type="html">Elasticsearch:分布式搜索、分析引擎</summary>
    
    
    
    <category term="Elasticsearch" scheme="https://sukie-sun.github.io/categories/Elasticsearch/"/>
    
    
    <category term="Linux系统环境" scheme="https://sukie-sun.github.io/tags/Linux%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83/"/>
    
    <category term="分布式搜索和分析引擎" scheme="https://sukie-sun.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%92%8C%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E/"/>
    
  </entry>
  
  <entry>
    <title>CDH部署操作</title>
    <link href="https://sukie-sun.github.io/2019/01/18/CDH%E6%93%8D%E4%BD%9C%E5%AD%A6%E4%B9%A0/"/>
    <id>https://sukie-sun.github.io/2019/01/18/CDH%E6%93%8D%E4%BD%9C%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-01-17T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.737Z</updated>
    
    <content type="html"><![CDATA[<h1 id="报错："><a href="#报错：" class="headerlink" title="报错："></a><strong>报错：</strong></h1><p>1、<code>Error:JAVA_HOME is not set and Java could not fund.Cloudera Manager requires Java 1.6 or later .NOTE：This script will find Oracle Java whether you install using the binary or the RPM based installer</code></p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1fzc3r48t1wj30f004qq3s.jpg"></p><p>原因：它运行时会默认到（ /usr/java/default）这个路径下找jdk</p><blockquote><p>在 /usr/java/default目录下创建jdk访问的软连接，</p><pre class="line-numbers language-shell"><code class="language-shell">ln -s /home/jdk1.8.0_191 /usr/java/default<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></blockquote>]]></content>
    
    
    <summary type="html">集群管理工具</summary>
    
    
    
    <category term="CDH" scheme="https://sukie-sun.github.io/categories/CDH/"/>
    
    
    <category term="HDFS" scheme="https://sukie-sun.github.io/tags/HDFS/"/>
    
  </entry>
  
  <entry>
    <title>Flume学习</title>
    <link href="https://sukie-sun.github.io/2019/01/18/Flume%E5%AD%A6%E4%B9%A0/"/>
    <id>https://sukie-sun.github.io/2019/01/18/Flume%E5%AD%A6%E4%B9%A0/</id>
    <published>2019-01-17T16:00:00.000Z</published>
    <updated>2020-08-07T13:07:21.741Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、理论理解"><a href="#一、理论理解" class="headerlink" title="一、理论理解"></a>一、理论理解</h2><p>1、官网:：<a href="http://flume.apache.org/">http://flume.apache.org/</a></p><p>2、概念：</p><p>​    Flume是一个分布式、可扩展、可靠、高可用的海量日志有效聚合及移动的框架。</p><p>​    它通常用于log数据，支持在系统中定制各类数据发送方，用于收集数据。它具有可靠性和容错可调机制和许多故障转移和恢复机制</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDly1g1jra7eyl9j30gi0e5jt8.jpg"></p><p>3、Flume1.0X         —-FlumeNG</p><p>flume1.0x版本中flume只有agent,由3个部分组成</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDly1g1jrc5v43yj30me071q39.jpg" alt="FlumeNG"></p><p>4、架构解释</p><p>Agent ：将数据源的数据发送给collector ，Agent由source、channel、sink三大组件组成。</p><ul><li>Source：</li></ul><blockquote><p>  从Client收集数据，传递给Channel。可以接收外部源发送过来的数据。</p><p>  不同的 source，可以接受不同的数据格式。</p><p>  比如有目录池(spooling directory)数据源，可以监控指定文件夹中的新文件变化，如果目录中有文件产生，就会立刻读取其内容。</p></blockquote><ul><li>Channel</li></ul><blockquote><p> 是一个存储地，接收source的输出，直到有sink消费掉channel中的数据，Channel中的数据直到进入到下一个channel中或者进入终端才会被删除；</p><p>当sink写入失败后，可以自动重启，不会造成数据丢失，因此很可靠。</p></blockquote><ul><li>Sink</li></ul><blockquote><p>用于数据输出</p></blockquote><p>4、Flume使用原理图</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDly1g1jrhaxmslj30mx0dbju2.jpg"></p><p>Flume使用Agent内部原理图</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDly1g1jri44xz1j30l80d00uq.jpg"></p><h2 id="二、特点"><a href="#二、特点" class="headerlink" title="二、特点"></a>二、特点</h2><h3 id="A、数据可靠性（内部实现）"><a href="#A、数据可靠性（内部实现）" class="headerlink" title="A、数据可靠性（内部实现）"></a>A、数据可靠性（内部实现）</h3><p>​     当节点出现故障时，日志能够被传送到其他节点上而不会丢失。</p><p> Flume提供了三种级别的可靠性保障,从强到弱依次分别为：</p><p>​    1、end-to-end：收到数据agent首先将event写到磁盘上，当数据传送成功后，再删除；如果数据发送失败，可以重新发送。</p><p>​    2、Store on failure：当数据接收方crash时</p><p>​    3、Best effort：数据发送到接收方后，不会进行确认。(udp)</p><h3 id="B、自身可扩展性"><a href="#B、自身可扩展性" class="headerlink" title="B、自身可扩展性"></a>B、自身可扩展性</h3><ul><li><p>Flume采用了三层架构，分别为agent，collector和storage，每一层均可以水平扩展。所有agent和 collector由master统一管理，使得系统容易监控和维护。master允许有多个（使用ZooKeeper进行管理和负载均衡），避免单点故障问题。</p></li><li><p>【1.0自身agent实现扩展】</p></li></ul><h3 id="C、功能可扩展性"><a href="#C、功能可扩展性" class="headerlink" title="C、功能可扩展性"></a>C、功能可扩展性</h3><p>  用户可以根据需要添加自己的agent。</p><p>   Flume自带了很多组件，包括各种agent（file，syslog，HDFS等）</p><h2 id="三、Flume安装"><a href="#三、Flume安装" class="headerlink" title="三、Flume安装"></a>三、Flume安装</h2><p>​       1)将下载的flume包，解压</p><p>　　2)修改 flume-env.sh 配置文件,主要是JAVA_HOME设置[可选局部环境变量设置]</p><p>​        3)验证是否安装成功 flume-ng version</p><p>telnet 相关安装：</p><p>​     yum list telnet*   查看telnet相关的安装包</p><p>​     直接yum –y install telnet 就OK</p><p>​     yum -y install telnet-server 安装telnet服务</p><p>​     yum -y install telnet-client  安装telnet客户端(大部分系统默认安装)</p><h2 id="四、分类"><a href="#四、分类" class="headerlink" title="四、分类"></a>四、分类</h2><pre><code>Flume 关于Event的笔记　　在Flume中使用Event对象来作为传递数据的格式。　　Sources端在flume-ng-core子项目中的org.apache.flume.serialization包下，有一个名为LineDeserializer的类，这个类负责把数据按行来读取，每一行封装成一个Event（实现方式：按字节读取，当遇到&quot;\n&quot;时封装成Event返回，下一次获取Event时继续获取下一字节并判断）。然后按用户设置的批量传输的值来封装List&lt;Event&gt;备注：capacity：默认该通道中最大的可以存储的event数量是1000trasactionCapacity：每次最大可以source中拿到或者送到sink中的event数量也是100</code></pre><p><code>exec</code>：</p><blockquote><p> Unix等操作系统执行命令行，如tail ，cat 。可监听文件</p></blockquote><p><code>netcat</code></p><blockquote><p>监听一个指定端口，并将接收到的数据的每一行转换为一个event事件</p></blockquote><p><code>avro</code></p><blockquote><p>序列化的一种，实现RPC（一种远程过程调用协议）。</p><p>监听AVRO端口来接收外部AVRO客户端事件流</p></blockquote><h3 id="1、-netcat（监听端口，在本地控制台打印）"><a href="#1、-netcat（监听端口，在本地控制台打印）" class="headerlink" title="1、 netcat（监听端口，在本地控制台打印）"></a>1、 netcat（监听端口，在本地控制台打印）</h3><h4 id="（1）-vim-netcat-logger"><a href="#（1）-vim-netcat-logger" class="headerlink" title="（1） vim netcat_logger"></a>（1） vim netcat_logger</h4><pre><code># example.conf: A single-node Flume configuration# Name the components on this agenta1.sources = r1a1.sinks = k1a1.channels = c1# Describe/configure the sourcea1.sources.r1.type = netcata1.sources.r1.bind = localhosta1.sources.r1.port = 44444# Describe the sinka1.sinks.k1.type = logger# Use a channel which buffers events in memorya1.channels.c1.type = memorya1.channels.c1.capacity = 1000a1.channels.c1.transactionCapacity = 100# Bind the source and sink to the channela1.sources.r1.channels = c1a1.sinks.k1.channel = c1</code></pre><h4 id="（2）命令操作"><a href="#（2）命令操作" class="headerlink" title="（2）命令操作"></a>（2）命令操作</h4><ul><li>（在会话1端）</li></ul><blockquote><p>在node00节点的控制台输入<code>启动</code>命令：</p><p>(<code>方式一</code>：指定配置文件的路径+文件名)</p><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent --conf-file /root/flume/netcat_logger --name a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（<code>方式二</code>：配置文件所在当前目录）</p><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent --conf ./ --conf-file netcat_logger --name a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></blockquote><p><code>特别注意</code>：</p><p>#####<code>官网方式</code>#########</p><blockquote><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent --conf conf --conf-file netcat_logger --name a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>解释：此命令适用于将配置文件放在flume解压安装目录的conf中（不常用）</p></blockquote><p><code>控制台显示</code>:</p><pre><code>​````````19/01/18 12:27:31 INFO instrumentation.MonitoredCounterGroup: Component type: CHANNEL, name: c1 started19/01/18 12:27:31 INFO node.Application: Starting Sink k119/01/18 12:27:31 INFO node.Application: Starting Source r119/01/18 12:27:31 INFO source.NetcatSource: Source starting19/01/18 12:27:31 INFO source.NetcatSource: Created serverSocket:sun.nio.ch.ServerSocketChannelImpl[/127.0.0.1:44444]</code></pre><ul><li>(在会话2端)</li></ul><blockquote><p>在node00节点的控制台输入命令：</p><p>1、在节点上安装telnet</p><pre class="line-numbers language-shell"><code class="language-shell">yum install -y telnetyum -y install telnet-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>2、启动：</p><pre class="line-numbers language-shell"><code class="language-shell">telnet localhost 44444  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>注意：</code>：</p><pre><code>a1.sources.r1.bind = localhost  # 监控本地端口44444的数据</code></pre><p>前提是/etc/hosts中已经配置</p><p>如果此处配置localhost 那么启动时，localhost  或127.0.0.1都可以，node00就不行</p><p>如果此处配置node00那么启动时，node00或ip都可以，localhost就不行</p><p>3、在会话2控制台输入任何内容;</p><p>都会在会话1端显示，且会话1端（ctrl+c）退出服务，会话2端也自动结束</p></blockquote><pre class="line-numbers language-shell"><code class="language-shell">  yum list telnet*   查看telnet相关的安装包   直接yum –y install telnet 就OK     yum -y install telnet-server 安装telnet服务     yum -y install telnet-client  安装telnet客户端(大部分系统默认安装)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2、avro（监听远程发送文件，在本地控制台打印）"><a href="#2、avro（监听远程发送文件，在本地控制台打印）" class="headerlink" title="2、avro（监听远程发送文件，在本地控制台打印）"></a>2、avro（监听远程发送文件，在本地控制台打印）</h3><h4 id="（1）vim-avro-logger"><a href="#（1）vim-avro-logger" class="headerlink" title="（1）vim avro_logger"></a>（1）vim avro_logger</h4><pre><code>#test avro sources##使用avro方式在某节点上将文件发送到本服务器上且通过logger方式显示##当前flume节点执行：#flume-ng agent --conf ./ --conf-file avro_loggers --name a1 -Dflume.root.logger=INFO,console##其他flume节点执行：#flume-ng avro-client --conf ./ -H 192.168.198.128 -p 55555 -F ./logsa1.sources=r1a1.channels=c1a1.sinks=k1a1.sources.r1.type = avro  a1.sources.r1.bind=192.168.198.128a1.sources.r1.port=55555a1.sinks.k1.type=loggera1.channels.c1.type = memorya1.channels.c1.capacity=1000a1.channels.c1.transactionCapacity = 100a1.sources.r1.channels=c1a1.sinks.k1.channel=c1</code></pre><p>实现功能：</p><blockquote><p>使用avro方式在某节点上将文件发送到本服务器上且通过logger方式显示</p></blockquote><h4 id="（2）命令操作-1"><a href="#（2）命令操作-1" class="headerlink" title="（2）命令操作"></a>（2）命令操作</h4><h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a><code>启动</code></h5><p>（在会话1端）</p><p>在node00上</p><ul><li>当前flume节点执行（配置文件在当前目录）：</li></ul><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent --conf ./ --conf-file avro_logger --name a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>显示：</code></p><pre><code>19/01/18 13:53:16 INFO instrumentation.MonitoredCounterGroup: Component type: CHANNEL, name: c1 started19/01/18 13:53:16 INFO node.Application: Starting Sink k119/01/18 13:53:16 INFO node.Application: Starting Source r119/01/18 13:53:16 INFO source.AvroSource: Starting Avro source r1: &amp;#123; bindAddress: 192.168.198.128, port: 55555 &amp;#125;...19/01/18 13:53:17 INFO instrumentation.MonitoredCounterGroup: Monitored counter group for type: SOURCE, name: r1: Successfully registered new MBean.19/01/18 13:53:17 INFO instrumentation.MonitoredCounterGroup: Component type: SOURCE, name: r1 started19/01/18 13:53:17 INFO source.AvroSource: Avro source r1 started.</code></pre><h5 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h5><p>(在会话2端)</p><p>在node00上发送文件到node00</p><p><code>启动</code></p><p>可在本地和其他flume节点执行（配置文件在当前目录）：</p><pre class="line-numbers language-shell"><code class="language-shell">flume-ng avro-client --conf ./ -H 192.168.198.128 -p 55555 -F ./flume.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(在会话1端)</p><pre><code>19/01/18 14:12:57 INFO sink.LoggerSink: Event: &amp;#123; headers:&amp;#123;&amp;#125; body: 68 65 6C 6C 6F 20 62 69 67 64 61 74 61          hello bigdata &amp;#125;</code></pre><p>时刻监听传输文件的内容</p><p><code>注意</code></p><blockquote><p>该过程也可应用于不同节点之间</p></blockquote><h3 id="3、exec（监听某一命令，在本地控制台打印）"><a href="#3、exec（监听某一命令，在本地控制台打印）" class="headerlink" title="3、exec（监听某一命令，在本地控制台打印）"></a>3、exec（监听某一命令，在本地控制台打印）</h3><h4 id="（1）vim-exec-logger"><a href="#（1）vim-exec-logger" class="headerlink" title="（1）vim exec_logger"></a>（1）vim exec_logger</h4><pre><code>#单节点flume配置# example.conf: A single-node Flume configuration   #给agent三大结构命名# Name the components on this agenta1.sources = r1a1.sinks = k1a1.channels = c1#描述source的配置：类型、命令（监听/root/flume.log文件）# Describe/configure the sourcea1.sources.r1.type = execa1.sources.r1.command = tail -F /root/flume.log#描述sink的配置：类型# Describe the sinka1.sinks.k1.type = logger#在内存中使用一个channel缓存事件# Use a channel which buffers events in memorya1.channels.c1.type = memorya1.channels.c1.capacity = 1000a1.channels.c1.transactionCapacity = 100#将source和sink绑定到channel上# Bind the source and sink to the channela1.sources.r1.channels = c1a1.sinks.k1.channel = c1</code></pre><p>（xshell会话1：）</p><blockquote><p>在node00上：<code>启动</code></p><p>在exec_logger文件所在的目录下</p><p>命令：</p><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent  --conf-file exec_logger --name a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>r1 启动</p></blockquote><blockquote><p>（复制会话：会话2）</p><p>在node00上：</p><p>在root目录下</p><p>命令：</p><pre class="line-numbers language-shell"><code class="language-shell">echo hello bigdata >>flume.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></blockquote><blockquote><p>之后在会话1上</p><p><code>logger本地控制台打印：</code></p><pre><code>19/01/18 12:03:23 INFO sink.LoggerSink: Event: &amp;#123; headers:&amp;#123;&amp;#125; body: 68 65 6C 6C 6F 20 62 69 67 64 61 74 61  hello bigdata &amp;#125;</code></pre></blockquote><h3 id="4、netcat–hdfs-监听数据，传到hdfs上"><a href="#4、netcat–hdfs-监听数据，传到hdfs上" class="headerlink" title="4、netcat–hdfs(监听数据，传到hdfs上)"></a>4、netcat–hdfs(监听数据，传到hdfs上)</h3><h4 id="（1）vim-netcat-hdfs"><a href="#（1）vim-netcat-hdfs" class="headerlink" title="（1）vim netcat_hdfs"></a>（1）vim netcat_hdfs</h4><pre><code># a1 which ones we want to activate.a1.channels = c1a1.sources = r1a1.sinks = k1a1.sources.r1.type = netcata1.sources.r1.bind = node00a1.sources.r1.port = 41414a1.sinks.k1.type = hdfsa1.sinks.k1.hdfs.path = hdfs://Sunrise/myflume/%y-%m-%da1.sinks.k1.hdfs.useLocalTimeStamp=true# Define a memory channel called c1 on a1a1.channels.c1.type = memory#默认值，可省#a1.channels.c1.capacity = 1000#a1.channels.c1.transactionCapacity = 100# Define an Avro source called r1 on a1 and tell ita1.sources.r1.channels = c1a1.sinks.k1.channel = c1</code></pre><h4 id="2-操作"><a href="#2-操作" class="headerlink" title="(2)操作"></a>(2)操作</h4><p>在node00的会话1上</p><p>启动</p><blockquote><p>在node00上：</p><p>在netcat_hdfs文件所在的目录下</p><p>命令：</p><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent  --conf-file netcat_hdfs --name a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></blockquote><p>显示：</p><pre><code>19/01/18 14:34:44 INFO instrumentation.MonitoredCounterGroup: Component type: CHANNEL, name: c1 started19/01/18 14:34:44 INFO node.Application: Starting Sink k119/01/18 14:34:44 INFO node.Application: Starting Source r119/01/18 14:34:44 INFO source.NetcatSource: Source starting19/01/18 14:34:44 INFO instrumentation.MonitoredCounterGroup: Monitored counter group for type: SINK, name: k1: Successfully registered new MBean.19/01/18 14:34:44 INFO instrumentation.MonitoredCounterGroup: Component type: SINK, name: k1 started19/01/18 14:34:44 INFO source.NetcatSource: Created serverSocket:sun.nio.ch.ServerSocketChannelImpl[/192.168.198.128:41414]</code></pre><p>在node00的会话2上</p><p>启动</p><pre class="line-numbers language-shell"><code class="language-shell">telnet node00 41414<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>显示</p><pre><code>Trying 192.168.198.128...Connected to node00.Escape character is &#39;^]&#39;.</code></pre><p>输入任意内容</p><p>在node00会话1端会显示</p><pre><code>19/01/18 14:36:50 INFO hdfs.HDFSSequenceFile: writeFormat = Writable, UseRawLocalFileSystem = false19/01/18 14:36:51 INFO hdfs.BucketWriter: Creating hdfs://Sunrise/myflume/19-01-18/FlumeData.1547822210259.tmp19/01/18 14:37:29 INFO hdfs.BucketWriter: Closing hdfs://Sunrise/myflume/19-01-18/FlumeData.1547822210259.tmp19/01/18 14:37:29 INFO hdfs.BucketWriter: Renaming hdfs://Sunrise/myflume/19-01-18/FlumeData.1547822210259.tmp to hdfs://Sunrise/myflume/19-01-18/FlumeData.154782221025919/01/18 14:37:29 INFO hdfs.HDFSEventSink: Writer callback called.</code></pre><p>在HDF分布式系统上会显示，生成的文件</p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1fzb4acaz5fj30u10blmzc.jpg"></p><p><img src="https://wx1.sinaimg.cn/large/005zftzDgy1fzb4bsv8d2j30wd08k74i.jpg"></p><p><code>注意：</code></p><p>这种情况会在hdfs上生成很多小文件，</p><p><a href="http://flume.apache.org/releases/content/1.8.0/FlumeUserGuide.html">在官网</a></p><p>HDFS Sink：<a href="http://flume.apache.org/releases/content/1.8.0/FlumeUserGuide.html#hdfs-sink"><em>文档</em></a></p><p>有很多关于文件生成过程中的配置</p><table><thead><tr><th>Name</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><strong>channel</strong></td><td>–</td><td></td></tr><tr><td><strong>type</strong></td><td>–</td><td>The component type name, needs to be <code>hdfs</code></td></tr><tr><td><strong>hdfs.path</strong></td><td>–</td><td>HDFS directory path (eg hdfs://namenode/flume/webdata/)</td></tr><tr><td>hdfs.filePrefix</td><td>FlumeData</td><td>Name prefixed to files created by Flume in hdfs directory</td></tr><tr><td>hdfs.fileSuffix</td><td>–</td><td>Suffix to append to file (eg <code>.avro</code> - <em>NOTE: period is not automatically added</em>)</td></tr><tr><td>hdfs.inUsePrefix</td><td>–</td><td>Prefix that is used for temporal files that flume actively writes into</td></tr><tr><td>hdfs.inUseSuffix</td><td><code>.tmp</code></td><td>Suffix that is used for temporal files that flume actively writes into</td></tr><tr><td>hdfs.rollInterval</td><td>30</td><td>Number of seconds to wait before rolling current file (0 = never roll based on time interval)</td></tr><tr><td>hdfs.rollSize</td><td>1024</td><td>File size to trigger roll, in bytes (0: never roll based on file size)</td></tr><tr><td>hdfs.rollCount</td><td>10</td><td>Number of events written to file before it rolled (0 = never roll based on number of events)</td></tr><tr><td>hdfs.idleTimeout</td><td>0</td><td>Timeout after which inactive files get closed (0 = disable automatic closing of idle files)</td></tr><tr><td>hdfs.batchSize</td><td>100</td><td>number of events written to file before it is flushed to HDFS</td></tr><tr><td>hdfs.codeC</td><td>–</td><td>Compression codec. one of following : gzip, bzip2, lzo, lzop, snappy</td></tr><tr><td>hdfs.fileType</td><td>SequenceFile</td><td>File format: currently <code>SequenceFile</code>, <code>DataStream</code> or <code>CompressedStream</code> <br>(1)DataStream will not compress output file and please don’t set codeC<br> (2)CompressedStream requires set hdfs.codeC with an available codeC</td></tr><tr><td>hdfs.maxOpenFiles</td><td>5000</td><td>Allow only this number of open files. If this number is exceeded, the oldest file is closed.</td></tr><tr><td>hdfs.minBlockReplicas</td><td>–</td><td>Specify minimum number of replicas per HDFS block. If not specified, it comes from the default Hadoop config in the classpath.</td></tr><tr><td>hdfs.writeFormat</td><td>Writable</td><td>Format for sequence file records. One of <code>Text</code> or <code>Writable</code>. Set to <code>Text</code> before creating data files with Flume, otherwise those files cannot be read by either Apache Impala (incubating) or Apache Hive.</td></tr><tr><td>hdfs.callTimeout</td><td>10000</td><td>Number of milliseconds allowed for HDFS operations, such as open, write, flush, close. This number should be increased if many HDFS timeout operations are occurring.</td></tr><tr><td>hdfs.threadsPoolSize</td><td>10</td><td>Number of threads per HDFS sink for HDFS IO ops (open, write, etc.)</td></tr><tr><td>hdfs.rollTimerPoolSize</td><td>1</td><td>Number of threads per HDFS sink for scheduling timed file rolling</td></tr><tr><td>hdfs.kerberosPrincipal</td><td>–</td><td>Kerberos user principal for accessing secure HDFS</td></tr><tr><td>hdfs.kerberosKeytab</td><td>–</td><td>Kerberos keytab for accessing secure HDFS</td></tr><tr><td>hdfs.proxyUser</td><td></td><td></td></tr><tr><td>hdfs.round</td><td>false</td><td>Should the timestamp be rounded down (if true, affects all time based escape sequences except %t)</td></tr><tr><td>hdfs.roundValue</td><td>1</td><td>Rounded down to the highest multiple of this (in the unit configured using <code>hdfs.roundUnit</code>), less than current time.</td></tr><tr><td>hdfs.roundUnit</td><td>second</td><td>The unit of the round down value - <code>second</code>, <code>minute</code> or <code>hour</code>.</td></tr><tr><td>hdfs.timeZone</td><td>Local Time</td><td>Name of the timezone that should be used for resolving the directory path, e.g. America/Los_Angeles.</td></tr><tr><td>hdfs.useLocalTimeStamp</td><td>false</td><td>Use the local time (instead of the timestamp from the event header) while replacing the escape sequences.</td></tr><tr><td>hdfs.closeTries</td><td>0</td><td>Number of times the sink must try renaming a file, after initiating a close attempt. <br>If set to 1, this sink will not re-try a failed rename (due to, for example, NameNode or DataNode failure), and may leave the file in an open state with a .tmp extension.<br> If set to 0, the sink will try to rename the file until the file is eventually renamed (there is no limit on the number of times it would try). The file may still remain open if the close call fails but the data will be intact and in this case, the file will be closed only after a Flume restart.</td></tr><tr><td>hdfs.retryInterval</td><td>180</td><td>Time in seconds between consecutive attempts to close a file. Each close call costs multiple RPC round-trips to the Namenode, so setting this too low can cause a lot of load on the name node. If set to 0 or less, the sink will not attempt to close the file if the first attempt fails, and may leave the file open or with a ”.tmp” extension.</td></tr><tr><td>serializer</td><td><code>TEXT</code></td><td>Other possible options include <code>avro_event</code> or the fully-qualified class name of an implementation of the <code>EventSerializer.Builder</code> interface.</td></tr></tbody></table><h3 id="avro-hdfs"><a href="#avro-hdfs" class="headerlink" title="avro-hdfs"></a>avro-hdfs</h3><p>（配置方式二）</p><pre><code># a1 which ones we want to activate.a1.channels = c1a1.sources = r1a1.sinks = k1a1.sources.r1.type = avroa1.sources.r1.bind=node01a1.sources.r1.port=55555a1.sinks.k1.type = hdfsa1.sinks.k1.hdfs.path = hdfs://shsxt/hdfsflume# Define a memory channel called c1 on a1a1.channels.c1.type = memorya1.channels.c1.capacity=1000a1.channels.c1.transactionCapacity = 100# Define an Avro source called r1 on a1 and tell ita1.sources.r1.channels = c1a1.sinks.k1.channel = c1</code></pre><p>##当前flume节点执行：<br>#flume-ng agent –conf ./ –conf-file avro_loggers –name a1 -Dflume.root.logger=INFO,console<br>##其他flume节点执行：<br>#flume-ng avro-client –conf ./ -H 192.168.198.128 -p 55555 -F ./logs</p><h3 id="5、结合版（netcat-avro）"><a href="#5、结合版（netcat-avro）" class="headerlink" title="5、结合版（netcat-avro）"></a>5、结合版（netcat-avro）</h3><h4 id="（1）编辑配置文件"><a href="#（1）编辑配置文件" class="headerlink" title="（1）编辑配置文件"></a>（1）编辑配置文件</h4><p>（node00：vim netcat_avro1）</p><pre><code># example.conf: A single-node Flume configuration#flume-ng agent --conf ./ --conf-file netcat_avro1 --name a1 -Dflume.root.logger=INFO,console#flume-ng --conf conf --conf-file /root/flume_test/netcat_hdfs -n a1 -Dflume.root.logger=INFO,console#telnet 192.168.235.15 44444# Name the components on this agent a1.sources = r1 a1.sinks = k1 a1.channels = c1 # Describe/configure the source a1.sources.r1.type = netcat a1.sources.r1.bind = node00 a1.sources.r1.port = 44444 # Describe the sink a1.sinks.k1.type = avro a1.sinks.k1.hostname = node01 a1.sinks.k1.port = 60000 # Use a channel which buffers events in memory a1.channels.c1.type = memory a1.channels.c1.capacity = 1000 a1.channels.c1.transactionCapacity = 100 # Bind the source and sink to the channel a1.sources.r1.channels = c1 a1.sinks.k1.channel = c1#---------------------------#flume-ng agent --conf-file etect2_logger --name a1 -#Dflume.root.logger=INFO,console#flume-ng agent --conf conf --conf-file netcat_logger --name a1 -#Dflume.root.logger=INFO,console</code></pre><p>（node01：netcat_avro2）</p><pre><code>#flume-ng agent --conf ./ --conf-file avro2 -n a1 a1.sources = r1a1.sinks = k1a1.channels = c1a1.sources.r1.type = avroa1.sources.r1.bind = node01a1.sources.r1.port = 60000a1.sinks.k1.type = logger# Use a channel which buffers events in memorya1.channels.c1.type = memorya1.channels.c1.capacity = 1000a1.channels.c1.transactionCapacity = 100# Bind the source and sink to the channela1.sources.r1.channels = c1a1.sinks.k1.channel = c1</code></pre><p>(2)操作</p><blockquote><p>先启动后面的flume节点node01  ，在启动node00，最后启动node02</p></blockquote><p>在node01上</p><p><code>启动</code></p><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent --conf conf --conf-file netcat_avro1 -n a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>显示</p><pre><code>19/01/18 23:22:27 INFO node.Application: Starting Channel c119/01/18 23:22:28 INFO instrumentation.MonitoredCounterGroup: Monitored counter group for type: CHANNEL, name: c1: Successfully registered new MBean.19/01/18 23:22:28 INFO instrumentation.MonitoredCounterGroup: Component type: CHANNEL, name: c1 started19/01/18 23:22:28 INFO node.Application: Starting Sink k119/01/18 23:22:28 INFO node.Application: Starting Source r119/01/18 23:22:28 INFO source.AvroSource: Starting Avro source r1: &amp;#123; bindAddress: node01, port: 60000 &amp;#125;...19/01/18 23:22:30 INFO instrumentation.MonitoredCounterGroup: Monitored counter group for type: SOURCE, name: r1: Successfully registered new MBean.19/01/18 23:22:30 INFO instrumentation.MonitoredCounterGroup: Component type: SOURCE, name: r1 started19/01/18 23:22:30 INFO source.AvroSource: Avro source r1 started.</code></pre><p>在node00上：</p><p><code>启动</code></p><pre class="line-numbers language-shell"><code class="language-shell">flume-ng agent --conf ./ --conf-file netcat_avro2 --name a1 -Dflume.root.logger=INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在node02上</p><p><code>启动</code></p><blockquote><p>telnet node00 44444</p></blockquote><p>然后输入数据文件</p><p>最后在</p><p>node01节点上</p><p>显示文件信息</p><pre><code>19/01/18 23:33:01 INFO sink.LoggerSink: Event: &amp;#123; headers:&amp;#123;&amp;#125; body: 68 65 6C 6C 6F 20 77 6F 72 6C 64 0D             hello world. &amp;#125;</code></pre>]]></content>
    
    
    <summary type="html">日志收集系统</summary>
    
    
    
    <category term="HDFS" scheme="https://sukie-sun.github.io/categories/HDFS/"/>
    
    
    <category term="flume" scheme="https://sukie-sun.github.io/tags/flume/"/>
    
  </entry>
  
</feed>
